<!DOCTYPE html>
<html lang="ms">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kalkulator Beban Tugas & Skor Akademik (Single File)</title>
  <style>
    :root{
      --bg:#0b1220;
      --card:#111a2e;
      --muted:#98a2b3;
      --text:#e6e8ee;
      --line:#25314d;
      --accent:#5b8cff;
      --good:#16a34a;
      --warn:#f59e0b;
      --bad:#ef4444;
      --chip:#1b2a4f;
      --white:#ffffff;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background: radial-gradient(1200px 700px at 10% 0%, #0f1a36 0%, var(--bg) 55%) fixed;
      color:var(--text);
    }
    a{color:inherit}
    .wrap{max-width:1200px;margin:0 auto;padding:18px}
    .topbar{
      display:flex; gap:12px; align-items:center; justify-content:space-between;
      margin-bottom:14px;
    }
    .title h1{margin:0;font-size:18px;letter-spacing:.2px}
    .title p{margin:4px 0 0 0;color:var(--muted);font-size:12.5px}
    .btnrow{display:flex;flex-wrap:wrap;gap:8px;justify-content:flex-end}
    button,.btn{
      border:1px solid var(--line);
      background: linear-gradient(180deg, #162548, #0f1933);
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:600;
      font-size:13px;
    }
    button:hover{border-color:#38548b}
    button:disabled{opacity:.55;cursor:not-allowed}
    .btn-accent{border-color:#2b4fb2;background:linear-gradient(180deg,#2f5bff,#1a2f6c)}
    .btn-danger{border-color:#7a2530;background:linear-gradient(180deg,#3a141a,#1c0b10)}
    .btn-ghost{background:transparent}
    .grid{
      display:grid; gap:12px;
      grid-template-columns: 1.15fr .85fr;
    }
    @media(max-width:980px){ .grid{grid-template-columns:1fr} }
    .card{
      background: rgba(17,26,46,.92);
      border:1px solid var(--line);
      border-radius:18px;
      padding:14px;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
    }
    .card h2{
      margin:0 0 10px 0;
      font-size:14px;
      letter-spacing:.2px;
      display:flex; align-items:center; justify-content:space-between;
    }
    .hint{color:var(--muted); font-size:12.5px; margin:6px 0 0 0}
    .row{display:grid;grid-template-columns: 1fr 1fr; gap:10px}
    @media(max-width:680px){ .row{grid-template-columns:1fr} }
    label{display:block;font-size:12px;color:var(--muted);margin:0 0 6px 0}
    input,select,textarea{
      width:100%;
      padding:10px 10px;
      border-radius:12px;
      border:1px solid var(--line);
      background:#0e162a;
      color:var(--text);
      outline:none;
    }
    textarea{min-height:78px;resize:vertical}
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px;
      border-radius:999px;
      background:rgba(27,42,79,.8);
      border:1px solid var(--line);
      color:var(--text);
      font-size:12.5px;
      margin:4px 8px 0 0;
    }
    .chips{display:flex;flex-wrap:wrap;gap:8px}
    .chip b{font-size:12.5px}
    .status{
      padding:6px 10px;border-radius:999px;font-size:12px;font-weight:700;
      border:1px solid var(--line); background:#0e162a;
    }
    .ok{color:var(--good);border-color:rgba(22,163,74,.5)}
    .no{color:var(--bad);border-color:rgba(239,68,68,.5)}
    .mid{color:var(--warn);border-color:rgba(245,158,11,.5)}
    .sectionHead{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      margin:10px 0 10px 0;
      padding-top:6px;
      border-top:1px dashed rgba(37,49,77,.9);
    }
    .sectionHead .left{display:flex;align-items:center;gap:10px}
    .sectionHead .right{display:flex;gap:8px;flex-wrap:wrap}
    .toggle{
      display:flex;align-items:center;gap:10px;
      padding:10px 12px;border:1px solid var(--line);
      border-radius:14px;background:#0e162a;
    }
    .toggle input{width:auto}
    .tableWrap{overflow:auto;border-radius:14px;border:1px solid var(--line)}
    table{width:100%;border-collapse:collapse;min-width:860px;background:#0e162a}
    th,td{border-bottom:1px solid rgba(37,49,77,.75);padding:10px;vertical-align:top}
    th{position:sticky;top:0;background:#0f1b33;text-align:left;font-size:12px;color:var(--muted)}
    td input, td textarea, td select{background:#0b1326}
    .num{max-width:140px}
    .small{max-width:220px}
    .muted{color:var(--muted)}
    .foot{
      display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;
      margin-top:10px;
      border-top:1px solid var(--line);
      padding-top:12px;
    }
    .msg{
      display:none;
      margin:10px 0 0 0;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background:#0e162a;
      color:var(--text);
      font-size:12.5px;
    }
    .msg.show{display:block}
    .printOnly{display:none}
    @media print{
      body{background:#fff;color:#111}
      .wrap{max-width:none;padding:0}
      .card{box-shadow:none;border:1px solid #ccc;background:#fff}
      .noPrint{display:none !important}
      .printOnly{display:block}
      table{min-width:0}
      input,select,textarea{border:1px solid #bbb;color:#111;background:#fff}
      .chip{border:1px solid #bbb;background:#f6f7fb;color:#111}
    }
  </style>
</head>

<body>
<div class="wrap">

  <div class="topbar noPrint">
    <div class="title">
      <h1>Kalkulator Beban Tugas & Skor Akademik</h1>
      <p>Single-file • Autosave • Export CSV/JSON • Print-to-PDF • Ada ruang “Tajuk Geran” & “Tajuk Publication”.</p>
    </div>
    <div class="btnrow">
      <button id="btnCalc" class="btn-accent">Kira Skor</button>
      <button id="btnPrint">Print (PDF)</button>
      <button id="btnManual" class="btn">Manual PDF</button>
      <button id="btnSaveLocal" class="btn">Simpan (Local)</button>
      <button id="btnReset" class="btn-danger">Reset</button>
    </div>
  </div>

  <div class="grid">
    <!-- LEFT -->
    <div class="card">
      <h2>Profil</h2>

      <div class="row">
        <div>
          <label>Nama</label>
          <input id="pName" placeholder="cth: Dato’ Ekeh" />
        </div>
        <div>
          <label>Institusi / Fakulti</label>
          <input id="pOrg" placeholder="cth: Universiti Malaysia Sabah (FST)" />
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <div>
          <label>Gred</label>
          <select id="pGrade">
            <option value="">-- pilih --</option>
            <option>VK5</option>
            <option>VK6</option>
            <option>VK7</option>
            <option>DS54</option>
            <option>DS55</option>
            <option>Others</option>
          </select>
          <div id="pGradeOtherWrap" style="display:none;margin-top:8px">
            <input id="pGradeOther" placeholder="Nyatakan gred (Others)" />
          </div>
        </div>
        <div>
          <label>Status</label>
          <select id="pStatus">
            <option value="">-- pilih --</option>
            <option>Permanent</option>
            <option>Contract</option>
            <option>Visiting</option>
            <option>Others</option>
          </select>
          <div id="pStatusOtherWrap" style="display:none;margin-top:8px">
            <input id="pStatusOther" placeholder="Nyatakan status (Others)" />
          </div>
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <div>
          <label>Kategori Template</label>
          <select id="pCategory">
            <option value="">-- pilih --</option>
            <option value="Academic">Academic</option>
            <option value="Administrative">Administrative</option>
            <option value="Laboratory">Laboratory</option>
          </select>
          <p class="hint">Jika pilih kategori, sistem akan set default “enabled section” dan unit points asas (boleh ubah di Admin).</p>
        </div>
        <div>
          <label>Catatan ringkas (untuk print)</label>
          <textarea id="pNotes" placeholder="cth: Semester 2, Sesi 2024/2025"></textarea>
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <div>
          <label>Tajuk Geran (boleh ubah)</label>
          <input id="pGrantTitle" placeholder="cth: FRGS - Machine Learning for Wage Inequality..." />
          <p class="hint">Ini akan dipaparkan dalam laporan print & export summary.</p>
        </div>
        <div>
          <label>Tajuk Publication Utama (boleh ubah)</label>
          <input id="pPubTitle" placeholder="cth: Investigating the Unemployment-Minimum Wage Nexus..." />
          <p class="hint">Ini juga dipaparkan dalam laporan print & export summary.</p>
        </div>
      </div>

      <div class="sectionHead">
        <div class="left">
          <h2 style="margin:0">Hidupkan/Sembunyikan Seksyen</h2>
        </div>
      </div>

      <div class="chips">
        <div class="toggle"><input type="checkbox" id="enTeaching"><span>Teaching</span></div>
        <div class="toggle"><input type="checkbox" id="enSupervision"><span>Supervision</span></div>
        <div class="toggle"><input type="checkbox" id="enResearch"><span>Research</span></div>
        <div class="toggle"><input type="checkbox" id="enPublication"><span>Publication</span></div>
        <div class="toggle"><input type="checkbox" id="enAdministration"><span>Administration</span></div>
        <div class="toggle"><input type="checkbox" id="enServices"><span>Services</span></div>
        <div class="toggle"><input type="checkbox" id="enLabOps"><span>Lab Ops</span></div>
        <div class="toggle"><input type="checkbox" id="enProSch"><span>Professional Scholarship</span></div>
      </div>

      <div id="msg" class="msg"></div>

      <div class="foot noPrint">
        <div class="muted" style="font-size:12.5px">
          Autosave aktif (LocalStorage). Disyorkan klik “Kira Skor” selepas ubah input besar.
        </div>
        <div class="btnrow">
          <button id="btnExportSummaryCSV" class="btn">Export Summary CSV</button>
          <button id="btnExportDetailedCSV" class="btn">Export Detailed CSV</button>
          <button id="btnExportJSON" class="btn">Export JSON</button>
        </div>
      </div>
    </div>

    <!-- RIGHT -->
    <div class="card">
      <h2>
        Ringkasan Skor
        <span id="benchStatus" class="status mid">Belum kira</span>
      </h2>

      <div class="chips">
        <div class="chip"><span class="muted">Jumlah Skor</span> <b id="outTotal">0.00</b></div>
        <div class="chip"><span class="muted">Benchmark</span> <b id="outBenchmark">0.00</b></div>
        <div class="chip"><span class="muted">Perbezaan</span> <b id="outDiff">0.00</b></div>
      </div>

      <div style="margin-top:10px" class="tableWrap">
        <table>
          <thead>
            <tr>
              <th>Seksyen</th>
              <th>Item</th>
              <th>Skor</th>
            </tr>
          </thead>
          <tbody id="tbodySummary"></tbody>
          <tfoot>
            <tr>
              <th colspan="2">Jumlah</th>
              <th id="outTotal2">0.00</th>
            </tr>
          </tfoot>
        </table>
      </div>

      <div class="sectionHead noPrint" style="margin-top:14px">
        <div class="left">
          <h2 style="margin:0">Admin (Optional)</h2>
        </div>
        <div class="right">
          <button id="btnAdminUnlock" class="btn">Unlock</button>
          <button id="btnAdminLock" class="btn-ghost">Lock</button>
        </div>
      </div>

      <div id="adminBox" class="noPrint" style="display:none">
        <p class="hint">Admin membenarkan ubah benchmark & unit points default. Password default: <b>admin123</b> (boleh ubah dalam kod).</p>

        <div class="row">
          <div>
            <label>Benchmark Skor (sasaran)</label>
            <input id="admBenchmark" type="number" step="0.01" />
          </div>
          <div>
            <label>Nota Admin</label>
            <input id="admNote" placeholder="cth: Benchmark ikut PTJ / semester" />
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <div>
            <label>Preset Template (Admin sahaja)</label>
            <div class="btnrow" style="justify-content:flex-start">
              <button id="btnPresetAcademic" class="btn">Preset Academic</button>
              <button id="btnPresetAdmin" class="btn">Preset Administrative</button>
              <button id="btnPresetLab" class="btn">Preset Laboratory</button>
            </div>
          </div>
          <div>
            <label>Unit points default (ringkas)</label>
            <input id="admUnitTeach" type="number" step="0.01" placeholder="Teaching unit" />
            <div style="height:8px"></div>
            <input id="admUnitPub" type="number" step="0.01" placeholder="Publication unit" />
          </div>
        </div>

        <div class="btnrow" style="justify-content:flex-start;margin-top:10px">
          <button id="btnAdminApply" class="btn-accent">Apply Admin Settings</button>
        </div>
      </div>

      <div class="printOnly" style="margin-top:12px">
        <h2>Ringkasan untuk Laporan</h2>
        <p><b>Nama:</b> <span id="printName"></span></p>
        <p><b>Institusi:</b> <span id="printOrg"></span></p>
        <p><b>Tajuk Geran:</b> <span id="printGrant"></span></p>
        <p><b>Tajuk Publication:</b> <span id="printPub"></span></p>
        <p><b>Nota:</b> <span id="printNotes"></span></p>
      </div>
    </div>
  </div>

  <!-- SECTIONS -->
  <div class="card" id="secTeach">
    <div class="sectionHead">
      <div class="left"><h2 style="margin:0">Teaching</h2><span class="muted" id="teachHint"></span></div>
      <div class="right noPrint">
        <button id="addTeach">Tambah</button>
        <button id="clearTeach" class="btn-danger">Clear</button>
      </div>
    </div>
    <div class="tableWrap">
      <table>
        <thead>
          <tr>
            <th style="width:32%">Aktiviti / Kursus</th>
            <th class="small">Semester / Sesi</th>
            <th class="num">Kuantiti</th>
            <th class="num">Unit Point</th>
            <th class="num">Subtotal</th>
            <th>Catatan</th>
            <th class="noPrint" style="width:90px">Aksi</th>
          </tr>
        </thead>
        <tbody id="tbodyTeach"></tbody>
      </table>
    </div>
  </div>

  <div class="card" id="secSv">
    <div class="sectionHead">
      <div class="left"><h2 style="margin:0">Supervision</h2><span class="muted" id="svHint"></span></div>
      <div class="right noPrint">
        <button id="addSv">Tambah</button>
        <button id="clearSv" class="btn-danger">Clear</button>
      </div>
    </div>
    <div class="tableWrap">
      <table>
        <thead>
          <tr>
            <th style="width:28%">Nama Pelajar / Projek</th>
            <th class="small">Tahap</th>
            <th class="num">Kuantiti</th>
            <th class="num">Unit Point</th>
            <th class="num">Subtotal</th>
            <th>Catatan</th>
            <th class="noPrint" style="width:90px">Aksi</th>
          </tr>
        </thead>
        <tbody id="tbodySv"></tbody>
      </table>
    </div>
  </div>

  <div class="card" id="secRes">
    <div class="sectionHead">
      <div class="left"><h2 style="margin:0">Research</h2><span class="muted" id="resHint"></span></div>
      <div class="right noPrint">
        <button id="addRes">Tambah</button>
        <button id="clearRes" class="btn-danger">Clear</button>
      </div>
    </div>
    <div class="tableWrap">
      <table>
        <thead>
          <tr>
            <th style="width:26%">Tajuk / Aktiviti Penyelidikan</th>
            <th class="small">Jenis (Grant/Project)</th>
            <th class="num">Kuantiti</th>
            <th class="num">Unit Point</th>
            <th class="num">Subtotal</th>
            <th>Catatan (cth: Tajuk geran terperinci)</th>
            <th class="noPrint" style="width:90px">Aksi</th>
          </tr>
        </thead>
        <tbody id="tbodyRes"></tbody>
      </table>
    </div>
  </div>

  <div class="card" id="secPub">
    <div class="sectionHead">
      <div class="left"><h2 style="margin:0">Publication</h2><span class="muted" id="pubHint"></span></div>
      <div class="right noPrint">
        <button id="addPub">Tambah</button>
        <button id="clearPub" class="btn-danger">Clear</button>
      </div>
    </div>
    <div class="tableWrap">
      <table>
        <thead>
          <tr>
            <th style="width:26%">Tajuk Publication</th>
            <th class="small">Jenis (Scopus/WoS/Book/Chapter)</th>
            <th class="num">Kuantiti</th>
            <th class="num">Unit Point</th>
            <th class="num">Subtotal</th>
            <th>Catatan (cth: jurnal, status, DOI)</th>
            <th class="noPrint" style="width:90px">Aksi</th>
          </tr>
        </thead>
        <tbody id="tbodyPub"></tbody>
      </table>
    </div>
  </div>

  <div class="card" id="secAdmin">
    <div class="sectionHead">
      <div class="left"><h2 style="margin:0">Administration</h2><span class="muted" id="adminHint"></span></div>
      <div class="right noPrint">
        <button id="addAdmin">Tambah</button>
        <button id="clearAdmin" class="btn-danger">Clear</button>
      </div>
    </div>
    <div class="tableWrap">
      <table>
        <thead>
          <tr>
            <th style="width:30%">Peranan / Jawatan</th>
            <th class="small">Tempoh</th>
            <th class="num">Kuantiti</th>
            <th class="num">Unit Point</th>
            <th class="num">Subtotal</th>
            <th>Catatan</th>
            <th class="noPrint" style="width:90px">Aksi</th>
          </tr>
        </thead>
        <tbody id="tbodyAdmin"></tbody>
      </table>
    </div>
  </div>

  <div class="card" id="secSvc">
    <div class="sectionHead">
      <div class="left"><h2 style="margin:0">Services</h2><span class="muted" id="svcHint"></span></div>
      <div class="right noPrint">
        <button id="addSvc">Tambah</button>
        <button id="clearSvc" class="btn-danger">Clear</button>
      </div>
    </div>
    <div class="tableWrap">
      <table>
        <thead>
          <tr>
            <th style="width:30%">Khidmat / Komuniti / Konsultansi</th>
            <th class="small">Peringkat</th>
            <th class="num">Kuantiti</th>
            <th class="num">Unit Point</th>
            <th class="num">Subtotal</th>
            <th>Catatan</th>
            <th class="noPrint" style="width:90px">Aksi</th>
          </tr>
        </thead>
        <tbody id="tbodySvc"></tbody>
      </table>
    </div>
  </div>

  <div class="card" id="secLab">
    <div class="sectionHead">
      <div class="left"><h2 style="margin:0">Lab Ops</h2><span class="muted" id="labHint"></span></div>
      <div class="right noPrint">
        <button id="addLab">Tambah</button>
        <button id="clearLab" class="btn-danger">Clear</button>
      </div>
    </div>
    <div class="tableWrap">
      <table>
        <thead>
          <tr>
            <th style="width:30%">Operasi Makmal / SOP / Latihan</th>
            <th class="small">Jenis</th>
            <th class="num">Kuantiti</th>
            <th class="num">Unit Point</th>
            <th class="num">Subtotal</th>
            <th>Catatan</th>
            <th class="noPrint" style="width:90px">Aksi</th>
          </tr>
        </thead>
        <tbody id="tbodyLab"></tbody>
      </table>
    </div>
  </div>

  <div class="card" id="secPS">
    <div class="sectionHead">
      <div class="left"><h2 style="margin:0">Professional Scholarship (ProSch)</h2><span class="muted" id="psHint"></span></div>
      <div class="right noPrint">
        <button id="addProSch">Tambah</button>
        <button id="clearProSch" class="btn-danger">Clear</button>
      </div>
    </div>
    <div class="tableWrap">
      <table>
        <thead>
          <tr>
            <th style="width:30%">Aktiviti (Talk, Training, Award, Review, Editorial)</th>
            <th class="small">Peringkat</th>
            <th class="num">Kuantiti</th>
            <th class="num">Unit Point</th>
            <th class="num">Subtotal</th>
            <th>Catatan</th>
            <th class="noPrint" style="width:90px">Aksi</th>
          </tr>
        </thead>
        <tbody id="tbodyPS"></tbody>
      </table>
    </div>
  </div>

</div>

<script>
/* =========================================================
   UTILITIES
========================================================= */
const $ = (id)=>document.getElementById(id);
const fmt2 = (x)=> (Number.isFinite(x) ? x.toFixed(2) : "0.00");
const nowISO = ()=> new Date().toISOString();

function showMsg(text, tone=""){
  const el = $("msg");
  if(!el) return;
  el.textContent = text;
  el.className = "msg show";
  if(tone==="ok") el.style.borderColor="rgba(22,163,74,.5)";
  else if(tone==="bad") el.style.borderColor="rgba(239,68,68,.5)";
  else el.style.borderColor="rgba(37,49,77,.95)";
  setTimeout(()=>{ try{ el.className="msg"; }catch{} }, 2600);
}
function hideMsg(){ const el=$("msg"); if(el) el.className="msg"; }

/* =========================================================
   STATE
========================================================= */
const STORAGE_KEY = "workload_score_v1";
let isAdmin = false;

const defaultState = ()=>({
  meta:{
    version:"1.0",
    savedAt:null
  },
  profile:{
    name:"",
    org:"",
    grade:"",
    gradeOther:"",
    status:"",
    statusOther:"",
    category:"",
    notes:"",
    grantTitle:"",
    pubTitle:""
  },
  enabled:{
    teach:true, sv:true, res:true, pub:true, admin:true, svc:true, lab:true, ps:true
  },
  admin:{
    benchmark: 100.00,
    note:"",
    unitTeachDefault: 1.00,
    unitPubDefault: 1.00
  },
  data:{
    teach:[],
    sv:[],
    res:[],
    pub:[],
    admin:[],
    svc:[],
    lab:[],
    ps:[]
  },
  lastCalc:{
    totalsByKind:{},
    total:0,
    benchmark:100
  }
});

let state = defaultState();

function ensureSeed(){
  // seed minimal rows (optional; keep empty by default)
  // no-op, but safe for future
  if(!state.data) state.data = defaultState().data;
}

function loadLocal(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return;
    const obj = JSON.parse(raw);
    state = mergeDeep(defaultState(), obj);
  }catch(e){
    console.warn("loadLocal fail", e);
  }
}

function autosave(){
  try{
    state.meta.savedAt = nowISO();
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  }catch(e){
    console.warn("autosave fail", e);
  }
}

function saveNow(){
  syncProfileFromUI();
  syncEnabledFromUI();
  autosave();
  showMsg("Disimpan ke LocalStorage.", "ok");
}

function resetAll(){
  if(!confirm("Reset semua data? Ini akan padam data dalam browser (LocalStorage).")) return;
  state = defaultState();
  autosave();
  syncUIFromState();
  applySectionVisibility();
  renderAll();
  setAdminUI();
  updateBenchmarkUI();
  showMsg("Reset selesai.", "ok");
}

/* Simple deep merge (safe) */
function mergeDeep(target, source){
  if(typeof target !== "object" || target===null) return source;
  const out = Array.isArray(target) ? [...target] : {...target};
  if(typeof source !== "object" || source===null) return out;
  for(const k of Object.keys(source)){
    const sv = source[k];
    const tv = out[k];
    if(Array.isArray(sv)) out[k] = sv;
    else if(typeof sv === "object" && sv !== null) out[k] = mergeDeep(tv ?? {}, sv);
    else out[k] = sv;
  }
  return out;
}

/* =========================================================
   PROFILE + ENABLED SYNC
========================================================= */
function syncProfileFromUI(){
  state.profile.name = $("pName").value.trim();
  state.profile.org  = $("pOrg").value.trim();
  state.profile.grade = $("pGrade").value;
  state.profile.gradeOther = $("pGradeOther").value.trim();
  state.profile.status = $("pStatus").value;
  state.profile.statusOther = $("pStatusOther").value.trim();
  state.profile.category = $("pCategory").value;
  state.profile.notes = $("pNotes").value.trim();
  state.profile.grantTitle = $("pGrantTitle").value.trim();
  state.profile.pubTitle = $("pPubTitle").value.trim();
}

function syncEnabledFromUI(){
  state.enabled.teach = $("enTeaching").checked;
  state.enabled.sv = $("enSupervision").checked;
  state.enabled.res = $("enResearch").checked;
  state.enabled.pub = $("enPublication").checked;
  state.enabled.admin = $("enAdministration").checked;
  state.enabled.svc = $("enServices").checked;
  state.enabled.lab = $("enLabOps").checked;
  state.enabled.ps = $("enProSch").checked;
}

function syncUIFromState(){
  // profile
  $("pName").value = state.profile.name || "";
  $("pOrg").value = state.profile.org || "";
  $("pGrade").value = state.profile.grade || "";
  $("pGradeOther").value = state.profile.gradeOther || "";
  $("pStatus").value = state.profile.status || "";
  $("pStatusOther").value = state.profile.statusOther || "";
  $("pCategory").value = state.profile.category || "";
  $("pNotes").value = state.profile.notes || "";
  $("pGrantTitle").value = state.profile.grantTitle || "";
  $("pPubTitle").value = state.profile.pubTitle || "";

  $("pGradeOtherWrap").style.display = ($("pGrade").value==="Others") ? "block" : "none";
  $("pStatusOtherWrap").style.display = ($("pStatus").value==="Others") ? "block" : "none";

  // enabled toggles
  $("enTeaching").checked = !!state.enabled.teach;
  $("enSupervision").checked = !!state.enabled.sv;
  $("enResearch").checked = !!state.enabled.res;
  $("enPublication").checked = !!state.enabled.pub;
  $("enAdministration").checked = !!state.enabled.admin;
  $("enServices").checked = !!state.enabled.svc;
  $("enLabOps").checked = !!state.enabled.lab;
  $("enProSch").checked = !!state.enabled.ps;
}

/* =========================================================
   SECTION VISIBILITY
========================================================= */
function applySectionVisibility(){
  $("secTeach").style.display = state.enabled.teach ? "block" : "none";
  $("secSv").style.display = state.enabled.sv ? "block" : "none";
  $("secRes").style.display = state.enabled.res ? "block" : "none";
  $("secPub").style.display = state.enabled.pub ? "block" : "none";
  $("secAdmin").style.display = state.enabled.admin ? "block" : "none";
  $("secSvc").style.display = state.enabled.svc ? "block" : "none";
  $("secLab").style.display = state.enabled.lab ? "block" : "none";
  $("secPS").style.display = state.enabled.ps ? "block" : "none";
}

/* =========================================================
   ADMIN
========================================================= */
const ADMIN_PASSWORD = "admin123";

function unlockAdmin(){
  const pw = prompt("Masukkan password admin:");
  if(pw !== ADMIN_PASSWORD){
    showMsg("Password salah.", "bad");
    return;
  }
  isAdmin = true;
  setAdminUI();
  showMsg("Admin unlocked.", "ok");
}

function lockAdmin(){
  isAdmin = false;
  setAdminUI();
  showMsg("Admin locked.", "ok");
}

function setAdminUI(){
  $("adminBox").style.display = isAdmin ? "block" : "none";
  // load admin fields
  $("admBenchmark").value = Number(state.admin.benchmark ?? 100);
  $("admNote").value = state.admin.note ?? "";
  $("admUnitTeach").value = Number(state.admin.unitTeachDefault ?? 1);
  $("admUnitPub").value = Number(state.admin.unitPubDefault ?? 1);

  // disable preset buttons if not admin
  ["btnPresetAcademic","btnPresetAdmin","btnPresetLab"].forEach(id=>{
    if($(id)) $(id).disabled = !isAdmin;
  });
}

function applyAdminSettings(){
  if(!isAdmin) return;
  const b = parseFloat($("admBenchmark").value);
  state.admin.benchmark = Number.isFinite(b) ? b : 100;
  state.admin.note = $("admNote").value.trim();

  const ut = parseFloat($("admUnitTeach").value);
  const up = parseFloat($("admUnitPub").value);
  state.admin.unitTeachDefault = Number.isFinite(ut) ? ut : 1;
  state.admin.unitPubDefault = Number.isFinite(up) ? up : 1;

  autosave();
  updateBenchmarkUI();
  showMsg("Admin settings dikemaskini.", "ok");
}

/* =========================================================
   TEMPLATES
========================================================= */
function applyTemplateByCategory(category){
  // Set “enabled” + default unit points
  if(category==="Academic"){
    state.enabled = {teach:true, sv:true, res:true, pub:true, admin:true, svc:true, lab:false, ps:true};
    state.admin.benchmark = state.admin.benchmark || 100;
    state.admin.unitTeachDefault = 1.0;
    state.admin.unitPubDefault = 1.0;
  }else if(category==="Administrative"){
    state.enabled = {teach:true, sv:false, res:true, pub:true, admin:true, svc:true, lab:false, ps:true};
    state.admin.benchmark = state.admin.benchmark || 80;
    state.admin.unitTeachDefault = 0.8;
    state.admin.unitPubDefault = 1.0;
  }else if(category==="Laboratory"){
    state.enabled = {teach:true, sv:true, res:true, pub:true, admin:true, svc:true, lab:true, ps:true};
    state.admin.benchmark = state.admin.benchmark || 90;
    state.admin.unitTeachDefault = 1.0;
    state.admin.unitPubDefault = 0.9;
  }
  syncUIFromState();
  applySectionVisibility();
  autosave();
  renderAll();
  updateBenchmarkUI();
  showMsg("Template digunakan: " + category, "ok");
}

/* =========================================================
   ROW MANAGEMENT
========================================================= */
function newRow(kind){
  // Common schema for all
  const base = {
    title:"",
    type:"",
    qty:1,
    unit: defaultUnit(kind),
    note:""
  };

  // Kind-specific prefill
  if(kind==="pub"){
    base.title = state.profile.pubTitle || "";
  }
  if(kind==="res"){
    base.title = state.profile.grantTitle || "";
    base.type = "Grant/Project";
  }
  return base;
}

function defaultUnit(kind){
  if(kind==="teach") return Number(state.admin.unitTeachDefault ?? 1);
  if(kind==="pub") return Number(state.admin.unitPubDefault ?? 1);
  // other default
  return 1.00;
}

function addRow(kind){
  state.data[kind].push(newRow(kind));
  autosave();
  renderKind(kind);
}

function deleteRow(kind, idx){
  state.data[kind].splice(idx,1);
  autosave();
  renderKind(kind);
}

function clearKind(kind){
  if(!confirm("Clear semua item untuk seksyen ini?")) return;
  state.data[kind] = [];
  autosave();
  renderKind(kind);
}

function updateCell(kind, idx, field, value){
  const row = state.data[kind][idx];
  if(!row) return;
  if(field==="qty" || field==="unit"){
    const n = parseFloat(value);
    row[field] = Number.isFinite(n) ? n : 0;
  }else{
    row[field] = value;
  }
  autosave();
}

/* =========================================================
   RENDERING
========================================================= */
function renderAll(){
  renderKind("teach");
  renderKind("sv");
  renderKind("res");
  renderKind("pub");
  renderKind("admin");
  renderKind("svc");
  renderKind("lab");
  renderKind("ps");
  renderSummaryTable(); // show last calc if any
}

function renderKind(kind){
  const map = {
    teach:"tbodyTeach",
    sv:"tbodySv",
    res:"tbodyRes",
    pub:"tbodyPub",
    admin:"tbodyAdmin",
    svc:"tbodySvc",
    lab:"tbodyLab",
    ps:"tbodyPS"
  };
  const tbody = $(map[kind]);
  if(!tbody) return;

  const rows = state.data[kind] || [];
  tbody.innerHTML = "";

  rows.forEach((r, idx)=>{
    const tr = document.createElement("tr");

    // title
    const td1 = document.createElement("td");
    const in1 = document.createElement("input");
    in1.value = r.title ?? "";
    in1.placeholder = (kind==="pub") ? "cth: Tajuk artikel / buku" :
                    (kind==="res") ? "cth: Tajuk geran / projek" :
                    "cth: Aktiviti";
    in1.addEventListener("input",(e)=>updateCell(kind, idx, "title", e.target.value));
    td1.appendChild(in1);

    // type
    const td2 = document.createElement("td");
    const in2 = document.createElement(kind==="teach" ? "input" : "input");
    in2.value = r.type ?? "";
    in2.placeholder = kind==="teach" ? "cth: Sem 2 24/25" :
                     kind==="sv" ? "cth: Master/PhD" :
                     kind==="pub" ? "cth: Scopus/WoS/Book" :
                     "cth: Jenis / Tempoh";
    in2.addEventListener("input",(e)=>updateCell(kind, idx, "type", e.target.value));
    td2.appendChild(in2);

    // qty
    const td3 = document.createElement("td");
    const in3 = document.createElement("input");
    in3.type = "number"; in3.step="0.01";
    in3.value = Number(r.qty ?? 0);
    in3.className = "num";
    in3.addEventListener("input",(e)=>updateCell(kind, idx, "qty", e.target.value));
    td3.appendChild(in3);

    // unit
    const td4 = document.createElement("td");
    const in4 = document.createElement("input");
    in4.type = "number"; in4.step="0.01";
    in4.value = Number(r.unit ?? defaultUnit(kind));
    in4.className = "num";
    in4.addEventListener("input",(e)=>updateCell(kind, idx, "unit", e.target.value));
    td4.appendChild(in4);

    // subtotal (computed on calculate; show live anyway)
    const td5 = document.createElement("td");
    const sub = (Number(r.qty||0) * Number(r.unit||0));
    td5.textContent = fmt2(sub);

    // note
    const td6 = document.createElement("td");
    const in6 = document.createElement("textarea");
    in6.value = r.note ?? "";
    in6.placeholder = "cth: status, peranan, jurnal, lokasi, bukti, dsb.";
    in6.addEventListener("input",(e)=>updateCell(kind, idx, "note", e.target.value));
    td6.appendChild(in6);

    // action
    const td7 = document.createElement("td");
    td7.className = "noPrint";
    const del = document.createElement("button");
    del.textContent = "Buang";
    del.className = "btn-danger";
    del.addEventListener("click",(e)=>{ e.preventDefault(); deleteRow(kind, idx); });
    td7.appendChild(del);

    [td1,td2,td3,td4,td5,td6,td7].forEach(td=>tr.appendChild(td));
    tbody.appendChild(tr);
  });

  // hints
  const hintMap = {
    teach:"teachHint", sv:"svHint", res:"resHint", pub:"pubHint",
    admin:"adminHint", svc:"svcHint", lab:"labHint", ps:"psHint"
  };
  const h = $(hintMap[kind]);
  if(h) h.textContent = rows.length ? `(${rows.length} item)` : "(tiada item)";
}

/* =========================================================
   CALCULATION + SUMMARY
========================================================= */
function sumKind(kind){
  const rows = state.data[kind] || [];
  let total=0;
  for(const r of rows){
    const qty = Number(r.qty || 0);
    const unit = Number(r.unit || 0);
    total += qty * unit;
  }
  return total;
}

function calculate(){
  syncProfileFromUI();
  syncEnabledFromUI();
  applySectionVisibility();

  const totals = {};
  const enabledKinds = [
    ["teach","Teaching"],
    ["sv","Supervision"],
    ["res","Research"],
    ["pub","Publication"],
    ["admin","Administration"],
    ["svc","Services"],
    ["lab","Lab Ops"],
    ["ps","ProSch"]
  ];

  let grand=0;
  for(const [k] of enabledKinds){
    if(!state.enabled[k]) { totals[k]=0; continue; }
    const t = sumKind(k);
    totals[k]=t;
    grand += t;
  }

  const bench = Number(state.admin.benchmark ?? 100);
  state.lastCalc = { totalsByKind: totals, total: grand, benchmark: bench };
  autosave();

  updateBenchmarkUI();
  renderSummaryTable();
  // refresh subtotal cells display
  renderAll();
  showMsg("Pengiraan selesai.", "ok");
}

function updateBenchmarkUI(){
  const total = Number(state.lastCalc.total ?? 0);
  const bench = Number(state.admin.benchmark ?? 0);

  $("outTotal").textContent = fmt2(total);
  $("outTotal2").textContent = fmt2(total);
  $("outBenchmark").textContent = fmt2(bench);

  const diff = total - bench;
  $("outDiff").textContent = fmt2(diff);

  const status = $("benchStatus");
  if(!status) return;

  if(!Number.isFinite(total) || !Number.isFinite(bench)){
    status.textContent = "Belum kira";
    status.className = "status mid";
    return;
  }
  if(total >= bench){
    status.textContent = "Capai benchmark";
    status.className = "status ok";
  }else if(total >= bench*0.8){
    status.textContent = "Hampir capai";
    status.className = "status mid";
  }else{
    status.textContent = "Belum capai";
    status.className = "status no";
  }
}

function renderSummaryTable(){
  const tbody = $("tbodySummary");
  if(!tbody) return;

  const labels = {
    teach:"Teaching",
    sv:"Supervision",
    res:"Research",
    pub:"Publication",
    admin:"Administration",
    svc:"Services",
    lab:"Lab Ops",
    ps:"ProSch"
  };

  tbody.innerHTML = "";
  const totals = state.lastCalc.totalsByKind || {};
  const kinds = ["teach","sv","res","pub","admin","svc","lab","ps"];

  for(const k of kinds){
    const tr = document.createElement("tr");
    const td1 = document.createElement("td");
    const td2 = document.createElement("td");
    const td3 = document.createElement("td");

    td1.textContent = labels[k];
    td2.textContent = state.enabled[k] ? `${(state.data[k]||[]).length} item` : "Disabled";
    td3.textContent = fmt2(Number(totals[k] ?? 0));
    tr.appendChild(td1); tr.appendChild(td2); tr.appendChild(td3);
    tbody.appendChild(tr);
  }
}

/* =========================================================
   EXPORTS
========================================================= */
function downloadText(filename, text){
  const blob = new Blob([text], {type:"text/plain;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(()=>URL.revokeObjectURL(url), 1000);
}

function csvEscape(s){
  const t = String(s ?? "");
  if(/[",\n]/.test(t)) return `"${t.replace(/"/g,'""')}"`;
  return t;
}

function exportSummaryCSV(){
  syncProfileFromUI();
  const totals = state.lastCalc.totalsByKind || {};
  const lines = [];
  lines.push(["Nama", state.profile.name].map(csvEscape).join(","));
  lines.push(["Institusi", state.profile.org].map(csvEscape).join(","));
  lines.push(["Tajuk Geran", state.profile.grantTitle].map(csvEscape).join(","));
  lines.push(["Tajuk Publication", state.profile.pubTitle].map(csvEscape).join(","));
  lines.push(["Benchmark", state.admin.benchmark].map(csvEscape).join(","));
  lines.push(["Jumlah Skor", state.lastCalc.total].map(csvEscape).join(","));
  lines.push("");
  lines.push(["Seksyen","Skor"].map(csvEscape).join(","));
  const kinds = ["teach","sv","res","pub","admin","svc","lab","ps"];
  const labels = {teach:"Teaching",sv:"Supervision",res:"Research",pub:"Publication",admin:"Administration",svc:"Services",lab:"Lab Ops",ps:"ProSch"};
  for(const k of kinds){
    lines.push([labels[k], fmt2(Number(totals[k]??0))].map(csvEscape).join(","));
  }
  downloadText("summary.csv", lines.join("\n"));
  showMsg("Summary CSV diexport.", "ok");
}

function exportDetailedCSV(){
  syncProfileFromUI();
  const header = ["Seksyen","Title","Type/Tempoh","Qty","Unit","Subtotal","Note"];
  const lines = [header.map(csvEscape).join(",")];
  const kinds = ["teach","sv","res","pub","admin","svc","lab","ps"];
  const labels = {teach:"Teaching",sv:"Supervision",res:"Research",pub:"Publication",admin:"Administration",svc:"Services",lab:"Lab Ops",ps:"ProSch"};

  for(const k of kinds){
    const rows = state.data[k] || [];
    for(const r of rows){
      const qty = Number(r.qty||0);
      const unit = Number(r.unit||0);
      const sub = qty*unit;
      lines.push([
        labels[k],
        r.title ?? "",
        r.type ?? "",
        qty,
        unit,
        fmt2(sub),
        r.note ?? ""
      ].map(csvEscape).join(","));
    }
  }
  downloadText("detailed.csv", lines.join("\n"));
  showMsg("Detailed CSV diexport.", "ok");
}

function exportJSON(){
  syncProfileFromUI();
  syncEnabledFromUI();
  autosave();
  downloadText("data.json", JSON.stringify(state, null, 2));
  showMsg("JSON diexport.", "ok");
}

/* =========================================================
   PRINT SUPPORT
========================================================= */
function syncPrintFields(){
  $("printName").textContent = state.profile.name || "—";
  $("printOrg").textContent  = state.profile.org || "—";
  $("printGrant").textContent = state.profile.grantTitle || "—";
  $("printPub").textContent = state.profile.pubTitle || "—";
  $("printNotes").textContent = state.profile.notes || "—";
}

function manualPDF(){
  alert(
`Manual PDF:
1) Klik butang “Print (PDF)”
2) Dalam dialog print browser, pilih “Save as PDF”
3) Pastikan “Background graphics” dihidupkan jika perlu.
Tip: Kira Skor dahulu untuk ringkasan terkini.`
  );
}

/* =========================================================
   INIT (wiring all buttons)
========================================================= */
function init(){
  loadLocal();
  ensureSeed();
  syncUIFromState();
  applySectionVisibility();
  renderAll();
  setAdminUI();
  updateBenchmarkUI();

  // Profile other fields
  $("pGrade").addEventListener("change", ()=>{
    $("pGradeOtherWrap").style.display = ($("pGrade").value==="Others") ? "block" : "none";
    syncProfileFromUI(); autosave();
  });
  $("pStatus").addEventListener("change", ()=>{
    $("pStatusOtherWrap").style.display = ($("pStatus").value==="Others") ? "block" : "none";
    syncProfileFromUI(); autosave();
  });

  // Profile changes autosave
  ["pName","pOrg","pGradeOther","pStatusOther","pNotes","pGrantTitle","pPubTitle"].forEach(id=>{
    $(id).addEventListener("input", ()=>{
      syncProfileFromUI(); autosave();
    });
  });

  // Category template
  $("pCategory").addEventListener("change", ()=>{
    syncProfileFromUI();
    if(state.profile.category) applyTemplateByCategory(state.profile.category);
  });

  // Toggles
  ["enTeaching","enSupervision","enResearch","enPublication","enAdministration","enServices","enLabOps","enProSch"].forEach(id=>{
    $(id).addEventListener("change", ()=>{
      syncEnabledFromUI();
      applySectionVisibility();
      autosave();
    });
  });

  // Admin
  $("btnAdminUnlock").addEventListener("click",(e)=>{ e.preventDefault(); unlockAdmin(); });
  $("btnAdminLock").addEventListener("click",(e)=>{ e.preventDefault(); lockAdmin(); });
  $("btnAdminApply").addEventListener("click",(e)=>{ e.preventDefault(); applyAdminSettings(); });

  // Add/Clear
  $("addTeach").onclick=(e)=>{e.preventDefault(); addRow("teach");};
  $("clearTeach").onclick=(e)=>{e.preventDefault(); clearKind("teach");};

  $("addSv").onclick=(e)=>{e.preventDefault(); addRow("sv");};
  $("clearSv").onclick=(e)=>{e.preventDefault(); clearKind("sv");};

  $("addRes").onclick=(e)=>{e.preventDefault(); addRow("res");};
  $("clearRes").onclick=(e)=>{e.preventDefault(); clearKind("res");};

  $("addPub").onclick=(e)=>{e.preventDefault(); addRow("pub");};
  $("clearPub").onclick=(e)=>{e.preventDefault(); clearKind("pub");};

  $("addAdmin").onclick=(e)=>{e.preventDefault(); addRow("admin");};
  $("clearAdmin").onclick=(e)=>{e.preventDefault(); clearKind("admin");};

  $("addSvc").onclick=(e)=>{e.preventDefault(); addRow("svc");};
  $("clearSvc").onclick=(e)=>{e.preventDefault(); clearKind("svc");};

  $("addLab").onclick=(e)=>{e.preventDefault(); addRow("lab");};
  $("clearLab").onclick=(e)=>{e.preventDefault(); clearKind("lab");};

  $("addProSch").onclick=(e)=>{e.preventDefault(); addRow("ps");};
  $("clearProSch").onclick=(e)=>{e.preventDefault(); clearKind("ps");};

  // Calculate / Print / Manual / Export
  $("btnCalc").onclick=(e)=>{e.preventDefault(); calculate();};

  $("btnPrint").onclick=(e)=>{
    e.preventDefault();
    syncProfileFromUI();
    syncPrintFields();
    window.print();
  };

  $("btnManual").onclick=(e)=>{e.preventDefault(); manualPDF();};

  $("btnExportSummaryCSV").onclick=(e)=>{e.preventDefault(); exportSummaryCSV();};
  $("btnExportDetailedCSV").onclick=(e)=>{e.preventDefault(); exportDetailedCSV();};
  $("btnExportJSON").onclick=(e)=>{e.preventDefault(); exportJSON();};

  // Save / Reset
  $("btnSaveLocal").onclick=(e)=>{e.preventDefault(); saveNow();};
  $("btnReset").onclick=(e)=>{e.preventDefault(); resetAll();};

  // Presets (admin only)
  $("btnPresetAcademic").onclick=(e)=>{e.preventDefault(); if(!isAdmin) return; applyTemplateByCategory("Academic");};
  $("btnPresetAdmin").onclick=(e)=>{e.preventDefault(); if(!isAdmin) return; applyTemplateByCategory("Administrative");};
  $("btnPresetLab").onclick=(e)=>{e.preventDefault(); if(!isAdmin) return; applyTemplateByCategory("Laboratory");};

  hideMsg();
}
document.addEventListener("DOMContentLoaded", init);
</script>

</body>
</html>
