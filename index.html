<!doctype html>
<!--
  Changes:
  - Reworked layout into left-side tabs with a sticky action bar for Calculate/Print/Export.
  - Switched to a flat, high-contrast palette and improved text wrapping/visibility.
  - Reorganized Advanced Settings into per-section groups and ensured empty table placeholders.
-->
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>FST UMS – Staff Busyness Index (Calculator)</title>

  <!-- =========================================================
       ADVANCED SETTINGS PASSPHRASE (EDIT HERE)
       Change this anytime to update local settings access.
       NOTE: This is front-end only (GitHub Pages static).
       ========================================================= -->
  <script>
    const ADMIN_PASSWORD = "FST-ADMIN-2025";  // <-- EDIT PASSWORD HERE
  </script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- jsPDF for manual PDF -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    :root{
      /* Web theme (professional flat). Print will override to B/W + gray. */
      --bg:#0f1218;
      --surface:#1a2230;
      --surface-2:#212b3b;
      --border:rgba(255,255,255,.12);
      --shadow: 0 16px 40px rgba(0,0,0,.35);
      --radius: 16px;
      --action-bar-height: 72px;

      --text:#f1f5f9;
      --muted:#cbd5e1;

      --primary:#3b82f6;
      --accent:#22c55e;
      --danger:#ef4444;
      --warn:#f59e0b;

      --t:#7c9dff;
      --sv:#3cc9ff;
      --r:#32d29c;
      --p:#f094c4;
      --a:#f2b44a;
      --s:#fb8898;
      --l:#43d389;
      --set:#60a5fa;

      /* ONE font family everywhere (web + print + manual). */
      --font: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial, "Noto Sans", "Liberation Sans", sans-serif;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: var(--font);
      background: var(--bg);
      color:var(--text);
      -webkit-text-size-adjust: 100%;
      text-rendering: optimizeLegibility;
    }

    .wrap{max-width:1280px;margin:0 auto;padding:22px 18px calc(var(--action-bar-height) + 28px)}

    /* =========================
       Top bar (mobile-friendly)
    ========================= */
    .topbar{
      display:flex;align-items:center;justify-content:space-between;gap:14px;
      padding:14px 16px;border:1px solid var(--border);
      background: var(--surface);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      position:sticky;top:10px;z-index:20;
      backdrop-filter: none;
    }
    .brand{display:flex;align-items:center;gap:14px;min-width:0}
    .logoBox{
      width:120px;height:72px;
      border-radius:14px;
      background:#ffffff;
      overflow:hidden;
      display:flex;align-items:center;justify-content:center;
      border:none;
      box-shadow:none;
      padding:8px;
      flex: 0 0 auto;
    }
    .logoBox img{width:100%;height:100%;object-fit:contain}

    .title{display:flex;flex-direction:column;gap:2px;min-width:0}
    .title h1{
      font-size:16px;margin:0;letter-spacing:.2px;
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
      max-width: 520px;
    }
    .title .sub{
      font-size:12px;color:var(--muted);
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
      max-width: 520px;
    }
    .title-actions{display:flex;align-items:center;gap:8px;flex-wrap:wrap}

    .top-actions{display:flex;flex-wrap:wrap;gap:8px;align-items:center;justify-content:flex-end}

    .btn{
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      color:var(--text);
      padding:10px 14px;border-radius:12px;
      cursor:pointer; font-weight:650;
      transition: transform .08s ease, background .2s ease, border .2s ease;
      user-select:none;
      font-family: var(--font);
      display:inline-flex;align-items:center;gap:8px;
    }
    .btn:hover{background:rgba(255,255,255,.10)}
    .btn:active{transform: translateY(1px)}
    .btn-primary{
      background:var(--primary);
      border-color: rgba(59,130,246,.85);
      color:#0b1220;
    }
    .btn-secondary{background:rgba(255,255,255,.08)}
    .btn-ghost{background:transparent}
    .btn-danger{
      background:rgba(239,68,68,.2);
      border-color: rgba(239,68,68,.6);
    }
    .btn-warn{
      background:rgba(245,158,11,.2);
      border-color: rgba(245,158,11,.6);
    }
    .btn-sm{padding:6px 10px;border-radius:10px;font-size:.82rem}
    .btn-md{padding:12px 18px;border-radius:14px;font-size:.95rem}
    .btn-icon{padding:6px 8px;min-width:36px;justify-content:center}
    .btn-icon svg{width:16px;height:16px;fill:currentColor}

    .pill{
      padding:8px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.05);
      color:var(--muted);
      font-size:12px;
      font-family: var(--font);
    }
    .pill strong{color:var(--text)}

    .badge{
      display:inline-flex;align-items:center;gap:8px;
      padding:6px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      font-size:12px;color:var(--muted);
      font-family: var(--font);
    }
    .dot{width:9px;height:9px;border-radius:99px;background:var(--accent);box-shadow:0 0 0 4px rgba(45,212,191,.15)}
    .dot.lock{background:var(--warn);box-shadow:0 0 0 4px rgba(255,176,32,.15)}

    /* =========================
       Sections
    ========================= */
    .section{
      margin-top:16px;
      border:1px solid rgba(255,255,255,.10);
      border-radius: var(--radius);
      overflow:hidden;
      box-shadow: var(--shadow);
      background: var(--surface);
    }
    .section header{
      display:flex;gap:10px;align-items:flex-start;justify-content:space-between;
      padding:16px 18px;
      border-bottom:1px solid rgba(255,255,255,.10);
    }
    .section h2{margin:0;font-size:15px;letter-spacing:.2px;font-family:var(--font)}
    .section .sub{margin-top:4px;color:var(--muted);font-size:12px;max-width:920px;font-family:var(--font)}
    .content{padding:16px 18px}

    /* Flat section accents */
    .profile{border-left:4px solid var(--t)}
    .toggles{border-left:4px solid #a78bfa}
    .settings{border-left:4px solid var(--set)}
    .teaching{border-left:4px solid var(--t)}
    .supervision{border-left:4px solid var(--sv)}
    .research{border-left:4px solid var(--r)}
    .publication{border-left:4px solid var(--p)}
    .admin{border-left:4px solid var(--a)}
    .service{border-left:4px solid var(--s)}
    .labops{border-left:4px solid var(--l)}
    .results{border-left:4px solid var(--accent)}
    .prosch{border-left:4px solid #94a3b8}

    .appShell{
      display:grid;
      grid-template-columns:240px minmax(0,1fr);
      gap:18px;
      margin-top:18px;
      align-items:start;
    }
    #sidebar{
      position:sticky;
      top:110px;
      align-self:start;
      background:var(--surface);
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:14px;
      box-shadow: var(--shadow);
    }
    .tablist{
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .tab-btn{
      border:1px solid transparent;
      background:transparent;
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      text-align:left;
      cursor:pointer;
      font-weight:600;
      font-family:var(--font);
    }
    .tab-btn[aria-selected="true"]{
      background:rgba(59,130,246,.18);
      border-color:rgba(59,130,246,.6);
    }
    .tab-btn:focus-visible{
      outline:3px solid rgba(59,130,246,.85);
      outline-offset:2px;
    }
    #mainContent{min-width:0;padding-bottom:var(--action-bar-height)}
    .tab-panel.is-hidden{display:none}

    /* =========================
       Layout grids
    ========================= */
    .grid{display:grid;gap:12px}
    .grid.two{grid-template-columns:repeat(2, minmax(0,1fr))}
    .grid.three{grid-template-columns:repeat(3, minmax(0,1fr))}

    /* =========================
       Form controls
    ========================= */
    label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px;font-family:var(--font)}
    input,select,textarea{
      width:100%;
      background:rgba(15,18,24,.6);
      border:1px solid rgba(255,255,255,.14);
      color:var(--text);
      border-radius:12px;
      padding:10px 10px;
      outline:none;
      font-family: var(--font);
      font-size: 14px;
      line-height: 1.25;
    }
    input:focus,select:focus,textarea:focus{border-color:rgba(76,199,255,.8);box-shadow:0 0 0 3px rgba(76,199,255,.2)}
    input:focus-visible,select:focus-visible,textarea:focus-visible,button:focus-visible{
      outline:3px solid rgba(76,199,255,.85);
      outline-offset:2px;
    }
    textarea{
      min-height:70px;
      resize:vertical;
      overflow:hidden; /* enables auto-grow without scrollbars */
      white-space: pre-wrap;
      overflow-wrap:anywhere;
      word-break:break-word;
    }
    input.err, select.err, textarea.err{border-color: rgba(255,91,110,.85) !important; box-shadow: 0 0 0 3px rgba(255,91,110,.18)}
    .hint{font-size:12px;color:var(--muted);margin-top:6px;font-family:var(--font)}
    .requiredMark::after{content:" *"; color: var(--warn); font-weight:800}

    /* =========================
       Tables: responsive
    ========================= */
    .tableWrap{
      width:100%;
      overflow-x:auto;
      -webkit-overflow-scrolling: touch;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.1);
      background:var(--surface-2);
    }
    table{width:100%;border-collapse:collapse;min-width:0}
    th,td{
      border-bottom:1px solid rgba(255,255,255,.10);
      padding:10px 8px;
      vertical-align:top;
      font-family:var(--font);
      min-width:0;
      white-space:normal;
      overflow-wrap:anywhere;
      word-break:break-word;
    }
    th{font-size:12px;color:var(--muted);text-align:left}
    td input, td select, td textarea{
      padding:8px 8px;
      border-radius:10px;
      width:100%;
      max-width:100%;
    }
    td textarea{
      min-height:44px;
      line-height:1.25;
      resize:vertical;
      white-space:pre-wrap;
      overflow-wrap:anywhere;
      word-break:break-word;
    }
    .tableWrap textarea{overflow:hidden}
    .emptyRow td{
      text-align:center;
      color:var(--muted);
      font-style:italic;
      border:1px dashed rgba(255,255,255,.16);
      padding:16px 12px;
    }

    /* allow long text inside table cells */
    td .cellText{
      white-space:pre-wrap;
      word-break:break-word;
      overflow-wrap:anywhere;
    }
    td.cell-actions{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }

    @media (max-width:980px){
      .tableWrap{overflow:visible}
      table thead{display:none}
      table tbody tr{
        display:block;
        margin:12px;
        border:1px solid rgba(255,255,255,.12);
        border-radius:14px;
        padding:8px 12px;
        background:rgba(12,18,35,.8);
      }
      table tbody tr td{
        display:flex;
        align-items:center;
        justify-content:space-between;
        gap:12px;
        border:none;
        padding:6px 0;
      }
      table tbody tr td::before{
        content:attr(data-label);
        color:var(--muted);
        font-weight:600;
        width:42%;
      }
      table tbody tr td input,
      table tbody tr td select,
      table tbody tr td textarea{
        width:58%;
      }
      table tbody tr td .cellText{
        width:58%;
      }
      table tbody tr td.cell-actions::before{display:none}
      table tbody tr.emptyRow{
        margin:12px;
        padding:0;
        border:none;
        background:transparent;
      }
      table tbody tr.emptyRow td{
        width:100%;
      }
      table tbody tr.emptyRow td::before{display:none}
    }

    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .row.right{justify-content:flex-end}

    .notice{
      padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);color:var(--muted);font-size:12px;
      font-family:var(--font);
      white-space: normal;
      overflow-wrap:anywhere;
      word-break:break-word;
    }
    .notice.bad{border-color: rgba(255,91,110,.55); background: rgba(255,91,110,.10); color:#ffd9de}
    .notice.warn{border-color: rgba(255,176,32,.55); background: rgba(255,176,32,.10); color:#ffe9c2}
    .notice.ok{border-color: rgba(45,212,191,.55); background: rgba(45,212,191,.10); color:#d9fffb}

    .settings-grid{
      display:grid;
      gap:16px;
    }
    .settings-card{
      border:1px solid rgba(255,255,255,.12);
      background:var(--surface-2);
      border-radius:14px;
      padding:14px;
    }
    .settings-card h3{
      margin:0 0 8px;
      font-size:14px;
      letter-spacing:.2px;
    }

    .kpi{
      display:grid;gap:10px;
      grid-template-columns:repeat(4, minmax(0,1fr));
    }
    .box{
      border:1px solid rgba(255,255,255,.12);
      background:rgba(7,11,21,.40);
      border-radius:14px;
      padding:12px;
      font-family:var(--font);
      min-width: 0;
    }
    .box .k{font-size:12px;color:var(--muted)}
    .box .v{font-size:20px;font-weight:900;margin-top:4px}
    .box .s{font-size:12px;color:var(--muted);margin-top:4px}

    /* Narrative / summary boxes: ensure wrap (web + print) */
    .wrapText{
      white-space: pre-wrap;
      overflow-wrap:anywhere;
      word-break:break-word;
    }

    .footer{
      margin-top:18px;
      color:rgba(255,255,255,.55);
      font-size:12px;text-align:center;
      font-family:var(--font)
    }
    .spacer{height:10px}

    .icon-btn{
      border:1px solid rgba(255,255,255,.2);
      background:rgba(255,255,255,.08);
      color:var(--text);
      width:34px;height:34px;border-radius:10px;
      display:inline-flex;align-items:center;justify-content:center;
      cursor:pointer;
    }
    .icon-btn svg{width:16px;height:16px;fill:currentColor}

    .action-bar{
      position:fixed;
      bottom:0;
      left:0;
      right:0;
      z-index:40;
      background:rgba(15,18,24,.98);
      border-top:1px solid var(--border);
      padding:10px 18px;
      display:flex;
      justify-content:center;
    }
    .action-bar .action-inner{
      width:min(1280px, 100%);
      display:flex;
      align-items:center;
      justify-content:flex-end;
      gap:10px;
    }
    .action-bar .dropdown-menu{
      top:auto;
      bottom:calc(100% + 8px);
    }

    /* =========================
       Modal
    ========================= */
    .modal-overlay{
      position:fixed;
      inset:0;
      background:rgba(3,7,16,.6);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:60;
      padding:18px;
    }
    .modal-overlay.open{display:flex}
    .modal{
      width:min(920px, 100%);
      max-height:90vh;
      background:var(--surface);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      display:flex;
      flex-direction:column;
    }
    .modal-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:16px 18px;
      border-bottom:1px solid rgba(255,255,255,.10);
    }
    .modal-header h3{margin:0;font-size:16px}
    .modal-body{
      padding:16px 18px;
      overflow:auto;
    }
    .modal-actions{
      display:flex;
      justify-content:flex-end;
      gap:10px;
      padding:14px 18px;
      border-top:1px solid rgba(255,255,255,.10);
    }
    .modal-grid{grid-template-columns:repeat(2, minmax(0,1fr))}
    body.modal-open{overflow:hidden}

    .dropdown{position:relative;display:inline-flex}
    .dropdown-menu{
      position:absolute;right:0;top:calc(100% + 8px);
      background:var(--surface-2);
      border:1px solid rgba(255,255,255,.14);
      border-radius:12px;
      padding:8px;
      min-width:220px;
      box-shadow:var(--shadow);
      display:none;
      z-index:30;
    }
    .dropdown-menu.open{display:block}
    .dropdown-menu button{
      width:100%;justify-content:flex-start;border-radius:10px;
    }

    /* Admin panel */
    .adminPanel{
      display:flex;gap:8px;align-items:center;flex-wrap:wrap;
    }
    .adminPanel input{
      width:220px;
      background:rgba(15,18,24,.65);
    }
    .adminPanel .small{flex-basis:100%}
    .small{font-size:12px;color:var(--muted);font-family:var(--font)}

    /* =========================
       RESPONSIVE (Phone/Tablet)
    ========================= */
    @media(max-width:980px){
      .wrap{padding:14px 12px calc(var(--action-bar-height) + 20px)}
      .topbar{position:relative;top:auto;flex-direction:column;align-items:stretch;gap:12px}
      .brand{width:100%}
      .logoBox{width:110px;height:66px}
      .title h1,.title .sub{max-width: 100%}
      .top-actions{justify-content:flex-start}
      .grid.two,.grid.three{grid-template-columns:1fr}
      .modal-grid{grid-template-columns:1fr}
      .kpi{grid-template-columns:repeat(2, minmax(0,1fr))}
      .btn{padding:12px 12px}
      .appShell{grid-template-columns:1fr}
      #sidebar{position:static}
      .tablist{
        flex-direction:row;
        overflow-x:auto;
        padding-bottom:6px;
      }
      .tab-btn{white-space:nowrap}
      .action-bar{padding:10px 12px}
    }
    @media(max-width:520px){
      .kpi{grid-template-columns:1fr}
      .logoBox{width:104px;height:62px}
      .btn{width:100%}
      .adminPanel{width:100%}
      .adminPanel input{width:100%}
      .pill,.badge{width:100%;justify-content:center}
    }

    /* =========================
       PRINT (Professional B/W + Gray)
    ========================= */
    .printOnly{display:none}
    @media print{
      @page { margin: 14mm; }

      body{
        background:#fff !important;
        color:#000 !important;
        font-family: var(--font) !important;
      }

      /* Force all text to print in black for readability */
      *, *::before, *::after{
        color:#000 !important;
        text-shadow:none !important;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
      }
      input::placeholder, textarea::placeholder{
        color:#000 !important;
      }

      /* Hide web controls */
      .topbar,.noPrint,#secSettings,#secToggles,#sidebar,#actionBar{display:none !important}
      .appShell{grid-template-columns:1fr !important}

      .wrap{max-width: 100% !important; padding:0 !important}

      /* Sections look like official forms */
      .section{
        box-shadow:none !important;
        border:1px solid #444 !important;
        border-radius: 8px !important;
        margin-top: 10px !important;
        background:#fff !important;
      }
      .section header{
        background:#e9e9e9 !important;
        color:#000 !important;
        border-bottom:1px solid #444 !important;
        padding:10px 12px !important;
      }
      .section h2{font-size: 12pt !important}
      .section .sub{color:#111 !important; font-size: 10pt !important}

      .content{padding:10px 12px !important}

      /* Inputs appear like form fields */
      input,select,textarea{
        color:#000 !important;
        background:#fff !important;
        border:1px solid #000 !important;
        border-radius: 6px !important;
      }

      /* KPI boxes */
      .box{
        border:1px solid #000 !important;
        background:#fff !important;
        border-radius: 8px !important;
      }
      .box .k,.box .s{color:#111 !important}
      .box .v{color:#000 !important}

      /* Tables: B/W */
      .tableWrap{overflow:visible !important}
      table{min-width: 0 !important; width:100% !important}
      th,td{
        border-bottom:1px solid #000 !important;
        color:#000 !important;
      }
      th{
        background:#efefef !important;
        border-top:1px solid #000 !important;
      }

      /* Force wrapping everywhere important */
      .wrapText, .notice, .hint, .sub, td, th, div, span{
        white-space: normal !important;
        overflow-wrap:anywhere !important;
        word-break:break-word !important;
      }

      .printOnly{display:block !important}
      canvas{max-width:100% !important; height:auto !important}
    }
  </style>
</head>

<body>
<div class="wrap">

  <div class="topbar">
    <div class="brand">
      <div class="logoBox" title="Place 'UMS logo.png' in the same folder as index.html">
        <img id="umsLogo" src="UMS logo.png" alt="UMS logo"
             onerror="this.style.display='none'; this.parentElement.innerHTML='<div style=&quot;color:#111;font-weight:800;font-size:12px;text-align:center;line-height:1.1&quot;>UMS<br>LOGO</div>';">
      </div>
      <div class="title">
        <h1>FST UMS – Staff Busyness Index Calculator</h1>
        <div class="sub">Single-file, local-only tool for workload recording and reporting. Advanced settings are for local configuration only (no security control).</div>
        <div class="title-actions noPrint">
          <span class="small">Need help?</span>
          <button class="icon-btn" id="btnManual" aria-label="Download user guide (PDF)" title="Download user guide (PDF)">
            <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 2a10 10 0 1 0 10 10A10.01 10.01 0 0 0 12 2Zm.02 17a1.25 1.25 0 1 1 1.23-1.25A1.24 1.24 0 0 1 12.02 19Zm2.2-7.43-.86.88a2.33 2.33 0 0 0-.74 1.76v.29h-1.5v-.41a3.4 3.4 0 0 1 .93-2.36l1.07-1.09a1.48 1.48 0 0 0-.25-2.4 1.67 1.67 0 0 0-2.2.49 1.93 1.93 0 0 0-.32.86H8.85a3.17 3.17 0 0 1 .57-1.69A3.15 3.15 0 0 1 13.7 6.8a3.03 3.03 0 0 1 .46 4.77Z"/></svg>
          </button>
        </div>
      </div>
    </div>

    <div class="top-actions noPrint">
      <span class="pill">Mode: <strong id="modeText">Staff</strong></span>
      <span class="badge"><span id="lockDot" class="dot lock"></span><span id="lockText">Settings locked</span></span>

      <div class="adminPanel">
        <input type="password" id="adminPass" placeholder="Advanced Settings (Local) passphrase">
        <button class="btn btn-warn btn-sm" id="btnAdminUnlock"><span class="btn-label">Enable Settings</span></button>
        <button class="btn btn-ghost btn-sm" id="btnAdminLock" style="display:none;"><span class="btn-label">Disable</span></button>
        <div class="small">Local configuration only — not a security control.</div>
      </div>

      <button class="btn btn-secondary" id="btnSaveLocal"><span class="btn-label">Save</span></button>
      <button class="btn btn-danger" id="btnReset"><span class="btn-label">Reset</span></button>
    </div>
  </div>

  <div class="appShell">
    <aside id="sidebar">
      <nav class="tablist" role="tablist" aria-label="Section navigation">
        <button class="tab-btn" id="tabProfile" role="tab" aria-controls="secProfile" aria-selected="true" tabindex="0">Staff Profile</button>
        <button class="tab-btn" id="tabToggles" role="tab" aria-controls="secToggles" aria-selected="false" tabindex="-1">Section Applicability (On/Off)</button>
        <button class="tab-btn" id="tabSettings" role="tab" aria-controls="secSettings" aria-selected="false" tabindex="-1">Advanced Settings (Local)</button>
        <button class="tab-btn" id="tabTeaching" role="tab" aria-controls="secTeaching" aria-selected="false" tabindex="-1">Teaching</button>
        <button class="tab-btn" id="tabSupervision" role="tab" aria-controls="secSupervision" aria-selected="false" tabindex="-1">Student Supervision</button>
        <button class="tab-btn" id="tabResearch" role="tab" aria-controls="secResearch" aria-selected="false" tabindex="-1">Research</button>
        <button class="tab-btn" id="tabPublication" role="tab" aria-controls="secPublication" aria-selected="false" tabindex="-1">Publication</button>
        <button class="tab-btn" id="tabAdministration" role="tab" aria-controls="secAdmin" aria-selected="false" tabindex="-1">Administration</button>
        <button class="tab-btn" id="tabService" role="tab" aria-controls="secService" aria-selected="false" tabindex="-1">Service & Engagement</button>
        <button class="tab-btn" id="tabLabOps" role="tab" aria-controls="secLabOps" aria-selected="false" tabindex="-1">Laboratory Operations</button>
        <button class="tab-btn" id="tabProSch" role="tab" aria-controls="secProSch" aria-selected="false" tabindex="-1">Professional & Scholarly Service</button>
        <button class="tab-btn" id="tabResults" role="tab" aria-controls="secResults" aria-selected="false" tabindex="-1">Results</button>
      </nav>
    </aside>
    <main id="mainContent">

  <!-- PROFILE -->
  <section class="section profile tab-panel" id="secProfile" role="tabpanel" aria-labelledby="tabProfile" tabindex="0">
    <header>
      <div>
        <h2>Staff Profile</h2>
        <div class="sub">All fields are required. Example Staff ID: <b>250505-02025</b>.</div>
      </div>
    </header>
    <div class="content">
      <div class="grid three">
        <div>
          <label class="requiredMark">Full Name</label>
          <input id="pName" placeholder="e.g., Dr. Amina Yusuf"/>
        </div>
        <div>
          <label class="requiredMark">Staff ID</label>
          <input id="pStaffId" placeholder="e.g., 250505-02025"/>
        </div>
        <div>
          <label class="requiredMark">Staff Category</label>
          <select id="pCategory">
            <option value="">Select</option>
            <option value="Academic">Academic</option>
            <option value="Administrative">Administrative</option>
            <option value="Laboratory">Laboratory</option>
          </select>
          <div class="hint">Selecting a category auto-applies section ON/OFF states and default weights.</div>
        </div>
        <div>
          <label>Academic Staff Category</label>
          <select id="pStaffCategory">
            <option value="nonadmin">Non-admin Academic Staff</option>
            <option value="admin">Admin Academic Staff</option>
          </select>
          <div class="hint">Used for Tutor/Demonstrator eligibility (Teaching + Supervision only).</div>
        </div>

        <div>
          <label class="requiredMark">School/Unit</label>
          <input id="pUnit" placeholder="e.g., Mathematics with Economics / Finance Unit / Chemistry Lab"/>
        </div>

        <div>
          <label class="requiredMark">Grade</label>
          <select id="pGrade">
            <option value="">Select</option>
            <option>Lecturer</option>
            <option>Senior Lecturer</option>
            <option>Associate Professor</option>
            <option>Professor</option>
            <option>Lab Officer</option>
            <option>Assistant Science Officer</option>
            <option>Administrative Officer</option>
            <option>Others</option>
          </select>
        </div>
        <div id="pGradeOtherWrap" style="display:none;">
          <label class="requiredMark">Other grade (specify)</label>
          <input id="pGradeOther" placeholder="Type the grade"/>
        </div>

        <div>
          <label class="requiredMark">Employment Status</label>
          <select id="pStatus">
            <option value="">Select</option>
            <option>Permanent</option>
            <option>Contract</option>
            <option>Part-time</option>
            <option>Others</option>
          </select>
        </div>
        <div id="pStatusOtherWrap" style="display:none;">
          <label class="requiredMark">Other status (specify)</label>
          <input id="pStatusOther" placeholder="Type the status"/>
        </div>

        <div>
          <label class="requiredMark">Reporting Period</label>
          <select id="pPeriod">
            <option value="">Select</option>
            <option value="Monthly">Monthly</option>
            <option value="Quarterly">Quarterly</option>
            <option value="Semester">Semester</option>
            <option value="Annual">Annual</option>
          </select>
      <div class="hint">All scores are normalized to <b>points per month</b> for fair comparisons.</div>
        </div>
      </div>

      <div class="spacer"></div>
      <div id="msgProfile" class="notice warn" style="display:none;"></div>
    </div>
  </section>

  <!-- TOGGLES -->
  <section class="section toggles tab-panel" id="secToggles" role="tabpanel" aria-labelledby="tabToggles" tabindex="0">
    <header>
      <div>
        <h2>Section Applicability (On/Off)</h2>
        <div class="sub">
          Turn on only relevant sections. The calculator will <b>re-normalize weights</b> using active sections only.
          This supports Academic, Administrative, and Laboratory roles fairly.
        </div>
      </div>
      <div class="row right noPrint">
        <span class="pill">Auto from Category</span>
      </div>
    </header>
    <div class="content">
      <div class="grid three">
        <div><label><input type="checkbox" id="enTeaching" checked> Teaching</label></div>
        <div><label><input type="checkbox" id="enSupervision" checked> Student Supervision</label></div>
        <div><label><input type="checkbox" id="enResearch" checked> Research (Grants/Projects)</label></div>
        <div><label><input type="checkbox" id="enPublication" checked> Publication</label></div>
        <div><label><input type="checkbox" id="enAdministration" checked> Administration</label></div>
        <div><label><input type="checkbox" id="enServices" checked> Service & Engagement</label></div>
        <div><label><input type="checkbox" id="enLabOps"> Laboratory Operations</label></div>
        <div><label><input type="checkbox" id="enProSch" checked> Professional & Scholarly Service (Reviewer/Editor/Examiner/Committee)</label></div>
      </div>
      <div class="spacer"></div>
      <div id="toggleWarn" class="notice warn" style="display:none;"></div>
    </div>
  </section>

  <!-- SETTINGS (ADMIN ONLY) -->
  <section class="section settings tab-panel" id="secSettings" role="tabpanel" aria-labelledby="tabSettings" tabindex="0">
    <header>
      <div>
        <h2>Advanced Settings (Local Configuration)</h2>
        <div class="sub">
          Locked by default. Unlock locally to edit weights, scoring scheme, and benchmarks.
          <span class="small">This is for local configuration only; it does not provide security. Baseline weights must sum to 1.00.</span>
        </div>
      </div>
    </header>
    <div class="content">
      <div id="msgSettings" class="notice warn" style="display:none;"></div>
      <div class="settings-grid">
        <div class="settings-card">
          <h3>Weight Logic / Notes</h3>
          <div class="notice">
            <b>Important:</b> This tool measures <b>busyness (workload)</b>, not performance.
            Scoring emphasizes workload indicators (time, volume, meetings, duration, responsibility) and excludes quality/outcome metrics (e.g., journal quartiles, impact factors).
          </div>
          <div class="spacer"></div>
          <div class="row noPrint">
            <button class="btn adminOnly" id="btnPresetAcademic"><span class="btn-label">Preset: Academic</span></button>
            <button class="btn adminOnly" id="btnPresetAdmin"><span class="btn-label">Preset: Administrative</span></button>
            <button class="btn adminOnly" id="btnPresetLab"><span class="btn-label">Preset: Laboratory</span></button>
          </div>
          <div class="spacer"></div>
          <div class="notice">
            <b>Weight logic:</b> Baseline weights must sum to <b>1.00</b>.
            During calculation, the tool uses only ON sections and re-normalizes weights automatically.
          </div>
          <div class="spacer"></div>
          <div class="notice">
            <b>Passphrase location:</b> At the very top of this <code>index.html</code>, search for <code>ADMIN_PASSWORD</code>.
          </div>
        </div>

        <div class="settings-card">
          <h3>Teaching</h3>
          <div class="grid three">
            <div><label class="requiredMark">Weight: Teaching</label><input class="adminOnly" id="wTeaching" type="number" step="0.01" min="0" value="0.30"/></div>
            <div><label>Teaching – points per contact hour</label><input class="adminOnly" id="tHourW" type="number" step="0.1" min="0" value="1.0"/></div>
            <div><label>Teaching – points per student (scaled /100)</label><input class="adminOnly" id="tStudW" type="number" step="0.1" min="0" value="0.6"/></div>
            <div><label>Teaching – multiplier per credit</label><input class="adminOnly" id="tCreditW" type="number" step="0.1" min="0" value="0.4"/></div>
          </div>
        </div>

        <div class="settings-card">
          <h3>Student Supervision</h3>
          <div class="grid three">
            <div><label class="requiredMark">Weight: Student Supervision</label><input class="adminOnly" id="wSupervision" type="number" step="0.01" min="0" value="0.15"/></div>
            <div><label>Student Supervision – Undergraduate (per student)</label><input class="adminOnly" id="svUG" type="number" step="0.1" min="0" value="1.5"/></div>
            <div><label>Student Supervision – Master (per student)</label><input class="adminOnly" id="svM" type="number" step="0.1" min="0" value="3.0"/></div>
            <div><label>Student Supervision – PhD (per student)</label><input class="adminOnly" id="svPHD" type="number" step="0.1" min="0" value="4.5"/></div>
          </div>
        </div>

        <div class="settings-card">
          <h3>Tutor/Demonstrator Eligibility (Teaching + Supervision)</h3>
          <div class="grid three">
            <div><label><input class="adminOnly" id="eligEnabled" type="checkbox" checked> Enable eligibility assessment</label></div>
            <div><label>Non-admin threshold (points)</label><input class="adminOnly" id="eligNonAdminThresh" type="number" step="0.1" min="0" value="10.0"/></div>
            <div><label>Admin ratio (0–1)</label><input class="adminOnly" id="eligAdminRatio" type="number" step="0.01" min="0" max="1" value="0.50"/></div>
            <div><label>Eligibility metric</label>
              <select class="adminOnly" id="eligMetric">
                <option value="sum">Teaching + Supervision (sum)</option>
              </select>
            </div>
          </div>
          <div class="hint">Admin threshold = Non-admin threshold × Admin ratio. Eligibility uses Teaching + Supervision burden only.</div>
        </div>

        <div class="settings-card">
          <h3>Research</h3>
          <div class="grid three">
            <div><label class="requiredMark">Weight: Research</label><input class="adminOnly" id="wResearch" type="number" step="0.01" min="0" value="0.20"/></div>
            <div><label>Research – base points per grant</label><input class="adminOnly" id="rBase" type="number" step="0.1" min="0" value="6"/></div>
            <div><label>Research – level multipliers (University,National,International)</label><input class="adminOnly" id="rUniNatIntl" type="text" value="1.0,1.4,1.8"/></div>
            <div><label>Research – role multipliers (PI,Co-I,Member)</label><input class="adminOnly" id="rRole" type="text" value="1.6,1.2,1.0"/></div>
          </div>
        </div>

        <div class="settings-card">
          <h3>Publication</h3>
          <div class="grid three">
            <div><label class="requiredMark">Weight: Publication</label><input class="adminOnly" id="wPublication" type="number" step="0.01" min="0" value="0.10"/></div>
            <div><label>Publication – base points per item</label><input class="adminOnly" id="pBase" type="number" step="0.1" min="0" value="4"/></div>
            <div><label>Publication – type multipliers (Journal,Book/Chapter,Proceeding,Other)</label><input class="adminOnly" id="pType" type="text" value="1.5,1.8,1.0,0.8"/></div>
            <div><label>Publication – indexed multipliers (Yes,No)</label><input class="adminOnly" id="pIdx" type="text" value="1.4,1.0"/></div>
          </div>
        </div>

        <div class="settings-card">
          <h3>Administration</h3>
          <div class="grid three">
            <div><label class="requiredMark">Weight: Administration</label><input class="adminOnly" id="wAdministration" type="number" step="0.01" min="0" value="0.15"/></div>
            <div><label>Administration – base points by level (Programme,Faculty,University,State,National,International,Industry)</label><input class="adminOnly" id="aLevel" type="text" value="3,5,7,8,10,12,9"/></div>
            <div><label>Administration – points per meeting</label><input class="adminOnly" id="aMeetW" type="number" step="0.1" min="0" value="1.5"/></div>
            <div><label>Administration – points per month in role</label><input class="adminOnly" id="aMonthW" type="number" step="0.1" min="0" value="0.3"/></div>
          </div>
        </div>

        <div class="settings-card">
          <h3>Service & Engagement</h3>
          <div class="grid three">
            <div><label class="requiredMark">Weight: Service & Engagement</label><input class="adminOnly" id="wServices" type="number" step="0.01" min="0" value="0.10"/></div>
            <div><label>Service & Engagement – points per hour</label><input class="adminOnly" id="sHourW" type="number" step="0.1" min="0" value="1.0"/></div>
            <div><label>Service & Engagement – points per participants (scaled /10)</label><input class="adminOnly" id="sPaxW" type="number" step="0.1" min="0" value="0.8"/></div>
            <div><label>Service & Engagement – role bonus (Lead,Member)</label><input class="adminOnly" id="sRoleBonus" type="text" value="4,1.5"/></div>
          </div>
        </div>

        <div class="settings-card">
          <h3>Laboratory Operations</h3>
          <div class="grid three">
            <div><label class="requiredMark">Weight: Laboratory Operations</label><input class="adminOnly" id="wLabOps" type="number" step="0.01" min="0" value="0.00"/></div>
            <div><label>Laboratory Operations – points per volume</label><input class="adminOnly" id="lVolW" type="number" step="0.1" min="0" value="1.0"/></div>
            <div><label>Laboratory Operations – points per hour</label><input class="adminOnly" id="lHourW" type="number" step="0.1" min="0" value="1.0"/></div>
            <div><label>Laboratory Operations – multipliers (Complexity Low,Medium,High)</label><input class="adminOnly" id="lCx" type="text" value="1.0,1.3,1.6"/></div>
            <div><label>Laboratory Operations – multipliers (Urgency Normal,Tight,Critical)</label><input class="adminOnly" id="lUr" type="text" value="1.0,1.25,1.5"/></div>
          </div>
        </div>

        <div class="settings-card">
          <h3>Professional & Scholarly Service</h3>
          <div class="grid three">
            <div><label class="requiredMark">Weight: Professional & Scholarly Service</label><input class="adminOnly" id="wProSch" type="number" step="0.01" min="0" value="0.00"/></div>
            <div><label>Professional & Scholarly Service – base points per item</label><input class="adminOnly" id="psBase" type="number" step="0.1" min="0" value="3.0"/></div>
            <div><label>Professional & Scholarly Service – role multipliers (Lead,Member)</label><input class="adminOnly" id="psRole" type="text" value="1.3,1.0"/></div>
            <div><label>Professional & Scholarly Service – multipliers (Complexity Low,Medium,High)</label><input class="adminOnly" id="psCx" type="text" value="1.0,1.3,1.6"/></div>
            <div><label>Professional & Scholarly Service – multipliers (Urgency Normal,Tight,Critical)</label><input class="adminOnly" id="psUr" type="text" value="1.0,1.25,1.5"/></div>
          </div>
        </div>

        <div class="settings-card">
          <h3>Benchmarks</h3>
          <div class="notice">
            <b>Institutional Benchmarks (advanced settings input):</b>
            These values are used for interpretation only (e.g., below/around/above faculty average; percentile band).
            They do not change the score calculation.
          </div>
          <div class="spacer"></div>
          <div class="grid three">
            <div><label>Faculty average index (points per month)</label><input class="adminOnly" id="bmAvg" type="number" step="0.1" min="0" value="45.0"/></div>
            <div><label>Percentile cut-off: 25th percentile (P25)</label><input class="adminOnly" id="bmP25" type="number" step="0.1" min="0" value="30.0"/></div>
            <div><label>Percentile cut-off: 50th percentile (P50 / median)</label><input class="adminOnly" id="bmP50" type="number" step="0.1" min="0" value="45.0"/></div>
            <div><label>Percentile cut-off: 75th percentile (P75)</label><input class="adminOnly" id="bmP75" type="number" step="0.1" min="0" value="60.0"/></div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- TEACHING -->
  <section class="section teaching tab-panel" id="secTeaching" role="tabpanel" aria-labelledby="tabTeaching" tabindex="0">
    <header>
      <div>
        <h2>Teaching</h2>
        <div class="sub">Credit is auto-extracted from the <b>last digit</b> of course code (e.g., SJ24102 → credit=2). Contact hours are auto-computed.</div>
      </div>
      <div class="row right noPrint">
        <button class="btn" id="addTeach"><span class="btn-label">Add course</span></button>
        <button class="btn btn-ghost" id="clearTeach"><span class="btn-label">Clear</span></button>
      </div>
    </header>
    <div class="content">
      <div class="tableWrap">
        <table id="tblTeach">
          <thead>
            <tr>
              <th style="width:14%">Course Code *</th>
              <th>Course Title *</th>
              <th style="width:8%">Credit</th>
              <th style="width:10%">Students *</th>
              <th style="width:10%">Lecture *</th>
              <th style="width:10%">Tutorial *</th>
              <th style="width:10%">Lab *</th>
              <th style="width:10%">Field *</th>
              <th style="width:10%">Contact Hours</th>
              <th style="width:6%">Action</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- SUPERVISION -->
  <section class="section supervision tab-panel" id="secSupervision" role="tabpanel" aria-labelledby="tabSupervision" tabindex="0">
    <header>
      <div>
        <h2>Student Supervision</h2>
        <div class="sub">Include active supervision load for the reporting period (Undergraduate, Master, PhD).</div>
      </div>
      <div class="row right noPrint">
        <button class="btn" id="addSv"><span class="btn-label">Add supervision</span></button>
        <button class="btn btn-ghost" id="clearSv"><span class="btn-label">Clear</span></button>
      </div>
    </header>
    <div class="content">
      <div class="tableWrap">
        <table id="tblSv">
          <thead>
            <tr>
              <th style="width:18%">Level *</th>
              <th>Student / Project *</th>
              <th style="width:14%">Role *</th>
              <th style="width:12%">Status *</th>
              <th style="width:12%">Start *</th>
              <th style="width:12%">End *</th>
              <th style="width:8%">Action</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- RESEARCH -->
  <section class="section research tab-panel" id="secResearch" role="tabpanel" aria-labelledby="tabResearch" tabindex="0">
    <header>
      <div>
        <h2>Research (Grants / Projects)</h2>
        <div class="sub">Specify grant level, status, role, amount and duration.</div>
      </div>
      <div class="row right noPrint">
        <button class="btn" id="addRes"><span class="btn-label">Add grant</span></button>
        <button class="btn btn-ghost" id="clearRes"><span class="btn-label">Clear</span></button>
      </div>
    </header>
    <div class="content">
      <div class="tableWrap">
        <table id="tblRes">
          <thead>
            <tr>
              <th style="width:14%">Grant Code *</th>
              <th>Title *</th>
              <th style="width:14%">Level *</th>
              <th style="width:12%">Status *</th>
              <th style="width:12%">Role *</th>
              <th style="width:12%">Amount (RM) *</th>
              <th style="width:10%">Start *</th>
              <th style="width:10%">End *</th>
              <th style="width:6%">Action</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- PUBLICATION -->
  <section class="section publication tab-panel" id="secPublication" role="tabpanel" aria-labelledby="tabPublication" tabindex="0">
    <header>
      <div>
        <h2>Publication</h2>
        <div class="sub">If ON, record publication output for the reporting period. This captures workload (count/handling), not quality metrics.</div>
      </div>
      <div class="row right noPrint">
        <button class="btn" id="addPub"><span class="btn-label">Add publication</span></button>
        <button class="btn btn-ghost" id="clearPub"><span class="btn-label">Clear</span></button>
      </div>
    </header>
    <div class="content">
      <div class="tableWrap">
        <table id="tblPub">
          <thead>
            <tr>
              <th style="width:10%">Year *</th>
              <th>Title *</th>
              <th style="width:16%">Type *</th>
              <th style="width:14%">Indexed? *</th>
              <th style="width:14%">Role *</th>
              <th style="width:12%">Start *</th>
              <th style="width:12%">End *</th>
              <th style="width:6%">Action</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- ADMINISTRATION -->
  <section class="section admin tab-panel" id="secAdmin" role="tabpanel" aria-labelledby="tabAdministration" tabindex="0">
    <header>
      <div>
        <h2>Administration</h2>
        <div class="sub">Include appointments, level, duration (months) and meeting workload. Notes should describe workload clearly.</div>
      </div>
      <div class="row right noPrint">
        <button class="btn" id="addAdmin"><span class="btn-label">Add admin role</span></button>
        <button class="btn btn-ghost" id="clearAdmin"><span class="btn-label">Clear</span></button>
      </div>
    </header>
    <div class="content">
      <div class="tableWrap">
        <table id="tblAdmin">
          <thead>
            <tr>
              <th style="width:18%">Position *</th>
              <th style="width:14%">Type *</th>
              <th style="width:18%">Level *</th>
              <th style="width:10%">Months *</th>
              <th style="width:10%">Meetings *</th>
              <th>Workload Notes *</th>
              <th style="width:10%">Start *</th>
              <th style="width:10%">End *</th>
              <th style="width:6%">Action</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="spacer"></div>
      <div class="notice">Tip: Record conference committee work under <b>Professional & Scholarly Service</b> (recommended) or Administration if it is an official appointment. Describe workload clearly in Notes.</div>
    </div>
  </section>

  <!-- SERVICES -->
  <section class="section service tab-panel" id="secService" role="tabpanel" aria-labelledby="tabService" tabindex="0">
    <header>
      <div>
        <h2>Service & Engagement</h2>
        <div class="sub">Service to university, industry, or community. Include start and end dates.</div>
      </div>
      <div class="row right noPrint">
        <button class="btn" id="addSvc"><span class="btn-label">Add service</span></button>
        <button class="btn btn-ghost" id="clearSvc"><span class="btn-label">Clear</span></button>
      </div>
    </header>
    <div class="content">
      <div class="tableWrap">
        <table id="tblSvc">
          <thead>
            <tr>
              <th style="width:18%">Service Type *</th>
              <th>Activity *</th>
              <th style="width:12%">Role *</th>
              <th style="width:10%">Hours (optional)</th>
              <th style="width:10%">Participants *</th>
              <th style="width:12%">Start *</th>
              <th style="width:12%">End *</th>
              <th style="width:6%">Action</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- LAB OPERATIONS -->
  <section class="section labops tab-panel" id="secLabOps" role="tabpanel" aria-labelledby="tabLabOps" tabindex="0">
    <header>
      <div>
        <h2>Laboratory Operations</h2>
        <div class="sub">For lab staff or lab-support work. Scored using (volume + hours) × complexity × urgency.</div>
      </div>
      <div class="row right noPrint">
        <button class="btn" id="addLab"><span class="btn-label">Add lab activity</span></button>
        <button class="btn btn-ghost" id="clearLab"><span class="btn-label">Clear</span></button>
      </div>
    </header>
    <div class="content">
      <div class="tableWrap">
        <table id="tblLab">
          <thead>
            <tr>
              <th style="width:18%">Type *</th>
              <th>Description *</th>
              <th style="width:10%">Volume *</th>
              <th style="width:12%">Complexity *</th>
              <th style="width:12%">Urgency *</th>
              <th style="width:10%">Hours *</th>
              <th style="width:12%">Start *</th>
              <th style="width:12%">End *</th>
              <th style="width:6%">Action</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- PROFESSIONAL & SCHOLARLY SERVICE -->
  <section class="section prosch tab-panel" id="secProSch" role="tabpanel" aria-labelledby="tabProSch" tabindex="0">
    <header>
      <div>
        <h2>Professional & Scholarly Service</h2>
        <div class="sub">
          This section captures <b>workload</b> such as journal reviewing, editorial handling, external examining, and conference committee work.
          It does not capture quality metrics (e.g., journal ranking). Use volume, rounds, complexity, urgency and time indicators.
        </div>
      </div>
      <div class="row right noPrint">
        <button class="btn" id="addProSch"><span class="btn-label">Add item</span></button>
        <button class="btn btn-ghost" id="clearProSch"><span class="btn-label">Clear</span></button>
      </div>
    </header>
    <div class="content">
      <div class="tableWrap">
        <table id="tblProSch">
          <thead>
            <tr>
              <th style="width:18%">Activity Type *</th>
              <th>Description *</th>
              <th style="width:12%">Role *</th>
              <th style="width:10%">Quantity *</th>
              <th style="width:10%">Rounds *</th>
              <th style="width:12%">Complexity *</th>
              <th style="width:12%">Urgency *</th>
              <th style="width:10%">Hours *</th>
              <th style="width:10%">Start *</th>
              <th style="width:10%">End *</th>
              <th style="width:6%">Action</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="spacer"></div>
      <div class="notice">
        Example: Reviewer (Quantity=3 manuscripts, Rounds=2, Complexity=High, Urgency=Tight, Hours=10).
        Conference committee can be recorded as “Conference Committee / Secretariat / Chair”.
      </div>
    </div>
  </section>

  <!-- RESULTS -->
  <section class="section results tab-panel" id="secResults" role="tabpanel" aria-labelledby="tabResults" tabindex="0">
    <header>
      <div>
        <h2>Results</h2>
        <div class="sub">
          Calculate a monthly-normalized busyness index, review contributions, export data, and print a professional black-and-white form (settings hidden in print).
        </div>
      </div>
    </header>
    <div class="content">
      <div id="msgGlobal" class="notice warn" style="display:none;"></div>

      <!-- KPIs -->
      <div class="kpi">
        <div class="box"><div class="k">Teaching</div><div class="v" id="outTeaching">0.0</div><div class="s">Monthly-normalized workload points</div></div>
        <div class="box"><div class="k">Student Supervision</div><div class="v" id="outSupervision">0.0</div><div class="s">Monthly-normalized workload points</div></div>
        <div class="box"><div class="k">Research (Grants / Projects)</div><div class="v" id="outResearch">0.0</div><div class="s">Monthly-normalized workload points</div></div>
        <div class="box"><div class="k">Publication</div><div class="v" id="outPublication">0.0</div><div class="s">Monthly-normalized workload points</div></div>

        <div class="box"><div class="k">Administration</div><div class="v" id="outAdministration">0.0</div><div class="s">Monthly-normalized workload points</div></div>
        <div class="box"><div class="k">Service & Engagement</div><div class="v" id="outServices">0.0</div><div class="s">Monthly-normalized workload points</div></div>
        <div class="box"><div class="k">Laboratory Operations</div><div class="v" id="outLabOps">0.0</div><div class="s">Monthly-normalized workload points</div></div>
        <div class="box"><div class="k">Professional & Scholarly Service</div><div class="v" id="outProSch">0.0</div><div class="s">Monthly-normalized workload points</div></div>

        <div class="box">
          <div class="k">Overall Busyness Index (Points per month)</div>
          <div class="v" id="outIndex">0.0</div>
          <div class="s" id="outBand">—</div>
        </div>

        <div class="box">
          <div class="k">Benchmark Interpretation (Advanced Settings)</div>
          <div class="s wrapText" id="outBenchmark">—</div>
        </div>
      </div>

      <div class="spacer"></div>

      <div class="grid two">
        <div class="box">
          <div class="k">Dean View Summary (read-only)</div>
          <div class="hint wrapText" id="outDean">—</div>
        </div>
        <div class="box">
          <div class="k">Narrative Summary (workload drivers)</div>
          <div class="hint wrapText" id="outNarr">—</div>
        </div>
      </div>

      <div class="spacer"></div>

      <div class="box">
        <div class="k">Top 3 contributors</div>
        <ol class="hint wrapText" id="outTop3">
          <li>—</li>
        </ol>
      </div>

      <div class="spacer"></div>

      <div class="box" id="eligibilityCard">
        <div class="k">Tutor/Demonstrator Eligibility (Teaching + Supervision)</div>
        <div class="spacer"></div>
        <div id="eligibilityDisabled" class="notice warn" style="display:none;">Eligibility assessment is disabled in settings.</div>
        <div id="eligibilityDetails">
          <div class="grid two">
            <div>
              <div class="k">Staff category</div>
              <div class="v" id="eligStaffCategory">—</div>
            </div>
            <div>
              <div class="k">Threshold used</div>
              <div class="v" id="eligThreshold">—</div>
            </div>
            <div>
              <div class="k">Teaching burden</div>
              <div class="v" id="eligTeaching">—</div>
            </div>
            <div>
              <div class="k">Supervision burden</div>
              <div class="v" id="eligSupervision">—</div>
            </div>
            <div>
              <div class="k">Eligibility score (ES)</div>
              <div class="v" id="eligScore">—</div>
            </div>
            <div>
              <div class="k">Delta</div>
              <div class="v" id="eligDelta">—</div>
            </div>
          </div>
          <div class="spacer"></div>
          <div class="notice" id="eligStatus">—</div>
          <div class="spacer"></div>
          <div class="notice">Eligibility is assessed using Teaching + Supervision burden only (separate from overall index).</div>
        </div>
      </div>

      <!-- PRINT-ONLY SIGNATURES -->
      <div class="printOnly" style="margin-top:16px">
        <hr style="border:0;border-top:1px solid #000;margin:12px 0">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px">
          <div>
            <div style="font-weight:800;margin-bottom:8px">Staff Declaration</div>
            <div>Full name: <span id="printName"></span></div>
            <div>Staff ID: <span id="printId"></span></div>
            <div>Date printed: <span id="printDate"></span></div>
            <div>Tutor/Demonstrator eligibility: <span id="printEligibility"></span></div>
            <div style="height:110px;border:1px solid #000;margin-top:10px;padding:10px">Staff Signature:</div>
          </div>
          <div>
            <div style="font-weight:800;margin-bottom:8px">Dean Approval</div>
            <div>Faculty: Faculty of Science and Technology</div>
            <div>Dean: Prof. P.Geol. Ts. Dr. Rodeano Roslee</div>
            <div>Date: _______________________</div>
            <div style="height:110px;border:1px solid #000;margin-top:10px;padding:10px">Dean Signature:</div>
          </div>
        </div>
        <div style="margin-top:12px;font-size:11px;color:#000">
          <div><strong>Note:</strong> This busyness index reflects workload intensity only and is not a performance evaluation.</div>
          <div>Use alongside qualitative review and departmental context.</div>
          <div style="margin-top:6px">Printed on: <span id="printFooterDate"></span></div>
        </div>
        <div style="margin-top:10px;font-size:11px;color:#000">© FST UMS</div>
      </div>

      <div class="spacer"></div>

      <div class="box">
        <canvas id="chart" height="120"></canvas>
      </div>

    </div>
  </section>

    </main>
  </div>

  <div class="footer">© FST UMS</div>
</div>

<div id="actionBar" class="action-bar noPrint">
  <div class="action-inner">
    <button class="btn btn-primary btn-md" id="btnCalc"><span class="btn-label">Calculate</span></button>
    <button class="btn btn-secondary" id="btnPrint"><span class="btn-label">Print PDF</span></button>
    <div class="dropdown">
      <button class="btn btn-secondary" id="btnExportToggle" aria-haspopup="true" aria-expanded="false" aria-controls="exportMenu">
        <span class="btn-label">Export</span>
        <svg viewBox="0 0 20 20" aria-hidden="true"><path d="M5 7l5 6 5-6H5z"/></svg>
      </button>
      <div class="dropdown-menu" id="exportMenu" role="menu">
        <button class="btn btn-ghost" id="btnExportSummaryCSV" role="menuitem">Summary CSV</button>
        <button class="btn btn-ghost" id="btnExportDetailedCSV" role="menuitem">Detailed CSV</button>
        <button class="btn btn-ghost" id="btnExportJSON" role="menuitem">Full JSON</button>
      </div>
    </div>
  </div>
</div>

<div id="modalOverlay" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="modalTitle" aria-hidden="true">
  <div class="modal">
    <div class="modal-header">
      <h3 id="modalTitle">Modal</h3>
      <button class="icon-btn" id="modalClose" type="button" aria-label="Close modal">
        <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M18.3 5.71 12 12l6.3 6.29-1.41 1.42L10.59 13.4 4.29 19.71 2.88 18.3 9.17 12 2.88 5.71 4.29 4.3l6.3 6.3 6.29-6.3Z"/></svg>
      </button>
    </div>
    <div class="modal-body" id="modalBody"></div>
    <div class="modal-actions">
      <button class="btn btn-ghost" id="modalCancel" type="button">Cancel</button>
      <button class="btn btn-primary" id="modalSave" type="button">Save</button>
    </div>
  </div>
</div>

<script>
/* =========================================================
   Helpers
========================================================= */
const $ = (id)=>document.getElementById(id);
const clamp = (x,a,b)=>Math.max(a,Math.min(b,x));
const n = (v)=>{ const x=parseFloat(v); return isNaN(x)?0:x; };
const uid = ()=>Math.random().toString(16).slice(2)+Date.now().toString(16);
const escapeHTML = (value)=>String(value ?? "").replace(/[&<>"']/g, (ch)=>({
  "&":"&amp;",
  "<":"&lt;",
  ">":"&gt;",
  "\"":"&quot;",
  "'":"&#39;"
}[ch]));
const formatInt = (value)=>String(Math.max(0, Math.floor(n(value))));
const formatHours = (value)=>n(value).toFixed(1);
const cellTextHTML = (value)=>`<div class="cellText">${escapeHTML(value ?? "")}</div>`;
const autoGrowTextarea = (el)=>{
  if(!el) return;
  el.style.height = "auto";
  el.style.height = `${el.scrollHeight}px`;
};

function showMsg(kind, html){
  const el = $("msgGlobal");
  el.className = "notice " + (kind==="bad"?"bad":kind==="ok"?"ok":"warn");
  el.innerHTML = html;
  el.style.display = "block";
}
function hideMsg(){ $("msgGlobal").style.display="none"; }
function confirmDelete(message="Delete this record? This action cannot be undone."){
  return window.confirm(message);
}

/* =========================================================
   Tabs
========================================================= */
const tabConfig = [
  {tab:"tabProfile", panel:"secProfile"},
  {tab:"tabToggles", panel:"secToggles"},
  {tab:"tabSettings", panel:"secSettings"},
  {tab:"tabTeaching", panel:"secTeaching"},
  {tab:"tabSupervision", panel:"secSupervision"},
  {tab:"tabResearch", panel:"secResearch"},
  {tab:"tabPublication", panel:"secPublication"},
  {tab:"tabAdministration", panel:"secAdmin"},
  {tab:"tabService", panel:"secService"},
  {tab:"tabLabOps", panel:"secLabOps"},
  {tab:"tabProSch", panel:"secProSch"},
  {tab:"tabResults", panel:"secResults"}
];

function setTabVisibility(tabId, visible){
  const btn = $(tabId);
  if(!btn) return;
  btn.hidden = !visible;
  btn.setAttribute("aria-hidden", String(!visible));
}

function getVisibleTabs(){
  return tabConfig.map(cfg=>$(cfg.tab)).filter(btn=>btn && !btn.hidden);
}

function activateTab(tabId, persist=true){
  const btn = $(tabId);
  if(!btn || btn.hidden) return;
  tabConfig.forEach(cfg=>{
    const tabBtn = $(cfg.tab);
    const panel = $(cfg.panel);
    const isActive = cfg.tab === tabId;
    if(tabBtn){
      tabBtn.setAttribute("aria-selected", String(isActive));
      tabBtn.tabIndex = isActive ? 0 : -1;
    }
    if(panel){
      const isEnabled = panel.dataset.enabled !== "false";
      const showPanel = isActive && isEnabled;
      panel.classList.toggle("is-hidden", !showPanel);
      panel.hidden = !showPanel;
    }
  });
  if(persist) localStorage.setItem("activeTabId", tabId);
}

function ensureActiveTab(){
  const active = document.querySelector('[role="tab"][aria-selected="true"]');
  if(active && !active.hidden){
    activateTab(active.id, false);
    return;
  }
  const visibleTabs = getVisibleTabs();
  if(visibleTabs.length) activateTab(visibleTabs[0].id, true);
}

function setupTabs(){
  tabConfig.forEach(cfg=>{
    const btn = $(cfg.tab);
    if(!btn) return;
    btn.addEventListener("click", ()=>activateTab(cfg.tab, true));
    btn.addEventListener("keydown", (e)=>{
      const keys = ["ArrowUp","ArrowDown","ArrowLeft","ArrowRight","Home","End"];
      if(!keys.includes(e.key)) return;
      e.preventDefault();
      const visible = getVisibleTabs();
      const currentIndex = visible.indexOf(btn);
      if(currentIndex === -1) return;
      let nextIndex = currentIndex;
      if(e.key === "Home") nextIndex = 0;
      else if(e.key === "End") nextIndex = visible.length - 1;
      else if(e.key === "ArrowUp" || e.key === "ArrowLeft"){
        nextIndex = (currentIndex - 1 + visible.length) % visible.length;
      }else if(e.key === "ArrowDown" || e.key === "ArrowRight"){
        nextIndex = (currentIndex + 1) % visible.length;
      }
      const nextBtn = visible[nextIndex];
      nextBtn.focus();
      activateTab(nextBtn.id, true);
    });
  });
  const stored = localStorage.getItem("activeTabId");
  if(stored && $(stored) && !$(stored).hidden){
    activateTab(stored, false);
  }else{
    const visibleTabs = getVisibleTabs();
    if(visibleTabs.length) activateTab(visibleTabs[0].id, false);
  }
}

/* =========================================================
   Modal
========================================================= */
let modalSaveHandler = null;

function modalInit(){
  const overlay = $("modalOverlay");
  const closeBtns = [$("modalClose"), $("modalCancel")];
  closeBtns.forEach(btn=>{
    btn.addEventListener("click", (e)=>{
      e.preventDefault();
      closeModal();
    });
  });
  $("modalSave").addEventListener("click", (e)=>{
    e.preventDefault();
    if(modalSaveHandler) modalSaveHandler();
  });
  overlay.addEventListener("click", (e)=>{
    if(e.target === overlay) closeModal();
  });
  document.addEventListener("keydown", (e)=>{
    if(e.key === "Escape" && overlay.classList.contains("open")) closeModal();
  });
}

function openModal({title, bodyHTML, saveLabel="Save", onSave}){
  $("modalTitle").textContent = title || "Modal";
  $("modalBody").innerHTML = bodyHTML || "";
  $("modalSave").textContent = saveLabel || "Save";
  modalSaveHandler = onSave || null;
  $("modalBody").querySelectorAll("textarea").forEach(area=>{
    autoGrowTextarea(area);
    area.addEventListener("input", ()=>autoGrowTextarea(area));
  });
  const firstField = $("modalBody").querySelector("input, select, textarea");
  if(firstField) firstField.focus();
  $("modalOverlay").classList.add("open");
  $("modalOverlay").setAttribute("aria-hidden", "false");
  document.body.classList.add("modal-open");
}

function closeModal(){
  $("modalOverlay").classList.remove("open");
  $("modalOverlay").setAttribute("aria-hidden", "true");
  $("modalBody").innerHTML = "";
  modalSaveHandler = null;
  document.body.classList.remove("modal-open");
}

const modalConfig = {
  teach:{
    title:"Add Teaching Course",
    editTitle:"Edit Teaching Course",
    saveLabel:"Add course",
    fields:[
      {name:"code", label:"Course Code", type:"text", required:true, placeholder:"e.g., SJ24102"},
      {name:"name", label:"Course Title", type:"text", required:true, placeholder:"Course title"},
      {name:"students", label:"Students", type:"number", required:true, min:0, step:1},
      {name:"lecture", label:"Lecture", type:"number", required:true, min:0, step:0.5},
      {name:"tutorial", label:"Tutorial", type:"number", required:true, min:0, step:0.5},
      {name:"laboratory", label:"Lab", type:"number", required:true, min:0, step:0.5},
      {name:"field", label:"Field", type:"number", required:true, min:0, step:0.5}
    ]
  },
  sv:{
    title:"Add Student Supervision",
    editTitle:"Edit Student Supervision",
    saveLabel:"Add supervision",
    fields:[
      {name:"level", label:"Level", type:"select", required:true, options:["Undergraduate","Master","PhD"], value:"Undergraduate"},
      {name:"title", label:"Student / Project", type:"text", required:true, placeholder:"Student name or project"},
      {name:"role", label:"Role", type:"select", required:true, options:["Main","Co-supervisor"], value:"Main"},
      {name:"status", label:"Status", type:"select", required:true, options:["Active","Completed"], value:"Active"},
      {name:"start", label:"Start Date", type:"date", required:true},
      {name:"end", label:"End Date", type:"date", required:true}
    ]
  },
  res:{
    title:"Add Research Grant / Project",
    editTitle:"Edit Research Grant / Project",
    saveLabel:"Add grant",
    fields:[
      {name:"code", label:"Grant Code", type:"text", required:true, placeholder:"Grant code"},
      {name:"title", label:"Title", type:"text", required:true, placeholder:"Grant title"},
      {name:"level", label:"Level", type:"select", required:true, options:["University","National","International"], value:"University"},
      {name:"status", label:"Status", type:"select", required:true, options:["Active","Applied","Ended"], value:"Active"},
      {name:"role", label:"Role", type:"select", required:true, options:["PI","Co-I","Member"], value:"PI"},
      {name:"amount", label:"Amount (RM)", type:"number", required:true, min:0, step:1},
      {name:"start", label:"Start Date", type:"date", required:true},
      {name:"end", label:"End Date", type:"date", required:true}
    ]
  },
  pub:{
    title:"Add Publication",
    editTitle:"Edit Publication",
    saveLabel:"Add publication",
    fields:[
      {name:"year", label:"Year", type:"number", required:true, min:1990, step:1, value:(new Date()).getFullYear()},
      {name:"title", label:"Title", type:"text", required:true, placeholder:"Publication title"},
      {name:"type", label:"Type", type:"select", required:true, options:["Journal","Book/Chapter","Proceeding","Other"], value:"Journal"},
      {name:"indexed", label:"Indexed?", type:"select", required:true, options:["Yes","No"], value:"Yes"},
      {name:"role", label:"Role", type:"select", required:true, options:["First/Corresponding","Co-author"], value:"First/Corresponding"},
      {name:"start", label:"Start Date", type:"date", required:true},
      {name:"end", label:"End Date", type:"date", required:true}
    ]
  },
  admin:{
    title:"Add Administration Role",
    editTitle:"Edit Administration Role",
    saveLabel:"Add admin role",
    fields:[
      {name:"position", label:"Position", type:"text", required:true, placeholder:"Position or appointment"},
      {name:"type", label:"Type", type:"select", required:true, options:["Official","Ad-hoc"], value:"Official"},
      {name:"level", label:"Level", type:"select", required:true, options:["Programme","Faculty","University","State","National","International","Industry"], value:"Faculty"},
      {name:"months", label:"Months", type:"number", required:true, min:0, step:1},
      {name:"meetings", label:"Meetings", type:"number", required:true, min:0, step:1},
      {name:"notes", label:"Workload Notes", type:"textarea", required:true, placeholder:"Key workload notes"},
      {name:"start", label:"Start Date", type:"date", required:true},
      {name:"end", label:"End Date", type:"date", required:true}
    ]
  },
  svc:{
    title:"Add Service & Engagement",
    editTitle:"Edit Service & Engagement",
    saveLabel:"Add service",
    fields:[
      {name:"type", label:"Service Type", type:"select", required:true, options:["Service to University","Service to Industry","Service to Community","Other"], value:"Service to University"},
      {name:"activity", label:"Activity", type:"textarea", required:true, placeholder:"Describe the activity"},
      {name:"role", label:"Role", type:"select", required:true, options:["Lead","Member"], value:"Lead"},
      {name:"hours", label:"Hours (optional)", type:"number", required:false, min:0, step:0.5},
      {name:"participants", label:"Participants (optional)", type:"number", required:false, min:0, step:1},
      {name:"start", label:"Start Date", type:"date", required:true},
      {name:"end", label:"End Date", type:"date", required:true}
    ]
  },
  lab:{
    title:"Add Laboratory Operation",
    editTitle:"Edit Laboratory Operation",
    saveLabel:"Add lab activity",
    fields:[
      {name:"type", label:"Type", type:"select", required:true, options:["Lab Sessions Support","Equipment/Maintenance","Safety/Compliance","Consumables/Procurement","Field/Site Work","Other"], value:"Equipment/Maintenance"},
      {name:"desc", label:"Description", type:"textarea", required:true, placeholder:"Describe briefly"},
      {name:"volume", label:"Volume", type:"number", required:true, min:0, step:1},
      {name:"complexity", label:"Complexity", type:"select", required:true, options:["Low","Medium","High"], value:"Medium"},
      {name:"urgency", label:"Urgency", type:"select", required:true, options:["Normal","Tight","Critical"], value:"Normal"},
      {name:"hours", label:"Hours (optional)", type:"number", required:false, min:0, step:0.5},
      {name:"start", label:"Start Date", type:"date", required:true},
      {name:"end", label:"End Date", type:"date", required:true}
    ]
  },
  ps:{
    title:"Add Professional & Scholarly Service",
    editTitle:"Edit Professional & Scholarly Service",
    saveLabel:"Add item",
    fields:[
      {name:"activityType", label:"Activity Type", type:"select", required:true, options:["Reviewer","Editor","External Examiner","Internal Examiner","Conference Committee","Journal Editorial Board","Grant Panel / Assessor","Other"], value:"Reviewer"},
      {name:"desc", label:"Description", type:"textarea", required:true, placeholder:"Describe task (journal/conference/thesis scope, key notes)"},
      {name:"role", label:"Role", type:"select", required:true, options:["Lead","Member"], value:"Member"},
      {name:"quantity", label:"Quantity", type:"number", required:true, min:0, step:1, value:1},
      {name:"rounds", label:"Rounds", type:"number", required:true, min:1, step:1, value:1},
      {name:"complexity", label:"Complexity", type:"select", required:true, options:["Low","Medium","High"], value:"Medium"},
      {name:"urgency", label:"Urgency", type:"select", required:true, options:["Normal","Tight","Critical"], value:"Normal"},
      {name:"hours", label:"Hours (optional)", type:"number", required:false, min:0, step:0.5},
      {name:"start", label:"Start Date", type:"date", required:true},
      {name:"end", label:"End Date", type:"date", required:true}
    ]
  }
};

function buildModalBody(fields, initialValues = {}){
  const renderField = (field)=>{
    const labelClass = field.required ? "requiredMark" : "";
    const placeholder = field.placeholder ? ` placeholder="${field.placeholder}"` : "";
    const min = field.min !== undefined ? ` min="${field.min}"` : "";
    const step = field.step !== undefined ? ` step="${field.step}"` : "";
    const hasInitial = Object.prototype.hasOwnProperty.call(initialValues, field.name);
    const rawValue = hasInitial ? initialValues[field.name] : field.value;
    const value = rawValue === null || rawValue === undefined ? "" : rawValue;
    const valueAttr = value === "" ? "" : ` value="${escapeHTML(value)}"`;
    if(field.type === "select"){
      const opts = field.options.map(opt=>{
        const selected = value === opt ? " selected" : "";
        return `<option value="${escapeHTML(opt)}"${selected}>${opt}</option>`;
      }).join("");
      return `
        <div>
          <label class="${labelClass}">${field.label}</label>
          <select data-field="${field.name}">${opts}</select>
        </div>`;
    }
    if(field.type === "textarea"){
      const textValue = escapeHTML(value);
      return `
        <div>
          <label class="${labelClass}">${field.label}</label>
          <textarea data-field="${field.name}" rows="2"${placeholder}>${textValue}</textarea>
        </div>`;
    }
    return `
      <div>
        <label class="${labelClass}">${field.label}</label>
        <input data-field="${field.name}" type="${field.type}"${placeholder}${min}${step}${valueAttr}/>
      </div>`;
  };

  return `
    <div class="grid modal-grid">
      ${fields.map(renderField).join("")}
    </div>`;
}

function readModalValues(fields){
  const body = $("modalBody");
  let ok = true;
  const values = {};
  fields.forEach(field=>{
    const el = body.querySelector(`[data-field="${field.name}"]`);
    if(!el) return;
    el.classList.remove("err");
    if(field.type === "number"){
      const raw = el.value;
      if(field.required && raw === ""){
        ok = false;
        el.classList.add("err");
        return;
      }
      values[field.name] = raw === "" ? null : n(raw);
    }else{
      const raw = el.value || "";
      if(field.required && !raw.trim()){
        ok = false;
        el.classList.add("err");
      }
      values[field.name] = raw;
    }
  });
  return {ok, values};
}

function openAddModal(kind){
  const cfg = modalConfig[kind];
  if(!cfg) return;
  const bodyHTML = buildModalBody(cfg.fields);
  openModal({
    title: cfg.title,
    bodyHTML,
    saveLabel: cfg.saveLabel,
    onSave: ()=>{
      const {ok, values} = readModalValues(cfg.fields);
      if(!ok) return;
      if(kind==="teach"){
        const code = (values.code || "").toUpperCase();
        state.data.teaching.push({
          id:uid(),
          code,
          name:values.name || "",
          credit:creditFromCode(code),
          students:Math.max(0, n(values.students)),
          lecture:Math.max(0, n(values.lecture)),
          tutorial:Math.max(0, n(values.tutorial)),
          laboratory:Math.max(0, n(values.laboratory)),
          field:Math.max(0, n(values.field))
        });
      }
      if(kind==="sv"){
        state.data.supervision.push({
          id:uid(),
          level:values.level || "Undergraduate",
          title:values.title || "",
          role:values.role || "Main",
          status:values.status || "Active",
          start:values.start || "",
          end:values.end || ""
        });
      }
      if(kind==="res"){
        state.data.research.push({
          id:uid(),
          code:values.code || "",
          title:values.title || "",
          level:values.level || "University",
          status:values.status || "Active",
          role:values.role || "PI",
          amount:Math.max(0, n(values.amount)),
          start:values.start || "",
          end:values.end || ""
        });
      }
      if(kind==="pub"){
        state.data.publication.push({
          id:uid(),
          year:Math.max(1990, Math.floor(n(values.year) || (new Date()).getFullYear())),
          title:values.title || "",
          type:values.type || "Journal",
          indexed:values.indexed || "Yes",
          role:values.role || "First/Corresponding",
          start:values.start || "",
          end:values.end || ""
        });
      }
      if(kind==="admin"){
        state.data.admin.push({
          id:uid(),
          position:values.position || "",
          type:values.type || "Official",
          level:values.level || "Faculty",
          months:Math.max(0, Math.floor(n(values.months))),
          meetings:Math.max(0, Math.floor(n(values.meetings))),
          notes:values.notes || "",
          start:values.start || "",
          end:values.end || ""
        });
      }
      if(kind==="svc"){
        state.data.service.push({
          id:uid(),
          type:values.type || "Service to University",
          activity:values.activity || "",
          role:values.role || "Lead",
          hours:values.hours === null ? 0 : Math.max(0, n(values.hours)),
          participants:values.participants === null ? 0 : Math.max(0, Math.floor(n(values.participants))),
          start:values.start || "",
          end:values.end || ""
        });
      }
      if(kind==="lab"){
        state.data.lab.push({
          id:uid(),
          type:values.type || "Equipment/Maintenance",
          desc:values.desc || "",
          volume:Math.max(0, Math.floor(n(values.volume))),
          complexity:values.complexity || "Medium",
          urgency:values.urgency || "Normal",
          hours:values.hours === null ? 0 : Math.max(0, n(values.hours)),
          start:values.start || "",
          end:values.end || ""
        });
      }
      if(kind==="ps"){
        state.data.prosch.push({
          id:uid(),
          activityType:values.activityType || "Reviewer",
          desc:values.desc || "",
          role:values.role || "Member",
          quantity:Math.max(0, Math.floor(n(values.quantity))),
          rounds:Math.max(1, Math.floor(n(values.rounds) || 1)),
          complexity:values.complexity || "Medium",
          urgency:values.urgency || "Normal",
          hours:values.hours === null ? 0 : Math.max(0, n(values.hours)),
          start:values.start || "",
          end:values.end || ""
        });
      }

      renderAll();
      autosave();
      closeModal();
    }
  });
}

function openEditModal(kind, recordId){
  const cfg = modalConfig[kind];
  if(!cfg) return;
  const dataMap = {
    teach: state.data.teaching,
    sv: state.data.supervision,
    res: state.data.research,
    pub: state.data.publication,
    admin: state.data.admin,
    svc: state.data.service,
    lab: state.data.lab,
    ps: state.data.prosch
  };
  const list = dataMap[kind];
  if(!list) return;
  const record = list.find(item=>item.id===recordId);
  if(!record) return;
  const bodyHTML = buildModalBody(cfg.fields, record);
  openModal({
    title: cfg.editTitle || cfg.title.replace(/^Add /, "Edit "),
    bodyHTML,
    saveLabel: "Save changes",
    onSave: ()=>{
      const {ok, values} = readModalValues(cfg.fields);
      if(!ok) return;
      if(kind==="teach"){
        record.code = (values.code || "").toUpperCase();
        record.name = values.name || "";
        record.credit = creditFromCode(record.code);
        record.students = Math.max(0, n(values.students));
        record.lecture = Math.max(0, n(values.lecture));
        record.tutorial = Math.max(0, n(values.tutorial));
        record.laboratory = Math.max(0, n(values.laboratory));
        record.field = Math.max(0, n(values.field));
      }
      if(kind==="sv"){
        record.level = values.level || "Undergraduate";
        record.title = values.title || "";
        record.role = values.role || "Main";
        record.status = values.status || "Active";
        record.start = values.start || "";
        record.end = values.end || "";
      }
      if(kind==="res"){
        record.code = values.code || "";
        record.title = values.title || "";
        record.level = values.level || "University";
        record.status = values.status || "Active";
        record.role = values.role || "PI";
        record.amount = Math.max(0, n(values.amount));
        record.start = values.start || "";
        record.end = values.end || "";
      }
      if(kind==="pub"){
        record.year = Math.max(1990, Math.floor(n(values.year) || (new Date()).getFullYear()));
        record.title = values.title || "";
        record.type = values.type || "Journal";
        record.indexed = values.indexed || "Yes";
        record.role = values.role || "First/Corresponding";
        record.start = values.start || "";
        record.end = values.end || "";
      }
      if(kind==="admin"){
        record.position = values.position || "";
        record.type = values.type || "Official";
        record.level = values.level || "Faculty";
        record.months = Math.max(0, Math.floor(n(values.months)));
        record.meetings = Math.max(0, Math.floor(n(values.meetings)));
        record.notes = values.notes || "";
        record.start = values.start || "";
        record.end = values.end || "";
      }
      if(kind==="svc"){
        record.type = values.type || "Service to University";
        record.activity = values.activity || "";
        record.role = values.role || "Lead";
        record.hours = values.hours === null ? 0 : Math.max(0, n(values.hours));
        record.participants = values.participants === null ? 0 : Math.max(0, Math.floor(n(values.participants)));
        record.start = values.start || "";
        record.end = values.end || "";
      }
      if(kind==="lab"){
        record.type = values.type || "Equipment/Maintenance";
        record.desc = values.desc || "";
        record.volume = Math.max(0, Math.floor(n(values.volume)));
        record.complexity = values.complexity || "Medium";
        record.urgency = values.urgency || "Normal";
        record.hours = values.hours === null ? 0 : Math.max(0, n(values.hours));
        record.start = values.start || "";
        record.end = values.end || "";
      }
      if(kind==="ps"){
        record.activityType = values.activityType || "Reviewer";
        record.desc = values.desc || "";
        record.role = values.role || "Member";
        record.quantity = Math.max(0, Math.floor(n(values.quantity)));
        record.rounds = Math.max(1, Math.floor(n(values.rounds) || 1));
        record.complexity = values.complexity || "Medium";
        record.urgency = values.urgency || "Normal";
        record.hours = values.hours === null ? 0 : Math.max(0, n(values.hours));
        record.start = values.start || "";
        record.end = values.end || "";
      }

      renderAll();
      autosave();
      closeModal();
    }
  });
}

/* =========================================================
   Period normalization (points per month)
========================================================= */
function periodMonths(period){
  if(period==="Monthly") return 1;
  if(period==="Quarterly") return 3;
  if(period==="Semester") return 6;
  if(period==="Annual") return 12;
  return 1;
}

/* =========================================================
   Soft caps / diminishing returns
========================================================= */
function applySoftCap(score, cap, marginalRateAfterCap){
  const c = Math.max(0, n(cap));
  const r = clamp(n(marginalRateAfterCap), 0, 1);
  const s = Math.max(0, n(score));
  if(c<=0) return s;
  if(s<=c) return s;
  return c + (s-c)*r;
}

/* =========================================================
   State
========================================================= */
let isAdmin = false;

const state = {
  profile:{
    name:"", staffId:"", category:"", unit:"",
    grade:"", gradeOther:"",
    status:"", statusOther:"",
    period:"",
    staffCategory:"nonadmin"
  },

  enabled:{
    Teaching:true,
    Supervision:true,
    Research:true,
    Publication:true,
    Administration:true,
    Services:true,
    LabOps:false,
    ProSch:true
  },

  // Baseline weights must sum to 1.00
  weights:{
    Teaching:0.30,
    Supervision:0.15,
    Research:0.20,
    Publication:0.10,
    Administration:0.15,
    Services:0.10,
    LabOps:0.00,
    ProSch:0.00
  },

  // Admin scoring scheme + caps (defaults are sensible placeholders)
  scheme:{
    teaching:{ hourW:1.0, studW:0.6, creditW:0.4 },
    supervision:{ ug:1.5, m:3.0, phd:4.5 },
    research:{ base:6, lvl:[1.0,1.4,1.8], role:[1.6,1.2,1.0] },
    publication:{ base:4, type:[1.5,1.8,1.0,0.8], idx:[1.4,1.0] },
    admin:{ lvl:[3,5,7,8,10,12,9], meetW:1.5, monthW:0.3 },
    service:{ hourW:1.0, paxW:0.8, bonus:[4,1.5] },
    lab:{ volW:1.0, hourW:1.0, cx:[1.0,1.3,1.6], ur:[1.0,1.25,1.5] },
    prosch:{ base:3.0, role:[1.3,1.0], cx:[1.0,1.3,1.6], ur:[1.0,1.25,1.5] },

    // Soft caps (applied AFTER period-normalization)
    caps:{
      Teaching:{ cap:35, rate:0.40 },
      Supervision:{ cap:25, rate:0.45 },
      Research:{ cap:30, rate:0.45 },
      Publication:{ cap:20, rate:0.50 },
      Administration:{ cap:35, rate:0.45 },
      Services:{ cap:25, rate:0.50 },
      LabOps:{ cap:35, rate:0.45 },
      ProSch:{ cap:25, rate:0.50 }
    }
  },

  // Benchmarks (interpretation only)
  benchmarks:{ avg:45.0, p25:30.0, p50:45.0, p75:60.0 },

  eligibility:{
    enabled:true,
    nonAdminThreshold:10.0,
    adminRatio:0.50,
    metric:"sum"
  },

  data:{
    teaching:[],
    supervision:[],
    research:[],
    publication:[],
    admin:[],
    service:[],
    lab:[],
    prosch:[]
  },

  audit:{ last_saved_at:null, last_calc_at:null }
};

/* =========================================================
   Admin lock
========================================================= */
function setAdminUI(){
  $("modeText").textContent = isAdmin ? "Advanced Settings" : "Staff";
  $("btnAdminLock").style.display = isAdmin ? "inline-block" : "none";
  $("lockDot").className = "dot " + (isAdmin ? "" : "lock");
  $("lockText").textContent = isAdmin ? "Settings unlocked (local)" : "Settings locked";

  document.querySelectorAll(".adminOnly").forEach(el=>{
    el.disabled = !isAdmin;
  });
}

function unlockAdmin(){
  const pw = $("adminPass").value;
  if(pw === ADMIN_PASSWORD){
    isAdmin = true;
    setAdminUI();
    showMsg("ok","<b>Settings unlocked:</b> You can now edit weights, scoring scheme, and benchmarks (local only).");
  }else{
    isAdmin = false;
    setAdminUI();
    showMsg("bad","<b>Passphrase mismatch:</b> Unable to unlock advanced settings.");
  }
}
function lockAdmin(){
  isAdmin = false;
  $("adminPass").value = "";
  setAdminUI();
  showMsg("warn","<b>Locked:</b> Settings are now read-only.");
}

/* =========================================================
   Parsing helper
========================================================= */
function parseCSVNums(str, expected){
  const arr = (str||"").split(",").map(s=>n(s.trim()));
  if(arr.length!==expected) return null;
  return arr;
}

/* =========================================================
   Category templates (weights + section ON/OFF)
========================================================= */
function applyTemplateByCategory(cat){
  if(cat==="Academic"){
    state.enabled = {
      Teaching:true, Supervision:true, Research:true, Publication:true,
      Administration:true, Services:true, LabOps:false, ProSch:true
    };
    state.weights = {
      Teaching:0.28, Supervision:0.14, Research:0.20, Publication:0.10,
      Administration:0.12, Services:0.08, LabOps:0.00, ProSch:0.08
    };
  } else if(cat==="Administrative"){
    state.enabled = {
      Teaching:false, Supervision:false, Research:false, Publication:false,
      Administration:true, Services:true, LabOps:false, ProSch:true
    };
    state.weights = {
      Teaching:0.00, Supervision:0.00, Research:0.00, Publication:0.00,
      Administration:0.55, Services:0.30, LabOps:0.00, ProSch:0.15
    };
  } else if(cat==="Laboratory"){
    state.enabled = {
      Teaching:false, Supervision:false, Research:false, Publication:false,
      Administration:true, Services:true, LabOps:true, ProSch:true
    };
    state.weights = {
      Teaching:0.00, Supervision:0.00, Research:0.00, Publication:0.00,
      Administration:0.40, Services:0.20, LabOps:0.30, ProSch:0.10
    };
  }
  syncUIFromState();
  applySectionVisibility();
  autosave();
}

/* =========================================================
   Sync UI <-> State
========================================================= */
function syncProfileFromUI(){
  state.profile.name = $("pName").value.trim();
  state.profile.staffId = $("pStaffId").value.trim();
  state.profile.category = $("pCategory").value;
  state.profile.unit = $("pUnit").value.trim();
  state.profile.grade = $("pGrade").value;
  state.profile.gradeOther = $("pGradeOther").value.trim();
  state.profile.status = $("pStatus").value;
  state.profile.statusOther = $("pStatusOther").value.trim();
  state.profile.period = $("pPeriod").value;
  state.profile.staffCategory = $("pStaffCategory").value || "nonadmin";
}

function syncEnabledFromUI(){
  state.enabled.Teaching = $("enTeaching").checked;
  state.enabled.Supervision = $("enSupervision").checked;
  state.enabled.Research = $("enResearch").checked;
  state.enabled.Publication = $("enPublication").checked;
  state.enabled.Administration = $("enAdministration").checked;
  state.enabled.Services = $("enServices").checked;
  state.enabled.LabOps = $("enLabOps").checked;
  state.enabled.ProSch = $("enProSch").checked;
}

function syncSettingsFromUI_ifAdmin(){
  if(!isAdmin) return;

  // weights
  state.weights.Teaching = n($("wTeaching").value);
  state.weights.Supervision = n($("wSupervision").value);
  state.weights.Research = n($("wResearch").value);
  state.weights.Publication = n($("wPublication").value);
  state.weights.Administration = n($("wAdministration").value);
  state.weights.Services = n($("wServices").value);
  state.weights.LabOps = n($("wLabOps").value);
  state.weights.ProSch = n($("wProSch").value);

  // benchmarks
  state.benchmarks.avg = n($("bmAvg").value);
  state.benchmarks.p25 = n($("bmP25").value);
  state.benchmarks.p50 = n($("bmP50").value);
  state.benchmarks.p75 = n($("bmP75").value);

  // eligibility
  state.eligibility.enabled = $("eligEnabled").checked;
  state.eligibility.nonAdminThreshold = n($("eligNonAdminThresh").value);
  state.eligibility.adminRatio = n($("eligAdminRatio").value);
  state.eligibility.metric = $("eligMetric").value || "sum";

  // scheme
  state.scheme.teaching.hourW = n($("tHourW").value);
  state.scheme.teaching.studW = n($("tStudW").value);
  state.scheme.teaching.creditW = n($("tCreditW").value);

  state.scheme.supervision.ug = n($("svUG").value);
  state.scheme.supervision.m = n($("svM").value);
  state.scheme.supervision.phd = n($("svPHD").value);

  state.scheme.research.base = n($("rBase").value);
  const rLvl = parseCSVNums($("rUniNatIntl").value, 3); if(rLvl) state.scheme.research.lvl = rLvl;
  const rRole = parseCSVNums($("rRole").value, 3); if(rRole) state.scheme.research.role = rRole;

  state.scheme.publication.base = n($("pBase").value);
  const pType = parseCSVNums($("pType").value, 4); if(pType) state.scheme.publication.type = pType;
  const pIdx = parseCSVNums($("pIdx").value, 2); if(pIdx) state.scheme.publication.idx = pIdx;

  const aLvl = parseCSVNums($("aLevel").value, 7); if(aLvl) state.scheme.admin.lvl = aLvl;
  state.scheme.admin.meetW = n($("aMeetW").value);
  state.scheme.admin.monthW = n($("aMonthW").value);

  state.scheme.service.hourW = n($("sHourW").value);
  state.scheme.service.paxW = n($("sPaxW").value);
  const sBonus = parseCSVNums($("sRoleBonus").value, 2); if(sBonus) state.scheme.service.bonus = sBonus;

  state.scheme.lab.volW = n($("lVolW").value);
  state.scheme.lab.hourW = n($("lHourW").value);
  const lCx = parseCSVNums($("lCx").value, 3); if(lCx) state.scheme.lab.cx = lCx;
  const lUr = parseCSVNums($("lUr").value, 3); if(lUr) state.scheme.lab.ur = lUr;

  // prosch
  state.scheme.prosch.base = n($("psBase").value);
  const psRole = parseCSVNums($("psRole").value, 2); if(psRole) state.scheme.prosch.role = psRole;
  const psCx = parseCSVNums($("psCx").value, 3); if(psCx) state.scheme.prosch.cx = psCx;
  const psUr = parseCSVNums($("psUr").value, 3); if(psUr) state.scheme.prosch.ur = psUr;
}

function syncUIFromState(){
  // profile
  $("pName").value = state.profile.name || "";
  $("pStaffId").value = state.profile.staffId || "";
  $("pCategory").value = state.profile.category || "";
  $("pUnit").value = state.profile.unit || "";
  $("pGrade").value = state.profile.grade || "";
  $("pGradeOther").value = state.profile.gradeOther || "";
  $("pStatus").value = state.profile.status || "";
  $("pStatusOther").value = state.profile.statusOther || "";
  $("pPeriod").value = state.profile.period || "";
  $("pStaffCategory").value = state.profile.staffCategory || "nonadmin";

  $("pGradeOtherWrap").style.display = (state.profile.grade==="Others") ? "block" : "none";
  $("pStatusOtherWrap").style.display = (state.profile.status==="Others") ? "block" : "none";

  // enabled
  $("enTeaching").checked = !!state.enabled.Teaching;
  $("enSupervision").checked = !!state.enabled.Supervision;
  $("enResearch").checked = !!state.enabled.Research;
  $("enPublication").checked = !!state.enabled.Publication;
  $("enAdministration").checked = !!state.enabled.Administration;
  $("enServices").checked = !!state.enabled.Services;
  $("enLabOps").checked = !!state.enabled.LabOps;
  $("enProSch").checked = !!state.enabled.ProSch;

  // weights
  $("wTeaching").value = state.weights.Teaching.toFixed(2);
  $("wSupervision").value = state.weights.Supervision.toFixed(2);
  $("wResearch").value = state.weights.Research.toFixed(2);
  $("wPublication").value = state.weights.Publication.toFixed(2);
  $("wAdministration").value = state.weights.Administration.toFixed(2);
  $("wServices").value = state.weights.Services.toFixed(2);
  $("wLabOps").value = state.weights.LabOps.toFixed(2);
  $("wProSch").value = state.weights.ProSch.toFixed(2);

  // benchmarks
  $("bmAvg").value = state.benchmarks.avg;
  $("bmP25").value = state.benchmarks.p25;
  $("bmP50").value = state.benchmarks.p50;
  $("bmP75").value = state.benchmarks.p75;

  // eligibility
  $("eligEnabled").checked = !!state.eligibility.enabled;
  $("eligNonAdminThresh").value = state.eligibility.nonAdminThreshold;
  $("eligAdminRatio").value = state.eligibility.adminRatio;
  $("eligMetric").value = state.eligibility.metric || "sum";

  // scheme
  $("tHourW").value = state.scheme.teaching.hourW;
  $("tStudW").value = state.scheme.teaching.studW;
  $("tCreditW").value = state.scheme.teaching.creditW;

  $("svUG").value = state.scheme.supervision.ug;
  $("svM").value = state.scheme.supervision.m;
  $("svPHD").value = state.scheme.supervision.phd;

  $("rBase").value = state.scheme.research.base;
  $("rUniNatIntl").value = state.scheme.research.lvl.join(",");
  $("rRole").value = state.scheme.research.role.join(",");

  $("pBase").value = state.scheme.publication.base;
  $("pType").value = state.scheme.publication.type.join(",");
  $("pIdx").value = state.scheme.publication.idx.join(",");

  $("aLevel").value = state.scheme.admin.lvl.join(",");
  $("aMeetW").value = state.scheme.admin.meetW;
  $("aMonthW").value = state.scheme.admin.monthW;

  $("sHourW").value = state.scheme.service.hourW;
  $("sPaxW").value = state.scheme.service.paxW;
  $("sRoleBonus").value = state.scheme.service.bonus.join(",");

  $("lVolW").value = state.scheme.lab.volW;
  $("lHourW").value = state.scheme.lab.hourW;
  $("lCx").value = state.scheme.lab.cx.join(",");
  $("lUr").value = state.scheme.lab.ur.join(",");

  $("psBase").value = state.scheme.prosch.base;
  $("psRole").value = state.scheme.prosch.role.join(",");
  $("psCx").value = state.scheme.prosch.cx.join(",");
  $("psUr").value = state.scheme.prosch.ur.join(",");
}

function applySectionVisibility(){
  const sectionStates = [
    {key:"Teaching", panel:"secTeaching", tab:"tabTeaching"},
    {key:"Supervision", panel:"secSupervision", tab:"tabSupervision"},
    {key:"Research", panel:"secResearch", tab:"tabResearch"},
    {key:"Publication", panel:"secPublication", tab:"tabPublication"},
    {key:"Administration", panel:"secAdmin", tab:"tabAdministration"},
    {key:"Services", panel:"secService", tab:"tabService"},
    {key:"LabOps", panel:"secLabOps", tab:"tabLabOps"},
    {key:"ProSch", panel:"secProSch", tab:"tabProSch"}
  ];

  sectionStates.forEach(({key, panel, tab})=>{
    const enabled = !!state.enabled[key];
    const panelEl = $(panel);
    if(panelEl){
      panelEl.dataset.enabled = enabled ? "true" : "false";
      if(!enabled){
        panelEl.classList.add("is-hidden");
        panelEl.hidden = true;
      }
    }
    setTabVisibility(tab, enabled);
  });
  ensureActiveTab();
}

/* =========================================================
   Benchmark UI
========================================================= */
function updateBenchmarkUI(indexValue=null){
  if(indexValue===null){
    $("outBenchmark").textContent = "—";
  }else{
    $("outBenchmark").textContent = benchmarkText(indexValue);
  }
}

/* =========================================================
   Validation helpers
========================================================= */
function validateProfile(){
  const ids = ["pName","pStaffId","pCategory","pUnit","pGrade","pStatus","pPeriod","pGradeOther","pStatusOther"];
  ids.forEach(id=>$(id).classList.remove("err"));
  let ok=true;

  if(!$("pName").value.trim()) ok=false, $("pName").classList.add("err");
  if(!$("pStaffId").value.trim()) ok=false, $("pStaffId").classList.add("err");
  if(!$("pCategory").value) ok=false, $("pCategory").classList.add("err");
  if(!$("pUnit").value.trim()) ok=false, $("pUnit").classList.add("err");
  if(!$("pGrade").value) ok=false, $("pGrade").classList.add("err");
  if(!$("pStatus").value) ok=false, $("pStatus").classList.add("err");
  if(!$("pPeriod").value) ok=false, $("pPeriod").classList.add("err");

  if($("pGrade").value==="Others" && !$("pGradeOther").value.trim()) ok=false, $("pGradeOther").classList.add("err");
  if($("pStatus").value==="Others" && !$("pStatusOther").value.trim()) ok=false, $("pStatusOther").classList.add("err");

  $("msgProfile").style.display = ok ? "none" : "block";
  if(!ok) $("msgProfile").innerHTML = "<b>Action required:</b> Please complete all required profile fields.";
  return ok;
}

function validateToggles(){
  syncEnabledFromUI();
  const anyOn = Object.values(state.enabled).some(Boolean);
  $("toggleWarn").style.display = anyOn ? "none" : "block";
  if(!anyOn) $("toggleWarn").textContent = "At least one section must be ON.";
  return anyOn;
}

function validateWeightsBaseline_ifAdmin(){
  if(!isAdmin) return true;
  const sum =
    state.weights.Teaching +
    state.weights.Supervision +
    state.weights.Research +
    state.weights.Publication +
    state.weights.Administration +
    state.weights.Services +
    state.weights.LabOps +
    state.weights.ProSch;

  const errors = [];
  if(Math.abs(sum-1.00) > 0.005){
    errors.push(`Baseline weights must sum to 1.00. Current sum = <b>${sum.toFixed(2)}</b>.`);
  }

  const nonAdmin = n(state.eligibility.nonAdminThreshold);
  if(nonAdmin < 0){
    errors.push("Eligibility non-admin threshold must be ≥ 0.");
  }
  const ratio = n(state.eligibility.adminRatio);
  if(ratio <= 0 || ratio > 1){
    errors.push("Eligibility admin ratio must be within (0, 1].");
  }

  const ok = errors.length === 0;
  $("msgSettings").style.display = ok ? "none" : "block";
  if(!ok) $("msgSettings").innerHTML = `<b>Settings validation:</b> ${errors.join(" ")}`;
  return ok;
}

function getActiveWeights(){
  const aw = {
    Teaching: state.enabled.Teaching ? state.weights.Teaching : 0,
    Supervision: state.enabled.Supervision ? state.weights.Supervision : 0,
    Research: state.enabled.Research ? state.weights.Research : 0,
    Publication: state.enabled.Publication ? state.weights.Publication : 0,
    Administration: state.enabled.Administration ? state.weights.Administration : 0,
    Services: state.enabled.Services ? state.weights.Services : 0,
    LabOps: state.enabled.LabOps ? state.weights.LabOps : 0,
    ProSch: state.enabled.ProSch ? state.weights.ProSch : 0
  };
  const sum = Object.values(aw).reduce((a,b)=>a+b,0);
  if(sum<=0) return null;
  Object.keys(aw).forEach(k=>aw[k]=aw[k]/sum);
  return aw;
}

/* =========================================================
   Teaching helpers
========================================================= */
function creditFromCode(code){
  const s = (code||"").trim();
  const m = s.match(/(\d)\s*$/);
  return m ? parseInt(m[1],10) : 0;
}
function contactHoursRow(r){
  return Math.max(0,n(r.lecture)) + Math.max(0,n(r.tutorial)) + Math.max(0,n(r.laboratory)) + Math.max(0,n(r.field));
}

/* =========================================================
   Scoring (raw -> monthly -> soft caps)
========================================================= */
function scoreTeaching_raw(){
  const sc=state.scheme.teaching;
  let total=0;
  state.data.teaching.forEach(x=>{
    const credit = creditFromCode(x.code);
    x.credit = credit;
    const contact = contactHoursRow(x);
    const students = Math.max(0,n(x.students));
    total += (contact*sc.hourW) + ((students/100)*sc.studW) + (credit*sc.creditW);
  });
  return total;
}

function scoreSupervision_raw(){
  const sc=state.scheme.supervision;
  let total=0;
  state.data.supervision.forEach(x=>{
    const roleMultiplier = (x.role==="Main") ? 1.0 : 0.6;
    const statusMultiplier = (x.status==="Active") ? 1.0 : 0.5;
    let base = 0;
    if(x.level==="Undergraduate") base=sc.ug;
    if(x.level==="Master") base=sc.m;
    if(x.level==="PhD") base=sc.phd;
    total += base * roleMultiplier * statusMultiplier;
  });
  return total;
}

function scoreResearch_raw(){
  const sc=state.scheme.research;
  const lvlMap={University:0, National:1, International:2};
  const roleMap={PI:0, "Co-I":1, Member:2};
  let total=0;
  state.data.research.forEach(x=>{
    const statusMultiplier = (x.status==="Active") ? 1.0 : (x.status==="Applied") ? 0.6 : 0.3;
    const li = lvlMap[x.level] ?? 0;
    const ri = roleMap[x.role] ?? 2;
    total += sc.base * sc.lvl[li] * sc.role[ri] * statusMultiplier;
  });
  return total;
}

function scorePublication_raw(){
  const sc=state.scheme.publication;
  const typeMap={"Journal":0,"Book/Chapter":1,"Proceeding":2,"Other":3};
  const idxMap={"Yes":0,"No":1};
  let total=0;
  state.data.publication.forEach(x=>{
    const ti = typeMap[x.type] ?? 3;
    const ii = idxMap[x.indexed] ?? 1;
    const roleMultiplier = (x.role==="First/Corresponding") ? 1.2 : 1.0;
    total += sc.base * sc.type[ti] * sc.idx[ii] * roleMultiplier;
  });
  return total;
}

function scoreAdministration_raw(){
  const sc=state.scheme.admin;
  const lvlMap={"Programme":0,"Faculty":1,"University":2,"State":3,"National":4,"International":5,"Industry":6};
  let total=0;
  state.data.admin.forEach(x=>{
    const li = lvlMap[x.level] ?? 1;
    const base = sc.lvl[li];
    const meetings = Math.max(0,n(x.meetings));
    const months = Math.max(0,n(x.months));
    const typeMultiplier = (x.type==="Official") ? 1.0 : 0.7;
    total += (base + meetings*sc.meetW + months*sc.monthW) * typeMultiplier;
  });
  return total;
}

function scoreServices_raw(){
  const sc=state.scheme.service;
  const roleMap={Lead:0, Member:1};
  let total=0;
  state.data.service.forEach(x=>{
    const hrs = Math.max(0,n(x.hours));
    const pax = Math.max(0,n(x.participants));
    const ri = roleMap[x.role] ?? 1;
    total += (hrs*sc.hourW) + ((pax/10)*sc.paxW) + sc.bonus[ri];
  });
  return total;
}

function scoreLabOps_raw(){
  const sc=state.scheme.lab;
  const cxMap={Low:0, Medium:1, High:2};
  const urMap={Normal:0, Tight:1, Critical:2};
  let total=0;
  state.data.lab.forEach(x=>{
    const vol = Math.max(0,n(x.volume));
    const hrs = Math.max(0,n(x.hours));
    const ci = cxMap[x.complexity] ?? 1;
    const ui = urMap[x.urgency] ?? 0;
    const base = (vol*sc.volW) + (hrs*sc.hourW);
    total += base * sc.cx[ci] * sc.ur[ui];
  });
  return total;
}

function scoreProSch_raw(){
  const sc=state.scheme.prosch;
  const roleMap={Lead:0, Member:1};
  const cxMap={Low:0, Medium:1, High:2};
  const urMap={Normal:0, Tight:1, Critical:2};

  let total=0;
  state.data.prosch.forEach(x=>{
    const qty = Math.max(0, Math.floor(n(x.quantity)));
    const rnd = Math.max(1, Math.floor(n(x.rounds) || 1));
    const hrs = Math.max(0, n(x.hours));
    const ri = roleMap[x.role] ?? 1;
    const ci = cxMap[x.complexity] ?? 1;
    const ui = urMap[x.urgency] ?? 0;

    const baseEffort = (sc.base * qty * rnd) + hrs;
    total += baseEffort * sc.role[ri] * sc.cx[ci] * sc.ur[ui];
  });
  return total;
}

function normalizeAndCap(sectionName, rawScore){
  const months = periodMonths(state.profile.period);
  const perMonth = (months>0) ? (Math.max(0,n(rawScore)) / months) : Math.max(0,n(rawScore));
  const capCfg = state.scheme.caps[sectionName] || {cap:0, rate:1};
  return applySoftCap(perMonth, capCfg.cap, capCfg.rate);
}

/* =========================================================
   Tutor/Demonstrator Eligibility (Teaching + Supervision)
========================================================= */
function getRawTeachingBurden(){
  if(!state.enabled.Teaching) return 0;
  return normalizeAndCap("Teaching", scoreTeaching_raw());
}

function getRawSupervisionBurden(){
  if(!state.enabled.Supervision) return 0;
  return normalizeAndCap("Supervision", scoreSupervision_raw());
}

function computeTutorDemoEligibility(){
  if(!state.eligibility.enabled){
    return {enabled:false};
  }
  const teaching = getRawTeachingBurden();
  const supervision = getRawSupervisionBurden();
  const ES = teaching + supervision;
  const staffCategory = state.profile.staffCategory || "nonadmin";
  const nonAdminThresh = n(state.eligibility.nonAdminThreshold);
  const adminRatio = n(state.eligibility.adminRatio);
  const thresholdUsed = (staffCategory === "admin") ? nonAdminThresh * adminRatio : nonAdminThresh;
  const eligible = ES >= thresholdUsed;
  const delta = ES - thresholdUsed;
  return {enabled:true, ES, teaching, supervision, thresholdUsed, eligible, delta, staffCategory};
}

function renderEligibilityCard(){
  const disabledNote = $("eligibilityDisabled");
  const details = $("eligibilityDetails");
  if(!disabledNote || !details) return;

  const result = computeTutorDemoEligibility();
  if(!result.enabled){
    disabledNote.style.display = "block";
    details.style.display = "none";
    return;
  }

  disabledNote.style.display = "none";
  details.style.display = "block";

  const staffLabel = result.staffCategory === "admin" ? "Admin Academic Staff" : "Non-admin Academic Staff";
  $("eligStaffCategory").textContent = staffLabel;
  $("eligTeaching").textContent = result.teaching.toFixed(2);
  $("eligSupervision").textContent = result.supervision.toFixed(2);
  $("eligScore").textContent = result.ES.toFixed(2);
  $("eligThreshold").textContent = result.thresholdUsed.toFixed(2);

  const deltaText = result.eligible
    ? `Exceeds threshold by +${result.delta.toFixed(2)}`
    : `Short by ${Math.abs(result.delta).toFixed(2)}`;
  $("eligDelta").textContent = deltaText;

  const statusEl = $("eligStatus");
  statusEl.className = "notice " + (result.eligible ? "ok" : "bad");
  statusEl.textContent = result.eligible ? "Eligible to apply" : "Not eligible";
}

function eligibilityPrintText(){
  const result = computeTutorDemoEligibility();
  if(!result.enabled){
    return "Eligibility assessment disabled.";
  }
  const staffLabel = result.staffCategory === "admin" ? "Admin" : "Non-admin";
  const status = result.eligible ? "Eligible" : "Not eligible";
  return `${status} (ES ${result.ES.toFixed(2)} vs Threshold ${result.thresholdUsed.toFixed(2)}; ${staffLabel}).`;
}

/* =========================================================
   Benchmarks interpretation text
========================================================= */
function benchmarkText(index){
  const b = state.benchmarks;
  const parts = [];

  if(n(b.avg)>0){
    if(index < b.avg - 5) parts.push(`Below faculty average (${b.avg.toFixed(1)}).`);
    else if(index > b.avg + 5) parts.push(`Above faculty average (${b.avg.toFixed(1)}).`);
    else parts.push(`Around faculty average (${b.avg.toFixed(1)}).`);
  }

  const p25=n(b.p25), p50=n(b.p50), p75=n(b.p75);
  if(p75>0 && p50>0 && p25>0){
    let band = "";
    if(index < p25) band = "Below 25th percentile (lighter workload relative to peers).";
    else if(index < p50) band = "Between 25th–50th percentile.";
    else if(index < p75) band = "Between 50th–75th percentile.";
    else band = "Above 75th percentile (heavier workload relative to peers).";
    parts.push(band);
  }

  if(parts.length===0) return "No benchmarks set in advanced settings.";
  return parts.join(" ");
}
</script>

<script>
/* =========================================================
   Tables: renderAll()
========================================================= */
let chart=null;

const editButtonHTML = (label="Edit record") => `
  <button class="btn btn-secondary btn-sm" data-act="edit" aria-label="${label}">Edit</button>`;
const deleteButtonHTML = (label="Delete record") => `
  <button class="btn btn-danger btn-sm" data-act="del" aria-label="${label}">Delete</button>`;

function renderAll(){
  renderTeaching();
  renderSupervision();
  renderResearch();
  renderPublication();
  renderAdministration();
  renderServices();
  renderLabOps();
  renderProSch();
}

/* =========================================================
   Teaching table
========================================================= */
function renderTeaching(){
  const tb = $("tblTeach").querySelector("tbody");
  tb.innerHTML="";
  if(state.data.teaching.length===0) return;
  state.data.teaching.forEach(r=>{
    const tr=document.createElement("tr"); tr.dataset.id=r.id;
    tr.innerHTML=`
      <td data-label="Course Code *">${cellTextHTML(r.code || "")}</td>
      <td data-label="Course Title *">${cellTextHTML(r.name || "")}</td>
      <td data-label="Credit">${cellTextHTML(formatInt(r.credit || 0))}</td>
      <td data-label="Students *">${cellTextHTML(formatInt(r.students || 0))}</td>
      <td data-label="Lecture *">${cellTextHTML(formatHours(r.lecture || 0))}</td>
      <td data-label="Tutorial *">${cellTextHTML(formatHours(r.tutorial || 0))}</td>
      <td data-label="Lab *">${cellTextHTML(formatHours(r.laboratory || 0))}</td>
      <td data-label="Field *">${cellTextHTML(formatHours(r.field || 0))}</td>
      <td data-label="Contact Hours">${cellTextHTML(formatHours(contactHoursRow(r)))}</td>
      <td class="cell-actions" data-label="Action">${editButtonHTML("Edit course")}${deleteButtonHTML("Delete course")}</td>
    `;
    tb.appendChild(tr);

    tr.addEventListener("click",(e)=>{
      const action = e.target.closest("[data-act]")?.getAttribute("data-act");
      if(action === "edit"){
        openEditModal("teach", tr.dataset.id);
      }
      if(action === "del"){
        if(!confirmDelete("Delete this course record?")) return;
        state.data.teaching = state.data.teaching.filter(x=>x.id!==tr.dataset.id);
        renderAll(); autosave();
      }
    });
  });
}

/* =========================================================
   Supervision table
========================================================= */
function renderSupervision(){
  const tb=$("tblSv").querySelector("tbody");
  tb.innerHTML="";
  if(state.data.supervision.length===0) return;
  state.data.supervision.forEach(r=>{
    const tr=document.createElement("tr"); tr.dataset.id=r.id;
    tr.innerHTML=`
      <td data-label="Level *">${cellTextHTML(r.level || "Undergraduate")}</td>
      <td data-label="Student / Project *">${cellTextHTML(r.title || "")}</td>
      <td data-label="Role *">${cellTextHTML(r.role || "Main")}</td>
      <td data-label="Status *">${cellTextHTML(r.status || "Active")}</td>
      <td data-label="Start Date *">${cellTextHTML(r.start || "")}</td>
      <td data-label="End Date *">${cellTextHTML(r.end || "")}</td>
      <td class="cell-actions" data-label="Action">${editButtonHTML("Edit supervision record")}${deleteButtonHTML("Delete supervision record")}</td>
    `;
    tb.appendChild(tr);

    tr.addEventListener("click",(e)=>{
      const action = e.target.closest("[data-act]")?.getAttribute("data-act");
      if(action === "edit"){
        openEditModal("sv", tr.dataset.id);
      }
      if(action === "del"){
        if(!confirmDelete("Delete this supervision record?")) return;
        state.data.supervision = state.data.supervision.filter(x=>x.id!==tr.dataset.id);
        renderAll(); autosave();
      }
    });
  });
}

/* =========================================================
   Research table
========================================================= */
function renderResearch(){
  const tb=$("tblRes").querySelector("tbody");
  tb.innerHTML="";
  if(state.data.research.length===0) return;
  state.data.research.forEach(r=>{
    const tr=document.createElement("tr"); tr.dataset.id=r.id;
    tr.innerHTML=`
      <td data-label="Grant Code *">${cellTextHTML(r.code || "")}</td>
      <td data-label="Title *">${cellTextHTML(r.title || "")}</td>
      <td data-label="Level *">${cellTextHTML(r.level || "University")}</td>
      <td data-label="Status *">${cellTextHTML(r.status || "Active")}</td>
      <td data-label="Role *">${cellTextHTML(r.role || "PI")}</td>
      <td data-label="Amount (RM) *">${cellTextHTML(formatInt(r.amount || 0))}</td>
      <td data-label="Start Date *">${cellTextHTML(r.start || "")}</td>
      <td data-label="End Date *">${cellTextHTML(r.end || "")}</td>
      <td class="cell-actions" data-label="Action">${editButtonHTML("Edit research record")}${deleteButtonHTML("Delete research record")}</td>
    `;
    tb.appendChild(tr);

    tr.addEventListener("click",(e)=>{
      const action = e.target.closest("[data-act]")?.getAttribute("data-act");
      if(action === "edit"){
        openEditModal("res", tr.dataset.id);
      }
      if(action === "del"){
        if(!confirmDelete("Delete this research record?")) return;
        state.data.research = state.data.research.filter(x=>x.id!==tr.dataset.id);
        renderAll(); autosave();
      }
    });
  });
}

/* =========================================================
   Publication table
========================================================= */
function renderPublication(){
  const tb=$("tblPub").querySelector("tbody");
  tb.innerHTML="";
  if(state.data.publication.length===0) return;
  state.data.publication.forEach(r=>{
    const tr=document.createElement("tr"); tr.dataset.id=r.id;
    tr.innerHTML=`
      <td data-label="Year *">${cellTextHTML(formatInt(r.year || (new Date()).getFullYear()))}</td>
      <td data-label="Title *">${cellTextHTML(r.title || "")}</td>
      <td data-label="Type *">${cellTextHTML(r.type || "Journal")}</td>
      <td data-label="Indexed? *">${cellTextHTML(r.indexed || "Yes")}</td>
      <td data-label="Role *">${cellTextHTML(r.role || "First/Corresponding")}</td>
      <td data-label="Start Date *">${cellTextHTML(r.start || "")}</td>
      <td data-label="End Date *">${cellTextHTML(r.end || "")}</td>
      <td class="cell-actions" data-label="Action">${editButtonHTML("Edit publication record")}${deleteButtonHTML("Delete publication record")}</td>
    `;
    tb.appendChild(tr);

    tr.addEventListener("click",(e)=>{
      const action = e.target.closest("[data-act]")?.getAttribute("data-act");
      if(action === "edit"){
        openEditModal("pub", tr.dataset.id);
      }
      if(action === "del"){
        if(!confirmDelete("Delete this publication record?")) return;
        state.data.publication = state.data.publication.filter(x=>x.id!==tr.dataset.id);
        renderAll(); autosave();
      }
    });
  });
}

/* =========================================================
   Administration table
========================================================= */
function renderAdministration(){
  const tb=$("tblAdmin").querySelector("tbody");
  tb.innerHTML="";
  if(state.data.admin.length===0) return;
  state.data.admin.forEach(r=>{
    const tr=document.createElement("tr"); tr.dataset.id=r.id;
    tr.innerHTML=`
      <td data-label="Position *">${cellTextHTML(r.position || "")}</td>
      <td data-label="Type *">${cellTextHTML(r.type || "Official")}</td>
      <td data-label="Level *">${cellTextHTML(r.level || "Faculty")}</td>
      <td data-label="Months *">${cellTextHTML(formatInt(r.months || 0))}</td>
      <td data-label="Meetings *">${cellTextHTML(formatInt(r.meetings || 0))}</td>
      <td data-label="Workload Notes *">${cellTextHTML(r.notes || "")}</td>
      <td data-label="Start Date *">${cellTextHTML(r.start || "")}</td>
      <td data-label="End Date *">${cellTextHTML(r.end || "")}</td>
      <td class="cell-actions" data-label="Action">${editButtonHTML("Edit administration record")}${deleteButtonHTML("Delete administration record")}</td>
    `;
    tb.appendChild(tr);

    tr.addEventListener("click",(e)=>{
      const action = e.target.closest("[data-act]")?.getAttribute("data-act");
      if(action === "edit"){
        openEditModal("admin", tr.dataset.id);
      }
      if(action === "del"){
        if(!confirmDelete("Delete this administration record?")) return;
        state.data.admin = state.data.admin.filter(x=>x.id!==tr.dataset.id);
        renderAll(); autosave();
      }
    });
  });
}

/* =========================================================
   Services table
========================================================= */
function renderServices(){
  const tb=$("tblSvc").querySelector("tbody");
  tb.innerHTML="";
  if(state.data.service.length===0) return;
  state.data.service.forEach(r=>{
    const tr=document.createElement("tr"); tr.dataset.id=r.id;
    tr.innerHTML=`
      <td data-label="Service Type *">${cellTextHTML(r.type || "Service to University")}</td>
      <td data-label="Activity *">${cellTextHTML(r.activity || "")}</td>
      <td data-label="Role *">${cellTextHTML(r.role || "Lead")}</td>
      <td data-label="Hours *">${cellTextHTML(formatHours(r.hours || 0))}</td>
      <td data-label="Participants *">${cellTextHTML(formatInt(r.participants || 0))}</td>
      <td data-label="Start Date *">${cellTextHTML(r.start || "")}</td>
      <td data-label="End Date *">${cellTextHTML(r.end || "")}</td>
      <td class="cell-actions" data-label="Action">${editButtonHTML("Edit service record")}${deleteButtonHTML("Delete service record")}</td>
    `;
    tb.appendChild(tr);

    tr.addEventListener("click",(e)=>{
      const action = e.target.closest("[data-act]")?.getAttribute("data-act");
      if(action === "edit"){
        openEditModal("svc", tr.dataset.id);
      }
      if(action === "del"){
        if(!confirmDelete("Delete this service record?")) return;
        state.data.service = state.data.service.filter(x=>x.id!==tr.dataset.id);
        renderAll(); autosave();
      }
    });
  });
}

/* =========================================================
   Lab Operations table
========================================================= */
function renderLabOps(){
  const tb=$("tblLab").querySelector("tbody");
  tb.innerHTML="";
  if(state.data.lab.length===0) return;
  state.data.lab.forEach(r=>{
    const tr=document.createElement("tr"); tr.dataset.id=r.id;
    tr.innerHTML=`
      <td data-label="Activity Type *">${cellTextHTML(r.type || "Equipment/Maintenance")}</td>
      <td data-label="Description *">${cellTextHTML(r.desc || "")}</td>
      <td data-label="Volume *">${cellTextHTML(formatInt(r.volume || 0))}</td>
      <td data-label="Complexity *">${cellTextHTML(r.complexity || "Medium")}</td>
      <td data-label="Urgency *">${cellTextHTML(r.urgency || "Normal")}</td>
      <td data-label="Hours *">${cellTextHTML(formatHours(r.hours || 0))}</td>
      <td data-label="Start Date *">${cellTextHTML(r.start || "")}</td>
      <td data-label="End Date *">${cellTextHTML(r.end || "")}</td>
      <td class="cell-actions" data-label="Action">${editButtonHTML("Edit lab operations record")}${deleteButtonHTML("Delete lab operations record")}</td>
    `;
    tb.appendChild(tr);

    tr.addEventListener("click",(e)=>{
      const action = e.target.closest("[data-act]")?.getAttribute("data-act");
      if(action === "edit"){
        openEditModal("lab", tr.dataset.id);
      }
      if(action === "del"){
        if(!confirmDelete("Delete this lab operations record?")) return;
        state.data.lab = state.data.lab.filter(x=>x.id!==tr.dataset.id);
        renderAll(); autosave();
      }
    });
  });
}

/* =========================================================
   Professional & Scholarly Service table
========================================================= */
function renderProSch(){
  const tb=$("tblProSch").querySelector("tbody");
  tb.innerHTML="";
  if(state.data.prosch.length===0) return;
  state.data.prosch.forEach(r=>{
    const tr=document.createElement("tr"); tr.dataset.id=r.id;
    tr.innerHTML=`
      <td data-label="Activity Type *">${cellTextHTML(r.activityType || "Reviewer")}</td>
      <td data-label="Description *">${cellTextHTML(r.desc || "")}</td>
      <td data-label="Role *">${cellTextHTML(r.role || "Member")}</td>
      <td data-label="Quantity *">${cellTextHTML(formatInt(r.quantity || 0))}</td>
      <td data-label="Rounds *">${cellTextHTML(formatInt(r.rounds || 1))}</td>
      <td data-label="Complexity *">${cellTextHTML(r.complexity || "Medium")}</td>
      <td data-label="Urgency *">${cellTextHTML(r.urgency || "Normal")}</td>
      <td data-label="Hours (optional)">${cellTextHTML(formatHours(r.hours || 0))}</td>
      <td data-label="Start Date *">${cellTextHTML(r.start || "")}</td>
      <td data-label="End Date *">${cellTextHTML(r.end || "")}</td>
      <td class="cell-actions" data-label="Action">${editButtonHTML("Edit professional service record")}${deleteButtonHTML("Delete professional service record")}</td>
    `;
    tb.appendChild(tr);

    tr.addEventListener("click",(e)=>{
      const action = e.target.closest("[data-act]")?.getAttribute("data-act");
      if(action === "edit"){
        openEditModal("ps", tr.dataset.id);
      }
      if(action === "del"){
        if(!confirmDelete("Delete this professional service record?")) return;
        state.data.prosch = state.data.prosch.filter(x=>x.id!==tr.dataset.id);
        renderAll(); autosave();
      }
    });
  });
}

/* =========================================================
   Add / Clear actions
========================================================= */
function addRow(kind){
  if(kind==="teach") state.data.teaching.push({id:uid(), code:"", name:"", credit:0, students:0, lecture:0, tutorial:0, laboratory:0, field:0});
  if(kind==="sv") state.data.supervision.push({id:uid(), level:"Undergraduate", title:"", role:"Main", status:"Active", start:"", end:""});

  if(kind==="res") state.data.research.push({
    id:uid(),
    code:"",
    title:"",
    level:"University",
    status:"Active",
    role:"PI",
    amount:0,
    start:"",
    end:""
  });

  if(kind==="pub") state.data.publication.push({
    id:uid(),
    year:(new Date()).getFullYear(),
    title:"",
    type:"Journal",
    indexed:"Yes",
    role:"First/Corresponding",
    start:"",
    end:""
  });

  if(kind==="admin") state.data.admin.push({id:uid(), position:"", type:"Official", level:"Faculty", months:0, meetings:0, notes:"", start:"", end:""});
  if(kind==="svc") state.data.service.push({id:uid(), type:"Service to University", activity:"", role:"Lead", hours:0, participants:0, start:"", end:""});
  if(kind==="lab") state.data.lab.push({id:uid(), type:"Equipment/Maintenance", desc:"", volume:0, complexity:"Medium", urgency:"Normal", hours:0, start:"", end:""});
  if(kind==="ps") state.data.prosch.push({id:uid(), activityType:"Reviewer", desc:"", role:"Member", quantity:1, rounds:1, complexity:"Medium", urgency:"Normal", hours:0, start:"", end:""});
  renderAll(); autosave();
}

function clearKind(kind){
  if(kind==="teach") state.data.teaching=[];
  if(kind==="sv") state.data.supervision=[];
  if(kind==="res") state.data.research=[];
  if(kind==="pub") state.data.publication=[];
  if(kind==="admin") state.data.admin=[];
  if(kind==="svc") state.data.service=[];
  if(kind==="lab") state.data.lab=[];
  if(kind==="ps") state.data.prosch=[];
  renderAll(); autosave();
}

/* =========================================================
   Validation (activity tables)
========================================================= */
function validateActivityTables(){
  let ok=true;
  const requireText = (value)=>{ if(!String(value||"").trim()){ ok=false; } };
  const requireNonNeg = (value, strictPositive=false)=>{
    const v=n(value);
    if(v<0 || (strictPositive && v<=0)){ ok=false; }
  };
  const requireDate = (value)=>{ if(!value){ ok=false; } };

  if(state.enabled.Teaching){
    state.data.teaching.forEach(item=>{
      requireText(item.code);
      requireText(item.name);
      requireNonNeg(item.students, true);
      ["lecture","tutorial","laboratory","field"].forEach(k=>requireNonNeg(item[k], false));
    });
  }

  if(state.enabled.Supervision){
    state.data.supervision.forEach(item=>{
      requireText(item.title);
      requireDate(item.start);
      requireDate(item.end);
    });
  }

  if(state.enabled.Research){
    state.data.research.forEach(item=>{
      requireText(item.code);
      requireText(item.title);
      requireNonNeg(item.amount, true);
      requireDate(item.start);
      requireDate(item.end);
    });
  }

  if(state.enabled.Publication){
    state.data.publication.forEach(item=>{
      requireNonNeg(item.year, true);
      requireText(item.title);
      requireDate(item.start);
      requireDate(item.end);
    });
  }

  if(state.enabled.Administration){
    state.data.admin.forEach(item=>{
      requireText(item.position);
      requireNonNeg(item.months, true);
      requireNonNeg(item.meetings, false);
      requireText(item.notes);
      requireDate(item.start);
      requireDate(item.end);
    });
  }

  if(state.enabled.Services){
    state.data.service.forEach(item=>{
      requireText(item.activity);
      requireNonNeg(item.hours, true);
      requireNonNeg(item.participants, true);
      requireDate(item.start);
      requireDate(item.end);
    });
  }

  if(state.enabled.LabOps){
    state.data.lab.forEach(item=>{
      requireText(item.desc);
      requireNonNeg(item.volume, true);
      requireNonNeg(item.hours, true);
      requireDate(item.start);
      requireDate(item.end);
    });
  }

  if(state.enabled.ProSch){
    state.data.prosch.forEach(item=>{
      requireText(item.desc);
      requireNonNeg(item.quantity, true);
      requireNonNeg(item.rounds, true);
      requireDate(item.start);
      requireDate(item.end);
    });
  }

  if(!ok){
    showMsg("warn","<b>Validation:</b> Please fill all required fields (no empty/negative values). Use Edit on any row that needs correction.");
  }
  return ok;
}

/* =========================================================
   Banding (interpretation)
========================================================= */
function bandFromIndex(x){
  if(x<20) return {label:"Low workload (per month)", cls:"ok"};
  if(x<45) return {label:"Normal workload (per month)", cls:"ok"};
  if(x<70) return {label:"High workload (per month)", cls:"warn"};
  return {label:"Overload risk (per month)", cls:"bad"};
}

/* =========================================================
   Narrative
========================================================= */
function narrative(scores, aw){
  const items = [
    ["Teaching", scores.Teaching, aw.Teaching, state.enabled.Teaching],
    ["Student Supervision", scores.Supervision, aw.Supervision, state.enabled.Supervision],
    ["Research", scores.Research, aw.Research, state.enabled.Research],
    ["Publication", scores.Publication, aw.Publication, state.enabled.Publication],
    ["Administration", scores.Administration, aw.Administration, state.enabled.Administration],
    ["Service & Engagement", scores.Services, aw.Services, state.enabled.Services],
    ["Laboratory Operations", scores.LabOps, aw.LabOps, state.enabled.LabOps],
    ["Professional & Scholarly Service", scores.ProSch, aw.ProSch, state.enabled.ProSch]
  ].filter(x=>x[3]);

  items.sort((a,b)=> (b[1]*b[2]) - (a[1]*a[2]));
  const top = items[0];
  const second = items[1] || null;
  const last = items[items.length-1];

  const topText = top ? `${top[0]} (weighted contribution ${(top[1]*top[2]).toFixed(1)})` : "—";
  const secondText = second ? `${second[0]} (${(second[1]*second[2]).toFixed(1)})` : "";
  const lowText = last ? `${last[0]} (weighted contribution ${(last[1]*last[2]).toFixed(1)})` : "—";

  return `Most of the workload is driven by ${topText}${secondText ? `, followed by ${secondText}` : ""}. The lowest contribution is from ${lowText}. This index measures workload intensity (busyness), not performance or quality.`;
}

function renderTopContributors(scores, aw){
  const items = [
    {label:"Teaching", value:scores.Teaching*aw.Teaching, enabled:state.enabled.Teaching},
    {label:"Student Supervision", value:scores.Supervision*aw.Supervision, enabled:state.enabled.Supervision},
    {label:"Research", value:scores.Research*aw.Research, enabled:state.enabled.Research},
    {label:"Publication", value:scores.Publication*aw.Publication, enabled:state.enabled.Publication},
    {label:"Administration", value:scores.Administration*aw.Administration, enabled:state.enabled.Administration},
    {label:"Service & Engagement", value:scores.Services*aw.Services, enabled:state.enabled.Services},
    {label:"Laboratory Operations", value:scores.LabOps*aw.LabOps, enabled:state.enabled.LabOps},
    {label:"Professional & Scholarly Service", value:scores.ProSch*aw.ProSch, enabled:state.enabled.ProSch}
  ].filter(x=>x.enabled);

  items.sort((a,b)=>b.value-a.value);
  const top = items.slice(0,3);
  const list = $("outTop3");
  list.innerHTML = "";
  if(top.length===0){
    const li = document.createElement("li");
    li.textContent = "—";
    list.appendChild(li);
    return;
  }
  top.forEach(item=>{
    const li = document.createElement("li");
    li.innerHTML = `<strong>${item.label}</strong> — ${item.value.toFixed(1)} weighted points`;
    list.appendChild(li);
  });
}

function deanViewSummary(index, band, aw){
  const labelMap = {
    Supervision:"Student Supervision",
    Services:"Service & Engagement",
    LabOps:"Laboratory Operations",
    ProSch:"Professional & Scholarly Service"
  };
  const on = Object.entries(state.enabled)
    .filter(([k,v])=>v)
    .map(([k])=>labelMap[k] || k)
    .join(", ");
  const w = Object.entries(aw)
    .filter(([k,v])=>v>0)
    .map(([k,v])=>`${labelMap[k] || k}:${v.toFixed(2)}`)
    .join(" | ");
  const bm = benchmarkText(index);

  return `Name: ${state.profile.name} | Staff ID: ${state.profile.staffId} | Category: ${state.profile.category} | Reporting Period: ${state.profile.period} | Sections ON: ${on} | Normalized weights: ${w} | Busyness Index (points per month): ${index.toFixed(1)} (${band.label}) | Benchmark: ${bm}`;
}

/* =========================================================
   Chart
========================================================= */
function drawChart(scores, aw){
  const labels=[], vals=[], colors=[];
  const palette = {
    Teaching: "rgba(124,157,255,0.82)",
    Supervision: "rgba(60,201,255,0.82)",
    Research: "rgba(50,210,156,0.82)",
    Publication: "rgba(240,148,196,0.82)",
    Administration: "rgba(242,180,74,0.82)",
    Services: "rgba(251,136,152,0.82)",
    LabOps: "rgba(67,211,137,0.82)",
    ProSch: "rgba(160,170,190,0.82)"
  };
  const pushIf=(on,label,raw,w,color)=>{
    if(!on) return;
    labels.push(label);
    vals.push(raw*w);
    colors.push(color);
  };

  pushIf(state.enabled.Teaching, "Teaching", scores.Teaching, aw.Teaching, palette.Teaching);
  pushIf(state.enabled.Supervision, "Student Supervision", scores.Supervision, aw.Supervision, palette.Supervision);
  pushIf(state.enabled.Research, "Research", scores.Research, aw.Research, palette.Research);
  pushIf(state.enabled.Publication, "Publication", scores.Publication, aw.Publication, palette.Publication);
  pushIf(state.enabled.Administration, "Administration", scores.Administration, aw.Administration, palette.Administration);
  pushIf(state.enabled.Services, "Service & Engagement", scores.Services, aw.Services, palette.Services);
  pushIf(state.enabled.LabOps, "Laboratory Operations", scores.LabOps, aw.LabOps, palette.LabOps);
  pushIf(state.enabled.ProSch, "Professional & Scholarly Service", scores.ProSch, aw.ProSch, palette.ProSch);

  const ctx=$("chart").getContext("2d");
  if(chart) chart.destroy();
  chart=new Chart(ctx,{
    type:"bar",
    data:{ labels, datasets:[{ label:"Weighted contribution (section points per month × normalized weight)", data:vals, backgroundColor:colors, borderColor:colors, borderWidth:1 }] },
    options:{
      responsive:true,
      plugins:{ legend:{ labels:{ color:"#eaf0ff"} } },
      scales:{
        x:{ ticks:{ color:"#eaf0ff"} , grid:{ color:"rgba(255,255,255,.08)" } },
        y:{ ticks:{ color:"#eaf0ff"} , grid:{ color:"rgba(255,255,255,.08)" } }
      }
    }
  });
}

/* =========================================================
   Calculate
========================================================= */
function calculate(){
  hideMsg();
  syncProfileFromUI();
  syncEnabledFromUI();
  syncSettingsFromUI_ifAdmin();

  if(!validateProfile()) return;
  if(!validateToggles()) return;
  applySectionVisibility();
  renderAll();

  if(!validateWeightsBaseline_ifAdmin()){
    showMsg("warn","<b>Settings validation:</b> Fix weights so baseline sum is 1.00.");
    return;
  }
  if(!validateActivityTables()) return;

  const aw = getActiveWeights();
  if(!aw){
    showMsg("bad","<b>Error:</b> Active weights are zero. Turn ON sections and ensure weights are not all zero.");
    return;
  }

  const raw = {
    Teaching: state.enabled.Teaching ? scoreTeaching_raw() : 0,
    Supervision: state.enabled.Supervision ? scoreSupervision_raw() : 0,
    Research: state.enabled.Research ? scoreResearch_raw() : 0,
    Publication: state.enabled.Publication ? scorePublication_raw() : 0,
    Administration: state.enabled.Administration ? scoreAdministration_raw() : 0,
    Services: state.enabled.Services ? scoreServices_raw() : 0,
    LabOps: state.enabled.LabOps ? scoreLabOps_raw() : 0,
    ProSch: state.enabled.ProSch ? scoreProSch_raw() : 0
  };

  const scores = {
    Teaching: state.enabled.Teaching ? normalizeAndCap("Teaching", raw.Teaching) : 0,
    Supervision: state.enabled.Supervision ? normalizeAndCap("Supervision", raw.Supervision) : 0,
    Research: state.enabled.Research ? normalizeAndCap("Research", raw.Research) : 0,
    Publication: state.enabled.Publication ? normalizeAndCap("Publication", raw.Publication) : 0,
    Administration: state.enabled.Administration ? normalizeAndCap("Administration", raw.Administration) : 0,
    Services: state.enabled.Services ? normalizeAndCap("Services", raw.Services) : 0,
    LabOps: state.enabled.LabOps ? normalizeAndCap("LabOps", raw.LabOps) : 0,
    ProSch: state.enabled.ProSch ? normalizeAndCap("ProSch", raw.ProSch) : 0
  };

  $("outTeaching").textContent = scores.Teaching.toFixed(1);
  $("outSupervision").textContent = scores.Supervision.toFixed(1);
  $("outResearch").textContent = scores.Research.toFixed(1);
  $("outPublication").textContent = scores.Publication.toFixed(1);
  $("outAdministration").textContent = scores.Administration.toFixed(1);
  $("outServices").textContent = scores.Services.toFixed(1);
  $("outLabOps").textContent = scores.LabOps.toFixed(1);
  $("outProSch").textContent = scores.ProSch.toFixed(1);

  const rawIndex =
    (scores.Teaching*aw.Teaching) +
    (scores.Supervision*aw.Supervision) +
    (scores.Research*aw.Research) +
    (scores.Publication*aw.Publication) +
    (scores.Administration*aw.Administration) +
    (scores.Services*aw.Services) +
    (scores.LabOps*aw.LabOps) +
    (scores.ProSch*aw.ProSch);

  const index = clamp(rawIndex, 0, 100);

  $("outIndex").textContent = index.toFixed(1);
  const b = bandFromIndex(index);
  $("outBand").textContent = b.label;

  $("outNarr").textContent = narrative(scores, aw);
  $("outDean").textContent = deanViewSummary(index, b, aw);
  renderTopContributors(scores, aw);

  updateBenchmarkUI(index);
  drawChart(scores, aw);
  renderEligibilityCard();

  state.audit.last_calc_at = new Date().toISOString();
  autosave();

  showMsg("ok", `<b>Calculated:</b> Busyness Index = <b>${index.toFixed(1)}</b> (${b.label}). Scores are normalized to points per month and apply diminishing returns (soft caps).`);
}

/* =========================================================
   Print helpers
========================================================= */
function syncPrintFields(){
  const name = (state.profile.name||"").trim();
  const id = (state.profile.staffId||"").trim();
  $("printName").textContent = name;
  $("printId").textContent = id;
  $("printDate").textContent = new Date().toLocaleString();
  $("printFooterDate").textContent = new Date().toLocaleDateString();
  $("printEligibility").textContent = eligibilityPrintText();
}
</script>

<script>
/* =========================================================
   EXPORT
========================================================= */
function download(filename, content, mime="text/plain"){
  const blob = new Blob([content], {type:mime});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href=url; a.download=filename; a.click();
  setTimeout(()=>URL.revokeObjectURL(url), 1500);
}

function exportSummaryCSV(){
  const aw = getActiveWeights() || {};
  const rows = [
    ["timestamp", new Date().toISOString()],
    ["name", state.profile.name],
    ["staff_id", state.profile.staffId],
    ["category", state.profile.category],
    ["unit", state.profile.unit],
    ["grade", (state.profile.grade==="Others")?state.profile.gradeOther:state.profile.grade],
    ["status", (state.profile.status==="Others")?state.profile.statusOther:state.profile.status],
    ["reporting_period", state.profile.period],
    ["months_in_period", periodMonths(state.profile.period)],
    ["enabled_sections", JSON.stringify(state.enabled)],
    ["baseline_weights", JSON.stringify(state.weights)],
    ["active_weights_normalized", JSON.stringify(aw)],
    ["Teaching_points_per_month", $("outTeaching").textContent],
    ["Supervision_points_per_month", $("outSupervision").textContent],
    ["Research_points_per_month", $("outResearch").textContent],
    ["Publication_points_per_month", $("outPublication").textContent],
    ["Administration_points_per_month", $("outAdministration").textContent],
    ["Services_points_per_month", $("outServices").textContent],
    ["Lab_Operations_points_per_month", $("outLabOps").textContent],
    ["Professional_and_Scholarly_Service_points_per_month", $("outProSch").textContent],
    ["busyness_index_points_per_month", $("outIndex").textContent],
    ["band", $("outBand").textContent],
    ["benchmark_avg", String(state.benchmarks?.avg ?? "")],
    ["benchmark_p25", String(state.benchmarks?.p25 ?? "")],
    ["benchmark_p50", String(state.benchmarks?.p50 ?? "")],
    ["benchmark_p75", String(state.benchmarks?.p75 ?? "")]
  ];
  const csv = rows.map(r=>r.map(x=>`"${String(x).replaceAll('"','""')}"`).join(",")).join("\n");
  download("FST_UMS_Busyness_Summary.csv", csv, "text/csv");
}

function exportDetailedCSV(){
  const lines = [];
  const pushSection = (name, arr)=>{
    lines.push(`SECTION,${name}`);
    if(!arr || arr.length===0){ lines.push("EMPTY"); lines.push(""); return; }
    const keys = Object.keys(arr[0]);
    lines.push(keys.join(","));
    arr.forEach(o=>{
      lines.push(keys.map(k=>`"${String(o[k]??"").replaceAll('"','""')}"`).join(","));
    });
    lines.push("");
  };

  pushSection("Teaching", state.data.teaching);
  pushSection("Supervision", state.data.supervision);
  pushSection("Research", state.data.research);
  pushSection("Publication", state.data.publication);
  pushSection("Administration", state.data.admin);
  pushSection("Services", state.data.service);
  pushSection("Lab Operations", state.data.lab);
  pushSection("Professional & Scholarly Service", state.data.prosch);

  download("FST_UMS_Busyness_Detailed.csv", lines.join("\n"), "text/csv");
}

function exportJSON(){
  const payload = {
    meta:{ generated_at:new Date().toISOString(), app:"FST UMS Staff Busyness Index", version:"2.0" },
    profile: state.profile,
    enabled_sections: state.enabled,
    baseline_weights: state.weights,
    active_weights_normalized: getActiveWeights(),
    scheme: state.scheme,
    benchmarks: state.benchmarks,
    period_months: periodMonths(state.profile.period),
    data: state.data,
    eligibility: (()=> {
      const result = computeTutorDemoEligibility();
      if(!result.enabled){
        return {
          enabled:false,
          staffCategory: state.profile.staffCategory || "nonadmin",
          teaching:null,
          supervision:null,
          ES:null,
          thresholdUsed:null,
          eligible:null,
          delta:null
        };
      }
      return {
        enabled:true,
        staffCategory: result.staffCategory,
        teaching: result.teaching,
        supervision: result.supervision,
        ES: result.ES,
        thresholdUsed: result.thresholdUsed,
        eligible: result.eligible,
        delta: result.delta
      };
    })(),
    results:{
      Teaching_points_per_month: $("outTeaching").textContent,
      Supervision_points_per_month: $("outSupervision").textContent,
      Research_points_per_month: $("outResearch").textContent,
      Publication_points_per_month: $("outPublication").textContent,
      Administration_points_per_month: $("outAdministration").textContent,
      Services_points_per_month: $("outServices").textContent,
      Lab_Operations_points_per_month: $("outLabOps").textContent,
      Professional_and_Scholarly_Service_points_per_month: $("outProSch").textContent,
      busyness_index_points_per_month: $("outIndex").textContent,
      band: $("outBand").textContent,
      benchmark_text: $("outBenchmark").textContent,
      dean_summary: $("outDean").textContent,
      narrative: $("outNarr").textContent
    },
    audit: state.audit
  };
  download("FST_UMS_Busyness_Full.json", JSON.stringify(payload,null,2), "application/json");
}

/* =========================================================
   MANUAL PDF (Professional)
========================================================= */
function manualPDF(){
  const jsPDFLib = (window.jspdf && window.jspdf.jsPDF) || window.jsPDF;
  if(!jsPDFLib){
    showMsg("bad", "PDF generator not loaded. Please check your connection and try again.");
    return;
  }

  const doc = new jsPDFLib({unit:"pt", format:"a4"});
  const W = doc.internal.pageSize.getWidth();
  const H = doc.internal.pageSize.getHeight();
  const m = 44;
  let y = 48;

  const setBody = ()=>{ doc.setFont("helvetica","normal"); doc.setFontSize(11); doc.setTextColor(0,0,0); };
  const setSmall = ()=>{ doc.setFont("helvetica","normal"); doc.setFontSize(9); doc.setTextColor(60,60,60); };
  const setSubhead = ()=>{ doc.setFont("helvetica","bold"); doc.setFontSize(11); doc.setTextColor(0,0,0); };

  const newPageIfNeeded = (hNeed=0)=>{
    if(y + hNeed > H - m){
      doc.addPage();
      y = m;
    }
  };

  const hr = ()=>{
    newPageIfNeeded(12);
    doc.setDrawColor(180,180,180);
    doc.setLineWidth(0.8);
    doc.line(m, y, W-m, y);
    y += 12;
  };

  const headerBox = (title)=>{
    newPageIfNeeded(44);
    doc.setFillColor(235,235,235);
    doc.setDrawColor(160,160,160);
    doc.setLineWidth(0.8);
    doc.rect(m, y, W-m*2, 26, "FD");
    doc.setFont("helvetica","bold");
    doc.setFontSize(12);
    doc.setTextColor(0,0,0);
    doc.text(title, m+10, y+17);
    y += 36;
  };

  const paragraph = (text, fontSize=11)=>{
    setBody();
    doc.setFontSize(fontSize);
    const lines = doc.splitTextToSize(text, W - m*2);
    lines.forEach(line=>{
      newPageIfNeeded(fontSize+8);
      doc.text(line, m, y);
      y += fontSize + 6;
    });
  };

  const formula = (text)=>{
    newPageIfNeeded(18);
    doc.setFont("courier","normal");
    doc.setFontSize(10);
    doc.setTextColor(0,0,0);
    const lines = doc.splitTextToSize(text, W - m*2);
    lines.forEach(line=>{
      newPageIfNeeded(16);
      doc.text(line, m, y);
      y += 14;
    });
    setBody();
  };

  const bullet = (items)=>{
    items.forEach(it=>{
      const lines = doc.splitTextToSize(it, W - m*2 - 18);
      lines.forEach((ln,idx)=>{
        newPageIfNeeded(16);
        doc.setFont("helvetica","normal"); doc.setFontSize(11);
        doc.text(idx===0 ? "•" : " ", m, y);
        doc.text(ln, m+14, y);
        y += 14;
      });
    });
  };

  const subhead = (text)=>{
    newPageIfNeeded(18);
    setSubhead();
    doc.text(text, m, y);
    y += 16;
    setBody();
  };

  doc.setFont("helvetica","bold"); doc.setFontSize(16); doc.setTextColor(0,0,0);
  doc.text("FST UMS Staff Busyness Index", m, y); y+=18;
  doc.setFont("helvetica","normal"); doc.setFontSize(11);
  doc.text("Calculation Manual (Points per Month, with Soft Caps)", m, y); y+=14;
  setSmall();
  doc.text("This tool measures busyness (workload intensity) based on activities and time/effort proxies. It does not measure performance or quality.", m, y); y+=18;
  hr();

  headerBox("1. Purpose & How to Use");
  paragraph("This manual explains required fields, scoring logic, soft caps and worked examples for Academic, Administrative and Laboratory staff categories. The index captures workload intensity only.");
  bullet([
    "Choose reporting period (Monthly, Quarterly, Semester, Annual). All section scores are normalized to points per month.",
    "Select Category preset to auto-set ON/OFF sections and baseline weights. You may still toggle sections if needed.",
    "Fill required fields (marked *) in each section, then click Calculate. Use Print for a B/W summary or Export for CSV/JSON.",
    "Advanced settings can be unlocked locally to adjust baseline weights, caps and scoring parameters."
  ]);
  hr();

  headerBox("2. Required Fields & Data Entry");
  paragraph("Complete these inputs before calculating. Required fields are marked * inside the calculator.");
  bullet([
    "Profile: Name, Staff ID, Category (Academic / Administrative / Laboratory), Unit/School/Department, Grade (or Other + text), Status (or Other + text), Reporting Period.",
    "Section toggles: Turn ON only relevant sections. Category presets update ON/OFF and baseline weights automatically.",
    "Teaching: Course code and name, enrolled students, lecture/tutorial/lab/field contact hours, start/end. Credit is auto-read from the last digit of the course code; contact hours auto-sum.",
    "Student Supervision: Level (Undergraduate, Master, PhD), student/project title, role (Main/Co), status (Active/Completed/Applied), start/end.",
    "Research (Grants/Projects): Grant code, title, level (University/National/International), status, role (PI/Co-I/Member), amount (RM), start/end.",
    "Publication: Year, title, type (Journal/Book-Chapter/Proceeding/Other), indexed? (Yes/No), role (First/Corresponding/Co-Author), start/end.",
    "Administration: Position, type (Official/Other), level (Programme to Industry), months in role, meetings, workload notes, start/end.",
    "Service & Engagement: Service type, activity, role (Lead/Member), hours, participants, start/end.",
    "Laboratory Operations: Type, description, volume, complexity, urgency, hours, start/end. Turn ON for Laboratory staff or roles with lab duties.",
    "Professional & Scholarly Service: Activity type (Reviewer/Editor/Examiner/Committee), description, role, quantity, rounds, complexity, urgency, hours, start/end."
  ]);
  hr();

  headerBox("3. Calculation Pipeline");
  bullet([
    "A) Raw section score: computed per section using workload proxies (hours, students, rounds, meetings, etc.).",
    "B) Period normalization: raw section score / months_in_period (points per month).",
    "C) Soft caps (diminishing returns): prevent inflation when a section is extremely large.",
    "D) Weighting: normalized weights use only ON sections. Sum of normalized weights = 1.",
    "E) Clamp: final index is clamped between 0 and 100 points per month (for display consistency)."
  ]);
  formula(`months_in_period = { Monthly:1, Quarterly:3, Semester:6, Annual:12 }
section_points_per_month = section_points_total / months_in_period
soft_cap(x, cap, tail) = (x <= cap) ? x : cap + (x - cap) * tail    (0 < tail < 1)
normalized_weight_i = baseline_weight_i / sum(baseline weights for ON sections)
index = sum(adjusted_section_points_per_month_i * normalized_weight_i)
final_index = clamp(index, 0, 100)`);
  hr();

  headerBox("4. Section Formulas (Busyness-based)");
  formula(
`Teaching = sum[(contact_hours * hourW) + ((students/100) * studW) + (credit * creditW)]
Student Supervision = sum[base(level) * role_multiplier * status_multiplier]
Research = sum[base * level_multiplier * role_multiplier * status_multiplier]
Publication = sum[base * type_multiplier * indexed_multiplier * role_multiplier]
Administration = sum[(base(level) + meetings * meetW + months * monthW) * type_multiplier]
Service & Engagement = sum[(hours * hourW) + ((participants/10) * paxW) + role_bonus]
Lab Operations = sum[(volume * volW + hours * hourW) * complexity_multiplier * urgency_multiplier]
Professional & Scholarly Service = sum[((base * quantity * rounds) + hours) * role_multiplier * complexity_multiplier * urgency_multiplier]`);
  hr();

  headerBox("5. Soft Caps (after monthly normalization)");
  paragraph("Caps are applied per section with tail rates (diminishing returns beyond the cap).");
  formula(
`Teaching cap=35, tail=0.40
Student Supervision cap=25, tail=0.45
Research cap=30, tail=0.45
Publication cap=20, tail=0.50
Administration cap=35, tail=0.45
Service & Engagement cap=25, tail=0.50
Laboratory Operations cap=35, tail=0.45
Professional & Scholarly Service cap=25, tail=0.50`);
  hr();

  headerBox("6. Worked Examples by Staff Category (using default presets)");
  paragraph("Examples use current default scoring parameters (version 2.0). Points shown are already normalized to the selected reporting period.");

  subhead("Academic (period: Monthly; sections ON: Teaching, Student Supervision, Research, Publication, Administration, Service & Engagement, ProSch)");
  paragraph("Baseline weights: Teaching 0.28, Student Supervision 0.14, Research 0.20, Publication 0.10, Administration 0.12, Service & Engagement 0.08, Professional & Scholarly Service 0.08.");
  formula(
`Data entered:
- Teaching: 2 courses -> 10.12 pts (contact hours + students + credits)
- Student Supervision: 2 Master (Main, Active) + 1 PhD (Main, Active) -> 10.50 pts
- Research: 1 National grant (PI, Active) -> 13.44 pts
- Publication: 2 indexed journal papers (First/Corresponding) -> 20.16 raw -> 20.08 after cap (cap 20, tail 0.50)
- Administration: Faculty appointment (12 months, 4 meetings) -> 14.60 pts
- Service & Engagement: Lead outreach (10 hours, 60 pax) -> 18.80 pts
- Professional & Scholarly Service: Reviewer (3 manuscripts, 2 rounds, High complexity, Tight urgency, +5 hours) -> 46.00 raw -> 35.50 after cap (cap 25, tail 0.50)
 Index = (10.12*0.28)+(10.50*0.14)+(13.44*0.20)+(20.08*0.10)+(14.60*0.12)+(18.80*0.08)+(35.50*0.08)
 Index ≈ 15.10 points per month`);

  subhead("Administrative (period: Quarterly = 3 months; sections ON: Administration, Service & Engagement, ProSch)");
  paragraph("Baseline weights: Administration 0.55, Service & Engagement 0.30, Professional & Scholarly Service 0.15.");
  formula(
`Data entered:
- Administration: 2 roles (Faculty level: 3 months, 8 meetings; University level: 3 months, 4 meetings) -> 31.80 raw -> 10.60 per month
- Service & Engagement: Lead outreach (15 hours, 120 pax) + Member support (6 hours, 40 pax) -> 39.30 raw -> 13.10 per month
- Professional & Scholarly Service: External examiner (2 rounds, High complexity, Normal urgency, +6 hours, Lead) -> 24.96 raw -> 8.32 per month
 Index = (10.60*0.55) + (13.10*0.30) + (8.32*0.15)
 Index ≈ 11.00 points per month`);

  subhead("Laboratory (period: Monthly; sections ON: Administration, Service & Engagement, Laboratory Operations, ProSch)");
  paragraph("Baseline weights: Administration 0.40, Service & Engagement 0.20, Laboratory Operations 0.30, Professional & Scholarly Service 0.10.");
  formula(
`Data entered:
- Laboratory Operations: Equipment maintenance (vol=25, hrs=14, Medium, Tight) + Sample processing (vol=40, hrs=20, High, Critical) -> 207.38 raw -> 112.57 after cap (cap 35, tail 0.45)
- Administration: Lab safety officer (12 months, 4 meetings, Faculty level) -> 14.60 pts
- Service & Engagement: Training session (Lead, 8 hours, 30 participants) -> 14.40 pts
- Professional & Scholarly Service: 2 reviews (1 round, Medium complexity, Normal urgency, +4 hours) -> 13.00 pts
 Index = (112.57*0.30) + (14.60*0.40) + (14.40*0.20) + (13.00*0.10)
 Index ≈ 43.79 points per month`);

  subhead("Exports & Evidence");
  bullet([
    "Use Print for a clean black-and-white PDF (hides settings).",
    "Export Summary CSV for monthly-normalized section totals; Detailed CSV for row-level data; Full JSON for all inputs, weights and outputs.",
    "For auditability, keep start/end dates and workload notes clear and specific."
  ]);

  setSmall();
  paragraph("© Faculty of Science and Technology (FST), Universiti Malaysia Sabah (UMS).", 9);

  doc.save("FST_UMS_Busyness_Index_Manual.pdf");
}
/* =========================================================
   STORAGE
========================================================= */
function autosave(){
  state.audit.last_saved_at = new Date().toISOString();
  localStorage.setItem("fst_busyness_v2", JSON.stringify(state));
}
function saveNow(){
  syncProfileFromUI();
  syncEnabledFromUI();
  syncSettingsFromUI_ifAdmin();
  autosave();
  showMsg("ok","<b>Saved locally:</b> Data stored in your browser (localStorage).");
}
function loadLocal(){
  const raw = localStorage.getItem("fst_busyness_v2");
  if(!raw) return;
  try{
    const obj = JSON.parse(raw);

    // Merge safely to keep new defaults if missing
    if(obj.profile) state.profile = {...state.profile, ...obj.profile};
    if(obj.enabled) state.enabled = {...state.enabled, ...obj.enabled};
    if(obj.weights) state.weights = {...state.weights, ...obj.weights};
    if(obj.scheme) state.scheme = {...state.scheme, ...obj.scheme};
    if(obj.benchmarks) state.benchmarks = {...state.benchmarks, ...obj.benchmarks};
    if(obj.eligibility) state.eligibility = {...state.eligibility, ...obj.eligibility};
    if(obj.data) state.data = {...state.data, ...obj.data};
    if(obj.audit) state.audit = {...state.audit, ...obj.audit};
  }catch(e){}
}

/* =========================================================
   RESET
========================================================= */
function resetAll(){
  if(!confirm("Reset all data? This will clear local saved data for this tool on this browser.")) return;
  localStorage.removeItem("fst_busyness_v2");
  location.reload();
}

/* =========================================================
   INIT
========================================================= */
function init(){
  loadLocal();
  syncUIFromState();
  applySectionVisibility();
  renderAll();
  modalInit();
  setupTabs();
  setAdminUI();
  updateBenchmarkUI(null);
  renderEligibilityCard();

  $("pGrade").addEventListener("change", ()=>{
    $("pGradeOtherWrap").style.display = ($("pGrade").value==="Others") ? "block" : "none";
    autosave();
  });
  $("pStatus").addEventListener("change", ()=>{
    $("pStatusOtherWrap").style.display = ($("pStatus").value==="Others") ? "block" : "none";
    autosave();
  });
  $("pStaffCategory").addEventListener("change", ()=>{
    syncProfileFromUI();
    renderEligibilityCard();
    autosave();
  });

  // Category template
  $("pCategory").addEventListener("change", ()=>{
    syncProfileFromUI();
    if(state.profile.category) applyTemplateByCategory(state.profile.category);
  });

  // Toggles
  ["enTeaching","enSupervision","enResearch","enPublication","enAdministration","enServices","enLabOps","enProSch"].forEach(id=>{
    $(id).addEventListener("change", ()=>{
      syncEnabledFromUI();
      applySectionVisibility();
      autosave();
    });
  });

  // Advanced settings
  $("btnAdminUnlock").addEventListener("click",(e)=>{ e.preventDefault(); unlockAdmin(); });
  $("btnAdminLock").addEventListener("click",(e)=>{ e.preventDefault(); lockAdmin(); });

  // Add/Clear
  $("addTeach").onclick=(e)=>{e.preventDefault(); openAddModal("teach");};
  $("clearTeach").onclick=(e)=>{e.preventDefault(); clearKind("teach");};

  $("addSv").onclick=(e)=>{e.preventDefault(); openAddModal("sv");};
  $("clearSv").onclick=(e)=>{e.preventDefault(); clearKind("sv");};

  $("addRes").onclick=(e)=>{e.preventDefault(); syncProfileFromUI(); openAddModal("res");};
  $("clearRes").onclick=(e)=>{e.preventDefault(); clearKind("res");};

  $("addPub").onclick=(e)=>{e.preventDefault(); syncProfileFromUI(); openAddModal("pub");};
  $("clearPub").onclick=(e)=>{e.preventDefault(); clearKind("pub");};

  $("addAdmin").onclick=(e)=>{e.preventDefault(); openAddModal("admin");};
  $("clearAdmin").onclick=(e)=>{e.preventDefault(); clearKind("admin");};

  $("addSvc").onclick=(e)=>{e.preventDefault(); openAddModal("svc");};
  $("clearSvc").onclick=(e)=>{e.preventDefault(); clearKind("svc");};

  $("addLab").onclick=(e)=>{e.preventDefault(); openAddModal("lab");};
  $("clearLab").onclick=(e)=>{e.preventDefault(); clearKind("lab");};

  $("addProSch").onclick=(e)=>{e.preventDefault(); openAddModal("ps");};
  $("clearProSch").onclick=(e)=>{e.preventDefault(); clearKind("ps");};

  // Calculate / Print / Manual / Export
  $("btnCalc").onclick=(e)=>{e.preventDefault(); calculate();};

  $("btnPrint").onclick=(e)=>{
    e.preventDefault();
    syncProfileFromUI();
    syncPrintFields();
    window.print();
  };

  $("btnManual").onclick=(e)=>{e.preventDefault(); manualPDF();};

  const exportToggle = $("btnExportToggle");
  const exportMenu = $("exportMenu");
  const closeExportMenu = ()=>{
    exportMenu.classList.remove("open");
    exportToggle.setAttribute("aria-expanded","false");
  };
  exportToggle.onclick=(e)=>{
    e.preventDefault();
    const isOpen = exportMenu.classList.toggle("open");
    exportToggle.setAttribute("aria-expanded", String(isOpen));
  };
  document.addEventListener("click",(e)=>{
    if(!exportMenu.contains(e.target) && !exportToggle.contains(e.target)){
      closeExportMenu();
    }
  });
  document.addEventListener("keydown",(e)=>{
    if(e.key==="Escape") closeExportMenu();
  });

  $("btnExportSummaryCSV").onclick=(e)=>{e.preventDefault(); exportSummaryCSV(); closeExportMenu();};
  $("btnExportDetailedCSV").onclick=(e)=>{e.preventDefault(); exportDetailedCSV(); closeExportMenu();};
  $("btnExportJSON").onclick=(e)=>{e.preventDefault(); exportJSON(); closeExportMenu();};

  // Save / Reset
  $("btnSaveLocal").onclick=(e)=>{e.preventDefault(); saveNow();};
  $("btnReset").onclick=(e)=>{e.preventDefault(); resetAll();};

  // Presets (admin only)
  $("btnPresetAcademic").onclick=(e)=>{e.preventDefault(); if(!isAdmin) return; applyTemplateByCategory("Academic");};
  $("btnPresetAdmin").onclick=(e)=>{e.preventDefault(); if(!isAdmin) return; applyTemplateByCategory("Administrative");};
  $("btnPresetLab").onclick=(e)=>{e.preventDefault(); if(!isAdmin) return; applyTemplateByCategory("Laboratory");};

  hideMsg();
}
document.addEventListener("DOMContentLoaded", init);
</script>

</body>
</html>
