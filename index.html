<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FST UMS Staff Busyness Index</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --bg0:#070A14;
      --bg1:#0B1022;
      --text:#ECF2FF;
      --muted:#B9C7FF;
      --line: rgba(255,255,255,.14);
      --shadow: 0 16px 40px rgba(0,0,0,.40);
      --radius:18px;

      /* Section accents */
      --c-profile:#60A5FA;
      --c-settings:#22C55E;
      --c-teaching:#A78BFA;
      --c-supervision:#38BDF8;
      --c-research:#34D399;
      --c-publication:#F472B6;
      --c-admin:#FBBF24;
      --c-service:#FB7185;
      --c-results:#2DD4BF;

      --danger:#FB7185;
      --warn:#FBBF24;
      --ok:#34D399;
      --info:#60A5FA;
    }

    *{ box-sizing:border-box; font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif; }
    body{
      margin:0;
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 15% 0%, rgba(96,165,250,.28) 0%, rgba(7,10,20,0) 55%),
        radial-gradient(900px 600px at 80% 8%, rgba(34,197,94,.18) 0%, rgba(7,10,20,0) 55%),
        linear-gradient(180deg, var(--bg1), var(--bg0));
      background-attachment: fixed;
    }
    .wrap{ max-width: 1200px; margin: 18px auto; padding: 14px; }

    .top{
      display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap;
      padding: 14px 16px;
      border-radius: var(--radius);
      border: 1px solid rgba(255,255,255,.14);
      background: linear-gradient(135deg, rgba(96,165,250,.18), rgba(45,212,191,.12));
      box-shadow: var(--shadow);
    }
    .brand{ display:flex; align-items:center; gap:12px; min-width: 260px; }
    .logo{
      width:56px; height:56px; border-radius: 16px;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.14);
      overflow:hidden; display:flex; align-items:center; justify-content:center;
    }
    .logo img{ width:100%; height:100%; object-fit:contain; padding:6px; }
    .tbox h1{ margin:0; font-size:1.12rem; font-weight: 950; letter-spacing:.2px; }
    .tbox p{ margin:4px 0 0; color: var(--muted); font-size:.88rem; }

    .mode{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end; }
    .pill{
      display:inline-flex; gap:8px; align-items:center;
      padding: 7px 10px; border-radius: 999px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      font-size:.82rem; font-weight: 900;
    }
    .dot{ width:9px; height:9px; border-radius:999px; background: var(--ok); }

    .btn{
      border:none; cursor:pointer;
      padding: 9px 12px;
      border-radius: 999px;
      font-weight: 950;
      color: var(--text);
      background: rgba(96,165,250,.18);
      border:1px solid rgba(96,165,250,.42);
    }
    .btn.secondary{ background: rgba(45,212,191,.16); border-color: rgba(45,212,191,.42); }
    .btn.ghost{ background: transparent; border-color: rgba(255,255,255,.18); color: var(--muted); }
    .btn.warn{ background: rgba(251,191,36,.14); border-color: rgba(251,191,36,.45); }
    .btn.danger{ background: rgba(251,113,133,.14); border-color: rgba(251,113,133,.45); }
    .btn:active{ transform: translateY(1px); }

    .notice{
      margin-top: 14px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: rgba(236,242,255,.92);
      line-height: 1.45;
      font-size:.92rem;
    }
    .notice.bad{ border-color: rgba(251,113,133,.45); background: rgba(251,113,133,.10); }
    .notice.warn{ border-color: rgba(251,191,36,.45); background: rgba(251,191,36,.10); }
    .notice.ok{ border-color: rgba(52,211,153,.45); background: rgba(52,211,153,.08); }

    /* Section base */
    .section{
      margin-top: 14px;
      border-radius: var(--radius);
      border: 1px solid rgba(255,255,255,.14);
      box-shadow: var(--shadow);
      overflow:hidden;
      background: rgba(255,255,255,.05);
    }
    .section header{
      padding: 12px 14px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
    }
    .section h2{ margin:0; font-size:1.03rem; font-weight: 1000; }
    .sub{ color: var(--muted); font-size: .86rem; margin-top:3px; }
    .content{ padding: 12px 14px; }

    /* FULL background colour per section (as requested) */
    .profile{ background: linear-gradient(180deg, rgba(96,165,250,.14), rgba(255,255,255,.04)); }
    .settings{ background: linear-gradient(180deg, rgba(34,197,94,.14), rgba(255,255,255,.04)); }
    .teaching{ background: linear-gradient(180deg, rgba(167,139,250,.16), rgba(255,255,255,.04)); }
    .supervision{ background: linear-gradient(180deg, rgba(56,189,248,.16), rgba(255,255,255,.04)); }
    .research{ background: linear-gradient(180deg, rgba(52,211,153,.14), rgba(255,255,255,.04)); }
    .publication{ background: linear-gradient(180deg, rgba(244,114,182,.14), rgba(255,255,255,.04)); }
    .admin{ background: linear-gradient(180deg, rgba(251,191,36,.14), rgba(255,255,255,.04)); }
    .service{ background: linear-gradient(180deg, rgba(251,113,133,.14), rgba(255,255,255,.04)); }
    .results{ background: linear-gradient(180deg, rgba(45,212,191,.14), rgba(255,255,255,.04)); }

    .grid{ display:grid; grid-template-columns: repeat(4, minmax(0,1fr)); gap: 10px; }
    @media (max-width: 980px){ .grid{ grid-template-columns: repeat(2, minmax(0,1fr)); } }
    @media (max-width: 520px){ .grid{ grid-template-columns: 1fr; } }

    label{ display:block; font-size:.78rem; color: var(--muted); margin: 0 0 5px; }
    input, select, textarea{
      width:100%;
      border-radius: 12px;
      padding: 9px 10px;
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.18);
      color: var(--text);
      outline: none;
    }
    textarea{ min-height: 44px; resize: vertical; }
    input::placeholder, textarea::placeholder{ color: rgba(236,242,255,.45); }
    input:focus, select:focus, textarea:focus{
      border-color: rgba(45,212,191,.55);
      box-shadow: 0 0 0 2px rgba(45,212,191,.16);
    }

    .otherWrap{ display:none; margin-top:8px; }
    .requiredMark::after{ content:" *"; color: var(--warn); font-weight: 1000; }

    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .row.right{ justify-content:flex-end; }
    .hr{ height:1px; background: rgba(255,255,255,.12); margin: 12px 0; }

    table{
      width:100%;
      border-collapse: separate;
      border-spacing: 0;
      margin-top: 10px;
      overflow:hidden;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.16);
    }
    thead th{
      text-align:left;
      padding: 9px 10px;
      font-size:.78rem;
      color: rgba(236,242,255,.95);
      border-bottom: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.10);
    }
    tbody td{
      padding: 8px 10px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.10);
      vertical-align: top;
    }
    tbody tr:last-child td{ border-bottom:none; }

    .miniinput{ font-size:.86rem; padding: 8px 9px; border-radius: 10px; }
    .err{ border-color: rgba(251,113,133,.85) !important; box-shadow: 0 0 0 2px rgba(251,113,133,.14) !important; }

    .kpi{ display:grid; grid-template-columns: repeat(6, minmax(0,1fr)); gap: 10px; margin-top: 10px; }
    @media (max-width: 980px){ .kpi{ grid-template-columns: repeat(2, minmax(0,1fr)); } }

    .box{
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.10);
      padding: 10px;
    }
    .k{ font-size:.78rem; color: var(--muted); }
    .v{ font-size: 1.15rem; font-weight: 1000; margin-top: 3px; }
    .s{ font-size: .78rem; color: rgba(236,242,255,.70); margin-top:2px; }

    .zone{
      display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
      margin-top:10px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.10);
    }
    .big{ font-size: 2.2rem; font-weight: 1100; letter-spacing:.4px; }
    .tag{
      display:inline-flex; align-items:center; gap:8px;
      padding: 7px 10px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.18);
      font-weight: 1000;
    }
    .tag.low{ background: rgba(96,165,250,.18); }
    .tag.normal{ background: rgba(52,211,153,.16); }
    .tag.high{ background: rgba(251,191,36,.18); }
    .tag.over{ background: rgba(251,113,133,.18); }
    .tag.low .dot{ background: var(--info); }
    .tag.normal .dot{ background: var(--ok); }
    .tag.high .dot{ background: var(--warn); }
    .tag.over .dot{ background: var(--danger); }

    .footer{ margin: 16px 0 6px; color: rgba(236,242,255,.65); font-size: .78rem; text-align:center; }

    /* Signature block: hidden on screen, visible only in print */
    .printOnly{ display:none; }

    /* PRINT: hide settings, prevent cut-off, show signature only */
    @media print{
      body{ background:#fff !important; color:#111 !important; }
      .top, .notice, .row.noPrint, .footer{ display:none !important; }

      /* Hide weights/settings section in print (as requested) */
      #secSettings{ display:none !important; }

      .section{
        box-shadow:none !important;
        border:1px solid #ddd !important;
        background:#fff !important;
      }
      .section header{ border-bottom:1px solid #ddd !important; }
      .section header h2, .sub{ color:#111 !important; }
      label{ color:#333 !important; }

      input, select, textarea{
        background:#fff !important; color:#111 !important;
        border: 1px solid #ccc !important;
        height: auto !important;
        white-space: pre-wrap !important;
      }

      table{
        border:1px solid #ccc !important;
        page-break-inside: avoid !important;
      }
      thead th{
        background:#f3f3f3 !important;
        color:#111 !important;
        border-bottom:1px solid #ccc !important;
        white-space: normal !important;
      }
      tbody td{
        background:#fff !important;
        color:#111 !important;
        border-bottom:1px solid #eee !important;
        white-space: normal !important;
        word-break: break-word !important;
        overflow-wrap: anywhere !important;
      }

      /* Strong anti-cut */
      .section, table, tr, td, th, .box, .zone { page-break-inside: avoid !important; break-inside: avoid !important; }
      h2, h3, p{ page-break-after: avoid !important; }
      canvas{ max-height: 220px !important; }

      /* Print-only signature */
      .printOnly{ display:block !important; margin-top: 12px !important; }
      .sigBox{
        border:1px solid #ccc !important;
        border-radius: 10px !important;
        padding: 10px !important;
        margin-top: 10px !important;
      }
      .sigGrid{
        display:grid !important;
        grid-template-columns: 1fr 1fr !important;
        gap: 10px !important;
      }
      .sigLine{
        height: 74px !important; /* bigger signature boxes */
        border: 1px solid #bbb !important;
        border-radius: 10px !important;
        padding: 8px !important;
      }
      .sigMeta{ font-size: 12px !important; color:#111 !important; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="logo" title="Put logo in repo: assets/UMS logo.png">
          <!-- Robust logo fallback for GitHub Pages -->
          <img id="umsLogo" src="assets/UMS%20logo.png" alt="UMS logo"
               onerror="(function(img){
                 const tries=['assets/UMS%20logo.PNG','UMS%20logo.png','UMS%20logo.PNG'];
                 const cur=img.getAttribute('data-try')?parseInt(img.getAttribute('data-try')):0;
                 if(cur < tries.length){ img.src=tries[cur]; img.setAttribute('data-try', String(cur+1)); }
               })(this)" />
        </div>
        <div class="tbox">
          <h1>FST UMS Staff Busyness Index</h1>
          <p>Teaching • Supervision • Research • Publication • Administration • Services</p>
        </div>
      </div>
      <div class="mode">
        <span class="pill" id="pillRole"><span class="dot" id="roleDot"></span><span id="roleText">Staff Mode</span></span>
        <button class="btn ghost" id="btnToggleMode">Switch to Management View</button>
        <button class="btn warn" id="btnAdminUnlock">Admin Unlock</button>
      </div>
    </div>

    <div class="notice" id="msgBox">
      <b>Note:</b> Settings/weights are locked for staff. Admin can unlock (per browser). Calculate & Print are at the bottom.
    </div>

    <!-- PROFILE -->
    <section class="section profile" id="secProfile">
      <header>
        <div>
          <h2>Staff Profile</h2>
          <div class="sub">All fields are required for audit trail & PDF signing.</div>
        </div>
      </header>
      <div class="content">
        <div class="grid">
          <div>
            <label class="requiredMark">Full Name</label>
            <input id="pName" placeholder="e.g., Assis Kamu" />
          </div>

          <div>
            <label class="requiredMark">Staff ID (format: 250505-02025)</label>
            <input id="pStaffId" placeholder="e.g., 250505-02025" />
          </div>

          <div>
            <label class="requiredMark">Programme / Department</label>
            <input id="pDept" placeholder="e.g., Mathematics with Economics" />
          </div>

          <div>
            <label class="requiredMark">Grade</label>
            <select id="pGrade">
              <option value="">Select</option>
              <option>DS45 / Lecturer</option>
              <option>DS51 / Senior Lecturer</option>
              <option>DS53 / Senior Lecturer</option>
              <option>DS54 / Senior Lecturer</option>
              <option>VK7 / Associate Professor</option>
              <option>VK6 / Professor</option>
              <option value="Other">Other</option>
            </select>
            <div class="otherWrap" id="pGradeOtherWrap">
              <label class="requiredMark">Specify Grade (Other)</label>
              <input id="pGradeOther" placeholder="Type grade..." />
            </div>
          </div>

          <div>
            <label class="requiredMark">Appointment Status</label>
            <select id="pStatus">
              <option value="">Select</option>
              <option>Permanent</option>
              <option>Contract</option>
              <option>Secondment</option>
              <option>Visiting</option>
              <option value="Other">Other</option>
            </select>
            <div class="otherWrap" id="pStatusOtherWrap">
              <label class="requiredMark">Specify Status (Other)</label>
              <input id="pStatusOther" placeholder="Type status..." />
            </div>
          </div>

          <div>
            <label class="requiredMark">Reporting Period</label>
            <input id="pPeriod" placeholder="e.g., Semester 1 2025/2026" />
          </div>
        </div>
      </div>
    </section>

    <!-- SETTINGS (Admin only) -->
    <section class="section settings" id="secSettings">
      <header>
        <div>
          <h2>Weights & Mark Scheme (Admin-only)</h2>
          <div class="sub">Weights must sum to exactly 1.00 (strict). Presets available.</div>
        </div>
        <div class="row noPrint">
          <span class="pill" id="lockPill"><span class="dot" id="lockDot"></span><span id="lockText">Locked</span></span>
        </div>
      </header>

      <div class="content">
        <div class="row noPrint" style="align-items:flex-end;">
          <div style="min-width:260px;flex:1;">
            <label>Rubric Preset (admin)</label>
            <select id="preset">
              <option value="custom">Custom</option>
              <option value="lecturer">Lecturer</option>
              <option value="senior">Senior Lecturer</option>
              <option value="assoc">Associate Professor</option>
              <option value="prof">Professor</option>
            </select>
          </div>

          <div style="min-width:260px;flex:1;">
            <label>Admin Password (to unlock settings)</label>
            <input id="adminPw" type="password" placeholder="Ask admin for password" />
          </div>

          <div class="row right" style="flex:1;">
            <button class="btn ghost" id="btnLoadLocal">Load saved</button>
            <button class="btn secondary" id="btnSaveLocal">Save locally</button>
            <button class="btn danger" id="btnResetAll">Reset all</button>
          </div>
        </div>

        <div class="notice warn" id="weightWarn" style="display:none;"></div>

        <div class="hr"></div>

        <!-- 6 weights -->
        <div class="grid">
          <div><label class="requiredMark">Weight: Teaching (T)</label><input id="wT" type="number" step="0.01" min="0" value="0.30" /></div>
          <div><label class="requiredMark">Weight: Supervision (SV)</label><input id="wSV" type="number" step="0.01" min="0" value="0.15" /></div>
          <div><label class="requiredMark">Weight: Research (R)</label><input id="wR" type="number" step="0.01" min="0" value="0.20" /></div>
          <div><label class="requiredMark">Weight: Publication (P)</label><input id="wP" type="number" step="0.01" min="0" value="0.10" /></div>
          <div><label class="requiredMark">Weight: Administration (A)</label><input id="wA" type="number" step="0.01" min="0" value="0.15" /></div>
          <div><label class="requiredMark">Weight: Services (S)</label><input id="wS" type="number" step="0.01" min="0" value="0.10" /></div>
        </div>

        <div class="hr"></div>

        <div class="grid">
          <div><label>Teaching: points per credit</label><input id="tCreditW" type="number" step="0.1" min="0" value="5" /></div>
          <div><label>Teaching: points per student</label><input id="tStudentW" type="number" step="0.01" min="0" value="0.10" /></div>
          <div><label>Teaching: points per contact hour</label><input id="tHourW" type="number" step="0.1" min="0" value="1.0" /></div>
          <div><label>Multiplier for PG course</label><input id="tPgMult" type="number" step="0.05" min="0" value="1.20" /></div>
        </div>

        <div class="hr"></div>

        <!-- Supervision weights -->
        <div class="grid">
          <div><label>Supervision: UG project points per student</label><input id="svUGW" type="number" step="0.5" min="0" value="2" /></div>
          <div><label>Supervision: Master points per student</label><input id="svMW" type="number" step="0.5" min="0" value="6" /></div>
          <div><label>Supervision: PhD points per student</label><input id="svPW" type="number" step="0.5" min="0" value="10" /></div>
          <div><label>Role multiplier (Main supervisor)</label><input id="svMainMult" type="number" step="0.05" min="0" value="1.00" /></div>
          <div><label>Role multiplier (Co-supervisor)</label><input id="svCoMult" type="number" step="0.05" min="0" value="0.60" /></div>
          <div><label>Role multiplier (Committee)</label><input id="svComMult" type="number" step="0.05" min="0" value="0.35" /></div>
          <div><label>Points per month (active supervision)</label><input id="svMonthW" type="number" step="0.05" min="0" value="0.10" /></div>
          <div><label>Meeting points (per meeting)</label><input id="svMeetW" type="number" step="0.1" min="0" value="0.8" /></div>
        </div>

        <div class="hr"></div>

        <div class="grid">
          <div><label>Research: PI base</label><input id="rPI" type="number" step="1" min="0" value="25" /></div>
          <div><label>Research: Co-I base</label><input id="rCo" type="number" step="1" min="0" value="12" /></div>
          <div><label>Research: Member base</label><input id="rMem" type="number" step="1" min="0" value="6" /></div>
          <div><label>Research Effort: points per hour</label><input id="rEffortW" type="number" step="0.1" min="0" value="1.0" /></div>
        </div>

        <div class="hr"></div>

        <div class="grid">
          <div><label>Publication: base per output</label><input id="pBase" type="number" step="0.5" min="0" value="4" /></div>
          <div><label>Publication: Q1 bonus</label><input id="pQ1" type="number" step="0.5" min="0" value="3" /></div>
          <div><label>Publication: Q2 bonus</label><input id="pQ2" type="number" step="0.5" min="0" value="2" /></div>
          <div><label>Publication: Q3 bonus</label><input id="pQ3" type="number" step="0.5" min="0" value="1" /></div>
          <div><label>Publication: First/Corresponding bonus</label><input id="pAuth" type="number" step="0.5" min="0" value="2" /></div>
          <div><label>Publication: Status multiplier (Published)</label><input id="pPubMult" type="number" step="0.05" min="0" value="1.00" /></div>
          <div><label>Publication: Status multiplier (Accepted)</label><input id="pAccMult" type="number" step="0.05" min="0" value="0.80" /></div>
          <div><label>Publication: Status multiplier (Submitted)</label><input id="pSubMult" type="number" step="0.05" min="0" value="0.60" /></div>
        </div>

        <div class="hr"></div>

        <div class="grid">
          <div><label>Admin: points per level (Programme)</label><input id="aProg" type="number" step="0.5" min="0" value="3" /></div>
          <div><label>Admin: points per level (Faculty)</label><input id="aFac" type="number" step="0.5" min="0" value="5" /></div>
          <div><label>Admin: points per level (University)</label><input id="aUni" type="number" step="0.5" min="0" value="7" /></div>
          <div><label>Admin: points per level (State)</label><input id="aState" type="number" step="0.5" min="0" value="8" /></div>
          <div><label>Admin: points per level (National)</label><input id="aNat" type="number" step="0.5" min="0" value="10" /></div>
          <div><label>Admin: points per level (International)</label><input id="aInt" type="number" step="0.5" min="0" value="12" /></div>
          <div><label>Admin: points per level (Industry)</label><input id="aInd" type="number" step="0.5" min="0" value="9" /></div>
          <div><label>Admin: points per meeting</label><input id="aMeetW" type="number" step="0.1" min="0" value="1.5" /></div>
          <div><label>Admin: points per preparation hour</label><input id="aPrepW" type="number" step="0.1" min="0" value="1.0" /></div>
          <div><label>Admin: points per month (duration)</label><input id="aMonthW" type="number" step="0.1" min="0" value="0.3" /></div>
          <div><label>Admin: bonus (Official)</label><input id="aOfficialB" type="number" step="0.5" min="0" value="3" /></div>
          <div><label>Admin: bonus (Conference Committee)</label><input id="aConfB" type="number" step="0.5" min="0" value="4" /></div>
        </div>

        <div class="hr"></div>

        <!-- Services scheme -->
        <div class="grid">
          <div><label>Service: points per hour</label><input id="sHourW" type="number" step="0.1" min="0" value="1.0" /></div>
          <div><label>Service: points per 10 participants</label><input id="sPaxW" type="number" step="0.1" min="0" value="0.8" /></div>
          <div><label>Service: Lead bonus</label><input id="sLead" type="number" step="0.5" min="0" value="4" /></div>
          <div><label>Service: Member bonus</label><input id="sMember" type="number" step="0.5" min="0" value="1.5" /></div>
        </div>

        <div class="notice">
          <b>Security note:</b> GitHub Pages is a static site. This “admin lock” is a practical UI lock, not a secure authentication system.
        </div>
      </div>
    </section>

    <!-- TEACHING -->
    <section class="section teaching" id="secTeaching">
      <header>
        <div>
          <h2>Teaching – Courses</h2>
          <div class="sub">Credit auto from last digit of course code (e.g., SJ24102 → 2). Credit is read-only.</div>
        </div>
        <div class="row noPrint">
          <button class="btn secondary" id="addCourse">+ Add course</button>
          <button class="btn ghost" id="clearCourse">Clear</button>
        </div>
      </header>
      <div class="content">
        <table id="tblCourse">
          <thead>
            <tr>
              <th style="width:10%">Level</th>
              <th style="width:14%">Course Code *</th>
              <th>Course Name *</th>
              <th style="width:8%">Credit</th>
              <th style="width:10%">Students *</th>
              <th style="width:8%">LEC *</th>
              <th style="width:8%">TUT *</th>
              <th style="width:8%">LAB *</th>
              <th style="width:9%">FIELD *</th>
              <th style="width:12%">Contact Hours</th>
              <th style="width:8%">Del</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- SUPERVISION -->
    <section class="section supervision" id="secSupervision">
      <header>
        <div>
          <h2>Supervision – UG / Master / PhD</h2>
          <div class="sub">Include active supervision load, duration, and meetings (no evidence link required).</div>
        </div>
        <div class="row noPrint">
          <button class="btn secondary" id="addSup">+ Add supervisee</button>
          <button class="btn ghost" id="clearSup">Clear</button>
        </div>
      </header>
      <div class="content">
        <table id="tblSup">
          <thead>
            <tr>
              <th style="width:14%">Level *</th>
              <th>Student (Name/Code) *</th>
              <th style="width:16%">Role *</th>
              <th style="width:16%">Status *</th>
              <th style="width:14%">Active Months *</th>
              <th style="width:14%">Meetings *</th>
              <th style="width:8%">Del</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- RESEARCH -->
    <section class="section research" id="secResearch">
      <header>
        <div>
          <h2>Research – Grants + Research Effort</h2>
          <div class="sub">Grants are top-down; effort includes supervision-related research tasks, reviewing, editorial, consultancy hours.</div>
        </div>
        <div class="row noPrint">
          <button class="btn secondary" id="addGrant">+ Add grant</button>
          <button class="btn ghost" id="clearGrant">Clear</button>
        </div>
      </header>
      <div class="content">
        <table id="tblGrant">
          <thead>
            <tr>
              <th style="width:14%">Grant Code *</th>
              <th>Title *</th>
              <th style="width:12%">Level *</th>
              <th style="width:12%">Role *</th>
              <th style="width:12%">Status *</th>
              <th style="width:12%">Amount (RM)</th>
              <th style="width:12%">Duration (months) *</th>
              <th style="width:8%">Del</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>

        <div class="hr"></div>

        <div class="row noPrint" style="justify-content:space-between;gap:12px;">
          <div>
            <h3 style="margin:0;font-size:1rem;font-weight:1000;">Research Effort</h3>
            <div class="sub">Use hours to represent real effort (meetings, data, analysis, review, editorial, consultancy, etc.).</div>
          </div>
          <div class="row">
            <button class="btn secondary" id="addEffort">+ Add effort</button>
            <button class="btn ghost" id="clearEffort">Clear</button>
          </div>
        </div>

        <table id="tblEffort">
          <thead>
            <tr>
              <th>Activity Type *</th>
              <th>Description *</th>
              <th style="width:16%">Hours *</th>
              <th style="width:10%">Del</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- PUBLICATION -->
    <section class="section publication" id="secPublication">
      <header>
        <div>
          <h2>Publication</h2>
          <div class="sub">Treated as a dedicated section. Use status and authorship to reflect workload level.</div>
        </div>
        <div class="row noPrint">
          <button class="btn secondary" id="addPub">+ Add publication</button>
          <button class="btn ghost" id="clearPub">Clear</button>
        </div>
      </header>
      <div class="content">
        <table id="tblPub">
          <thead>
            <tr>
              <th style="width:12%">Year *</th>
              <th>Title *</th>
              <th style="width:12%">Index *</th>
              <th style="width:12%">Quartile</th>
              <th style="width:16%">Authorship *</th>
              <th style="width:14%">Status *</th>
              <th style="width:8%">Del</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- ADMINISTRATION -->
    <section class="section admin" id="secAdmin">
      <header>
        <div>
          <h2>Administration – Appointments & Committees</h2>
          <div class="sub">Level + meetings + preparation hours + duration. Suitable for conference committees and pre-event work.</div>
        </div>
        <div class="row noPrint">
          <button class="btn secondary" id="addAdmin">+ Add appointment</button>
          <button class="btn ghost" id="clearAdmin">Clear</button>
        </div>
      </header>
      <div class="content">
        <table id="tblAdmin">
          <thead>
            <tr>
              <th>Appointment / Role *</th>
              <th style="width:16%">Type *</th>
              <th style="width:16%">Level *</th>
              <th style="width:12%">Meetings *</th>
              <th style="width:14%">Prep Hours *</th>
              <th style="width:14%">Duration (months) *</th>
              <th style="width:8%">Del</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- SERVICES (3 categories + dates) -->
    <section class="section service" id="secService">
      <header>
        <div>
          <h2>Services – University / Industry / Community</h2>
          <div class="sub">Each service activity must include start & end dates.</div>
        </div>
      </header>
      <div class="content">
        <div class="row noPrint" style="justify-content:flex-end;">
          <button class="btn secondary" id="addSU">+ University</button>
          <button class="btn secondary" id="addSI">+ Industry</button>
          <button class="btn secondary" id="addSC">+ Community</button>
          <button class="btn ghost" id="clearServiceAll">Clear all</button>
        </div>

        <div class="hr"></div>
        <h3 style="margin:0;font-size:1rem;font-weight:1000;">Service to University</h3>
        <table id="tblSU">
          <thead>
            <tr>
              <th>Activity *</th>
              <th style="width:14%">Role *</th>
              <th style="width:12%">Hours *</th>
              <th style="width:14%">Participants</th>
              <th style="width:14%">Start *</th>
              <th style="width:14%">End *</th>
              <th style="width:8%">Del</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>

        <div class="hr"></div>
        <h3 style="margin:0;font-size:1rem;font-weight:1000;">Service to Industry</h3>
        <table id="tblSI">
          <thead>
            <tr>
              <th>Activity *</th>
              <th style="width:14%">Role *</th>
              <th style="width:12%">Hours *</th>
              <th style="width:14%">Participants</th>
              <th style="width:14%">Start *</th>
              <th style="width:14%">End *</th>
              <th style="width:8%">Del</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>

        <div class="hr"></div>
        <h3 style="margin:0;font-size:1rem;font-weight:1000;">Service to Community</h3>
        <table id="tblSC">
          <thead>
            <tr>
              <th>Activity *</th>
              <th style="width:14%">Role *</th>
              <th style="width:12%">Hours *</th>
              <th style="width:14%">Participants</th>
              <th style="width:14%">Start *</th>
              <th style="width:14%">End *</th>
              <th style="width:8%">Del</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- RESULTS -->
    <section class="section results" id="secResults">
      <header>
        <div>
          <h2>Results & Export</h2>
          <div class="sub">Calculate at bottom • Print PDF includes signatures (print only) • Export for dashboard</div>
        </div>
        <span class="pill" id="auditPill"><span class="dot" style="background:var(--info)"></span><span id="auditStamp">Not calculated yet</span></span>
      </header>

      <div class="content">
        <div class="kpi">
          <div class="box"><div class="k">Teaching (T)</div><div class="v" id="outT">0.0</div><div class="s">Courses + contact hours</div></div>
          <div class="box"><div class="k">Supervision (SV)</div><div class="v" id="outSV">0.0</div><div class="s">UG/Master/PhD</div></div>
          <div class="box"><div class="k">Research (R)</div><div class="v" id="outR">0.0</div><div class="s">Grants + effort</div></div>
          <div class="box"><div class="k">Publication (P)</div><div class="v" id="outP">0.0</div><div class="s">Status + authorship</div></div>
          <div class="box"><div class="k">Administration (A)</div><div class="v" id="outA">0.0</div><div class="s">Level + meetings</div></div>
          <div class="box"><div class="k">Services (S)</div><div class="v" id="outS">0.0</div><div class="s">Uni/Industry/Community</div></div>
        </div>

        <div class="zone">
          <div>
            <div class="k" style="color:var(--muted);font-size:.86rem">Busyness Index</div>
            <div class="big"><span id="bigIndex">0.0</span> <span style="font-size:.92rem;color:rgba(236,242,255,.75)">/100</span></div>
          </div>
          <div class="tag normal" id="zoneTag"><span class="dot"></span><span id="zoneText">Normal</span></div>
        </div>
        <p id="zoneDesc" style="color:var(--muted);margin:10px 0 0;line-height:1.45"></p>

        <div class="hr"></div>

        <canvas id="chart" height="140"></canvas>

        <div class="hr"></div>

        <h3 style="margin:0;font-size:1rem;font-weight:1000;">Narrative Summary (auto)</h3>
        <p id="narrative" style="color:rgba(236,242,255,.86);line-height:1.55;margin:8px 0 0"></p>

        <div class="hr"></div>

        <div class="row noPrint" style="justify-content:space-between;gap:12px;">
          <div style="min-width:260px;flex:1;">
            <label>Management View – Import staff JSON (read-only)</label>
            <input type="file" id="jsonImport" accept=".json" />
          </div>
          <div class="row right" style="flex:1">
            <button class="btn secondary" id="btnExportSummaryCSV">Export Summary CSV</button>
            <button class="btn secondary" id="btnExportDetailedCSV">Export Detailed CSV</button>
            <button class="btn" id="btnExportJSON">Export Full JSON</button>
          </div>
        </div>

        <div class="hr"></div>

        <div class="row noPrint" style="justify-content:flex-end;">
          <button class="btn secondary" id="btnCalculate">Calculate</button>
          <button class="btn" id="btnPrint">Print PDF</button>
        </div>

        <!-- PRINT-ONLY SIGNATURE -->
        <div class="printOnly">
          <div class="sigBox">
            <div class="sigMeta"><b>Faculty:</b> Faculty of Science and Technology (FST), Universiti Malaysia Sabah</div>
            <div class="sigMeta"><b>Dean:</b> Prof. P.Geol. Ts. Dr. Rodeano Roslee</div>
            <div class="sigMeta"><b>Printed date:</b> <span id="printDate"></span></div>
            <div class="sigMeta" style="margin-top:6px;"><b>Staff:</b> <span id="sigStaffName"></span> (<span id="sigStaffId"></span>)</div>

            <div class="sigGrid" style="margin-top:10px;">
              <div>
                <div class="sigMeta"><b>Staff Signature</b></div>
                <div class="sigLine"></div>
                <div class="sigMeta">Date: _______________________</div>
              </div>
              <div>
                <div class="sigMeta"><b>Dean Signature</b></div>
                <div class="sigLine"></div>
                <div class="sigMeta">Date: _______________________</div>
              </div>
            </div>
          </div>
        </div>

      </div>
    </section>

    <div class="footer">© <span id="yearNow"></span> FST UMS</div>
  </div>

<script>
/* ======================
   CONFIG
====================== */
const LS_KEY = "fst_ums_busyness_v4";
const ADMIN_PASSWORD = "FST-ADMIN"; // CHANGE THIS
const STAFF_ID_REGEX = /^\\d{6}-\\d{5}$/;

/* ======================
   STATE
====================== */
let isAdminUnlocked = false;
let isManagementView = false;
let lastCalculatedISO = "";

const state = {
  profile: {
    name:"", staffId:"", dept:"", grade:"", gradeOther:"",
    status:"", statusOther:"",
    period:""
  },
  settings: {
    weights: { T:0.30, SV:0.15, R:0.20, P:0.10, A:0.15, S:0.10 },
    teaching: { creditW:5, studentW:0.10, hourW:1.0, pgMult:1.20 },
    supervision: { ugW:2, mW:6, pW:10, mainMult:1.00, coMult:0.60, comMult:0.35, monthW:0.10, meetW:0.8 },
    research: { PI:25, CO:12, MEM:6, effortW:1.0 },
    publication: { base:4, q1:3, q2:2, q3:1, auth:2, pubMult:1.0, accMult:0.8, subMult:0.6 },
    admin: {
      levelW: { Programme:3, Faculty:5, University:7, State:8, National:10, International:12, Industry:9 },
      perMeeting:1.5, perPrepHour:1.0, perMonth:0.3,
      bonus: { Official:3, "Conference Committee":4, "Ad-hoc":1.5 }
    },
    service: { hourW:1.0, paxW:0.8, lead:4, member:1.5 }
  },
  data: {
    courses:[], supervisees:[],
    grants:[], effort:[],
    pubs:[],
    adminRoles:[],
    svcUni:[], svcInd:[], svcCom:[]
  }
};

function n(v){ const x = parseFloat(v); return Number.isFinite(x) ? x : 0; }
function clamp(x, lo, hi){ return Math.max(lo, Math.min(hi, x)); }
function uid(){ return Math.random().toString(16).slice(2) + Date.now().toString(16); }
function $(id){ return document.getElementById(id); }

/* Other fields */
function bindOther(selectId, wrapId, inputId){
  const sel = $(selectId), wrap = $(wrapId), inp = $(inputId);
  const update = ()=>{
    const isOther = sel.value === "Other";
    wrap.style.display = isOther ? "block" : "none";
    if(!isOther) inp.value = "";
    autosave();
  };
  sel.addEventListener("change", update);
  inp.addEventListener("input", ()=>autosave());
  update();
}

/* CREDIT */
function inferCredit(code){
  if(!code) return 0;
  const s = String(code).trim();
  const mLastDigit = s.match(/(\\d)(?!.*\\d)/);
  return mLastDigit ? n(mLastDigit[1]) : 0;
}
function contactHours(c){ return n(c.lec)+n(c.tut)+n(c.lab)+n(c.field); }

/* Seed rows */
function ensureSeed(){
  if(state.data.courses.length===0) state.data.courses.push({ id:uid(), level:"UG", code:"", name:"", credit:0, students:0, lec:0, tut:0, lab:0, field:0 });
  if(state.data.supervisees.length===0) state.data.supervisees.push({ id:uid(), level:"UG", student:"", role:"Main", status:"Active", months:0, meetings:0 });
  if(state.data.grants.length===0) state.data.grants.push({ id:uid(), code:"", title:"", level:"University", role:"PI", status:"Active", amount:0, months:0 });
  if(state.data.effort.length===0) state.data.effort.push({ id:uid(), type:"Supervision-related research", desc:"", hours:0 });
  if(state.data.pubs.length===0) state.data.pubs.push({ id:uid(), year:"", title:"", index:"Scopus", quartile:"Q1", authorship:"First/Corresponding", status:"Published" });
  if(state.data.adminRoles.length===0) state.data.adminRoles.push({ id:uid(), role:"", type:"Official", level:"Programme", meetings:0, prep:0, months:0 });
  if(state.data.svcUni.length===0) state.data.svcUni.push({ id:uid(), activity:"", role:"Lead", hours:0, pax:0, start:"", end:"" });
  if(state.data.svcInd.length===0) state.data.svcInd.push({ id:uid(), activity:"", role:"Lead", hours:0, pax:0, start:"", end:"" });
  if(state.data.svcCom.length===0) state.data.svcCom.push({ id:uid(), activity:"", role:"Lead", hours:0, pax:0, start:"", end:"" });
}

/* Render tables */
function renderCourses(){
  const tb = $("tblCourse").querySelector("tbody");
  tb.innerHTML = "";
  state.data.courses.forEach(r=>{
    const tr = document.createElement("tr");
    tr.dataset.id = r.id;
    tr.innerHTML = `
      <td><select class="miniinput" data-k="level"><option>UG</option><option>PG</option></select></td>
      <td><input class="miniinput" data-k="code" placeholder="e.g., SJ24102" /></td>
      <td><input class="miniinput" data-k="name" placeholder="Course name" /></td>
      <td><input class="miniinput" data-k="credit" type="number" readonly /></td>
      <td><input class="miniinput" data-k="students" type="number" min="0" step="1" /></td>
      <td><input class="miniinput" data-k="lec" type="number" min="0" step="1" /></td>
      <td><input class="miniinput" data-k="tut" type="number" min="0" step="1" /></td>
      <td><input class="miniinput" data-k="lab" type="number" min="0" step="1" /></td>
      <td><input class="miniinput" data-k="field" type="number" min="0" step="1" /></td>
      <td><input class="miniinput" data-k="ch" type="number" readonly /></td>
      <td><button class="btn danger" data-act="del" style="padding:6px 10px;font-size:.8rem">✖</button></td>
    `;
    tb.appendChild(tr);

    tr.querySelector('[data-k="level"]').value = r.level;
    tr.querySelector('[data-k="code"]').value = r.code;
    tr.querySelector('[data-k="name"]').value = r.name;
    tr.querySelector('[data-k="credit"]').value = r.credit;
    tr.querySelector('[data-k="students"]').value = r.students;
    tr.querySelector('[data-k="lec"]').value = r.lec;
    tr.querySelector('[data-k="tut"]').value = r.tut;
    tr.querySelector('[data-k="lab"]').value = r.lab;
    tr.querySelector('[data-k="field"]').value = r.field;
    tr.querySelector('[data-k="ch"]').value = contactHours(r);

    tr.addEventListener("input",(e)=>{
      const k = e.target.getAttribute("data-k");
      if(!k) return;
      const obj = state.data.courses.find(x=>x.id===tr.dataset.id);
      if(!obj) return;

      if(k==="code"){
        obj.code = e.target.value.trim();
        obj.credit = inferCredit(obj.code);
        tr.querySelector('[data-k="credit"]').value = obj.credit;
      } else if(k==="level" || k==="name"){
        obj[k] = e.target.value;
      } else if(["students","lec","tut","lab","field"].includes(k)){
        obj[k] = Math.max(0, n(e.target.value));
        e.target.value = obj[k];
      }
      tr.querySelector('[data-k="ch"]').value = contactHours(obj);
      autosave();
    });

    tr.addEventListener("click",(e)=>{
      if(e.target?.getAttribute("data-act")==="del"){
        state.data.courses = state.data.courses.filter(x=>x.id!==tr.dataset.id);
        ensureSeed(); renderCourses(); autosave();
      }
    });
  });
}

function renderSup(){
  const tb = $("tblSup").querySelector("tbody");
  tb.innerHTML = "";
  state.data.supervisees.forEach(r=>{
    const tr = document.createElement("tr");
    tr.dataset.id = r.id;
    tr.innerHTML = `
      <td>
        <select class="miniinput" data-k="level">
          <option>UG</option><option>Master</option><option>PhD</option>
        </select>
      </td>
      <td><input class="miniinput" data-k="student" placeholder="Student name / code" /></td>
      <td>
        <select class="miniinput" data-k="role">
          <option>Main</option><option>Co</option><option>Committee</option>
        </select>
      </td>
      <td>
        <select class="miniinput" data-k="status">
          <option>Active</option><option>Completed</option><option>On-hold</option>
        </select>
      </td>
      <td><input class="miniinput" data-k="months" type="number" min="0" step="1" /></td>
      <td><input class="miniinput" data-k="meetings" type="number" min="0" step="1" /></td>
      <td><button class="btn danger" data-act="del" style="padding:6px 10px;font-size:.8rem">✖</button></td>
    `;
    tb.appendChild(tr);

    tr.querySelector('[data-k="level"]').value = r.level;
    tr.querySelector('[data-k="student"]').value = r.student;
    tr.querySelector('[data-k="role"]').value = r.role;
    tr.querySelector('[data-k="status"]').value = r.status;
    tr.querySelector('[data-k="months"]').value = r.months;
    tr.querySelector('[data-k="meetings"]').value = r.meetings;

    tr.addEventListener("input",(e)=>{
      const k = e.target.getAttribute("data-k");
      if(!k) return;
      const obj = state.data.supervisees.find(x=>x.id===tr.dataset.id);
      if(!obj) return;

      if(["months","meetings"].includes(k)){
        obj[k] = Math.max(0, n(e.target.value));
        e.target.value = obj[k];
      } else {
        obj[k] = e.target.value;
      }
      autosave();
    });

    tr.addEventListener("click",(e)=>{
      if(e.target?.getAttribute("data-act")==="del"){
        state.data.supervisees = state.data.supervisees.filter(x=>x.id!==tr.dataset.id);
        ensureSeed(); renderSup(); autosave();
      }
    });
  });
}

function renderGrants(){
  const tb = $("tblGrant").querySelector("tbody");
  tb.innerHTML = "";
  state.data.grants.forEach(r=>{
    const tr = document.createElement("tr");
    tr.dataset.id = r.id;
    tr.innerHTML = `
      <td><input class="miniinput" data-k="code" placeholder="e.g., FRGS/..." /></td>
      <td><input class="miniinput" data-k="title" placeholder="Grant title" /></td>
      <td><select class="miniinput" data-k="level"><option>University</option><option>National</option><option>International</option></select></td>
      <td><select class="miniinput" data-k="role"><option>PI</option><option>Co-I</option><option>Member</option></select></td>
      <td><select class="miniinput" data-k="status"><option>Active</option><option>Applied</option><option>Ended</option></select></td>
      <td><input class="miniinput" data-k="amount" type="number" min="0" step="1000" /></td>
      <td><input class="miniinput" data-k="months" type="number" min="0" step="1" /></td>
      <td><button class="btn danger" data-act="del" style="padding:6px 10px;font-size:.8rem">✖</button></td>
    `;
    tb.appendChild(tr);

    tr.querySelector('[data-k="code"]').value = r.code;
    tr.querySelector('[data-k="title"]').value = r.title;
    tr.querySelector('[data-k="level"]').value = r.level;
    tr.querySelector('[data-k="role"]').value = r.role;
    tr.querySelector('[data-k="status"]').value = r.status;
    tr.querySelector('[data-k="amount"]').value = r.amount;
    tr.querySelector('[data-k="months"]').value = r.months;

    tr.addEventListener("input",(e)=>{
      const k = e.target.getAttribute("data-k");
      if(!k) return;
      const obj = state.data.grants.find(x=>x.id===tr.dataset.id);
      if(!obj) return;

      if(k==="amount" || k==="months"){
        obj[k] = Math.max(0, n(e.target.value));
        e.target.value = obj[k];
      } else {
        obj[k] = e.target.value;
      }
      autosave();
    });

    tr.addEventListener("click",(e)=>{
      if(e.target?.getAttribute("data-act")==="del"){
        state.data.grants = state.data.grants.filter(x=>x.id!==tr.dataset.id);
        ensureSeed(); renderGrants(); autosave();
      }
    });
  });
}

function renderEffort(){
  const tb = $("tblEffort").querySelector("tbody");
  tb.innerHTML = "";
  state.data.effort.forEach(r=>{
    const tr = document.createElement("tr");
    tr.dataset.id = r.id;
    tr.innerHTML = `
      <td>
        <select class="miniinput" data-k="type">
          <option>Supervision-related research</option>
          <option>Data collection/analysis</option>
          <option>Peer Review</option>
          <option>Editorial</option>
          <option>Consultancy</option>
          <option>Other</option>
        </select>
      </td>
      <td><input class="miniinput" data-k="desc" placeholder="Describe briefly" /></td>
      <td><input class="miniinput" data-k="hours" type="number" min="0" step="0.5" /></td>
      <td><button class="btn danger" data-act="del" style="padding:6px 10px;font-size:.8rem">✖</button></td>
    `;
    tb.appendChild(tr);

    tr.querySelector('[data-k="type"]').value = r.type;
    tr.querySelector('[data-k="desc"]').value = r.desc;
    tr.querySelector('[data-k="hours"]').value = r.hours;

    tr.addEventListener("input",(e)=>{
      const k = e.target.getAttribute("data-k");
      if(!k) return;
      const obj = state.data.effort.find(x=>x.id===tr.dataset.id);
      if(!obj) return;

      if(k==="hours"){
        obj.hours = Math.max(0, n(e.target.value));
        e.target.value = obj.hours;
      } else {
        obj[k] = e.target.value;
      }
      autosave();
    });

    tr.addEventListener("click",(e)=>{
      if(e.target?.getAttribute("data-act")==="del"){
        state.data.effort = state.data.effort.filter(x=>x.id!==tr.dataset.id);
        ensureSeed(); renderEffort(); autosave();
      }
    });
  });
}

function renderPubs(){
  const tb = $("tblPub").querySelector("tbody");
  tb.innerHTML = "";
  state.data.pubs.forEach(r=>{
    const tr = document.createElement("tr");
    tr.dataset.id = r.id;
    tr.innerHTML = `
      <td><input class="miniinput" data-k="year" placeholder="e.g., 2025" /></td>
      <td><input class="miniinput" data-k="title" placeholder="Publication title" /></td>
      <td>
        <select class="miniinput" data-k="index">
          <option>Scopus</option><option>WoS</option><option>MyCite</option><option>Non-indexed</option>
        </select>
      </td>
      <td>
        <select class="miniinput" data-k="quartile">
          <option>Q1</option><option>Q2</option><option>Q3</option><option>Q4</option><option>N/A</option>
        </select>
      </td>
      <td>
        <select class="miniinput" data-k="authorship">
          <option>First/Corresponding</option><option>Co-author</option><option>Single author</option>
        </select>
      </td>
      <td>
        <select class="miniinput" data-k="status">
          <option>Published</option><option>Accepted</option><option>Submitted</option><option>In preparation</option>
        </select>
      </td>
      <td><button class="btn danger" data-act="del" style="padding:6px 10px;font-size:.8rem">✖</button></td>
    `;
    tb.appendChild(tr);

    tr.querySelector('[data-k="year"]').value = r.year;
    tr.querySelector('[data-k="title"]').value = r.title;
    tr.querySelector('[data-k="index"]').value = r.index;
    tr.querySelector('[data-k="quartile"]').value = r.quartile;
    tr.querySelector('[data-k="authorship"]').value = r.authorship;
    tr.querySelector('[data-k="status"]').value = r.status;

    tr.addEventListener("input",(e)=>{
      const k = e.target.getAttribute("data-k");
      if(!k) return;
      const obj = state.data.pubs.find(x=>x.id===tr.dataset.id);
      if(!obj) return;
      obj[k] = e.target.value;
      autosave();
    });

    tr.addEventListener("click",(e)=>{
      if(e.target?.getAttribute("data-act")==="del"){
        state.data.pubs = state.data.pubs.filter(x=>x.id!==tr.dataset.id);
        ensureSeed(); renderPubs(); autosave();
      }
    });
  });
}

function renderAdmin(){
  const tb = $("tblAdmin").querySelector("tbody");
  tb.innerHTML = "";
  state.data.adminRoles.forEach(r=>{
    const tr = document.createElement("tr");
    tr.dataset.id = r.id;
    tr.innerHTML = `
      <td><input class="miniinput" data-k="role" placeholder="e.g., AJK Conference / Programme Head" /></td>
      <td>
        <select class="miniinput" data-k="type">
          <option>Official</option><option>Ad-hoc</option><option>Conference Committee</option>
        </select>
      </td>
      <td>
        <select class="miniinput" data-k="level">
          <option>Programme</option><option>Faculty</option><option>University</option>
          <option>State</option><option>National</option><option>International</option><option>Industry</option>
        </select>
      </td>
      <td><input class="miniinput" data-k="meetings" type="number" min="0" step="1" /></td>
      <td><input class="miniinput" data-k="prep" type="number" min="0" step="0.5" /></td>
      <td><input class="miniinput" data-k="months" type="number" min="0" step="1" /></td>
      <td><button class="btn danger" data-act="del" style="padding:6px 10px;font-size:.8rem">✖</button></td>
    `;
    tb.appendChild(tr);

    tr.querySelector('[data-k="role"]').value = r.role;
    tr.querySelector('[data-k="type"]').value = r.type;
    tr.querySelector('[data-k="level"]').value = r.level;
    tr.querySelector('[data-k="meetings"]').value = r.meetings;
    tr.querySelector('[data-k="prep"]').value = r.prep;
    tr.querySelector('[data-k="months"]').value = r.months;

    tr.addEventListener("input",(e)=>{
      const k = e.target.getAttribute("data-k");
      if(!k) return;
      const obj = state.data.adminRoles.find(x=>x.id===tr.dataset.id);
      if(!obj) return;

      if(["meetings","prep","months"].includes(k)){
        obj[k] = Math.max(0, n(e.target.value));
        e.target.value = obj[k];
      } else {
        obj[k] = e.target.value;
      }
      autosave();
    });

    tr.addEventListener("click",(e)=>{
      if(e.target?.getAttribute("data-act")==="del"){
        state.data.adminRoles = state.data.adminRoles.filter(x=>x.id!==tr.dataset.id);
        ensureSeed(); renderAdmin(); autosave();
      }
    });
  });
}

function renderServiceTable(tbodyEl, arr, key){
  tbodyEl.innerHTML = "";
  arr.forEach(r=>{
    const tr = document.createElement("tr");
    tr.dataset.id = r.id;
    tr.innerHTML = `
      <td><input class="miniinput" data-k="activity" placeholder="Activity" /></td>
      <td><select class="miniinput" data-k="role"><option>Lead</option><option>Member</option></select></td>
      <td><input class="miniinput" data-k="hours" type="number" min="0" step="0.5" /></td>
      <td><input class="miniinput" data-k="pax" type="number" min="0" step="1" /></td>
      <td><input class="miniinput" data-k="start" type="date" /></td>
      <td><input class="miniinput" data-k="end" type="date" /></td>
      <td><button class="btn danger" data-act="del" style="padding:6px 10px;font-size:.8rem">✖</button></td>
    `;
    tbodyEl.appendChild(tr);

    tr.querySelector('[data-k="activity"]').value = r.activity;
    tr.querySelector('[data-k="role"]').value = r.role;
    tr.querySelector('[data-k="hours"]').value = r.hours;
    tr.querySelector('[data-k="pax"]').value = r.pax;
    tr.querySelector('[data-k="start"]').value = r.start;
    tr.querySelector('[data-k="end"]').value = r.end;

    tr.addEventListener("input",(e)=>{
      const k = e.target.getAttribute("data-k");
      if(!k) return;
      const obj = arr.find(x=>x.id===tr.dataset.id);
      if(!obj) return;

      if(k==="hours" || k==="pax"){
        obj[k] = Math.max(0, n(e.target.value));
        e.target.value = obj[k];
      } else {
        obj[k] = e.target.value;
      }
      autosave();
    });

    tr.addEventListener("click",(e)=>{
      if(e.target?.getAttribute("data-act")==="del"){
        const idx = arr.findIndex(x=>x.id===tr.dataset.id);
        if(idx>=0) arr.splice(idx,1);
        ensureSeed(); renderAll(); autosave();
      }
    });
  });
}

function renderServices(){
  renderServiceTable($("tblSU").querySelector("tbody"), state.data.svcUni, "svcUni");
  renderServiceTable($("tblSI").querySelector("tbody"), state.data.svcInd, "svcInd");
  renderServiceTable($("tblSC").querySelector("tbody"), state.data.svcCom, "svcCom");
}

function renderAll(){
  renderCourses();
  renderSup();
  renderGrants();
  renderEffort();
  renderPubs();
  renderAdmin();
  renderServices();
}

/* Sync settings/profile */
function syncProfileFromUI(){
  state.profile.name = $("pName").value.trim();
  state.profile.staffId = $("pStaffId").value.trim();
  state.profile.dept = $("pDept").value.trim();
  state.profile.grade = $("pGrade").value;
  state.profile.gradeOther = $("pGradeOther").value.trim();
  state.profile.status = $("pStatus").value;
  state.profile.statusOther = $("pStatusOther").value.trim();
  state.profile.period = $("pPeriod").value.trim();
}

function syncSettingsFromUI(){
  state.settings.weights.T = n($("wT").value);
  state.settings.weights.SV = n($("wSV").value);
  state.settings.weights.R = n($("wR").value);
  state.settings.weights.P = n($("wP").value);
  state.settings.weights.A = n($("wA").value);
  state.settings.weights.S = n($("wS").value);

  state.settings.teaching.creditW = n($("tCreditW").value);
  state.settings.teaching.studentW = n($("tStudentW").value);
  state.settings.teaching.hourW = n($("tHourW").value);
  state.settings.teaching.pgMult = n($("tPgMult").value);

  state.settings.supervision.ugW = n($("svUGW").value);
  state.settings.supervision.mW = n($("svMW").value);
  state.settings.supervision.pW = n($("svPW").value);
  state.settings.supervision.mainMult = n($("svMainMult").value);
  state.settings.supervision.coMult = n($("svCoMult").value);
  state.settings.supervision.comMult = n($("svComMult").value);
  state.settings.supervision.monthW = n($("svMonthW").value);
  state.settings.supervision.meetW = n($("svMeetW").value);

  state.settings.research.PI = n($("rPI").value);
  state.settings.research.CO = n($("rCo").value);
  state.settings.research.MEM = n($("rMem").value);
  state.settings.research.effortW = n($("rEffortW").value);

  state.settings.publication.base = n($("pBase").value);
  state.settings.publication.q1 = n($("pQ1").value);
  state.settings.publication.q2 = n($("pQ2").value);
  state.settings.publication.q3 = n($("pQ3").value);
  state.settings.publication.auth = n($("pAuth").value);
  state.settings.publication.pubMult = n($("pPubMult").value);
  state.settings.publication.accMult = n($("pAccMult").value);
  state.settings.publication.subMult = n($("pSubMult").value);

  state.settings.admin.levelW.Programme = n($("aProg").value);
  state.settings.admin.levelW.Faculty = n($("aFac").value);
  state.settings.admin.levelW.University = n($("aUni").value);
  state.settings.admin.levelW.State = n($("aState").value);
  state.settings.admin.levelW.National = n($("aNat").value);
  state.settings.admin.levelW.International = n($("aInt").value);
  state.settings.admin.levelW.Industry = n($("aInd").value);
  state.settings.admin.perMeeting = n($("aMeetW").value);
  state.settings.admin.perPrepHour = n($("aPrepW").value);
  state.settings.admin.perMonth = n($("aMonthW").value);
  state.settings.admin.bonus.Official = n($("aOfficialB").value);
  state.settings.admin.bonus["Conference Committee"] = n($("aConfB").value);

  state.settings.service.hourW = n($("sHourW").value);
  state.settings.service.paxW = n($("sPaxW").value);
  state.settings.service.lead = n($("sLead").value);
  state.settings.service.member = n($("sMember").value);
}

function syncUIFromProfile(){
  $("pName").value = state.profile.name;
  $("pStaffId").value = state.profile.staffId;
  $("pDept").value = state.profile.dept;
  $("pGrade").value = state.profile.grade;
  $("pGradeOther").value = state.profile.gradeOther;
  $("pStatus").value = state.profile.status;
  $("pStatusOther").value = state.profile.statusOther;
  $("pPeriod").value = state.profile.period;
}

function syncUIFromSettings(){
  $("wT").value = state.settings.weights.T;
  $("wSV").value = state.settings.weights.SV;
  $("wR").value = state.settings.weights.R;
  $("wP").value = state.settings.weights.P;
  $("wA").value = state.settings.weights.A;
  $("wS").value = state.settings.weights.S;

  $("tCreditW").value = state.settings.teaching.creditW;
  $("tStudentW").value = state.settings.teaching.studentW;
  $("tHourW").value = state.settings.teaching.hourW;
  $("tPgMult").value = state.settings.teaching.pgMult;

  $("svUGW").value = state.settings.supervision.ugW;
  $("svMW").value = state.settings.supervision.mW;
  $("svPW").value = state.settings.supervision.pW;
  $("svMainMult").value = state.settings.supervision.mainMult;
  $("svCoMult").value = state.settings.supervision.coMult;
  $("svComMult").value = state.settings.supervision.comMult;
  $("svMonthW").value = state.settings.supervision.monthW;
  $("svMeetW").value = state.settings.supervision.meetW;

  $("rPI").value = state.settings.research.PI;
  $("rCo").value = state.settings.research.CO;
  $("rMem").value = state.settings.research.MEM;
  $("rEffortW").value = state.settings.research.effortW;

  $("pBase").value = state.settings.publication.base;
  $("pQ1").value = state.settings.publication.q1;
  $("pQ2").value = state.settings.publication.q2;
  $("pQ3").value = state.settings.publication.q3;
  $("pAuth").value = state.settings.publication.auth;
  $("pPubMult").value = state.settings.publication.pubMult;
  $("pAccMult").value = state.settings.publication.accMult;
  $("pSubMult").value = state.settings.publication.subMult;

  $("aProg").value = state.settings.admin.levelW.Programme;
  $("aFac").value = state.settings.admin.levelW.Faculty;
  $("aUni").value = state.settings.admin.levelW.University;
  $("aState").value = state.settings.admin.levelW.State;
  $("aNat").value = state.settings.admin.levelW.National;
  $("aInt").value = state.settings.admin.levelW.International;
  $("aInd").value = state.settings.admin.levelW.Industry;
  $("aMeetW").value = state.settings.admin.perMeeting;
  $("aPrepW").value = state.settings.admin.perPrepHour;
  $("aMonthW").value = state.settings.admin.perMonth;
  $("aOfficialB").value = state.settings.admin.bonus.Official;
  $("aConfB").value = state.settings.admin.bonus["Conference Committee"];

  $("sHourW").value = state.settings.service.hourW;
  $("sPaxW").value = state.settings.service.paxW;
  $("sLead").value = state.settings.service.lead;
  $("sMember").value = state.settings.service.member;
}

/* Validation */
function clearErrors(){ document.querySelectorAll(".err").forEach(e=>e.classList.remove("err")); }
function showMsg(type, html){
  const box = $("msgBox");
  box.className = "notice " + (type || "");
  box.innerHTML = html;
}

function validateWeightsStrict(){
  syncSettingsFromUI();
  const w = state.settings.weights;
  const sum = w.T + w.SV + w.R + w.P + w.A + w.S;

  if(Object.values(w).some(v=>v<0)){
    $("weightWarn").style.display="block";
    $("weightWarn").textContent="Weights cannot be negative.";
    return false;
  }
  if(Math.abs(sum - 1.0) > 0.001){
    $("weightWarn").style.display="block";
    $("weightWarn").textContent=`Weight sum must be exactly 1.00. Current sum = ${sum.toFixed(3)}.`;
    return false;
  }
  $("weightWarn").style.display="none";
  $("weightWarn").textContent="";
  return true;
}

function validateProfileRequired(){
  syncProfileFromUI();
  let ok = true;

  if(!state.profile.name){ $("pName").classList.add("err"); ok=false; }
  if(!state.profile.staffId || !STAFF_ID_REGEX.test(state.profile.staffId)){ $("pStaffId").classList.add("err"); ok=false; }
  if(!state.profile.dept){ $("pDept").classList.add("err"); ok=false; }

  if(!state.profile.grade){ $("pGrade").classList.add("err"); ok=false; }
  if(state.profile.grade==="Other" && !state.profile.gradeOther){ $("pGradeOther").classList.add("err"); ok=false; }

  if(!state.profile.status){ $("pStatus").classList.add("err"); ok=false; }
  if(state.profile.status==="Other" && !state.profile.statusOther){ $("pStatusOther").classList.add("err"); ok=false; }

  if(!state.profile.period){ $("pPeriod").classList.add("err"); ok=false; }
  return ok;
}

function validateTables(){
  let ok = true;

  // Courses
  state.data.courses.forEach((c,i)=>{
    const tr = $("tblCourse").querySelectorAll("tbody tr")[i]; if(!tr) return;
    if(!String(c.code||"").trim() || n(c.credit)<=0){ tr.querySelector('[data-k="code"]').classList.add("err"); ok=false; }
    if(!String(c.name||"").trim()){ tr.querySelector('[data-k="name"]').classList.add("err"); ok=false; }
    if(n(c.students)<=0){ tr.querySelector('[data-k="students"]').classList.add("err"); ok=false; }
    if(contactHours(c)<=0){
      ["lec","tut","lab","field"].forEach(k=>tr.querySelector(`[data-k="${k}"]`).classList.add("err"));
      ok=false;
    }
  });

  // Supervision
  state.data.supervisees.forEach((s,i)=>{
    const tr = $("tblSup").querySelectorAll("tbody tr")[i]; if(!tr) return;
    if(!String(s.student||"").trim()){ tr.querySelector('[data-k="student"]').classList.add("err"); ok=false; }
    if(n(s.months)<=0){ tr.querySelector('[data-k="months"]').classList.add("err"); ok=false; }
    if(n(s.meetings)<0){ tr.querySelector('[data-k="meetings"]').classList.add("err"); ok=false; }
  });

  // Grants
  state.data.grants.forEach((g,i)=>{
    const tr = $("tblGrant").querySelectorAll("tbody tr")[i]; if(!tr) return;
    if(!String(g.code||"").trim()){ tr.querySelector('[data-k="code"]').classList.add("err"); ok=false; }
    if(!String(g.title||"").trim()){ tr.querySelector('[data-k="title"]').classList.add("err"); ok=false; }
    if(n(g.months)<=0){ tr.querySelector('[data-k="months"]').classList.add("err"); ok=false; }
  });

  // Effort
  state.data.effort.forEach((e,i)=>{
    const tr = $("tblEffort").querySelectorAll("tbody tr")[i]; if(!tr) return;
    if(!String(e.desc||"").trim()){ tr.querySelector('[data-k="desc"]').classList.add("err"); ok=false; }
    if(n(e.hours)<=0){ tr.querySelector('[data-k="hours"]').classList.add("err"); ok=false; }
  });

  // Publication
  state.data.pubs.forEach((p,i)=>{
    const tr = $("tblPub").querySelectorAll("tbody tr")[i]; if(!tr) return;
    if(!String(p.year||"").trim()){ tr.querySelector('[data-k="year"]').classList.add("err"); ok=false; }
    if(!String(p.title||"").trim()){ tr.querySelector('[data-k="title"]').classList.add("err"); ok=false; }
  });

  // Admin
  state.data.adminRoles.forEach((a,i)=>{
    const tr = $("tblAdmin").querySelectorAll("tbody tr")[i]; if(!tr) return;
    if(!String(a.role||"").trim()){ tr.querySelector('[data-k="role"]').classList.add("err"); ok=false; }
    if(n(a.months)<=0){ tr.querySelector('[data-k="months"]').classList.add("err"); ok=false; }
  });

  // Services (Uni/Ind/Com)
  const svcGroups = [
    {arr: state.data.svcUni, tbl:"tblSU"},
    {arr: state.data.svcInd, tbl:"tblSI"},
    {arr: state.data.svcCom, tbl:"tblSC"}
  ];
  svcGroups.forEach(g=>{
    g.arr.forEach((s,i)=>{
      const tr = $(g.tbl).querySelectorAll("tbody tr")[i]; if(!tr) return;
      if(!String(s.activity||"").trim()){ tr.querySelector('[data-k="activity"]').classList.add("err"); ok=false; }
      if(n(s.hours)<=0){ tr.querySelector('[data-k="hours"]').classList.add("err"); ok=false; }
      if(!String(s.start||"").trim()){ tr.querySelector('[data-k="start"]').classList.add("err"); ok=false; }
      if(!String(s.end||"").trim()){ tr.querySelector('[data-k="end"]').classList.add("err"); ok=false; }
    });
  });

  return ok;
}

/* Scoring */
function scoreTeaching(){
  const s = state.settings.teaching;
  let total = 0;
  state.data.courses.forEach(c=>{
    let base = (n(c.credit)*s.creditW) + (n(c.students)*s.studentW) + (contactHours(c)*s.hourW);
    if((c.level||"UG")==="PG") base *= (s.pgMult || 1);
    total += base;
  });
  return total;
}

function scoreSupervision(){
  const sv = state.settings.supervision;
  let total = 0;

  state.data.supervisees.forEach(x=>{
    let base = 0;
    if(x.level==="UG") base += sv.ugW;
    else if(x.level==="Master") base += sv.mW;
    else base += sv.pW;

    let mult = sv.mainMult;
    if(x.role==="Co") mult = sv.coMult;
    if(x.role==="Committee") mult = sv.comMult;

    base = base * mult;
    base += n(x.months) * sv.monthW;
    base += n(x.meetings) * sv.meetW;

    total += base;
  });

  return total;
}

function scoreResearch(){
  const r = state.settings.research;
  let total = 0;

  state.data.grants.forEach(g=>{
    let base = 0;
    const role = (g.role||"").toUpperCase();
    if(role==="PI") base += r.PI;
    else if(role==="CO-I") base += r.CO;
    else base += r.MEM;

    const lvl = (g.level||"").toLowerCase();
    if(lvl==="national") base += 3;
    if(lvl==="international") base += 6;

    const st = (g.status||"").toLowerCase();
    if(st==="active") base += 5;
    if(st==="applied") base += 2;

    base += n(g.months) * 0.15;
    base += (n(g.amount)/100000) * 2;
    total += base;
  });

  state.data.effort.forEach(e=>{
    total += Math.max(0, n(e.hours)) * (r.effortW || 1);
  });

  return total;
}

function scorePublication(){
  const p = state.settings.publication;
  let total = 0;

  state.data.pubs.forEach(x=>{
    let base = p.base;

    const q = (x.quartile||"").toUpperCase();
    if(q==="Q1") base += p.q1;
    else if(q==="Q2") base += p.q2;
    else if(q==="Q3") base += p.q3;

    const auth = (x.authorship||"").toLowerCase();
    if(auth.includes("first") || auth.includes("single")) base += p.auth;

    const st = (x.status||"").toLowerCase();
    let mult = p.pubMult;
    if(st==="accepted") mult = p.accMult;
    if(st==="submitted") mult = p.subMult;
    if(st==="in preparation") mult = 0.30;

    total += base * mult;
  });

  return total;
}

function scoreAdmin(){
  const a = state.settings.admin;
  let total = 0;

  state.data.adminRoles.forEach(x=>{
    const lvlScore = n(a.levelW[x.level] ?? 0);
    const meetings = Math.max(0, n(x.meetings));
    const prep = Math.max(0, n(x.prep));
    const months = Math.max(0, n(x.months));
    const bonus = n(a.bonus[x.type] ?? 0);

    total += lvlScore + (meetings*a.perMeeting) + (prep*a.perPrepHour) + (months*a.perMonth) + bonus;
  });
  return total;
}

function scoreServices(){
  const s = state.settings.service;
  const calc = (arr)=>{
    let t = 0;
    arr.forEach(x=>{
      let base = (Math.max(0, n(x.hours)) * s.hourW) + ((Math.max(0, n(x.pax))/10) * s.paxW);
      base += (String(x.role).toLowerCase()==="lead") ? s.lead : s.member;
      t += base;
    });
    return t;
  };
  return calc(state.data.svcUni) + calc(state.data.svcInd) + calc(state.data.svcCom);
}

function classify(index){
  if(index < 40) return { key:"low", label:"Low", desc:"Lower workload range." };
  if(index < 70) return { key:"normal", label:"Normal", desc:"Balanced workload range." };
  if(index < 90) return { key:"high", label:"High", desc:"High busyness. Be cautious with new assignments." };
  return { key:"over", label:"Overload", desc:"Very high. Consider workload redistribution/support." };
}

/* Chart */
let chartObj=null;
function drawChart(vals){
  const ctx = $("chart").getContext("2d");
  if(chartObj) chartObj.destroy();

  const css = getComputedStyle(document.documentElement);
  const colors = [
    css.getPropertyValue("--c-teaching").trim(),
    css.getPropertyValue("--c-supervision").trim(),
    css.getPropertyValue("--c-research").trim(),
    css.getPropertyValue("--c-publication").trim(),
    css.getPropertyValue("--c-admin").trim(),
    css.getPropertyValue("--c-service").trim()
  ];

  chartObj = new Chart(ctx,{
    type:"bar",
    data:{
      labels:["Teaching","Supervision","Research","Publication","Administration","Services"],
      datasets:[{ data: vals, backgroundColor: colors }]
    },
    options:{
      responsive:true,
      plugins:{ legend:{ display:false } },
      scales:{ y:{ beginAtZero:true } }
    }
  });
}

/* Narrative */
function narrativeFromScores(scores, weights){
  // scores: {T,SV,R,P,A,S}
  const items = [
    {k:"Teaching", v:scores.T, w:weights.T},
    {k:"Supervision", v:scores.SV, w:weights.SV},
    {k:"Research", v:scores.R, w:weights.R},
    {k:"Publication", v:scores.P, w:weights.P},
    {k:"Administration", v:scores.A, w:weights.A},
    {k:"Services", v:scores.S, w:weights.S},
  ];

  // Contribution proxy = score * weight
  const contrib = items.map(x=>({k:x.k, c:x.v * x.w, raw:x.v, w:x.w}));
  contrib.sort((a,b)=>b.c-a.c);

  const top = contrib.slice(0,2);
  const low = contrib.slice(-2).reverse();

  const topTxt = top.map(x=>`${x.k} (contribution ${x.c.toFixed(1)})`).join(" and ");
  const lowTxt = low.map(x=>`${x.k} (contribution ${x.c.toFixed(1)})`).join(" and ");

  const msg = [
    `This staff member’s busyness is driven mainly by ${topTxt}.`,
    `Areas contributing less are ${lowTxt}.`,
    `If workload redistribution is needed, consider reducing assignments in ${top[0].k} first (highest contribution), or provide support such as co-teaching, shared supervision, admin assistance, or task reallocation.`,
    `To increase balanced performance (if required by management), opportunities may include strengthening activities in ${low[0].k} with realistic targets aligned to the reporting period.`
  ].join(" ");

  return msg;
}

/* Admin lock + mode */
function setSettingsLocked(locked){
  const ids = [
    "preset","wT","wSV","wR","wP","wA","wS",
    "tCreditW","tStudentW","tHourW","tPgMult",
    "svUGW","svMW","svPW","svMainMult","svCoMult","svComMult","svMonthW","svMeetW",
    "rPI","rCo","rMem","rEffortW",
    "pBase","pQ1","pQ2","pQ3","pAuth","pPubMult","pAccMult","pSubMult",
    "aProg","aFac","aUni","aState","aNat","aInt","aInd","aMeetW","aPrepW","aMonthW","aOfficialB","aConfB",
    "sHourW","sPaxW","sLead","sMember"
  ];
  ids.forEach(id=>{
    const e = $(id); if(!e) return;
    if(e.tagName==="SELECT") e.disabled = locked;
    else e.readOnly = locked;
  });
  $("lockText").textContent = locked ? "Locked" : "Unlocked (Admin)";
  $("lockDot").style.background = locked ? "var(--warn)" : "var(--ok)";
}

function adminUnlock(){
  const pw = $("adminPw").value || "";
  if(pw === ADMIN_PASSWORD){
    isAdminUnlocked = true;
    setSettingsLocked(false);
    showMsg("ok", "<b>Admin unlocked:</b> Settings can now be edited on this browser.");
    autosave();
  } else {
    showMsg("bad", "<b>Admin unlock failed:</b> Incorrect password.");
  }
}

function toggleMode(){
  isManagementView = !isManagementView;
  $("roleText").textContent = isManagementView ? "Management View" : "Staff Mode";
  $("roleDot").style.background = isManagementView ? "var(--warn)" : "var(--ok)";
  $("btnToggleMode").textContent = isManagementView ? "Switch to Staff Mode" : "Switch to Management View";

  $("secSettings").style.display = isManagementView ? "none" : "block";

  const ro = isManagementView;
  ["pName","pStaffId","pDept","pGrade","pStatus","pPeriod","pGradeOther","pStatusOther"].forEach(id=>{
    const e = $(id); if(!e) return;
    if(e.tagName==="SELECT") e.disabled = ro;
    else e.readOnly = ro;
  });
  document.querySelectorAll("#secTeaching input, #secTeaching select, #secSupervision input, #secSupervision select, #secResearch input, #secResearch select, #secPublication input, #secPublication select, #secAdmin input, #secAdmin select, #secService input, #secService select")
    .forEach(e=>{ if(e.tagName==="SELECT") e.disabled = ro; else e.readOnly = ro; });

  ["addCourse","clearCourse","addSup","clearSup","addGrant","clearGrant","addEffort","clearEffort","addPub","clearPub","addAdmin","clearAdmin","addSU","addSI","addSC","clearServiceAll"]
    .forEach(id=>{ const b=$(id); if(b) b.style.display = ro ? "none" : "inline-flex"; });

  $("btnAdminUnlock").style.display = ro ? "none" : "inline-flex";
  showMsg("ok", ro
    ? "<b>Management View:</b> Settings hidden. Import JSON to review staff record (read-only)."
    : "<b>Staff Mode:</b> Fill activities, then Calculate at the bottom."
  );
}

/* Save/Load */
function autosave(){
  syncProfileFromUI();
  if(isAdminUnlocked) syncSettingsFromUI();
  localStorage.setItem(LS_KEY, JSON.stringify({ state, lastCalculatedISO, isAdminUnlocked }));
}
function loadLocal(){
  const raw = localStorage.getItem(LS_KEY);
  if(!raw) return false;
  try{
    const obj = JSON.parse(raw);
    if(obj?.state){
      Object.assign(state.profile, obj.state.profile || {});
      Object.assign(state.settings, obj.state.settings || {});
      Object.assign(state.data, obj.state.data || {});
      lastCalculatedISO = obj.lastCalculatedISO || "";
      isAdminUnlocked = !!obj.isAdminUnlocked;
      syncUIFromProfile();
      syncUIFromSettings();
      renderAll();
      setSettingsLocked(!isAdminUnlocked);
      return true;
    }
  }catch{}
  return false;
}
function resetAll(){
  if(!confirm("Reset all data and settings?")) return;
  localStorage.removeItem(LS_KEY);
  location.reload();
}

/* Calculate */
function calculate(){
  clearErrors();

  if(!validateWeightsStrict()){
    showMsg("warn", "<b>Action required:</b> Fix weights (sum must be exactly 1.00) before calculation.");
    return;
  }
  if(!validateProfileRequired()){
    showMsg("bad", "<b>Missing required profile fields.</b> Please complete all compulsory fields (including valid Staff ID format).");
    return;
  }
  if(!validateTables()){
    showMsg("bad", "<b>Missing required activity fields.</b> Please complete all compulsory cells highlighted in red.");
    return;
  }

  const T = scoreTeaching();
  const SV = scoreSupervision();
  const R = scoreResearch();
  const P = scorePublication();
  const A = scoreAdmin();
  const S = scoreServices();

  const w = state.settings.weights;
  const index = clamp((T*w.T) + (SV*w.SV) + (R*w.R) + (P*w.P) + (A*w.A) + (S*w.S), 0, 100);

  lastCalculatedISO = new Date().toISOString();
  $("auditStamp").textContent = "Calculated: " + lastCalculatedISO;

  $("outT").textContent = T.toFixed(1);
  $("outSV").textContent = SV.toFixed(1);
  $("outR").textContent = R.toFixed(1);
  $("outP").textContent = P.toFixed(1);
  $("outA").textContent = A.toFixed(1);
  $("outS").textContent = S.toFixed(1);
  $("bigIndex").textContent = index.toFixed(1);

  const cls = classify(index);
  $("zoneTag").className = "tag " + cls.key;
  $("zoneText").textContent = cls.label;
  $("zoneDesc").textContent = cls.desc;

  // chart + narrative
  drawChart([T, SV, R, P, A, S]);
  $("narrative").textContent = narrativeFromScores({T,SV,R,P,A,S}, w);

  // print-only signature info
  const d = new Date();
  $("printDate").textContent = d.toLocaleDateString("en-GB");
  $("sigStaffName").textContent = state.profile.name;
  $("sigStaffId").textContent = state.profile.staffId;

  showMsg("ok", "<b>OK:</b> Index updated. You may Export or Print PDF.");
  autosave();
}

/* Export helpers */
function downloadText(filename, text, mime="text/plain;charset=utf-8"){
  const blob = new Blob([text], {type:mime});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = filename;
  document.body.appendChild(a); a.click(); a.remove();
  setTimeout(()=>URL.revokeObjectURL(url), 500);
}
function quote(x){
  const s = String(x ?? "");
  if(s.includes(",") || s.includes('"') || s.includes("\\n")){
    return '"' + s.replaceAll('"','""') + '"';
  }
  return s;
}

function exportSummaryCSV(){
  calculate();
  const w = state.settings.weights;
  const header = [
    "timestamp","period","name","staff_id","programme_dept","grade","appointment_status",
    "score_T","score_SV","score_R","score_P","score_A","score_S","index_total","zone",
    "w_T","w_SV","w_R","w_P","w_A","w_S"
  ].join(",");

  const gradeFinal = (state.profile.grade==="Other") ? state.profile.gradeOther : state.profile.grade;
  const statusFinal = (state.profile.status==="Other") ? state.profile.statusOther : state.profile.status;

  const row = [
    lastCalculatedISO || new Date().toISOString(),
    quote(state.profile.period),
    quote(state.profile.name),
    quote(state.profile.staffId),
    quote(state.profile.dept),
    quote(gradeFinal),
    quote(statusFinal),
    n($("outT").textContent).toFixed(1),
    n($("outSV").textContent).toFixed(1),
    n($("outR").textContent).toFixed(1),
    n($("outP").textContent).toFixed(1),
    n($("outA").textContent).toFixed(1),
    n($("outS").textContent).toFixed(1),
    n($("bigIndex").textContent).toFixed(1),
    quote($("zoneText").textContent),
    w.T, w.SV, w.R, w.P, w.A, w.S
  ].join(",");

  downloadText("fst_ums_busyness_summary.csv", header + "\\n" + row, "text/csv;charset=utf-8");
}

function exportDetailedCSV(){
  calculate();
  const blocks = [];

  const gradeFinal = (state.profile.grade==="Other") ? state.profile.gradeOther : state.profile.grade;
  const statusFinal = (state.profile.status==="Other") ? state.profile.statusOther : state.profile.status;

  blocks.push("==PROFILE==");
  blocks.push(["timestamp","period","name","staff_id","programme_dept","grade","appointment_status"].join(","));
  blocks.push([
    lastCalculatedISO || new Date().toISOString(),
    quote(state.profile.period), quote(state.profile.name), quote(state.profile.staffId),
    quote(state.profile.dept), quote(gradeFinal), quote(statusFinal)
  ].join(","));

  blocks.push("\\n==COURSES==");
  blocks.push(["level","code","name","credit","students","lec","tut","lab","field","contact_hours"].join(","));
  state.data.courses.forEach(c=>{
    blocks.push([quote(c.level),quote(c.code),quote(c.name),n(c.credit),n(c.students),n(c.lec),n(c.tut),n(c.lab),n(c.field),contactHours(c)].join(","));
  });

  blocks.push("\\n==SUPERVISION==");
  blocks.push(["level","student","role","status","active_months","meetings"].join(","));
  state.data.supervisees.forEach(s=>{
    blocks.push([quote(s.level),quote(s.student),quote(s.role),quote(s.status),n(s.months),n(s.meetings)].join(","));
  });

  blocks.push("\\n==GRANTS==");
  blocks.push(["code","title","level","role","status","amount_rm","duration_months"].join(","));
  state.data.grants.forEach(g=>{
    blocks.push([quote(g.code),quote(g.title),quote(g.level),quote(g.role),quote(g.status),n(g.amount),n(g.months)].join(","));
  });

  blocks.push("\\n==RESEARCH_EFFORT==");
  blocks.push(["type","description","hours"].join(","));
  state.data.effort.forEach(e=>{
    blocks.push([quote(e.type),quote(e.desc),n(e.hours)].join(","));
  });

  blocks.push("\\n==PUBLICATIONS==");
  blocks.push(["year","title","index","quartile","authorship","status"].join(","));
  state.data.pubs.forEach(p=>{
    blocks.push([quote(p.year),quote(p.title),quote(p.index),quote(p.quartile),quote(p.authorship),quote(p.status)].join(","));
  });

  blocks.push("\\n==ADMIN_APPOINTMENTS==");
  blocks.push(["role","type","level","meetings","prep_hours","duration_months"].join(","));
  state.data.adminRoles.forEach(a=>{
    blocks.push([quote(a.role),quote(a.type),quote(a.level),n(a.meetings),n(a.prep),n(a.months)].join(","));
  });

  const svcDump = (name, arr)=>{
    blocks.push(`\\n==${name}==`);
    blocks.push(["activity","role","hours","participants","start","end"].join(","));
    arr.forEach(s=>{
      blocks.push([quote(s.activity),quote(s.role),n(s.hours),n(s.pax),quote(s.start),quote(s.end)].join(","));
    });
  };
  svcDump("SERVICE_UNIVERSITY", state.data.svcUni);
  svcDump("SERVICE_INDUSTRY", state.data.svcInd);
  svcDump("SERVICE_COMMUNITY", state.data.svcCom);

  downloadText("fst_ums_busyness_detailed.csv", blocks.join("\\n"), "text/csv;charset=utf-8");
}

function exportJSON(){
  calculate();
  const gradeFinal = (state.profile.grade==="Other") ? state.profile.gradeOther : state.profile.grade;
  const statusFinal = (state.profile.status==="Other") ? state.profile.statusOther : state.profile.status;

  const payload = {
    metadata: { exported_at: new Date().toISOString(), calculated_at: lastCalculatedISO || null, version:"v4", system:"FST UMS Staff Busyness Index" },
    profile: { ...state.profile, grade_final: gradeFinal, status_final: statusFinal },
    settings: state.settings,
    data: state.data,
    results: {
      T: n($("outT").textContent),
      SV: n($("outSV").textContent),
      R: n($("outR").textContent),
      P: n($("outP").textContent),
      A: n($("outA").textContent),
      S: n($("outS").textContent),
      index: n($("bigIndex").textContent),
      zone: $("zoneText").textContent,
      narrative: $("narrative").textContent
    }
  };
  downloadText("fst_ums_busyness_full.json", JSON.stringify(payload, null, 2), "application/json;charset=utf-8");
}

/* Presets */
function applyPreset(p){
  if(!isAdminUnlocked) return;

  if(p==="lecturer"){
    state.settings.weights = { T:0.40, SV:0.15, R:0.15, P:0.10, A:0.10, S:0.10 };
  } else if(p==="senior"){
    state.settings.weights = { T:0.35, SV:0.15, R:0.20, P:0.10, A:0.10, S:0.10 };
  } else if(p==="assoc"){
    state.settings.weights = { T:0.28, SV:0.17, R:0.22, P:0.10, A:0.13, S:0.10 };
  } else if(p==="prof"){
    state.settings.weights = { T:0.20, SV:0.18, R:0.25, P:0.12, A:0.15, S:0.10 };
  }
  syncUIFromSettings();
  autosave();
  showMsg("ok", `<b>Preset applied:</b> ${p}.`);
}

/* Add/Clear actions */
function addRow(kind){
  if(kind==="course") state.data.courses.push({ id:uid(), level:"UG", code:"", name:"", credit:0, students:0, lec:0, tut:0, lab:0, field:0 });
  if(kind==="sup") state.data.supervisees.push({ id:uid(), level:"UG", student:"", role:"Main", status:"Active", months:0, meetings:0 });
  if(kind==="grant") state.data.grants.push({ id:uid(), code:"", title:"", level:"University", role:"PI", status:"Active", amount:0, months:0 });
  if(kind==="effort") state.data.effort.push({ id:uid(), type:"Data collection/analysis", desc:"", hours:0 });
  if(kind==="pub") state.data.pubs.push({ id:uid(), year:"", title:"", index:"Scopus", quartile:"Q1", authorship:"First/Corresponding", status:"Published" });
  if(kind==="admin") state.data.adminRoles.push({ id:uid(), role:"", type:"Official", level:"Programme", meetings:0, prep:0, months:0 });

  if(kind==="svcUni") state.data.svcUni.push({ id:uid(), activity:"", role:"Lead", hours:0, pax:0, start:"", end:"" });
  if(kind==="svcInd") state.data.svcInd.push({ id:uid(), activity:"", role:"Lead", hours:0, pax:0, start:"", end:"" });
  if(kind==="svcCom") state.data.svcCom.push({ id:uid(), activity:"", role:"Lead", hours:0, pax:0, start:"", end:"" });

  renderAll(); autosave();
}

function clearKind(kind){
  if(!confirm("Clear this section?")) return;
  if(kind==="course") state.data.courses = [];
  if(kind==="sup") state.data.supervisees = [];
  if(kind==="grant") state.data.grants = [];
  if(kind==="effort") state.data.effort = [];
  if(kind==="pub") state.data.pubs = [];
  if(kind==="admin") state.data.adminRoles = [];
  if(kind==="svcAll"){ state.data.svcUni=[]; state.data.svcInd=[]; state.data.svcCom=[]; }

  ensureSeed();
  renderAll(); autosave();
}

/* Management import */
function importJSONFile(file){
  const reader = new FileReader();
  reader.onload = ()=>{
    try{
      const obj = JSON.parse(reader.result);
      if(obj?.profile && obj?.settings && obj?.data){
        Object.assign(state.profile, obj.profile || {});
        Object.assign(state.settings, obj.settings || {});
        Object.assign(state.data, obj.data || {});
        lastCalculatedISO = obj.metadata?.calculated_at || "";
      } else throw new Error("Invalid format");

      syncUIFromProfile();
      syncUIFromSettings();
      renderAll();

      if(!isManagementView) toggleMode();
      calculate();
      showMsg("ok", "<b>Imported:</b> Staff JSON loaded (Management View).");
    } catch(e){
      console.error(e);
      showMsg("bad", "<b>Error:</b> Unable to import JSON. Please import JSON exported from this system.");
    }
  };
  reader.readAsText(file);
}

/* Init */
function init(){
  $("yearNow").textContent = String(new Date().getFullYear());
  ensureSeed();
  renderAll();

  bindOther("pGrade","pGradeOtherWrap","pGradeOther");
  bindOther("pStatus","pStatusOtherWrap","pStatusOther");

  loadLocal();
  setSettingsLocked(!isAdminUnlocked);

  // settings change
  document.querySelectorAll("#secSettings input, #secSettings select").forEach(e=>{
    e.addEventListener("input", ()=>{
      if(!isAdminUnlocked) return;
      if(e.id==="preset") applyPreset(e.value);
      else autosave();
    });
  });

  // profile autosave
  ["pName","pStaffId","pDept","pPeriod","pGrade","pStatus","pGradeOther","pStatusOther"].forEach(id=>{
    $(id).addEventListener("input", ()=>autosave());
  });

  // buttons
  $("btnAdminUnlock").addEventListener("click",(e)=>{ e.preventDefault(); adminUnlock(); });
  $("btnToggleMode").addEventListener("click",(e)=>{ e.preventDefault(); toggleMode(); });

  $("btnSaveLocal").addEventListener("click",(e)=>{ e.preventDefault(); autosave(); showMsg("ok","<b>Saved:</b> Stored locally in this browser."); });
  $("btnLoadLocal").addEventListener("click",(e)=>{ e.preventDefault(); if(loadLocal()) showMsg("ok","<b>Loaded:</b> Local saved data loaded."); else showMsg("warn","<b>No saved data</b> found."); });
  $("btnResetAll").addEventListener("click",(e)=>{ e.preventDefault(); resetAll(); });

  $("addCourse").addEventListener("click",(e)=>{ e.preventDefault(); addRow("course"); });
  $("clearCourse").addEventListener("click",(e)=>{ e.preventDefault(); clearKind("course"); });

  $("addSup").addEventListener("click",(e)=>{ e.preventDefault(); addRow("sup"); });
  $("clearSup").addEventListener("click",(e)=>{ e.preventDefault(); clearKind("sup"); });

  $("addGrant").addEventListener("click",(e)=>{ e.preventDefault(); addRow("grant"); });
  $("clearGrant").addEventListener("click",(e)=>{ e.preventDefault(); clearKind("grant"); });

  $("addEffort").addEventListener("click",(e)=>{ e.preventDefault(); addRow("effort"); });
  $("clearEffort").addEventListener("click",(e)=>{ e.preventDefault(); clearKind("effort"); });

  $("addPub").addEventListener("click",(e)=>{ e.preventDefault(); addRow("pub"); });
  $("clearPub").addEventListener("click",(e)=>{ e.preventDefault(); clearKind("pub"); });

  $("addAdmin").addEventListener("click",(e)=>{ e.preventDefault(); addRow("admin"); });
  $("clearAdmin").addEventListener("click",(e)=>{ e.preventDefault(); clearKind("admin"); });

  $("addSU").addEventListener("click",(e)=>{ e.preventDefault(); addRow("svcUni"); });
  $("addSI").addEventListener("click",(e)=>{ e.preventDefault(); addRow("svcInd"); });
  $("addSC").addEventListener("click",(e)=>{ e.preventDefault(); addRow("svcCom"); });
  $("clearServiceAll").addEventListener("click",(e)=>{ e.preventDefault(); clearKind("svcAll"); });

  $("btnCalculate").addEventListener("click",(e)=>{ e.preventDefault(); calculate(); });
  $("btnPrint").addEventListener("click",(e)=>{ e.preventDefault(); calculate(); window.print(); });

  $("btnExportSummaryCSV").addEventListener("click",(e)=>{ e.preventDefault(); exportSummaryCSV(); });
  $("btnExportDetailedCSV").addEventListener("click",(e)=>{ e.preventDefault(); exportDetailedCSV(); });
  $("btnExportJSON").addEventListener("click",(e)=>{ e.preventDefault(); exportJSON(); });

  $("jsonImport").addEventListener("change",(e)=>{
    const f = e.target.files?.[0];
    if(f) importJSONFile(f);
    e.target.value = "";
  });
}

init();
</script>
</body>
</html>
