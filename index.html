<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>FST UMS – Staff Busyness Index (Calculator)</title>

  <!-- =========================================================
       ADMIN PASSWORD (EDIT HERE)
       Change this anytime to update admin access for Settings.
       NOTE: This is front-end only (GitHub Pages static).
       ========================================================= -->
  <script>
    const ADMIN_PASSWORD = "FST-ADMIN-2025";  // <-- EDIT PASSWORD HERE
  </script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- jsPDF for manual + report PDFs -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    :root{
      --bg:#0b1220;
      --text:#eaf0ff;
      --muted:#b8c3e6;
      --line:rgba(255,255,255,.12);
      --shadow: 0 18px 60px rgba(0,0,0,.45);
      --radius: 18px;

      --danger:#ff5b6e;
      --warn:#ffb020;
      --ok:#2bd4bf;

      --t:#a78bfa;
      --sv:#38bdf8;
      --r:#34d399;
      --p:#f472b6;
      --a:#fbbf24;
      --s:#fb7185;
      --l:#22c55e;
      --set:#60a5fa;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background:
        radial-gradient(1200px 700px at 20% 5%, rgba(96,165,250,.18), transparent 55%),
        radial-gradient(1000px 650px at 80% 10%, rgba(244,114,182,.14), transparent 60%),
        radial-gradient(900px 650px at 70% 80%, rgba(45,212,191,.12), transparent 55%),
        linear-gradient(180deg, #070b15, #0b1220 45%, #070b15);
      color:var(--text);
    }

    .wrap{max-width:1180px;margin:0 auto;padding:22px 18px 80px}

    .topbar{
      display:flex;align-items:center;justify-content:space-between;gap:16px;
      padding:14px 16px;border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      position:sticky;top:10px;z-index:20;
      backdrop-filter: blur(10px);
    }
    .brand{display:flex;align-items:center;gap:14px;min-width:280px}
    .logoBox{
      width:120px;height:72px;
      border-radius:14px;
      background:#ffffff;
      overflow:hidden;
      display:flex;align-items:center;justify-content:center;
      border:none;
      box-shadow:none;
      padding:8px;
      flex:0 0 auto;
    }
    .logoBox img{width:100%;height:100%;object-fit:contain}

    .title{display:flex;flex-direction:column;gap:2px}
    .title h1{font-size:16px;margin:0;letter-spacing:.2px}
    .title .sub{font-size:12px;color:var(--muted)}

    .top-actions{display:flex;flex-wrap:wrap;gap:8px;align-items:center;justify-content:flex-end}

    .btn{
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      color:var(--text);
      padding:10px 12px;border-radius:12px;
      cursor:pointer; font-weight:650;
      transition: transform .08s ease, background .2s ease, border .2s ease;
      user-select:none;
      white-space:nowrap;
    }
    .btn:hover{background:rgba(255,255,255,.10)}
    .btn:active{transform: translateY(1px)}
    .btn.primary{background:linear-gradient(180deg, rgba(45,212,191,.35), rgba(45,212,191,.16)); border-color: rgba(45,212,191,.45)}
    .btn.warn{background:linear-gradient(180deg, rgba(255,176,32,.38), rgba(255,176,32,.16)); border-color: rgba(255,176,32,.55)}
    .btn.danger{background:linear-gradient(180deg, rgba(255,91,110,.35), rgba(255,91,110,.14)); border-color: rgba(255,91,110,.55)}
    .btn.ghost{background:transparent}

    .pill{
      padding:8px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.05);
      color:var(--muted);
      font-size:12px;
    }
    .pill strong{color:var(--text)}

    .badge{
      display:inline-flex;align-items:center;gap:8px;
      padding:6px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      font-size:12px;color:var(--muted)
    }
    .dot{width:9px;height:9px;border-radius:99px;background:var(--ok);box-shadow:0 0 0 4px rgba(45,212,191,.15)}
    .dot.lock{background:var(--warn);box-shadow:0 0 0 4px rgba(255,176,32,.15)}

    .section{
      margin-top:16px;
      border:1px solid rgba(255,255,255,.10);
      border-radius: var(--radius);
      overflow:hidden;
      box-shadow: var(--shadow);
    }
    .section header{
      display:flex;gap:10px;align-items:flex-start;justify-content:space-between;
      padding:16px 18px;
      border-bottom:1px solid rgba(255,255,255,.10);
    }
    .section h2{margin:0;font-size:15px;letter-spacing:.2px}
    .section .sub{margin-top:4px;color:var(--muted);font-size:12px;max-width:920px}
    .content{padding:16px 18px}

    /* Strong section backgrounds */
    .profile{
      background:
        radial-gradient(900px 520px at 18% 10%, rgba(96,165,250,.46) 0%, rgba(96,165,250,0) 58%),
        linear-gradient(180deg, rgba(96,165,250,.22), rgba(255,255,255,.03));
    }
    .toggles{
      background:
        radial-gradient(900px 520px at 18% 10%, rgba(167,139,250,.46) 0%, rgba(167,139,250,0) 58%),
        linear-gradient(180deg, rgba(167,139,250,.22), rgba(255,255,255,.03));
    }
    .settings{
      background:
        radial-gradient(900px 520px at 18% 10%, rgba(96,165,250,.44) 0%, rgba(96,165,250,0) 58%),
        linear-gradient(180deg, rgba(96,165,250,.20), rgba(255,255,255,.03));
    }
    .teaching{
      background:
        radial-gradient(900px 520px at 18% 10%, rgba(167,139,250,.48) 0%, rgba(167,139,250,0) 60%),
        linear-gradient(180deg, rgba(167,139,250,.22), rgba(255,255,255,.03));
    }
    .supervision{
      background:
        radial-gradient(900px 520px at 18% 10%, rgba(56,189,248,.48) 0%, rgba(56,189,248,0) 60%),
        linear-gradient(180deg, rgba(56,189,248,.22), rgba(255,255,255,.03));
    }
    .research{
      background:
        radial-gradient(900px 520px at 18% 10%, rgba(52,211,153,.46) 0%, rgba(52,211,153,0) 60%),
        linear-gradient(180deg, rgba(52,211,153,.20), rgba(255,255,255,.03));
    }
    .publication{
      background:
        radial-gradient(900px 520px at 18% 10%, rgba(244,114,182,.46) 0%, rgba(244,114,182,0) 60%),
        linear-gradient(180deg, rgba(244,114,182,.20), rgba(255,255,255,.03));
    }
    .admin{
      background:
        radial-gradient(900px 520px at 18% 10%, rgba(251,191,36,.48) 0%, rgba(251,191,36,0) 60%),
        linear-gradient(180deg, rgba(251,191,36,.18), rgba(255,255,255,.03));
    }
    .service{
      background:
        radial-gradient(900px 520px at 18% 10%, rgba(251,113,133,.48) 0%, rgba(251,113,133,0) 60%),
        linear-gradient(180deg, rgba(251,113,133,.18), rgba(255,255,255,.03));
    }
    .labops{
      background:
        radial-gradient(900px 520px at 18% 10%, rgba(34,197,94,.48) 0%, rgba(34,197,94,0) 60%),
        linear-gradient(180deg, rgba(34,197,94,.18), rgba(255,255,255,.03));
    }
    .results{
      background:
        radial-gradient(900px 520px at 18% 10%, rgba(45,212,191,.48) 0%, rgba(45,212,191,0) 60%),
        linear-gradient(180deg, rgba(45,212,191,.18), rgba(255,255,255,.03));
    }

    .grid{display:grid;gap:12px}
    .grid.two{grid-template-columns:repeat(2, minmax(0,1fr))}
    .grid.three{grid-template-columns:repeat(3, minmax(0,1fr))}
    @media(max-width:980px){
      .grid.two,.grid.three{grid-template-columns:1fr}
      .topbar{position:relative;top:auto}
      .logoBox{width:110px;height:66px}
    }

    /* Phone-first polish */
    @media(max-width:640px){
      .wrap{padding:14px 12px 86px}
      .topbar{
        flex-direction:column;
        align-items:stretch;
        gap:10px;
        position:relative;
        top:auto;
      }
      .brand{min-width:unset}
      .title h1{font-size:14px}
      .title .sub{font-size:12px}
      .top-actions{
        width:100%;
        justify-content:flex-start;
      }
      .adminPanel{width:100%}
      .adminPanel input{width:100% !important}
      .btn{flex:1 1 auto}
      .pill,.badge{width:100%;justify-content:center}
      .logoBox{width:108px;height:64px}
      .content{padding:14px}
      th,td{padding:8px 6px}
    }

    label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
    input,select,textarea{
      width:100%;
      background:rgba(7,11,21,.55);
      border:1px solid rgba(255,255,255,.14);
      color:var(--text);
      border-radius:12px;
      padding:10px 10px;
      outline:none;
    }
    textarea{min-height:42px;resize:vertical}
    textarea.autoGrow{
      resize:none;
      overflow:hidden;
      min-height:42px;
    }
    input.err, select.err, textarea.err{border-color: rgba(255,91,110,.85) !important; box-shadow: 0 0 0 3px rgba(255,91,110,.18)}
    .hint{font-size:12px;color:var(--muted);margin-top:6px}
    .requiredMark::after{content:" *"; color: var(--warn); font-weight:800}

    .tableWrap{
      width:100%;
      overflow:auto;
      -webkit-overflow-scrolling:touch;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.08);
      background:rgba(7,11,21,.18);
    }
    table{width:100%;border-collapse:collapse;min-width:980px}
    @media(max-width:720px){
      table{min-width:980px}
    }
    th,td{border-bottom:1px solid rgba(255,255,255,.10);padding:10px 8px;vertical-align:top}
    th{font-size:12px;color:var(--muted);text-align:left}
    td input, td select, td textarea{padding:8px 8px;border-radius:10px}

    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .row.right{justify-content:flex-end}

    .notice{
      padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);color:var(--muted);font-size:12px
    }
    .notice.bad{border-color: rgba(255,91,110,.55); background: rgba(255,91,110,.10); color:#ffd9de}
    .notice.warn{border-color: rgba(255,176,32,.55); background: rgba(255,176,32,.10); color:#ffe9c2}
    .notice.ok{border-color: rgba(45,212,191,.55); background: rgba(45,212,191,.10); color:#d9fffb}

    .kpi{
      display:grid;gap:10px;
      grid-template-columns:repeat(4, minmax(0,1fr));
    }
    @media(max-width:900px){ .kpi{grid-template-columns:repeat(2, minmax(0,1fr))} }
    @media(max-width:520px){ .kpi{grid-template-columns:1fr} }
    .box{
      border:1px solid rgba(255,255,255,.12);
      background:rgba(7,11,21,.40);
      border-radius:14px;
      padding:12px;
    }
    .box .k{font-size:12px;color:var(--muted)}
    .box .v{font-size:20px;font-weight:900;margin-top:4px}
    .box .s{font-size:12px;color:var(--muted);margin-top:4px}

    .footer{
      margin-top:18px;
      color:rgba(255,255,255,.55);
      font-size:12px;text-align:center
    }

    .spacer{height:10px}

    /* Keep print CSS minimal because Print button generates a B/W professional PDF via jsPDF */
    @media print{
      body{background:#fff;color:#000}
      .topbar,.noPrint,#secSettings,#secToggles{display:none !important}
      .wrap{max-width:900px;padding:0}
      .section{box-shadow:none;border:1px solid #ddd}
      .section header{background:#f7f7f7;color:#000}
      .content, input, select, textarea{color:#000}
      input,select,textarea{background:#fff;border:1px solid #bbb}
      .box{border:1px solid #ddd;background:#fff}
      canvas{max-width:100% !important}
    }

    .adminPanel{
      display:flex;gap:8px;align-items:center;flex-wrap:wrap;
    }
    .adminPanel input{
      width:220px;
      background:rgba(7,11,21,.65);
    }
    .small{font-size:12px;color:var(--muted)}
  </style>
</head>

<body>
<div class="wrap">

  <div class="topbar">
    <div class="brand">
      <div class="logoBox" title="Place 'UMS logo.png' in the same folder as index.html">
        <img id="umsLogo" src="UMS logo.png" alt="UMS logo"
             onerror="this.style.display='none'; this.parentElement.innerHTML='<div style=&quot;color:#111;font-weight:800;font-size:12px;text-align:center;line-height:1.1&quot;>UMS<br>LOGO</div>';">
      </div>
      <div class="title">
        <h1>FST UMS – Staff Busyness Index Calculator</h1>
        <div class="sub">Single-file tool (GitHub Pages). Admin can lock weights/mark scheme; staff only enter activities.</div>
      </div>
    </div>

    <div class="top-actions noPrint">
      <span class="pill">Mode: <strong id="modeText">Staff</strong></span>
      <span class="badge"><span id="lockDot" class="dot lock"></span><span id="lockText">Settings locked</span></span>

      <div class="adminPanel">
        <input type="password" id="adminPass" placeholder="Admin password (for Settings)">
        <button class="btn warn" id="btnAdminUnlock">Unlock</button>
        <button class="btn ghost" id="btnAdminLock" style="display:none;">Lock</button>
      </div>

      <button class="btn" id="btnSaveLocal">Save</button>
      <button class="btn danger" id="btnReset">Reset</button>
    </div>
  </div>

  <!-- PROFILE -->
  <section class="section profile" id="secProfile">
    <header>
      <div>
        <h2>Staff Profile</h2>
        <div class="sub">All fields are required. Staff ID example: <b>250505-02025</b>.</div>
      </div>
    </header>
    <div class="content">
      <div class="grid three">
        <div>
          <label class="requiredMark">Full Name</label>
          <input id="pName" placeholder="e.g., Assis Kamu"/>
        </div>
        <div>
          <label class="requiredMark">Staff ID</label>
          <input id="pStaffId" placeholder="e.g., 250505-02025"/>
        </div>
        <div>
          <label class="requiredMark">Staff Category</label>
          <select id="pCategory">
            <option value="">Select</option>
            <option value="Academic">Academic</option>
            <option value="Administrative">Administrative Staff</option>
            <option value="Laboratory">Laboratory Staff</option>
          </select>
          <div class="hint">Selecting category will auto-apply ON/OFF sections and default weights.</div>
        </div>

        <div>
          <label class="requiredMark">Programme/Unit</label>
          <textarea id="pUnit" class="autoGrow" rows="1" placeholder="e.g., Mathematics with Economics / Finance Unit / Chemistry Lab"></textarea>
        </div>

        <div>
          <label class="requiredMark">Grade</label>
          <select id="pGrade">
            <option value="">Select</option>
            <option>Lecturer</option>
            <option>Senior Lecturer</option>
            <option>Associate Professor</option>
            <option>Professor</option>
            <option>Lab Officer</option>
            <option>Assistant Science Officer</option>
            <option>Administrative Officer</option>
            <option>Others</option>
          </select>
        </div>
        <div id="pGradeOtherWrap" style="display:none;">
          <label class="requiredMark">Grade (Others) – please specify</label>
          <textarea id="pGradeOther" class="autoGrow" rows="1" placeholder="Type grade here"></textarea>
        </div>

        <div>
          <label class="requiredMark">Employment Status</label>
          <select id="pStatus">
            <option value="">Select</option>
            <option>Permanent</option>
            <option>Contract</option>
            <option>Part-time</option>
            <option>Others</option>
          </select>
        </div>
        <div id="pStatusOtherWrap" style="display:none;">
          <label class="requiredMark">Status (Others) – please specify</label>
          <textarea id="pStatusOther" class="autoGrow" rows="1" placeholder="Type status here"></textarea>
        </div>

        <div>
          <label class="requiredMark">Reporting Period</label>
          <select id="pPeriod">
            <option value="">Select</option>
            <option value="Monthly">Monthly</option>
            <option value="Quarterly">Quarterly</option>
            <option value="Semester">Semester</option>
            <option value="Annual">Annual</option>
          </select>
        </div>
      </div>

      <div class="spacer"></div>
      <div id="msgProfile" class="notice warn" style="display:none;"></div>
    </div>
  </section>

  <!-- TOGGLES -->
  <section class="section toggles" id="secToggles">
    <header>
      <div>
        <h2>Section Applicability (ON/OFF)</h2>
        <div class="sub">
          Turn ON only relevant sections. The calculator will <b>auto re-normalize weights</b> using ON sections only.
          (This supports Academic, Administrative, and Laboratory roles fairly.)
        </div>
      </div>
      <div class="row right noPrint">
        <span class="pill">Auto from Category</span>
      </div>
    </header>
    <div class="content">
      <div class="grid three">
        <div><label><input type="checkbox" id="enTeaching" checked> Teaching</label></div>
        <div><label><input type="checkbox" id="enSupervision" checked> Supervision</label></div>
        <div><label><input type="checkbox" id="enResearch" checked> Research</label></div>
        <div><label><input type="checkbox" id="enPublication" checked> Publication</label></div>
        <div><label><input type="checkbox" id="enAdministration" checked> Administration</label></div>
        <div><label><input type="checkbox" id="enServices" checked> Services</label></div>
        <div><label><input type="checkbox" id="enLabOps"> Lab Operations</label></div>
      </div>
      <div class="spacer"></div>
      <div id="toggleWarn" class="notice warn" style="display:none;"></div>
    </div>
  </section>

  <!-- SETTINGS (ADMIN ONLY) -->
  <section class="section settings" id="secSettings">
    <header>
      <div>
        <h2>Settings (Weights & Scoring Scheme) – Admin Only</h2>
        <div class="sub">
          Locked by default. Admin must unlock using password to edit.
          <span class="small">Baseline weights must sum to 1.00.</span>
        </div>
      </div>
    </header>
    <div class="content">
      <div id="msgSettings" class="notice warn" style="display:none;"></div>

      <div class="grid three">
        <div><label class="requiredMark">Weight: Teaching (T)</label><input class="adminOnly" id="wT" type="number" step="0.01" min="0" value="0.30"/></div>
        <div><label class="requiredMark">Weight: Supervision (SV)</label><input class="adminOnly" id="wSV" type="number" step="0.01" min="0" value="0.15"/></div>
        <div><label class="requiredMark">Weight: Research (R)</label><input class="adminOnly" id="wR" type="number" step="0.01" min="0" value="0.20"/></div>
        <div><label class="requiredMark">Weight: Publication (P)</label><input class="adminOnly" id="wP" type="number" step="0.01" min="0" value="0.10"/></div>
        <div><label class="requiredMark">Weight: Administration (A)</label><input class="adminOnly" id="wA" type="number" step="0.01" min="0" value="0.15"/></div>
        <div><label class="requiredMark">Weight: Services (S)</label><input class="adminOnly" id="wS" type="number" step="0.01" min="0" value="0.10"/></div>
        <div><label class="requiredMark">Weight: Lab Operations (L)</label><input class="adminOnly" id="wL" type="number" step="0.01" min="0" value="0.00"/></div>
      </div>

      <div class="spacer"></div>
      <div class="row noPrint">
        <button class="btn adminOnly" id="btnPresetAcademic">Preset: Academic</button>
        <button class="btn adminOnly" id="btnPresetAdmin">Preset: Administrative</button>
        <button class="btn adminOnly" id="btnPresetLab">Preset: Laboratory</button>
      </div>

      <div class="spacer"></div>
      <div class="notice">
        <b>Important:</b> During calculation, the system uses only ON sections and re-normalizes weights automatically.
        Baseline weights (admin) must still sum to <b>1.00</b>.
      </div>

      <div class="spacer"></div>
      <hr style="border:0;border-top:1px solid rgba(255,255,255,.10);margin:16px 0">

      <div class="grid three">
        <div><label>Teaching – points per contact hour</label><input class="adminOnly" id="tHourW" type="number" step="0.1" min="0" value="1.0"/></div>
        <div><label>Teaching – points per student (scaled /100)</label><input class="adminOnly" id="tStudW" type="number" step="0.1" min="0" value="0.6"/></div>
        <div><label>Teaching – multiplier per credit</label><input class="adminOnly" id="tCreditW" type="number" step="0.1" min="0" value="0.4"/></div>

        <div><label>Supervision – UG (per student)</label><input class="adminOnly" id="svUG" type="number" step="0.1" min="0" value="1.5"/></div>
        <div><label>Supervision – Master (per student)</label><input class="adminOnly" id="svM" type="number" step="0.1" min="0" value="3.0"/></div>
        <div><label>Supervision – PhD (per student)</label><input class="adminOnly" id="svPHD" type="number" step="0.1" min="0" value="4.5"/></div>

        <div><label>Research – base points per grant</label><input class="adminOnly" id="rBase" type="number" step="0.1" min="0" value="6"/></div>
        <div><label>Research – level multipliers (Uni,Nat,Intl)</label><input class="adminOnly" id="rUniNatIntl" type="text" value="1.0,1.4,1.8"/></div>
        <div><label>Research – role multipliers (PI,Co-I,Member)</label><input class="adminOnly" id="rRole" type="text" value="1.6,1.2,1.0"/></div>

        <div><label>Publication – base points per item</label><input class="adminOnly" id="pBase" type="number" step="0.1" min="0" value="4"/></div>
        <div><label>Publication – type multipliers (Journal,Book,Proceeding,Other)</label><input class="adminOnly" id="pType" type="text" value="1.5,1.8,1.0,0.8"/></div>
        <div><label>Publication – indexed multipliers (Yes,No)</label><input class="adminOnly" id="pIdx" type="text" value="1.4,1.0"/></div>

        <div><label>Admin – base points by level (Prog,Fac,Uni,State,Nat,Intl,Industry)</label><input class="adminOnly" id="aLevel" type="text" value="3,5,7,8,10,12,9"/></div>
        <div><label>Admin – per meeting points</label><input class="adminOnly" id="aMeetW" type="number" step="0.1" min="0" value="1.5"/></div>
        <div><label>Admin – per month points</label><input class="adminOnly" id="aMonthW" type="number" step="0.1" min="0" value="0.3"/></div>

        <div><label>Services – points per hour</label><input class="adminOnly" id="sHourW" type="number" step="0.1" min="0" value="1.0"/></div>
        <div><label>Services – points per participants (scaled /10)</label><input class="adminOnly" id="sPaxW" type="number" step="0.1" min="0" value="0.8"/></div>
        <div><label>Services – role bonus (Lead,Member)</label><input class="adminOnly" id="sRoleBonus" type="text" value="4,1.5"/></div>

        <div><label>Lab Ops – points per volume</label><input class="adminOnly" id="lVolW" type="number" step="0.1" min="0" value="1.0"/></div>
        <div><label>Lab Ops – points per hour</label><input class="adminOnly" id="lHourW" type="number" step="0.1" min="0" value="1.0"/></div>
        <div><label>Lab Ops – multipliers (Complexity Low,Med,High)</label><input class="adminOnly" id="lCx" type="text" value="1.0,1.3,1.6"/></div>
        <div><label>Lab Ops – multipliers (Urgency Normal,Tight,Critical)</label><input class="adminOnly" id="lUr" type="text" value="1.0,1.25,1.5"/></div>
      </div>

      <div class="spacer"></div>
      <div class="notice">
        <b>Admin password location:</b> At the very top of this <code>index.html</code>, search for <code>ADMIN_PASSWORD</code>.
      </div>
    </div>
  </section>

  <!-- TEACHING -->
  <section class="section teaching" id="secTeaching">
    <header>
      <div>
        <h2>Teaching</h2>
        <div class="sub">Credit is auto-extracted from the <b>last digit</b> of course code (e.g., SJ24102 → credit=2). Contact hours are auto-computed.</div>
      </div>
      <div class="row right noPrint">
        <button class="btn" id="addTeach">+ Add course</button>
        <button class="btn ghost" id="clearTeach">Clear</button>
      </div>
    </header>
    <div class="content">
      <div class="tableWrap">
        <table id="tblTeach">
          <thead>
            <tr>
              <th style="width:14%">Course Code *</th>
              <th>Course Name *</th>
              <th style="width:8%">Credit</th>
              <th style="width:10%">Students *</th>
              <th style="width:10%">Lecture *</th>
              <th style="width:10%">Tutorial *</th>
              <th style="width:10%">Lab *</th>
              <th style="width:10%">Field *</th>
              <th style="width:10%">Contact hrs</th>
              <th style="width:6%">Del</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="hint">On phone: swipe left/right on the table if needed.</div>
    </div>
  </section>

  <!-- SUPERVISION -->
  <section class="section supervision" id="secSupervision">
    <header>
      <div>
        <h2>Supervision</h2>
        <div class="sub">Include active supervision load for the reporting period (UG, Master, PhD).</div>
      </div>
      <div class="row right noPrint">
        <button class="btn" id="addSv">+ Add supervision</button>
        <button class="btn ghost" id="clearSv">Clear</button>
      </div>
    </header>
    <div class="content">
      <div class="tableWrap">
        <table id="tblSv">
          <thead>
            <tr>
              <th style="width:18%">Level *</th>
              <th>Student / Project *</th>
              <th style="width:14%">Role *</th>
              <th style="width:12%">Status *</th>
              <th style="width:12%">Start *</th>
              <th style="width:12%">End *</th>
              <th style="width:8%">Del</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="hint">On phone: swipe left/right on the table if needed.</div>
    </div>
  </section>

  <!-- RESEARCH -->
  <section class="section research" id="secResearch">
    <header>
      <div>
        <h2>Research (Grants / Projects)</h2>
        <div class="sub">Specify grant level, status, role, amount and duration.</div>
      </div>
      <div class="row right noPrint">
        <button class="btn" id="addRes">+ Add grant</button>
        <button class="btn ghost" id="clearRes">Clear</button>
      </div>
    </header>
    <div class="content">
      <div class="tableWrap">
        <table id="tblRes">
          <thead>
            <tr>
              <th style="width:14%">Grant Code *</th>
              <th>Title *</th>
              <th style="width:14%">Level *</th>
              <th style="width:12%">Status *</th>
              <th style="width:12%">Role *</th>
              <th style="width:12%">Amount (RM) *</th>
              <th style="width:10%">Start *</th>
              <th style="width:10%">End *</th>
              <th style="width:6%">Del</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="hint">On phone: swipe left/right on the table if needed.</div>
    </div>
  </section>

  <!-- PUBLICATION -->
  <section class="section publication" id="secPublication">
    <header>
      <div>
        <h2>Publication</h2>
        <div class="sub">If ON, record publication output for the reporting period.</div>
      </div>
      <div class="row right noPrint">
        <button class="btn" id="addPub">+ Add publication</button>
        <button class="btn ghost" id="clearPub">Clear</button>
      </div>
    </header>
    <div class="content">
      <div class="tableWrap">
        <table id="tblPub">
          <thead>
            <tr>
              <th style="width:10%">Year *</th>
              <th>Title *</th>
              <th style="width:16%">Type *</th>
              <th style="width:14%">Indexed? *</th>
              <th style="width:14%">Role *</th>
              <th style="width:12%">Start *</th>
              <th style="width:12%">End *</th>
              <th style="width:6%">Del</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="hint">On phone: swipe left/right on the table if needed.</div>
    </div>
  </section>

  <!-- ADMINISTRATION -->
  <section class="section admin" id="secAdmin">
    <header>
      <div>
        <h2>Administration</h2>
        <div class="sub">Include appointments (official/ad-hoc), level, duration (months) and meeting workload.</div>
      </div>
      <div class="row right noPrint">
        <button class="btn" id="addAdmin">+ Add admin role</button>
        <button class="btn ghost" id="clearAdmin">Clear</button>
      </div>
    </header>
    <div class="content">
      <div class="tableWrap">
        <table id="tblAdmin">
          <thead>
            <tr>
              <th style="width:18%">Position *</th>
              <th style="width:14%">Type *</th>
              <th style="width:18%">Level *</th>
              <th style="width:10%">Months *</th>
              <th style="width:10%">Meetings *</th>
              <th>Notes *</th>
              <th style="width:10%">Start *</th>
              <th style="width:10%">End *</th>
              <th style="width:6%">Del</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="spacer"></div>
      <div class="notice">Tip: For conference committee work (AJK), use Position = “Conference Committee” and describe pre-conference preparation in Notes.</div>
      <div class="hint">On phone: swipe left/right on the table if needed.</div>
    </div>
  </section>

  <!-- SERVICES -->
  <section class="section service" id="secService">
    <header>
      <div>
        <h2>Services</h2>
        <div class="sub">Service to university / industry / community. Include start and end dates.</div>
      </div>
      <div class="row right noPrint">
        <button class="btn" id="addSvc">+ Add service</button>
        <button class="btn ghost" id="clearSvc">Clear</button>
      </div>
    </header>
    <div class="content">
      <div class="tableWrap">
        <table id="tblSvc">
          <thead>
            <tr>
              <th style="width:18%">Service Type *</th>
              <th>Activity *</th>
              <th style="width:12%">Role *</th>
              <th style="width:10%">Hours *</th>
              <th style="width:10%">Participants *</th>
              <th style="width:12%">Start *</th>
              <th style="width:12%">End *</th>
              <th style="width:6%">Del</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="hint">On phone: swipe left/right on the table if needed.</div>
    </div>
  </section>

  <!-- LAB OPS -->
  <section class="section labops" id="secLabOps" style="display:none;">
    <header>
      <div>
        <h2>Lab Operations</h2>
        <div class="sub">For lab staff or lab-support work. Scored using (volume + hours) × complexity × urgency.</div>
      </div>
      <div class="row right noPrint">
        <button class="btn" id="addLab">+ Add lab activity</button>
        <button class="btn ghost" id="clearLab">Clear</button>
      </div>
    </header>
    <div class="content">
      <div class="tableWrap">
        <table id="tblLab">
          <thead>
            <tr>
              <th style="width:18%">Type *</th>
              <th>Description *</th>
              <th style="width:10%">Volume *</th>
              <th style="width:12%">Complexity *</th>
              <th style="width:12%">Urgency *</th>
              <th style="width:10%">Hours *</th>
              <th style="width:12%">Start *</th>
              <th style="width:12%">End *</th>
              <th style="width:6%">Del</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="hint">On phone: swipe left/right on the table if needed.</div>
    </div>
  </section>

  <!-- RESULTS -->
  <section class="section results" id="secResults">
    <header>
      <div>
        <h2>Results</h2>
        <div class="sub">Calculate index, view section contributions, export for dashboard, and generate professional black & white PDF report.</div>
      </div>
    </header>
    <div class="content">
      <div id="msgGlobal" class="notice warn" style="display:none;"></div>

      <div class="kpi">
        <div class="box"><div class="k">Teaching (T)</div><div class="v" id="outT">0.0</div><div class="s">Contact hours × students × credit</div></div>
        <div class="box"><div class="k">Supervision (SV)</div><div class="v" id="outSV">0.0</div><div class="s">UG/Master/PhD load</div></div>
        <div class="box"><div class="k">Research (R)</div><div class="v" id="outR">0.0</div><div class="s">Grants × level × role</div></div>
        <div class="box"><div class="k">Publication (P)</div><div class="v" id="outP">0.0</div><div class="s">Type × indexed × role</div></div>

        <div class="box"><div class="k">Administration (A)</div><div class="v" id="outA">0.0</div><div class="s">Level + meetings + months</div></div>
        <div class="box"><div class="k">Services (S)</div><div class="v" id="outS">0.0</div><div class="s">Hours + participants + role</div></div>
        <div class="box"><div class="k">Lab Operations (L)</div><div class="v" id="outL">0.0</div><div class="s">Volume + hours × multipliers</div></div>
        <div class="box">
          <div class="k">Overall Busyness Index</div>
          <div class="v" id="outIndex">0.0</div>
          <div class="s" id="outBand">—</div>
        </div>
      </div>

      <div class="spacer"></div>

      <div class="box">
        <div class="row" style="justify-content:space-between;align-items:flex-start">
          <div style="min-width:280px">
            <div class="k">Dean View Summary (read-only)</div>
            <div class="hint" id="outDean">—</div>
            <div class="spacer"></div>
            <div class="k">Narrative Summary</div>
            <div class="hint" id="outNarr">—</div>
          </div>
          <div class="row noPrint">
            <button class="btn primary" id="btnCalc">Calculate</button>
            <button class="btn" id="btnPrint">Print PDF</button>
            <button class="btn warn" id="btnManual">Download Manual (PDF)</button>
          </div>
        </div>
      </div>

      <div class="spacer"></div>

      <div class="row noPrint">
        <button class="btn" id="btnExportSummaryCSV">Export Summary CSV</button>
        <button class="btn" id="btnExportDetailedCSV">Export Detailed CSV</button>
        <button class="btn" id="btnExportJSON">Export Full JSON</button>
      </div>

      <div class="spacer"></div>

      <div class="box">
        <canvas id="chart" height="120"></canvas>
        <div class="hint">Chart is for on-screen view only. The PDF report is black & white.</div>
      </div>

    </div>
  </section>

  <div class="footer">© FST UMS</div>
</div>

<script>
/* ========================= Helpers ========================= */
const $ = (id)=>document.getElementById(id);
const clamp = (x,a,b)=>Math.max(a,Math.min(b,x));
const n = (v)=>{ const x=parseFloat(v); return isNaN(x)?0:x; };
const uid = ()=>Math.random().toString(16).slice(2)+Date.now().toString(16);

function showMsg(kind, html){
  const el = $("msgGlobal");
  el.className = "notice " + (kind==="bad"?"bad":kind==="ok"?"ok":"warn");
  el.innerHTML = html;
  el.style.display = "block";
}
function hideMsg(){ $("msgGlobal").style.display="none"; }

function autosizeTextarea(el){
  if(!el) return;
  if(el.tagName !== "TEXTAREA") return;
  el.style.height = "auto";
  const max = 320; // keep reasonable on table rows
  el.style.height = Math.min(el.scrollHeight, max) + "px";
}
function autosizeAllTextareas(root=document){
  root.querySelectorAll("textarea.autoGrow").forEach(t=>autosizeTextarea(t));
}

/* ========================= State ========================= */
let isAdmin = false;
let lastCalc = null; // store last calculated results for PDF/report/manual

const state = {
  profile:{
    name:"", staffId:"", category:"", unit:"",
    grade:"", gradeOther:"",
    status:"", statusOther:"",
    period:""
  },
  enabled:{ T:true, SV:true, R:true, P:true, A:true, S:true, L:false },
  weights:{ T:0.30, SV:0.15, R:0.20, P:0.10, A:0.15, S:0.10, L:0.00 },
  scheme:{
    teaching:{ hourW:1.0, studW:0.6, creditW:0.4 },
    supervision:{ ug:1.5, m:3.0, phd:4.5 },
    research:{ base:6, lvl:[1.0,1.4,1.8], role:[1.6,1.2,1.0] },
    publication:{ base:4, type:[1.5,1.8,1.0,0.8], idx:[1.4,1.0] },
    admin:{ lvl:[3,5,7,8,10,12,9], meetW:1.5, monthW:0.3 },
    service:{ hourW:1.0, paxW:0.8, bonus:[4,1.5] },
    lab:{ volW:1.0, hourW:1.0, cx:[1.0,1.3,1.6], ur:[1.0,1.25,1.5] }
  },
  data:{
    teaching:[],
    supervision:[],
    research:[],
    publication:[],
    admin:[],
    service:[],
    lab:[]
  },
  audit:{ last_saved_at:null, last_calc_at:null }
};

/* ========================= Admin lock ========================= */
function setAdminUI(){
  $("modeText").textContent = isAdmin ? "Admin" : "Staff";
  $("btnAdminLock").style.display = isAdmin ? "inline-block" : "none";
  $("lockDot").className = "dot " + (isAdmin ? "" : "lock");
  $("lockText").textContent = isAdmin ? "Settings unlocked" : "Settings locked";

  document.querySelectorAll(".adminOnly").forEach(el=>{
    el.disabled = !isAdmin;
  });
}

function unlockAdmin(){
  const pw = $("adminPass").value;
  if(pw === ADMIN_PASSWORD){
    isAdmin = true;
    setAdminUI();
    showMsg("ok","<b>Admin unlocked:</b> You can now edit weights and scoring scheme.");
  }else{
    isAdmin = false;
    setAdminUI();
    showMsg("bad","<b>Access denied:</b> Wrong admin password.");
  }
}
function lockAdmin(){
  isAdmin = false;
  $("adminPass").value = "";
  setAdminUI();
  showMsg("warn","<b>Locked:</b> Settings are now read-only.");
}

/* ========================= Parsing helpers ========================= */
function parseCSVNums(str, expected){
  const arr = (str||"").split(",").map(s=>n(s.trim()));
  if(arr.length!==expected) return null;
  return arr;
}

/* ========================= Category templates ========================= */
function applyTemplateByCategory(cat){
  if(cat==="Academic"){
    state.enabled = { T:true, SV:true, R:true, P:true, A:true, S:true, L:false };
    state.weights = { T:0.30, SV:0.15, R:0.20, P:0.10, A:0.15, S:0.10, L:0.00 };
  } else if(cat==="Administrative"){
    state.enabled = { T:false, SV:false, R:false, P:false, A:true, S:true, L:false };
    state.weights = { T:0.00, SV:0.00, R:0.00, P:0.00, A:0.60, S:0.40, L:0.00 };
  } else if(cat==="Laboratory"){
    state.enabled = { T:false, SV:false, R:false, P:false, A:true, S:true, L:true };
    state.weights = { T:0.00, SV:0.00, R:0.00, P:0.00, A:0.45, S:0.25, L:0.30 };
  }
  syncUIFromState();
  applySectionVisibility();
  autosave();
  autosizeAllTextareas();
}

/* ========================= Sync UI <-> State ========================= */
function syncProfileFromUI(){
  state.profile.name = $("pName").value.trim();
  state.profile.staffId = $("pStaffId").value.trim();
  state.profile.category = $("pCategory").value;
  state.profile.unit = $("pUnit").value.trim();
  state.profile.grade = $("pGrade").value;
  state.profile.gradeOther = $("pGradeOther").value.trim();
  state.profile.status = $("pStatus").value;
  state.profile.statusOther = $("pStatusOther").value.trim();
  state.profile.period = $("pPeriod").value;
}

function syncEnabledFromUI(){
  state.enabled.T = $("enTeaching").checked;
  state.enabled.SV = $("enSupervision").checked;
  state.enabled.R = $("enResearch").checked;
  state.enabled.P = $("enPublication").checked;
  state.enabled.A = $("enAdministration").checked;
  state.enabled.S = $("enServices").checked;
  state.enabled.L = $("enLabOps").checked;
}

function syncSettingsFromUI_ifAdmin(){
  if(!isAdmin) return;

  state.weights.T = n($("wT").value);
  state.weights.SV = n($("wSV").value);
  state.weights.R = n($("wR").value);
  state.weights.P = n($("wP").value);
  state.weights.A = n($("wA").value);
  state.weights.S = n($("wS").value);
  state.weights.L = n($("wL").value);

  state.scheme.teaching.hourW = n($("tHourW").value);
  state.scheme.teaching.studW = n($("tStudW").value);
  state.scheme.teaching.creditW = n($("tCreditW").value);

  state.scheme.supervision.ug = n($("svUG").value);
  state.scheme.supervision.m = n($("svM").value);
  state.scheme.supervision.phd = n($("svPHD").value);

  state.scheme.research.base = n($("rBase").value);
  const rLvl = parseCSVNums($("rUniNatIntl").value, 3); if(rLvl) state.scheme.research.lvl = rLvl;
  const rRole = parseCSVNums($("rRole").value, 3); if(rRole) state.scheme.research.role = rRole;

  state.scheme.publication.base = n($("pBase").value);
  const pType = parseCSVNums($("pType").value, 4); if(pType) state.scheme.publication.type = pType;
  const pIdx = parseCSVNums($("pIdx").value, 2); if(pIdx) state.scheme.publication.idx = pIdx;

  const aLvl = parseCSVNums($("aLevel").value, 7); if(aLvl) state.scheme.admin.lvl = aLvl;
  state.scheme.admin.meetW = n($("aMeetW").value);
  state.scheme.admin.monthW = n($("aMonthW").value);

  state.scheme.service.hourW = n($("sHourW").value);
  state.scheme.service.paxW = n($("sPaxW").value);
  const sBonus = parseCSVNums($("sRoleBonus").value, 2); if(sBonus) state.scheme.service.bonus = sBonus;

  state.scheme.lab.volW = n($("lVolW").value);
  state.scheme.lab.hourW = n($("lHourW").value);
  const lCx = parseCSVNums($("lCx").value, 3); if(lCx) state.scheme.lab.cx = lCx;
  const lUr = parseCSVNums($("lUr").value, 3); if(lUr) state.scheme.lab.ur = lUr;
}

function syncUIFromState(){
  $("pName").value = state.profile.name || "";
  $("pStaffId").value = state.profile.staffId || "";
  $("pCategory").value = state.profile.category || "";
  $("pUnit").value = state.profile.unit || "";
  $("pGrade").value = state.profile.grade || "";
  $("pGradeOther").value = state.profile.gradeOther || "";
  $("pStatus").value = state.profile.status || "";
  $("pStatusOther").value = state.profile.statusOther || "";
  $("pPeriod").value = state.profile.period || "";
  $("pGradeOtherWrap").style.display = (state.profile.grade==="Others") ? "block" : "none";
  $("pStatusOtherWrap").style.display = (state.profile.status==="Others") ? "block" : "none";

  $("enTeaching").checked = !!state.enabled.T;
  $("enSupervision").checked = !!state.enabled.SV;
  $("enResearch").checked = !!state.enabled.R;
  $("enPublication").checked = !!state.enabled.P;
  $("enAdministration").checked = !!state.enabled.A;
  $("enServices").checked = !!state.enabled.S;
  $("enLabOps").checked = !!state.enabled.L;

  $("wT").value = state.weights.T.toFixed(2);
  $("wSV").value = state.weights.SV.toFixed(2);
  $("wR").value = state.weights.R.toFixed(2);
  $("wP").value = state.weights.P.toFixed(2);
  $("wA").value = state.weights.A.toFixed(2);
  $("wS").value = state.weights.S.toFixed(2);
  $("wL").value = state.weights.L.toFixed(2);

  $("tHourW").value = state.scheme.teaching.hourW;
  $("tStudW").value = state.scheme.teaching.studW;
  $("tCreditW").value = state.scheme.teaching.creditW;

  $("svUG").value = state.scheme.supervision.ug;
  $("svM").value = state.scheme.supervision.m;
  $("svPHD").value = state.scheme.supervision.phd;

  $("rBase").value = state.scheme.research.base;
  $("rUniNatIntl").value = state.scheme.research.lvl.join(",");
  $("rRole").value = state.scheme.research.role.join(",");

  $("pBase").value = state.scheme.publication.base;
  $("pType").value = state.scheme.publication.type.join(",");
  $("pIdx").value = state.scheme.publication.idx.join(",");

  $("aLevel").value = state.scheme.admin.lvl.join(",");
  $("aMeetW").value = state.scheme.admin.meetW;
  $("aMonthW").value = state.scheme.admin.monthW;

  $("sHourW").value = state.scheme.service.hourW;
  $("sPaxW").value = state.scheme.service.paxW;
  $("sRoleBonus").value = state.scheme.service.bonus.join(",");

  $("lVolW").value = state.scheme.lab.volW;
  $("lHourW").value = state.scheme.lab.hourW;
  $("lCx").value = state.scheme.lab.cx.join(",");
  $("lUr").value = state.scheme.lab.ur.join(",");
}

function applySectionVisibility(){
  $("secTeaching").style.display = state.enabled.T ? "block" : "none";
  $("secSupervision").style.display = state.enabled.SV ? "block" : "none";
  $("secResearch").style.display = state.enabled.R ? "block" : "none";
  $("secPublication").style.display = state.enabled.P ? "block" : "none";
  $("secAdmin").style.display = state.enabled.A ? "block" : "none";
  $("secService").style.display = state.enabled.S ? "block" : "none";
  $("secLabOps").style.display = state.enabled.L ? "block" : "none";
}

/* ========================= Validation ========================= */
function validateProfile(){
  const ids = ["pName","pStaffId","pCategory","pUnit","pGrade","pStatus","pPeriod","pGradeOther","pStatusOther"];
  ids.forEach(id=>$(id).classList.remove("err"));
  let ok=true;

  if(!$("pName").value.trim()) ok=false, $("pName").classList.add("err");
  if(!$("pStaffId").value.trim()) ok=false, $("pStaffId").classList.add("err");
  if(!$("pCategory").value) ok=false, $("pCategory").classList.add("err");
  if(!$("pUnit").value.trim()) ok=false, $("pUnit").classList.add("err");
  if(!$("pGrade").value) ok=false, $("pGrade").classList.add("err");
  if(!$("pStatus").value) ok=false, $("pStatus").classList.add("err");
  if(!$("pPeriod").value) ok=false, $("pPeriod").classList.add("err");

  if($("pGrade").value==="Others" && !$("pGradeOther").value.trim()) ok=false, $("pGradeOther").classList.add("err");
  if($("pStatus").value==="Others" && !$("pStatusOther").value.trim()) ok=false, $("pStatusOther").classList.add("err");

  $("msgProfile").style.display = ok ? "none" : "block";
  if(!ok) $("msgProfile").innerHTML = "<b>Action required:</b> Please complete all required profile fields.";
  return ok;
}

function validateToggles(){
  syncEnabledFromUI();
  const anyOn = Object.values(state.enabled).some(Boolean);
  $("toggleWarn").style.display = anyOn ? "none" : "block";
  if(!anyOn) $("toggleWarn").textContent = "At least one section must be ON.";
  return anyOn;
}

function validateWeightsBaseline_ifAdmin(){
  if(!isAdmin) return true;
  const sum = state.weights.T+state.weights.SV+state.weights.R+state.weights.P+state.weights.A+state.weights.S+state.weights.L;
  const ok = Math.abs(sum-1.00) <= 0.005;
  $("msgSettings").style.display = ok ? "none" : "block";
  if(!ok) $("msgSettings").innerHTML = `<b>Admin validation:</b> Weight baseline must sum to 1.00. Current sum = <b>${sum.toFixed(2)}</b>.`;
  return ok;
}

function getActiveWeights(){
  const aw = {
    T: state.enabled.T ? state.weights.T : 0,
    SV: state.enabled.SV ? state.weights.SV : 0,
    R: state.enabled.R ? state.weights.R : 0,
    P: state.enabled.P ? state.weights.P : 0,
    A: state.enabled.A ? state.weights.A : 0,
    S: state.enabled.S ? state.weights.S : 0,
    L: state.enabled.L ? state.weights.L : 0
  };
  const sum = Object.values(aw).reduce((a,b)=>a+b,0);
  if(sum<=0) return null;
  Object.keys(aw).forEach(k=>aw[k]=aw[k]/sum);
  return aw;
}

function validateActivityTables(){
  document.querySelectorAll("input.err,select.err,textarea.err").forEach(el=>el.classList.remove("err"));
  let ok=true;

  function requireText(el){ if(!el.value.trim()){ el.classList.add("err"); ok=false; } }
  function requireNonNeg(el, strictPositive=false){
    const v=n(el.value);
    if(v<0 || (strictPositive && v<=0)){ el.classList.add("err"); ok=false; }
  }
  function requireDate(el){ if(!el.value){ el.classList.add("err"); ok=false; } }

  if(state.enabled.T){
    $("tblTeach").querySelectorAll("tbody tr").forEach(tr=>{
      requireText(tr.querySelector('[data-k="code"]'));
      requireText(tr.querySelector('[data-k="name"]'));
      requireNonNeg(tr.querySelector('[data-k="students"]'), true);
      ["lec","tut","lab","field"].forEach(k=>requireNonNeg(tr.querySelector(`[data-k="${k}"]`), false));
    });
  }
  if(state.enabled.SV){
    $("tblSv").querySelectorAll("tbody tr").forEach(tr=>{
      requireText(tr.querySelector('[data-k="title"]'));
      requireDate(tr.querySelector('[data-k="start"]'));
      requireDate(tr.querySelector('[data-k="end"]'));
    });
  }
  if(state.enabled.R){
    $("tblRes").querySelectorAll("tbody tr").forEach(tr=>{
      requireText(tr.querySelector('[data-k="code"]'));
      requireText(tr.querySelector('[data-k="title"]'));
      requireNonNeg(tr.querySelector('[data-k="amount"]'), true);
      requireDate(tr.querySelector('[data-k="start"]'));
      requireDate(tr.querySelector('[data-k="end"]'));
    });
  }
  if(state.enabled.P){
    $("tblPub").querySelectorAll("tbody tr").forEach(tr=>{
      requireNonNeg(tr.querySelector('[data-k="year"]'), true);
      requireText(tr.querySelector('[data-k="title"]'));
      requireDate(tr.querySelector('[data-k="start"]'));
      requireDate(tr.querySelector('[data-k="end"]'));
    });
  }
  if(state.enabled.A){
    $("tblAdmin").querySelectorAll("tbody tr").forEach(tr=>{
      requireText(tr.querySelector('[data-k="pos"]'));
      requireNonNeg(tr.querySelector('[data-k="months"]'), true);
      requireNonNeg(tr.querySelector('[data-k="meetings"]'), false);
      requireText(tr.querySelector('[data-k="notes"]'));
      requireDate(tr.querySelector('[data-k="start"]'));
      requireDate(tr.querySelector('[data-k="end"]'));
    });
  }
  if(state.enabled.S){
    $("tblSvc").querySelectorAll("tbody tr").forEach(tr=>{
      requireText(tr.querySelector('[data-k="activity"]'));
      requireNonNeg(tr.querySelector('[data-k="hours"]'), true);
      requireNonNeg(tr.querySelector('[data-k="participants"]'), true);
      requireDate(tr.querySelector('[data-k="start"]'));
      requireDate(tr.querySelector('[data-k="end"]'));
    });
  }
  if(state.enabled.L){
    $("tblLab").querySelectorAll("tbody tr").forEach(tr=>{
      requireText(tr.querySelector('[data-k="desc"]'));
      requireNonNeg(tr.querySelector('[data-k="volume"]'), true);
      requireNonNeg(tr.querySelector('[data-k="hours"]'), true);
      requireDate(tr.querySelector('[data-k="start"]'));
      requireDate(tr.querySelector('[data-k="end"]'));
    });
  }

  if(!ok) showMsg("warn","<b>Validation:</b> Please fill all required fields (no empty/negative values). Highlighted boxes require attention.");
  return ok;
}

/* ========================= Tables ========================= */
function ensureSeed(){
  if(state.data.teaching.length===0) state.data.teaching.push({id:uid(), code:"", name:"", credit:0, students:0, lec:0, tut:0, lab:0, field:0});
  if(state.data.supervision.length===0) state.data.supervision.push({id:uid(), level:"Undergraduate", title:"", role:"Main", status:"Active", start:"", end:""});
  if(state.data.research.length===0) state.data.research.push({id:uid(), code:"", title:"", level:"University", status:"Active", role:"PI", amount:0, start:"", end:""});
  if(state.data.publication.length===0) state.data.publication.push({id:uid(), year:(new Date()).getFullYear(), title:"", type:"Journal", indexed:"Yes", role:"First/Corresponding", start:"", end:""});
  if(state.data.admin.length===0) state.data.admin.push({id:uid(), pos:"", type:"Official", level:"Faculty", months:0, meetings:0, notes:"", start:"", end:""});
  if(state.data.service.length===0) state.data.service.push({id:uid(), type:"Service to University", activity:"", role:"Lead", hours:0, participants:0, start:"", end:""});
  if(state.data.lab.length===0) state.data.lab.push({id:uid(), type:"Equipment/Maintenance", desc:"", volume:0, cx:"Medium", ur:"Normal", hours:0, start:"", end:""});
}

function creditFromCode(code){
  const s = (code||"").trim();
  const m = s.match(/(\d)\s*$/);
  return m ? parseInt(m[1],10) : 0;
}
function contactHoursRow(r){
  return Math.max(0,n(r.lec))+Math.max(0,n(r.tut))+Math.max(0,n(r.lab))+Math.max(0,n(r.field));
}

function renderAll(){
  renderTeaching();
  renderSv();
  renderRes();
  renderPub();
  renderAdmin();
  renderSvc();
  renderLab();
  autosizeAllTextareas();
}

function renderTeaching(){
  const tb = $("tblTeach").querySelector("tbody");
  tb.innerHTML="";
  state.data.teaching.forEach(r=>{
    const tr=document.createElement("tr"); tr.dataset.id=r.id;
    tr.innerHTML=`
      <td><input data-k="code" placeholder="e.g., SJ24102"/></td>
      <td><textarea data-k="name" class="autoGrow" rows="1" placeholder="Course name"></textarea></td>
      <td><input data-k="credit" disabled/></td>
      <td><input data-k="students" type="number" min="0" step="1"/></td>
      <td><input data-k="lec" type="number" min="0" step="0.5"/></td>
      <td><input data-k="tut" type="number" min="0" step="0.5"/></td>
      <td><input data-k="lab" type="number" min="0" step="0.5"/></td>
      <td><input data-k="field" type="number" min="0" step="0.5"/></td>
      <td><input data-k="contact" disabled/></td>
      <td><button class="btn danger" data-act="del" style="padding:6px 10px;font-size:.8rem">✖</button></td>
    `;
    tb.appendChild(tr);

    tr.querySelector('[data-k="code"]').value=r.code;
    tr.querySelector('[data-k="name"]').value=r.name;
    tr.querySelector('[data-k="credit"]').value=r.credit;
    tr.querySelector('[data-k="students"]').value=r.students;
    tr.querySelector('[data-k="lec"]').value=r.lec;
    tr.querySelector('[data-k="tut"]').value=r.tut;
    tr.querySelector('[data-k="lab"]').value=r.lab;
    tr.querySelector('[data-k="field"]').value=r.field;
    tr.querySelector('[data-k="contact"]').value=contactHoursRow(r).toFixed(1);

    tr.addEventListener("input",(e)=>{
      const k=e.target.getAttribute("data-k"); if(!k) return;
      const obj=state.data.teaching.find(x=>x.id===tr.dataset.id); if(!obj) return;

      if(k==="code"){
        obj.code=e.target.value.toUpperCase();
        obj.credit=creditFromCode(obj.code);
        tr.querySelector('[data-k="credit"]').value=obj.credit;
      } else if(k==="name"){
        obj.name=e.target.value;
        autosizeTextarea(e.target);
      } else if(["students","lec","tut","lab","field"].includes(k)){
        obj[k]=Math.max(0,n(e.target.value)); e.target.value=obj[k];
        tr.querySelector('[data-k="contact"]').value=contactHoursRow(obj).toFixed(1);
      }
      autosave();
    });

    tr.addEventListener("click",(e)=>{
      if(e.target?.getAttribute("data-act")==="del"){
        state.data.teaching = state.data.teaching.filter(x=>x.id!==tr.dataset.id);
        ensureSeed(); renderAll(); autosave();
      }
    });
  });
}

function renderSv(){
  const tb=$("tblSv").querySelector("tbody"); tb.innerHTML="";
  state.data.supervision.forEach(r=>{
    const tr=document.createElement("tr"); tr.dataset.id=r.id;
    tr.innerHTML=`
      <td>
        <select data-k="level">
          <option>Undergraduate</option>
          <option>Master</option>
          <option>PhD</option>
        </select>
      </td>
      <td><textarea data-k="title" class="autoGrow" rows="1" placeholder="Student name / project"></textarea></td>
      <td>
        <select data-k="role">
          <option>Main</option>
          <option>Co-supervisor</option>
        </select>
      </td>
      <td>
        <select data-k="status">
          <option>Active</option>
          <option>Completed</option>
        </select>
      </td>
      <td><input data-k="start" type="date"/></td>
      <td><input data-k="end" type="date"/></td>
      <td><button class="btn danger" data-act="del" style="padding:6px 10px;font-size:.8rem">✖</button></td>
    `;
    tb.appendChild(tr);
    tr.querySelector('[data-k="level"]').value=r.level;
    tr.querySelector('[data-k="title"]').value=r.title;
    tr.querySelector('[data-k="role"]').value=r.role;
    tr.querySelector('[data-k="status"]').value=r.status;
    tr.querySelector('[data-k="start"]').value=r.start;
    tr.querySelector('[data-k="end"]').value=r.end;

    tr.addEventListener("input",(e)=>{
      const k=e.target.getAttribute("data-k"); if(!k) return;
      const obj=state.data.supervision.find(x=>x.id===tr.dataset.id); if(!obj) return;
      obj[k]=e.target.value;
      if(k==="title") autosizeTextarea(e.target);
      autosave();
    });
    tr.addEventListener("click",(e)=>{
      if(e.target?.getAttribute("data-act")==="del"){
        state.data.supervision=state.data.supervision.filter(x=>x.id!==tr.dataset.id);
        ensureSeed(); renderAll(); autosave();
      }
    });
  });
}

function renderRes(){
  const tb=$("tblRes").querySelector("tbody"); tb.innerHTML="";
  state.data.research.forEach(r=>{
    const tr=document.createElement("tr"); tr.dataset.id=r.id;
    tr.innerHTML=`
      <td><input data-k="code" placeholder="Grant code"/></td>
      <td><textarea data-k="title" class="autoGrow" rows="1" placeholder="Grant title"></textarea></td>
      <td>
        <select data-k="level">
          <option>University</option>
          <option>National</option>
          <option>International</option>
        </select>
      </td>
      <td>
        <select data-k="status">
          <option>Active</option>
          <option>Applied</option>
          <option>Ended</option>
        </select>
      </td>
      <td>
        <select data-k="role">
          <option>PI</option>
          <option>Co-I</option>
          <option>Member</option>
        </select>
      </td>
      <td><input data-k="amount" type="number" min="0" step="1" placeholder="RM"/></td>
      <td><input data-k="start" type="date"/></td>
      <td><input data-k="end" type="date"/></td>
      <td><button class="btn danger" data-act="del" style="padding:6px 10px;font-size:.8rem">✖</button></td>
    `;
    tb.appendChild(tr);
    tr.querySelector('[data-k="code"]').value=r.code;
    tr.querySelector('[data-k="title"]').value=r.title;
    tr.querySelector('[data-k="level"]').value=r.level;
    tr.querySelector('[data-k="status"]').value=r.status;
    tr.querySelector('[data-k="role"]').value=r.role;
    tr.querySelector('[data-k="amount"]').value=r.amount;
    tr.querySelector('[data-k="start"]').value=r.start;
    tr.querySelector('[data-k="end"]').value=r.end;

    tr.addEventListener("input",(e)=>{
      const k=e.target.getAttribute("data-k"); if(!k) return;
      const obj=state.data.research.find(x=>x.id===tr.dataset.id); if(!obj) return;
      if(k==="amount") obj.amount=Math.max(0,n(e.target.value)), e.target.value=obj.amount;
      else obj[k]=e.target.value;
      if(k==="title") autosizeTextarea(e.target);
      autosave();
    });
    tr.addEventListener("click",(e)=>{
      if(e.target?.getAttribute("data-act")==="del"){
        state.data.research=state.data.research.filter(x=>x.id!==tr.dataset.id);
        ensureSeed(); renderAll(); autosave();
      }
    });
  });
}

function renderPub(){
  const tb=$("tblPub").querySelector("tbody"); tb.innerHTML="";
  state.data.publication.forEach(r=>{
    const tr=document.createElement("tr"); tr.dataset.id=r.id;
    tr.innerHTML=`
      <td><input data-k="year" type="number" min="1990" step="1"/></td>
      <td><textarea data-k="title" class="autoGrow" rows="1" placeholder="Publication title"></textarea></td>
      <td>
        <select data-k="type">
          <option>Journal</option>
          <option>Book/Chapter</option>
          <option>Proceeding</option>
          <option>Other</option>
        </select>
      </td>
      <td>
        <select data-k="indexed">
          <option>Yes</option>
          <option>No</option>
        </select>
      </td>
      <td>
        <select data-k="role">
          <option>First/Corresponding</option>
          <option>Co-author</option>
        </select>
      </td>
      <td><input data-k="start" type="date"/></td>
      <td><input data-k="end" type="date"/></td>
      <td><button class="btn danger" data-act="del" style="padding:6px 10px;font-size:.8rem">✖</button></td>
    `;
    tb.appendChild(tr);
    tr.querySelector('[data-k="year"]').value=r.year;
    tr.querySelector('[data-k="title"]').value=r.title;
    tr.querySelector('[data-k="type"]').value=r.type;
    tr.querySelector('[data-k="indexed"]').value=r.indexed;
    tr.querySelector('[data-k="role"]').value=r.role;
    tr.querySelector('[data-k="start"]').value=r.start;
    tr.querySelector('[data-k="end"]').value=r.end;

    tr.addEventListener("input",(e)=>{
      const k=e.target.getAttribute("data-k"); if(!k) return;
      const obj=state.data.publication.find(x=>x.id===tr.dataset.id); if(!obj) return;
      if(k==="year") obj.year=Math.max(1990, Math.floor(n(e.target.value)||new Date().getFullYear())), e.target.value=obj.year;
      else obj[k]=e.target.value;
      if(k==="title") autosizeTextarea(e.target);
      autosave();
    });
    tr.addEventListener("click",(e)=>{
      if(e.target?.getAttribute("data-act")==="del"){
        state.data.publication=state.data.publication.filter(x=>x.id!==tr.dataset.id);
        ensureSeed(); renderAll(); autosave();
      }
    });
  });
}

function renderAdmin(){
  const tb=$("tblAdmin").querySelector("tbody"); tb.innerHTML="";
  state.data.admin.forEach(r=>{
    const tr=document.createElement("tr"); tr.dataset.id=r.id;
    tr.innerHTML=`
      <td><textarea data-k="pos" class="autoGrow" rows="1" placeholder="Position / appointment"></textarea></td>
      <td>
        <select data-k="type">
          <option>Official</option>
          <option>Ad-hoc</option>
        </select>
      </td>
      <td>
        <select data-k="level">
          <option>Programme</option>
          <option>Faculty</option>
          <option>University</option>
          <option>State</option>
          <option>National</option>
          <option>International</option>
          <option>Industry</option>
        </select>
      </td>
      <td><input data-k="months" type="number" min="0" step="1"/></td>
      <td><input data-k="meetings" type="number" min="0" step="1"/></td>
      <td><textarea data-k="notes" class="autoGrow" rows="1" placeholder="Key workload notes"></textarea></td>
      <td><input data-k="start" type="date"/></td>
      <td><input data-k="end" type="date"/></td>
      <td><button class="btn danger" data-act="del" style="padding:6px 10px;font-size:.8rem">✖</button></td>
    `;
    tb.appendChild(tr);
    tr.querySelector('[data-k="pos"]').value=r.pos;
    tr.querySelector('[data-k="type"]').value=r.type;
    tr.querySelector('[data-k="level"]').value=r.level;
    tr.querySelector('[data-k="months"]').value=r.months;
    tr.querySelector('[data-k="meetings"]').value=r.meetings;
    tr.querySelector('[data-k="notes"]').value=r.notes;
    tr.querySelector('[data-k="start"]').value=r.start;
    tr.querySelector('[data-k="end"]').value=r.end;

    tr.addEventListener("input",(e)=>{
      const k=e.target.getAttribute("data-k"); if(!k) return;
      const obj=state.data.admin.find(x=>x.id===tr.dataset.id); if(!obj) return;
      if(k==="months"||k==="meetings"){ obj[k]=Math.max(0,Math.floor(n(e.target.value))); e.target.value=obj[k]; }
      else obj[k]=e.target.value;
      if(k==="pos"||k==="notes") autosizeTextarea(e.target);
      autosave();
    });
    tr.addEventListener("click",(e)=>{
      if(e.target?.getAttribute("data-act")==="del"){
        state.data.admin=state.data.admin.filter(x=>x.id!==tr.dataset.id);
        ensureSeed(); renderAll(); autosave();
      }
    });
  });
}

function renderSvc(){
  const tb=$("tblSvc").querySelector("tbody"); tb.innerHTML="";
  state.data.service.forEach(r=>{
    const tr=document.createElement("tr"); tr.dataset.id=r.id;
    tr.innerHTML=`
      <td>
        <select data-k="type">
          <option>Service to University</option>
          <option>Service to Industry</option>
          <option>Service to Community</option>
          <option>Other</option>
        </select>
      </td>
      <td><textarea data-k="activity" class="autoGrow" rows="1" placeholder="Describe activity"></textarea></td>
      <td>
        <select data-k="role">
          <option>Lead</option>
          <option>Member</option>
        </select>
      </td>
      <td><input data-k="hours" type="number" min="0" step="0.5"/></td>
      <td><input data-k="participants" type="number" min="0" step="1"/></td>
      <td><input data-k="start" type="date"/></td>
      <td><input data-k="end" type="date"/></td>
      <td><button class="btn danger" data-act="del" style="padding:6px 10px;font-size:.8rem">✖</button></td>
    `;
    tb.appendChild(tr);
    tr.querySelector('[data-k="type"]').value=r.type;
    tr.querySelector('[data-k="activity"]').value=r.activity;
    tr.querySelector('[data-k="role"]').value=r.role;
    tr.querySelector('[data-k="hours"]').value=r.hours;
    tr.querySelector('[data-k="participants"]').value=r.participants;
    tr.querySelector('[data-k="start"]').value=r.start;
    tr.querySelector('[data-k="end"]').value=r.end;

    tr.addEventListener("input",(e)=>{
      const k=e.target.getAttribute("data-k"); if(!k) return;
      const obj=state.data.service.find(x=>x.id===tr.dataset.id); if(!obj) return;
      if(k==="hours") obj.hours=Math.max(0,n(e.target.value)), e.target.value=obj.hours;
      else if(k==="participants") obj.participants=Math.max(0,Math.floor(n(e.target.value))), e.target.value=obj.participants;
      else obj[k]=e.target.value;
      if(k==="activity") autosizeTextarea(e.target);
      autosave();
    });
    tr.addEventListener("click",(e)=>{
      if(e.target?.getAttribute("data-act")==="del"){
        state.data.service=state.data.service.filter(x=>x.id!==tr.dataset.id);
        ensureSeed(); renderAll(); autosave();
      }
    });
  });
}

function renderLab(){
  const tb=$("tblLab").querySelector("tbody"); tb.innerHTML="";
  state.data.lab.forEach(r=>{
    const tr=document.createElement("tr"); tr.dataset.id=r.id;
    tr.innerHTML=`
      <td>
        <select data-k="type">
          <option>Lab Sessions Support</option>
          <option>Equipment/Maintenance</option>
          <option>Safety/Compliance</option>
          <option>Consumables/Procurement</option>
          <option>Field/Site Work</option>
          <option>Other</option>
        </select>
      </td>
      <td><textarea data-k="desc" class="autoGrow" rows="1" placeholder="Describe briefly"></textarea></td>
      <td><input data-k="volume" type="number" min="0" step="1"/></td>
      <td>
        <select data-k="cx">
          <option>Low</option><option>Medium</option><option>High</option>
        </select>
      </td>
      <td>
        <select data-k="ur">
          <option>Normal</option><option>Tight</option><option>Critical</option>
        </select>
      </td>
      <td><input data-k="hours" type="number" min="0" step="0.5"/></td>
      <td><input data-k="start" type="date"/></td>
      <td><input data-k="end" type="date"/></td>
      <td><button class="btn danger" data-act="del" style="padding:6px 10px;font-size:.8rem">✖</button></td>
    `;
    tb.appendChild(tr);

    tr.querySelector('[data-k="type"]').value=r.type;
    tr.querySelector('[data-k="desc"]').value=r.desc;
    tr.querySelector('[data-k="volume"]').value=r.volume;
    tr.querySelector('[data-k="cx"]').value=r.cx;
    tr.querySelector('[data-k="ur"]').value=r.ur;
    tr.querySelector('[data-k="hours"]').value=r.hours;
    tr.querySelector('[data-k="start"]').value=r.start;
    tr.querySelector('[data-k="end"]').value=r.end;

    tr.addEventListener("input",(e)=>{
      const k=e.target.getAttribute("data-k"); if(!k) return;
      const obj=state.data.lab.find(x=>x.id===tr.dataset.id); if(!obj) return;
      if(k==="volume") obj.volume=Math.max(0,Math.floor(n(e.target.value))), e.target.value=obj.volume;
      else if(k==="hours") obj.hours=Math.max(0,n(e.target.value)), e.target.value=obj.hours;
      else obj[k]=e.target.value;
      if(k==="desc") autosizeTextarea(e.target);
      autosave();
    });
    tr.addEventListener("click",(e)=>{
      if(e.target?.getAttribute("data-act")==="del"){
        state.data.lab=state.data.lab.filter(x=>x.id!==tr.dataset.id);
        ensureSeed(); renderAll(); autosave();
      }
    });
  });
}

/* ========================= Add/Clear ========================= */
function addRow(kind){
  if(kind==="teach") state.data.teaching.push({id:uid(), code:"", name:"", credit:0, students:0, lec:0, tut:0, lab:0, field:0});
  if(kind==="sv") state.data.supervision.push({id:uid(), level:"Undergraduate", title:"", role:"Main", status:"Active", start:"", end:""});
  if(kind==="res") state.data.research.push({id:uid(), code:"", title:"", level:"University", status:"Active", role:"PI", amount:0, start:"", end:""});
  if(kind==="pub") state.data.publication.push({id:uid(), year:(new Date()).getFullYear(), title:"", type:"Journal", indexed:"Yes", role:"First/Corresponding", start:"", end:""});
  if(kind==="admin") state.data.admin.push({id:uid(), pos:"", type:"Official", level:"Faculty", months:0, meetings:0, notes:"", start:"", end:""});
  if(kind==="svc") state.data.service.push({id:uid(), type:"Service to University", activity:"", role:"Lead", hours:0, participants:0, start:"", end:""});
  if(kind==="lab") state.data.lab.push({id:uid(), type:"Equipment/Maintenance", desc:"", volume:0, cx:"Medium", ur:"Normal", hours:0, start:"", end:""});
  renderAll(); autosave();
}
function clearKind(kind){
  if(kind==="teach") state.data.teaching=[];
  if(kind==="sv") state.data.supervision=[];
  if(kind==="res") state.data.research=[];
  if(kind==="pub") state.data.publication=[];
  if(kind==="admin") state.data.admin=[];
  if(kind==="svc") state.data.service=[];
  if(kind==="lab") state.data.lab=[];
  ensureSeed(); renderAll(); autosave();
}

/* ========================= Scoring ========================= */
function scoreTeaching(){
  const sc=state.scheme.teaching;
  let total=0;
  state.data.teaching.forEach(x=>{
    const credit = creditFromCode(x.code);
    x.credit = credit;
    const contact = contactHoursRow(x);
    const students = Math.max(0,n(x.students));
    total += (contact*sc.hourW) + ((students/100)*sc.studW) + (credit*sc.creditW);
  });
  return total;
}
function scoreSupervision(){
  const sc=state.scheme.supervision;
  let total=0;
  state.data.supervision.forEach(x=>{
    const roleMult = (x.role==="Main") ? 1.0 : 0.6;
    const statusMult = (x.status==="Active") ? 1.0 : 0.5;
    let base = 0;
    if(x.level==="Undergraduate") base=sc.ug;
    if(x.level==="Master") base=sc.m;
    if(x.level==="PhD") base=sc.phd;
    total += base*roleMult*statusMult;
  });
  return total;
}
function scoreResearch(){
  const sc=state.scheme.research;
  const lvlMap={University:0, National:1, International:2};
  const roleMap={PI:0, "Co-I":1, Member:2};
  let total=0;
  state.data.research.forEach(x=>{
    const statusMult = (x.status==="Active") ? 1.0 : (x.status==="Applied") ? 0.6 : 0.3;
    const li = lvlMap[x.level] ?? 0;
    const ri = roleMap[x.role] ?? 2;
    total += sc.base * sc.lvl[li] * sc.role[ri] * statusMult;
  });
  return total;
}
function scorePublication(){
  const sc=state.scheme.publication;
  const typeMap={"Journal":0,"Book/Chapter":1,"Proceeding":2,"Other":3};
  const idxMap={"Yes":0,"No":1};
  let total=0;
  state.data.publication.forEach(x=>{
    const ti = typeMap[x.type] ?? 3;
    const ii = idxMap[x.indexed] ?? 1;
    const roleMult = (x.role==="First/Corresponding") ? 1.2 : 1.0;
    total += sc.base * sc.type[ti] * sc.idx[ii] * roleMult;
  });
  return total;
}
function scoreAdmin(){
  const sc=state.scheme.admin;
  const lvlMap={"Programme":0,"Faculty":1,"University":2,"State":3,"National":4,"International":5,"Industry":6};
  let total=0;
  state.data.admin.forEach(x=>{
    const li = lvlMap[x.level] ?? 1;
    const base = sc.lvl[li];
    const meetings = Math.max(0,n(x.meetings));
    const months = Math.max(0,n(x.months));
    const typeBonus = (x.type==="Official") ? 1.0 : 0.7;
    total += (base + meetings*sc.meetW + months*sc.monthW) * typeBonus;
  });
  return total;
}
function scoreService(){
  const sc=state.scheme.service;
  const roleMap={Lead:0, Member:1};
  let total=0;
  state.data.service.forEach(x=>{
    const hrs = Math.max(0,n(x.hours));
    const pax = Math.max(0,n(x.participants));
    const ri = roleMap[x.role] ?? 1;
    total += (hrs*sc.hourW) + ((pax/10)*sc.paxW) + sc.bonus[ri];
  });
  return total;
}
function scoreLab(){
  const sc=state.scheme.lab;
  const cxMap={Low:0, Medium:1, High:2};
  const urMap={Normal:0, Tight:1, Critical:2};
  let total=0;
  state.data.lab.forEach(x=>{
    const vol = Math.max(0,n(x.volume));
    const hrs = Math.max(0,n(x.hours));
    const ci = cxMap[x.cx] ?? 1;
    const ui = urMap[x.ur] ?? 0;
    const base = (vol*sc.volW) + (hrs*sc.hourW);
    total += base * sc.cx[ci] * sc.ur[ui];
  });
  return total;
}

/* ========================= Results ========================= */
let chart=null;

function bandFromIndex(x){
  if(x<20) return {label:"Low workload", cls:"ok"};
  if(x<45) return {label:"Normal workload", cls:"ok"};
  if(x<70) return {label:"High workload", cls:"warn"};
  return {label:"Overload risk", cls:"bad"};
}

function narrative(scores, aw){
  const items = [
    ["Teaching", scores.T, aw.T, state.enabled.T],
    ["Supervision", scores.SV, aw.SV, state.enabled.SV],
    ["Research", scores.R, aw.R, state.enabled.R],
    ["Publication", scores.P, aw.P, state.enabled.P],
    ["Administration", scores.A, aw.A, state.enabled.A],
    ["Services", scores.S, aw.S, state.enabled.S],
    ["Lab Operations", scores.L, aw.L, state.enabled.L]
  ].filter(x=>x[3]);

  items.sort((a,b)=> (b[1]*b[2]) - (a[1]*a[2]));
  const top = items[0];
  const second = items[1] || null;
  const last = items[items.length-1];

  const topText = top ? `${top[0]} (weighted contribution ${(top[1]*top[2]).toFixed(1)})` : "—";
  const secondText = second ? `${second[0]} (${(second[1]*second[2]).toFixed(1)})` : "";
  const lowText = last ? `${last[0]} (weighted contribution ${(last[1]*last[2]).toFixed(1)})` : "—";

  return `Most of the busyness is driven by: ${topText}${secondText?`, followed by ${secondText}`:""}. The lowest contribution is from: ${lowText}. Consider balancing workload by shifting tasks away from the top driver(s) or increasing support in that section.`;
}

function deanViewSummary(index, band, aw){
  const on = Object.entries(state.enabled).filter(([k,v])=>v).map(([k])=>k).join(", ");
  const w = Object.entries(aw).filter(([k,v])=>v>0).map(([k,v])=>`${k}:${v.toFixed(2)}`).join(" | ");
  return `Name: ${state.profile.name} | ID: ${state.profile.staffId} | Category: ${state.profile.category} | Period: ${state.profile.period} | ON sections: ${on} | Normalized weights: ${w} | Index: ${index.toFixed(1)} (${band.label})`;
}

function drawChart(scores, aw){
  const labels=[], vals=[], colors=[];
  const pushIf=(on,label,raw,w,color)=>{
    if(!on) return;
    labels.push(label);
    vals.push(raw*w);
    colors.push(color);
  };
  pushIf(state.enabled.T, "Teaching", scores.T, aw.T, "rgba(167,139,250,.85)");
  pushIf(state.enabled.SV, "Supervision", scores.SV, aw.SV, "rgba(56,189,248,.85)");
  pushIf(state.enabled.R, "Research", scores.R, aw.R, "rgba(52,211,153,.85)");
  pushIf(state.enabled.P, "Publication", scores.P, aw.P, "rgba(244,114,182,.85)");
  pushIf(state.enabled.A, "Administration", scores.A, aw.A, "rgba(251,191,36,.85)");
  pushIf(state.enabled.S, "Services", scores.S, aw.S, "rgba(251,113,133,.85)");
  pushIf(state.enabled.L, "Lab Ops", scores.L, aw.L, "rgba(34,197,94,.85)");

  const ctx=$("chart").getContext("2d");
  if(chart) chart.destroy();
  chart=new Chart(ctx,{
    type:"bar",
    data:{ labels, datasets:[{ label:"Weighted contribution (raw score × normalized weight)", data:vals, backgroundColor:colors, borderColor:colors, borderWidth:1 }] },
    options:{
      responsive:true,
      plugins:{ legend:{ labels:{ color:"#eaf0ff"} } },
      scales:{
        x:{ ticks:{ color:"#eaf0ff"} , grid:{ color:"rgba(255,255,255,.08)" } },
        y:{ ticks:{ color:"#eaf0ff"} , grid:{ color:"rgba(255,255,255,.08)" } }
      }
    }
  });
}

function calculate(){
  hideMsg();
  syncProfileFromUI();
  syncEnabledFromUI();
  syncSettingsFromUI_ifAdmin();

  if(!validateProfile()) return false;
  if(!validateToggles()) return false;
  applySectionVisibility();
  ensureSeed();
  renderAll();

  if(!validateWeightsBaseline_ifAdmin()) {
    showMsg("warn","<b>Admin validation:</b> Fix weights so baseline sum is 1.00.");
    return false;
  }

  if(!validateActivityTables()) return false;

  const aw = getActiveWeights();
  if(!aw){
    showMsg("bad","<b>Error:</b> Active weights are zero. Turn ON sections and ensure weights are not all zero.");
    return false;
  }

  const scores = {
    T: state.enabled.T ? scoreTeaching() : 0,
    SV: state.enabled.SV ? scoreSupervision() : 0,
    R: state.enabled.R ? scoreResearch() : 0,
    P: state.enabled.P ? scorePublication() : 0,
    A: state.enabled.A ? scoreAdmin() : 0,
    S: state.enabled.S ? scoreService() : 0,
    L: state.enabled.L ? scoreLab() : 0
  };

  $("outT").textContent = scores.T.toFixed(1);
  $("outSV").textContent = scores.SV.toFixed(1);
  $("outR").textContent = scores.R.toFixed(1);
  $("outP").textContent = scores.P.toFixed(1);
  $("outA").textContent = scores.A.toFixed(1);
  $("outS").textContent = scores.S.toFixed(1);
  $("outL").textContent = scores.L.toFixed(1);

  const index = clamp(
    (scores.T*aw.T) + (scores.SV*aw.SV) + (scores.R*aw.R) + (scores.P*aw.P) +
    (scores.A*aw.A) + (scores.S*aw.S) + (scores.L*aw.L)
  , 0, 100);

  $("outIndex").textContent = index.toFixed(1);
  const b = bandFromIndex(index);
  $("outBand").textContent = b.label;

  $("outNarr").textContent = narrative(scores, aw);
  $("outDean").textContent = deanViewSummary(index, b, aw);
  drawChart(scores, aw);

  state.audit.last_calc_at = new Date().toISOString();
  autosave();

  lastCalc = { scores, aw, index, band:b };

  showMsg("ok", `<b>Calculated:</b> Index = <b>${index.toFixed(1)}</b> (${b.label}). Active weights were re-normalized automatically based on ON sections.`);
  return true;
}

/* ========================= Professional B/W Report PDF (Print PDF) ========================= */
function reportPDF(){
  // Always calculate first to ensure latest values & validation
  const ok = calculate();
  if(!ok) return;

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({unit:"pt", format:"a4"});
  const W = doc.internal.pageSize.getWidth();
  const H = doc.internal.pageSize.getHeight();
  const m = 44;
  let y = 40;

  const line = (x1,y1,x2,y2)=>doc.line(x1,y1,x2,y2);
  const rect = (x,y,w,h)=>doc.rect(x,y,w,h);
  const text = (t,x,y,opts={})=>doc.text(String(t), x, y, opts);

  const setFont = (size=10, bold=false)=>{
    doc.setFont("helvetica", bold?"bold":"normal");
    doc.setFontSize(size);
    doc.setTextColor(0,0,0);
  };

  const addPageIfNeeded = (need=0)=>{
    if(y + need > H - m){
      doc.addPage();
      y = m;
      header(true);
    }
  };

  const header = (isContinued=false)=>{
    setFont(12,true);
    text("FACULTY OF SCIENCE AND TECHNOLOGY (FST), UNIVERSITI MALAYSIA SABAH", m, 40);
    setFont(10,false);
    text("STAFF BUSYNESS INDEX – REPORT (BLACK & WHITE)", m, 58);
    setFont(9,false);
    text(isContinued ? "Continued" : `Generated: ${new Date().toLocaleString()}`, W - m, 58, {align:"right"});
    line(m, 66, W - m, 66);
    y = 82;
  };

  const sectionTitle = (title)=>{
    addPageIfNeeded(52);
    setFont(10,true);
    doc.setFillColor(245,245,245);
    doc.rect(m, y-14, W-2*m, 22, "F");
    doc.setDrawColor(0,0,0);
    rect(m, y-14, W-2*m, 22);
    text(title, m+10, y);
    y += 34;
  };

  const kvTable = (rows)=>{
    const col1 = m;
    const col2 = m + 170;
    const colW = (W - 2*m) - 170;
    const rowH = 18;

    addPageIfNeeded(rows.length*rowH + 12);
    setFont(9,false);
    doc.setDrawColor(0,0,0);
    rows.forEach(([k,v])=>{
      rect(col1, y-12, 170, rowH);
      rect(col2, y-12, colW, rowH);
      setFont(9,true); text(k, col1+8, y);
      setFont(9,false);
      const vv = (v===undefined || v===null) ? "" : String(v);
      const lines = doc.splitTextToSize(vv, colW-16);
      text(lines[0] || "", col2+8, y);
      y += rowH;
    });
    y += 10;
  };

  const simpleTable = (headers, rows, colWidths)=>{
    const rowH = 18;
    addPageIfNeeded((rows.length+2)*rowH + 8);

    // header
    setFont(9,true);
    let x = m;
    doc.setFillColor(245,245,245);
    doc.rect(m, y-12, W-2*m, rowH, "F");
    doc.setDrawColor(0,0,0);
    rect(m, y-12, W-2*m, rowH);
    headers.forEach((h,i)=>{
      text(h, x+6, y);
      x += colWidths[i];
    });
    y += rowH;

    // rows
    setFont(9,false);
    rows.forEach(r=>{
      addPageIfNeeded(rowH+2);
      let x2 = m;
      rect(m, y-12, W-2*m, rowH);
      r.forEach((cell,i)=>{
        text(String(cell), x2+6, y);
        x2 += colWidths[i];
      });
      y += rowH;
    });
    y += 10;
  };

  // Start
  header(false);

  sectionTitle("A. Staff Profile");
  kvTable([
    ["Full Name", state.profile.name],
    ["Staff ID", state.profile.staffId],
    ["Staff Category", state.profile.category],
    ["Programme/Unit", state.profile.unit],
    ["Grade", state.profile.grade==="Others" ? state.profile.gradeOther : state.profile.grade],
    ["Employment Status", state.profile.status==="Others" ? state.profile.statusOther : state.profile.status],
    ["Reporting Period", state.profile.period],
  ]);

  sectionTitle("B. Section Applicability & Normalized Weights");
  const onSections = Object.entries(state.enabled).filter(([k,v])=>v).map(([k])=>k).join(", ");
  const aw = lastCalc.aw;
  const weightsText = Object.entries(aw).filter(([k,v])=>v>0).map(([k,v])=>`${k} = ${v.toFixed(2)}`).join("   |   ");
  kvTable([
    ["Sections ON", onSections],
    ["Normalized Weights (w')", weightsText],
    ["Normalization Formula", "w'_i = (en_i × w_i) / Σ(en × w)"],
  ]);

  sectionTitle("C. Scores & Index");
  const s = lastCalc.scores;
  const rows = [];
  const pushRow = (code, name, enabled, score, weight)=>{
    if(!enabled) return;
    rows.push([code, name, score.toFixed(1), weight.toFixed(2), (score*weight).toFixed(1)]);
  };
  pushRow("T","Teaching", state.enabled.T, s.T, aw.T);
  pushRow("SV","Supervision", state.enabled.SV, s.SV, aw.SV);
  pushRow("R","Research", state.enabled.R, s.R, aw.R);
  pushRow("P","Publication", state.enabled.P, s.P, aw.P);
  pushRow("A","Administration", state.enabled.A, s.A, aw.A);
  pushRow("S","Services", state.enabled.S, s.S, aw.S);
  pushRow("L","Lab Operations", state.enabled.L, s.L, aw.L);

  simpleTable(
    ["Code","Section","Raw Score","w'","Contribution"],
    rows,
    [44, 190, 80, 44, (W-2*m) - (44+190+80+44)]
  );

  kvTable([
    ["Overall Busyness Index", lastCalc.index.toFixed(1)],
    ["Band/Interpretation", lastCalc.band.label],
    ["Index Formula", "Index = Σ(Score_i × w'_i), clamped to [0,100]"],
  ]);

  sectionTitle("D. Narrative Summary");
  setFont(9,false);
  const narrLines = doc.splitTextToSize($("outNarr").textContent || "", W-2*m-16);
  addPageIfNeeded(narrLines.length*14 + 20);
  rect(m, y-12, W-2*m, Math.max(44, narrLines.length*14 + 18));
  text(narrLines, m+8, y);
  y += Math.max(44, narrLines.length*14 + 18) + 10;

  sectionTitle("E. Staff Declaration & Dean Approval");
  addPageIfNeeded(160);
  const boxW = (W - 2*m - 14) / 2;
  const boxH = 150;

  // Staff declaration
  rect(m, y-12, boxW, boxH);
  setFont(10,true); text("Staff Declaration", m+10, y+6);
  setFont(9,false);
  text(`Name: ${state.profile.name || ""}`, m+10, y+28);
  text(`Staff ID: ${state.profile.staffId || ""}`, m+10, y+46);
  text(`Date: _______________________`, m+10, y+64);
  rect(m+10, y+78, boxW-20, 50);
  setFont(8,false); text("Signature", m+14, y+140);

  // Dean approval
  const xR = m + boxW + 14;
  rect(xR, y-12, boxW, boxH);
  setFont(10,true); text("Dean Approval", xR+10, y+6);
  setFont(9,false);
  text("Faculty: Faculty of Science and Technology", xR+10, y+28);
  text("Dean: Prof. P.Geol. Ts. Dr. Rodeano Roslee", xR+10, y+46);
  text("Date: _______________________", xR+10, y+64);
  rect(xR+10, y+78, boxW-20, 50);
  setFont(8,false); text("Signature", xR+14, y+140);

  y += boxH + 10;
  setFont(8,false);
  text("© FST UMS. This report is generated from the Staff Busyness Index Calculator (single-file web tool).", m, H - 28);

  doc.save(`FST_UMS_Busyness_Report_${(state.profile.staffId||"staff")}.pdf`);
}

/* ========================= Manual PDF (detailed + equations + 3 staff examples) ========================= */
function manualPDF(){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({unit:"pt", format:"a4"});
  const W = doc.internal.pageSize.getWidth();
  const H = doc.internal.pageSize.getHeight();
  const m = 44;
  let y = 46;

  const addPageIfNeeded = (need=0)=>{
    if(y + need > H - m){
      doc.addPage();
      y = m;
      pageHeader(true);
    }
  };

  const pageHeader = (continued=false)=>{
    doc.setFont("helvetica","bold"); doc.setFontSize(14);
    doc.text("FST UMS Staff Busyness Index – Calculation Manual", m, 34);
    doc.setFont("helvetica","normal"); doc.setFontSize(9);
    doc.setTextColor(80,80,80);
    doc.text(continued ? "Continued" : `Generated: ${new Date().toLocaleString()}`, W-m, 34, {align:"right"});
    doc.setTextColor(0,0,0);
    doc.line(m, 42, W-m, 42);
    y = 60;
  };

  const title = (t)=>{
    addPageIfNeeded(34);
    doc.setFillColor(245,245,245);
    doc.rect(m, y-14, W-2*m, 22, "F");
    doc.setDrawColor(0,0,0);
    doc.rect(m, y-14, W-2*m, 22);
    doc.setFont("helvetica","bold"); doc.setFontSize(10);
    doc.text(t, m+10, y);
    y += 30;
  };

  const para = (t, size=9)=>{
    doc.setFont("helvetica","normal");
    doc.setFontSize(size);
    const lines = doc.splitTextToSize(t, W-2*m);
    addPageIfNeeded(lines.length*(size+5) + 10);
    lines.forEach(line=>{
      doc.text(line, m, y);
      y += size + 5;
    });
    y += 6;
  };

  const mono = (t)=>{
    doc.setFont("courier","normal"); doc.setFontSize(9);
    const lines = doc.splitTextToSize(t, W-2*m-16);
    addPageIfNeeded(lines.length*14 + 20);
    doc.rect(m, y-12, W-2*m, lines.length*14 + 14);
    lines.forEach((line,i)=>{
      doc.text(line, m+8, y + i*14);
    });
    y += lines.length*14 + 18;
    doc.setFont("helvetica","normal");
  };

  const bullet = (items)=>{
    doc.setFont("helvetica","normal"); doc.setFontSize(9);
    items.forEach(it=>{
      const lines = doc.splitTextToSize(it, W-2*m-18);
      addPageIfNeeded(lines.length*14 + 8);
      doc.text("•", m, y);
      doc.text(lines, m+12, y);
      y += lines.length*14;
    });
    y += 8;
  };

  const table2 = (rows)=>{
    const leftW = 190;
    const rightW = (W - 2*m) - leftW;
    const rowH = 18;
    addPageIfNeeded(rows.length*rowH + 18);
    doc.setFont("helvetica","normal"); doc.setFontSize(9);
    rows.forEach(([k,v])=>{
      doc.rect(m, y-12, leftW, rowH);
      doc.rect(m+leftW, y-12, rightW, rowH);
      doc.setFont("helvetica","bold"); doc.text(String(k), m+8, y);
      doc.setFont("helvetica","normal");
      const vv = String(v ?? "");
      const lines = doc.splitTextToSize(vv, rightW-16);
      doc.text(lines[0] || "", m+leftW+8, y);
      y += rowH;
    });
    y += 8;
  };

  pageHeader(false);

  title("1. Purpose and Overview");
  para("This manual explains (i) how each section score is computed, (ii) how section ON/OFF affects the normalized weights, and (iii) how the overall Busyness Index is calculated. It includes worked examples for Academic, Administrative, and Laboratory staff categories.");

  title("2. Notation");
  bullet([
    "Baseline weights: w_T, w_SV, w_R, w_P, w_A, w_S, w_L (admin inputs). Baseline weights must sum to 1.00.",
    "Enable indicator: en_i ∈ {0,1} where i ∈ {T, SV, R, P, A, S, L}. ON = 1, OFF = 0.",
    "Normalized weight: w'_i after removing OFF sections.",
    "Raw section score: Score_i computed from activity entries.",
  ]);

  title("3. Section ON/OFF and Weight Re-normalization");
  para("When some sections are OFF, the calculator automatically re-normalizes weights so that only ON sections share 100% of the total weight.");
  mono(
`Normalization:
w'_i = (en_i × w_i) / Σ(en_k × w_k)

Where:
- en_i = 1 if section i is ON, else 0
- Σ(en_k × w_k) is the sum of baseline weights over ON sections
- If Σ(...) = 0, calculation cannot proceed (at least one ON section is required).`
  );

  title("4. Overall Busyness Index");
  para("The overall index is computed as the weighted sum of section scores using normalized weights. The index is clamped to the range 0–100.");
  mono(
`Overall Index:
Index = clamp( Σ(Score_i × w'_i), 0, 100 )`
  );

  title("5. Section Scoring Formulas (Mathematical Details)");
  para("Default scoring parameters are shown in the Settings section (admin-only). The formulas below follow the current calculator logic.");

  // Teaching
  para("5.1 Teaching (T)");
  mono(
`For each course j:
Credit_j = last digit of CourseCode_j
ContactHours_j = Lec_j + Tut_j + Lab_j + Field_j

CourseScore_j = (ContactHours_j × hourW) +
                ((Students_j / 100) × studW) +
                (Credit_j × creditW)

Teaching Score:
Score_T = Σ CourseScore_j`
  );
  table2([
    ["Default hourW", state.scheme.teaching.hourW],
    ["Default studW", state.scheme.teaching.studW],
    ["Default creditW", state.scheme.teaching.creditW],
  ]);

  // Supervision
  para("5.2 Supervision (SV)");
  mono(
`For each supervision record k:
Base(level_k) = {UG: ug, Master: m, PhD: phd}
RoleMult = 1.0 if Main, else 0.6
StatusMult = 1.0 if Active, else 0.5

RecordScore_k = Base(level_k) × RoleMult × StatusMult

Supervision Score:
Score_SV = Σ RecordScore_k`
  );
  table2([
    ["Default UG (ug)", state.scheme.supervision.ug],
    ["Default Master (m)", state.scheme.supervision.m],
    ["Default PhD (phd)", state.scheme.supervision.phd],
  ]);

  // Research
  para("5.3 Research (R)");
  mono(
`For each grant record g:
LevelMult = {University: lvl[0], National: lvl[1], International: lvl[2]}
RoleMult  = {PI: role[0], Co-I: role[1], Member: role[2]}
StatusMult = 1.0 if Active, 0.6 if Applied, 0.3 if Ended

GrantScore_g = base × LevelMult × RoleMult × StatusMult

Research Score:
Score_R = Σ GrantScore_g`
  );
  table2([
    ["Default base", state.scheme.research.base],
    ["Default lvl (Uni,Nat,Intl)", state.scheme.research.lvl.join(", ")],
    ["Default role (PI,Co-I,Member)", state.scheme.research.role.join(", ")],
  ]);

  // Publication
  para("5.4 Publication (P)");
  mono(
`For each publication item p:
TypeMult = {Journal, Book/Chapter, Proceeding, Other} → type[]
IdxMult  = {Yes, No} → idx[]
RoleMult = 1.2 if First/Corresponding, else 1.0

ItemScore_p = base × TypeMult × IdxMult × RoleMult

Publication Score:
Score_P = Σ ItemScore_p`
  );
  table2([
    ["Default base", state.scheme.publication.base],
    ["Default type (J,Book,Proc,Other)", state.scheme.publication.type.join(", ")],
    ["Default idx (Yes,No)", state.scheme.publication.idx.join(", ")],
  ]);

  // Admin
  para("5.5 Administration (A)");
  mono(
`For each admin record a:
LevelBase = lvl[levelIndex]
Meetings = meetings_a
Months   = months_a
TypeBonus = 1.0 if Official, else 0.7

RecordScore_a = (LevelBase + Meetings×meetW + Months×monthW) × TypeBonus

Administration Score:
Score_A = Σ RecordScore_a`
  );
  table2([
    ["Default lvl bases", state.scheme.admin.lvl.join(", ")],
    ["Default meetW", state.scheme.admin.meetW],
    ["Default monthW", state.scheme.admin.monthW],
  ]);

  // Services
  para("5.6 Services (S)");
  mono(
`For each service record s:
RoleBonus = bonus[Lead] if Lead, else bonus[Member]
RecordScore_s = (Hours×hourW) + ((Participants/10)×paxW) + RoleBonus

Services Score:
Score_S = Σ RecordScore_s`
  );
  table2([
    ["Default hourW", state.scheme.service.hourW],
    ["Default paxW", state.scheme.service.paxW],
    ["Default role bonus (Lead,Member)", state.scheme.service.bonus.join(", ")],
  ]);

  // Lab Ops
  para("5.7 Lab Operations (L)");
  mono(
`For each lab activity ℓ:
Base = (Volume×volW) + (Hours×hourW)
ComplexityMult = cx[Low/Med/High]
UrgencyMult    = ur[Normal/Tight/Critical]

RecordScore_ℓ = Base × ComplexityMult × UrgencyMult

Lab Ops Score:
Score_L = Σ RecordScore_ℓ`
  );
  table2([
    ["Default volW", state.scheme.lab.volW],
    ["Default hourW", state.scheme.lab.hourW],
    ["Default cx (Low,Med,High)", state.scheme.lab.cx.join(", ")],
    ["Default ur (Normal,Tight,Critical)", state.scheme.lab.ur.join(", ")],
  ]);

  title("6. Worked Examples (3 Staff Categories)");
  para("The examples below use simple illustrative entries. Your actual calculator will compute scores using the same formulas, then apply normalized weights based on ON sections.");

  // Example 1: Academic
  para("6.1 Example – Academic Staff (All ON except Lab Ops)");
  mono(
`Sections ON: T, SV, R, P, A, S (Lab Ops OFF)
Baseline weights (example): T=0.30, SV=0.15, R=0.20, P=0.10, A=0.15, S=0.10
Since Lab Ops is OFF and baseline L=0.00, normalized weights remain the same.

Sample Teaching (1 course):
Course code SJ24102 → Credit=2
Lec=3, Tut=1, Lab=0, Field=0 → ContactHours=4
Students=120
CourseScore = (4×1.0) + ((120/100)×0.6) + (2×0.4)
          = 4.0 + 0.72 + 0.8 = 5.52
So Score_T = 5.52

Assume (illustration) other section scores:
Score_SV = 6.00
Score_R  = 12.00
Score_P  = 9.00
Score_A  = 10.00
Score_S  = 8.00

Index = Σ(Score_i × w'_i)
      = 5.52×0.30 + 6.00×0.15 + 12×0.20 + 9×0.10 + 10×0.15 + 8×0.10
      = 1.656 + 0.900 + 2.400 + 0.900 + 1.500 + 0.800
      = 8.156`
  );
  para("Note: The index is clamped to [0,100]. The small number above is purely illustrative—your real scores can be larger depending on workload entries.");

  // Example 2: Administrative
  para("6.2 Example – Administrative Staff (Only Administration + Services ON)");
  mono(
`Sections ON: A, S
Baseline weights (example): A=0.60, S=0.40
Normalized weights: w'_A=0.60/(0.60+0.40)=0.60, w'_S=0.40/(1.00)=0.40

Sample Administration (1 record):
Level=Faculty → LevelBase=5 (from default aLevel)
Meetings=8, Months=6, Type=Official
RecordScore_A = (5 + 8×1.5 + 6×0.3) × 1.0
              = (5 + 12 + 1.8) = 18.8
So Score_A = 18.8

Sample Services (1 record):
Hours=10, Participants=80, Role=Lead
RecordScore_S = 10×1.0 + (80/10)×0.8 + 4
              = 10 + 6.4 + 4 = 20.4
So Score_S = 20.4

Index = 18.8×0.60 + 20.4×0.40
      = 11.28 + 8.16 = 19.44`
  );

  // Example 3: Laboratory
  para("6.3 Example – Laboratory Staff (Administration + Services + Lab Ops ON)");
  mono(
`Sections ON: A, S, L
Baseline weights (example): A=0.45, S=0.25, L=0.30
Normalized weights (sum=1.00): same as baseline

Sample Lab Ops (1 record):
Volume=25, Hours=12
Complexity=High → cx=1.6
Urgency=Tight → ur=1.25
Base = 25×1.0 + 12×1.0 = 37
RecordScore_L = 37 × 1.6 × 1.25 = 74.0
So Score_L = 74.0

Assume:
Score_A = 22.0
Score_S = 18.0

Index = 22×0.45 + 18×0.25 + 74×0.30
      = 9.90 + 4.50 + 22.20
      = 36.60`
  );

  title("7. Notes for Admin");
  bullet([
    "Baseline weights must sum to 1.00. Normalization happens automatically during calculation based on ON sections.",
    "Changing scoring scheme parameters changes how raw section scores are computed.",
    "This is a front-end-only tool (static hosting). Do not store sensitive information in it."
  ]);

  doc.save("FST_UMS_Busyness_Index_Manual.pdf");
}

/* ========================= Export ========================= */
function download(filename, content, mime="text/plain"){
  const blob = new Blob([content], {type:mime});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href=url; a.download=filename; a.click();
  setTimeout(()=>URL.revokeObjectURL(url), 1500);
}

function exportSummaryCSV(){
  const aw = getActiveWeights() || {};
  const rows = [
    ["timestamp", new Date().toISOString()],
    ["name", state.profile.name],
    ["staff_id", state.profile.staffId],
    ["category", state.profile.category],
    ["unit", state.profile.unit],
    ["grade", (state.profile.grade==="Others")?state.profile.gradeOther:state.profile.grade],
    ["status", (state.profile.status==="Others")?state.profile.statusOther:state.profile.status],
    ["period", state.profile.period],
    ["enabled_sections", JSON.stringify(state.enabled)],
    ["active_weights_normalized", JSON.stringify(aw)],
    ["T", $("outT").textContent],
    ["SV", $("outSV").textContent],
    ["R", $("outR").textContent],
    ["P", $("outP").textContent],
    ["A", $("outA").textContent],
    ["S", $("outS").textContent],
    ["L", $("outL").textContent],
    ["index", $("outIndex").textContent],
    ["band", $("outBand").textContent]
  ];
  const csv = rows.map(r=>r.map(x=>`"${String(x).replaceAll('"','""')}"`).join(",")).join("\n");
  download("FST_UMS_Busyness_Summary.csv", csv, "text/csv");
}

function exportDetailedCSV(){
  const lines = [];
  const pushSection = (name, arr)=>{
    lines.push(`SECTION,${name}`);
    if(arr.length===0){ lines.push("EMPTY"); lines.push(""); return; }
    const keys = Object.keys(arr[0]);
    lines.push(keys.join(","));
    arr.forEach(o=>{
      lines.push(keys.map(k=>`"${String(o[k]??"").replaceAll('"','""')}"`).join(","));
    });
    lines.push("");
  };
  pushSection("Teaching", state.data.teaching);
  pushSection("Supervision", state.data.supervision);
  pushSection("Research", state.data.research);
  pushSection("Publication", state.data.publication);
  pushSection("Administration", state.data.admin);
  pushSection("Services", state.data.service);
  pushSection("Lab Operations", state.data.lab);

  download("FST_UMS_Busyness_Detailed.csv", lines.join("\n"), "text/csv");
}

function exportJSON(){
  const payload = {
    meta:{ generated_at:new Date().toISOString(), app:"FST UMS Staff Busyness Index", version:"1.0" },
    profile: state.profile,
    enabled_sections: state.enabled,
    baseline_weights: state.weights,
    active_weights_normalized: getActiveWeights(),
    scheme: state.scheme,
    data: state.data,
    results:{
      T:$("outT").textContent, SV:$("outSV").textContent, R:$("outR").textContent,
      P:$("outP").textContent, A:$("outA").textContent, S:$("outS").textContent, L:$("outL").textContent,
      index:$("outIndex").textContent, band:$("outBand").textContent,
      dean_summary:$("outDean").textContent,
      narrative:$("outNarr").textContent
    },
    audit: state.audit
  };
  download("FST_UMS_Busyness_Full.json", JSON.stringify(payload,null,2), "application/json");
}

/* ========================= Storage ========================= */
function autosave(){
  state.audit.last_saved_at = new Date().toISOString();
  localStorage.setItem("fst_busyness_v1", JSON.stringify(state));
}
function saveNow(){
  syncProfileFromUI();
  syncEnabledFromUI();
  syncSettingsFromUI_ifAdmin();
  autosave();
  showMsg("ok","<b>Saved locally:</b> Data stored in your browser (localStorage).");
}
function loadLocal(){
  const raw = localStorage.getItem("fst_busyness_v1");
  if(!raw) return;
  try{
    const obj = JSON.parse(raw);
    Object.assign(state, obj);
  }catch(e){}
}

/* ========================= Reset ========================= */
function resetAll(){
  if(!confirm("Reset all data? This will clear local saved data for this tool on this browser.")) return;
  localStorage.removeItem("fst_busyness_v1");
  location.reload();
}

/* ========================= Init ========================= */
function init(){
  loadLocal();
  ensureSeed();
  syncUIFromState();
  applySectionVisibility();
  renderAll();
  setAdminUI();
  autosizeAllTextareas();

  // Autosize listener (covers manual typing too)
  document.addEventListener("input", (e)=>{
    if(e.target && e.target.tagName==="TEXTAREA" && e.target.classList.contains("autoGrow")){
      autosizeTextarea(e.target);
    }
  });

  // Profile other fields
  $("pGrade").addEventListener("change", ()=>{
    $("pGradeOtherWrap").style.display = ($("pGrade").value==="Others") ? "block" : "none";
    autosizeAllTextareas();
  });
  $("pStatus").addEventListener("change", ()=>{
    $("pStatusOtherWrap").style.display = ($("pStatus").value==="Others") ? "block" : "none";
    autosizeAllTextareas();
  });

  // Category template
  $("pCategory").addEventListener("change", ()=>{
    syncProfileFromUI();
    if(state.profile.category) applyTemplateByCategory(state.profile.category);
  });

  // Toggles
  ["enTeaching","enSupervision","enResearch","enPublication","enAdministration","enServices","enLabOps"].forEach(id=>{
    $(id).addEventListener("change", ()=>{
      syncEnabledFromUI();
      applySectionVisibility();
      autosave();
    });
  });

  // Admin
  $("btnAdminUnlock").addEventListener("click",(e)=>{ e.preventDefault(); unlockAdmin(); });
  $("btnAdminLock").addEventListener("click",(e)=>{ e.preventDefault(); lockAdmin(); });

  // Add/Clear
  $("addTeach").onclick=(e)=>{e.preventDefault(); addRow("teach");};
  $("clearTeach").onclick=(e)=>{e.preventDefault(); clearKind("teach");};
  $("addSv").onclick=(e)=>{e.preventDefault(); addRow("sv");};
  $("clearSv").onclick=(e)=>{e.preventDefault(); clearKind("sv");};
  $("addRes").onclick=(e)=>{e.preventDefault(); addRow("res");};
  $("clearRes").onclick=(e)=>{e.preventDefault(); clearKind("res");};
  $("addPub").onclick=(e)=>{e.preventDefault(); addRow("pub");};
  $("clearPub").onclick=(e)=>{e.preventDefault(); clearKind("pub");};
  $("addAdmin").onclick=(e)=>{e.preventDefault(); addRow("admin");};
  $("clearAdmin").onclick=(e)=>{e.preventDefault(); clearKind("admin");};
  $("addSvc").onclick=(e)=>{e.preventDefault(); addRow("svc");};
  $("clearSvc").onclick=(e)=>{e.preventDefault(); clearKind("svc");};
  $("addLab").onclick=(e)=>{e.preventDefault(); addRow("lab");};
  $("clearLab").onclick=(e)=>{e.preventDefault(); clearKind("lab");};

  // Calculate / Report PDF / Manual / Export
  $("btnCalc").onclick=(e)=>{e.preventDefault(); calculate();};
  $("btnPrint").onclick=(e)=>{e.preventDefault(); syncProfileFromUI(); reportPDF();};
  $("btnManual").onclick=(e)=>{e.preventDefault(); manualPDF();};
  $("btnExportSummaryCSV").onclick=(e)=>{e.preventDefault(); exportSummaryCSV();};
  $("btnExportDetailedCSV").onclick=(e)=>{e.preventDefault(); exportDetailedCSV();};
  $("btnExportJSON").onclick=(e)=>{e.preventDefault(); exportJSON();};

  // Save / Reset
  $("btnSaveLocal").onclick=(e)=>{e.preventDefault(); saveNow();};
  $("btnReset").onclick=(e)=>{e.preventDefault(); resetAll();};

  // Presets (admin only)
  $("btnPresetAcademic").onclick=(e)=>{e.preventDefault(); if(!isAdmin) return; applyTemplateByCategory("Academic");};
  $("btnPresetAdmin").onclick=(e)=>{e.preventDefault(); if(!isAdmin) return; applyTemplateByCategory("Administrative");};
  $("btnPresetLab").onclick=(e)=>{e.preventDefault(); if(!isAdmin) return; applyTemplateByCategory("Laboratory");};

  hideMsg();
}
init();
</script>

</body>
</html>
