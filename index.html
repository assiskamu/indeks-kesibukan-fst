<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FST UMS Staff Busyness Index</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --bg0:#070A14;
      --bg1:#0B1022;
      --card: rgba(255,255,255,.06);
      --card2: rgba(255,255,255,.08);
      --line: rgba(255,255,255,.14);
      --text: #ECF2FF;
      --muted:#B9C7FF;

      /* Section accents */
      --a-profile:#60A5FA;
      --a-settings:#22C55E;
      --a-teaching:#A78BFA;
      --a-research:#34D399;
      --a-admin:#FBBF24;
      --a-service:#FB7185;
      --a-results:#2DD4BF;

      --danger:#FB7185;
      --warn:#FBBF24;
      --ok:#34D399;
      --info:#60A5FA;

      --radius:18px;
      --shadow: 0 16px 40px rgba(0,0,0,.40);
    }

    *{ box-sizing:border-box; font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif; }
    body{
      margin:0;
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 15% 0%, rgba(96,165,250,.28) 0%, rgba(7,10,20,0) 55%),
        radial-gradient(900px 600px at 80% 8%, rgba(34,197,94,.18) 0%, rgba(7,10,20,0) 55%),
        linear-gradient(180deg, var(--bg1), var(--bg0));
      background-attachment: fixed;
    }
    .wrap{ max-width: 1200px; margin: 18px auto; padding: 14px; }

    .top{
      display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap;
      padding: 14px 16px;
      border-radius: var(--radius);
      border: 1px solid rgba(255,255,255,.14);
      background: linear-gradient(135deg, rgba(96,165,250,.18), rgba(45,212,191,.12));
      box-shadow: var(--shadow);
    }
    .brand{ display:flex; align-items:center; gap:12px; min-width: 260px; }
    .logo{
      width:52px; height:52px; border-radius: 16px;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.14);
      overflow:hidden; display:flex; align-items:center; justify-content:center;
    }
    .logo img{ width:100%; height:100%; object-fit:contain; padding:6px; }
    .tbox h1{ margin:0; font-size:1.12rem; font-weight: 950; letter-spacing:.2px; }
    .tbox p{ margin:4px 0 0; color: var(--muted); font-size:.88rem; }

    .mode{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end;
    }
    .pill{
      display:inline-flex; gap:8px; align-items:center;
      padding: 7px 10px; border-radius: 999px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      font-size:.82rem; font-weight: 900;
    }
    .dot{ width:9px; height:9px; border-radius:999px; background: var(--ok); }

    .btn{
      border:none; cursor:pointer;
      padding: 9px 12px;
      border-radius: 999px;
      font-weight: 950;
      color: var(--text);
      background: rgba(96,165,250,.18);
      border:1px solid rgba(96,165,250,.42);
    }
    .btn.secondary{ background: rgba(45,212,191,.16); border-color: rgba(45,212,191,.42); }
    .btn.ghost{ background: transparent; border-color: rgba(255,255,255,.18); color: var(--muted); }
    .btn.warn{ background: rgba(251,191,36,.14); border-color: rgba(251,191,36,.45); }
    .btn.danger{ background: rgba(251,113,133,.14); border-color: rgba(251,113,133,.45); }
    .btn:active{ transform: translateY(1px); }

    .notice{
      margin-top: 14px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: rgba(236,242,255,.92);
      line-height: 1.45;
      font-size:.92rem;
    }
    .notice.bad{ border-color: rgba(251,113,133,.45); background: rgba(251,113,133,.10); }
    .notice.warn{ border-color: rgba(251,191,36,.45); background: rgba(251,191,36,.10); }
    .notice.ok{ border-color: rgba(52,211,153,.45); background: rgba(52,211,153,.08); }

    .section{
      margin-top: 14px;
      border-radius: var(--radius);
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.05);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .section header{
      padding: 12px 14px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
    }
    .section h2{ margin:0; font-size:1.03rem; font-weight: 1000; }
    .sub{ color: var(--muted); font-size: .86rem; margin-top:3px; }
    .content{ padding: 12px 14px; }

    .accent{
      height:5px;
      background: linear-gradient(90deg, var(--acc), rgba(255,255,255,0));
    }
    .profile{ --acc: var(--a-profile); }
    .settings{ --acc: var(--a-settings); }
    .teaching{ --acc: var(--a-teaching); }
    .research{ --acc: var(--a-research); }
    .admin{ --acc: var(--a-admin); }
    .service{ --acc: var(--a-service); }
    .results{ --acc: var(--a-results); }

    .grid{
      display:grid;
      grid-template-columns: repeat(4, minmax(0,1fr));
      gap: 10px;
    }
    @media (max-width: 980px){ .grid{ grid-template-columns: repeat(2, minmax(0,1fr)); } }
    @media (max-width: 520px){ .grid{ grid-template-columns: 1fr; } }

    label{ display:block; font-size:.78rem; color: var(--muted); margin: 0 0 5px; }
    input, select, textarea{
      width:100%;
      border-radius: 12px;
      padding: 9px 10px;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.16);
      color: var(--text);
      outline: none;
    }
    textarea{ min-height: 40px; resize: vertical; }
    input::placeholder, textarea::placeholder{ color: rgba(236,242,255,.45); }
    input:focus, select:focus, textarea:focus{
      border-color: rgba(45,212,191,.55);
      box-shadow: 0 0 0 2px rgba(45,212,191,.16);
    }

    .otherWrap{ display:none; margin-top:8px; }
    .requiredMark::after{ content:" *"; color: var(--warn); font-weight: 1000; }

    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .row.right{ justify-content:flex-end; }
    .hr{ height:1px; background: rgba(255,255,255,.10); margin: 12px 0; }

    table{
      width:100%;
      border-collapse: separate;
      border-spacing: 0;
      margin-top: 10px;
      overflow:hidden;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.14);
    }
    thead th{
      text-align:left;
      padding: 9px 10px;
      font-size:.78rem;
      color: rgba(236,242,255,.95);
      border-bottom: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.08);
    }
    tbody td{
      padding: 8px 10px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.10);
      vertical-align: top;
    }
    tbody tr:last-child td{ border-bottom:none; }

    .miniinput{ font-size:.86rem; padding: 8px 9px; border-radius: 10px; }

    .err{
      border-color: rgba(251,113,133,.8) !important;
      box-shadow: 0 0 0 2px rgba(251,113,133,.14) !important;
    }

    .kpi{
      display:grid; grid-template-columns: repeat(5, minmax(0,1fr));
      gap: 10px;
      margin-top: 10px;
    }
    @media (max-width: 980px){ .kpi{ grid-template-columns: repeat(2, minmax(0,1fr)); } }

    .box{
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.08);
      padding: 10px;
    }
    .k{ font-size:.78rem; color: var(--muted); }
    .v{ font-size: 1.25rem; font-weight: 1000; margin-top: 3px; }
    .s{ font-size: .78rem; color: rgba(236,242,255,.70); margin-top:2px; }

    .zone{
      display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
      margin-top:10px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.08);
    }
    .big{
      font-size: 2.2rem;
      font-weight: 1100;
      letter-spacing:.4px;
    }
    .tag{
      display:inline-flex; align-items:center; gap:8px;
      padding: 7px 10px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.18);
      font-weight: 1000;
    }
    .tag.low{ background: rgba(96,165,250,.18); }
    .tag.normal{ background: rgba(52,211,153,.16); }
    .tag.high{ background: rgba(251,191,36,.18); }
    .tag.over{ background: rgba(251,113,133,.18); }
    .tag.low .dot{ background: var(--info); }
    .tag.normal .dot{ background: var(--ok); }
    .tag.high .dot{ background: var(--warn); }
    .tag.over .dot{ background: var(--danger); }

    .footer{
      margin: 16px 0 6px;
      color: rgba(236,242,255,.65);
      font-size: .78rem;
      text-align:center;
    }

    /* Print: professional, black/white, ensure no cut */
    @media print{
      body{ background:#fff !important; color:#111 !important; }
      .top, .notice, .row.noPrint, .accent{ display:none !important; }
      .section{ box-shadow:none !important; border:1px solid #ddd !important; background:#fff !important; }
      .section header{ border-bottom:1px solid #ddd !important; }
      .section header h2, .sub{ color:#111 !important; }
      label{ color:#333 !important; }
      input, select, textarea{
        background:#fff !important; color:#111 !important;
        border: 1px solid #ccc !important;
        height: auto !important;
        white-space: pre-wrap !important;
      }
      table{ border:1px solid #ccc !important; page-break-inside:auto !important; }
      thead th{ background:#f3f3f3 !important; color:#111 !important; border-bottom:1px solid #ccc !important; }
      tbody td{ background:#fff !important; color:#111 !important; border-bottom:1px solid #eee !important; }
      .section, table, tr, td, th{ page-break-inside: avoid !important; }
      canvas{ max-height: 240px !important; }
      .footer{ color:#333 !important; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="logo" title="Put logo at assets/UMS logo.png">
          <!-- If logo not showing: confirm folder assets/ and exact filename 'UMS logo.png' -->
          <img src="assets/UMS%20logo.png" alt="UMS logo" />
        </div>
        <div class="tbox">
          <h1>FST UMS Staff Busyness Index</h1>
          <p>One-page • Required fields • Admin-locked settings • Professional Print PDF</p>
        </div>
      </div>
      <div class="mode">
        <span class="pill" id="pillRole"><span class="dot" id="roleDot"></span><span id="roleText">Staff Mode</span></span>
        <button class="btn ghost" id="btnToggleMode">Switch to Management View</button>
        <button class="btn warn" id="btnAdminUnlock">Admin Unlock</button>
      </div>
    </div>

    <div class="notice" id="msgBox">
      <b>Note:</b> Settings/weights are locked for staff. Admin can unlock (per browser). Calculate & Print are at the bottom.
    </div>

    <!-- PROFILE -->
    <section class="section profile" id="secProfile">
      <div class="accent"></div>
      <header>
        <div>
          <h2>Staff Profile</h2>
          <div class="sub">All fields are required for audit trail & PDF signing.</div>
        </div>
      </header>
      <div class="content">
        <div class="grid">
          <div>
            <label class="requiredMark">Full Name</label>
            <input id="pName" placeholder="e.g., Dr. ..." />
          </div>

          <div>
            <label class="requiredMark">Staff ID (format: 250505-02025)</label>
            <input id="pStaffId" placeholder="e.g., 250505-02025" />
          </div>

          <div>
            <label class="requiredMark">Programme / Department</label>
            <input id="pDept" placeholder="e.g., Mathematics with Economics" />
          </div>

          <div>
            <label class="requiredMark">Grade</label>
            <select id="pGrade">
              <option value="">Select</option>
              <option>DS45 / Lecturer</option>
              <option>DS51 / Senior Lecturer</option>
              <option>DS53 / Senior Lecturer</option>
              <option>DS54 / Senior Lecturer</option>
              <option>VK7 / Associate Professor</option>
              <option>VK6 / Professor</option>
              <option value="Other">Other</option>
            </select>
            <div class="otherWrap" id="pGradeOtherWrap">
              <label class="requiredMark">Specify Grade (Other)</label>
              <input id="pGradeOther" placeholder="Type grade..." />
            </div>
          </div>

          <div>
            <label class="requiredMark">Appointment Status</label>
            <select id="pStatus">
              <option value="">Select</option>
              <option>Permanent</option>
              <option>Contract</option>
              <option>Secondment</option>
              <option>Visiting</option>
              <option value="Other">Other</option>
            </select>
            <div class="otherWrap" id="pStatusOtherWrap">
              <label class="requiredMark">Specify Status (Other)</label>
              <input id="pStatusOther" placeholder="Type status..." />
            </div>
          </div>

          <div>
            <label class="requiredMark">Reporting Period</label>
            <input id="pPeriod" placeholder="e.g., Semester 1 2025/2026" />
          </div>

          <div>
            <label class="requiredMark">Faculty Name</label>
            <input id="pFaculty" value="Faculty of Science and Technology (FST), UMS" />
          </div>

          <div>
            <label class="requiredMark">Dean Name</label>
            <input id="pDean" placeholder="Type Dean's full name" />
          </div>
        </div>
      </div>
    </section>

    <!-- SETTINGS (Admin only) -->
    <section class="section settings" id="secSettings">
      <div class="accent"></div>
      <header>
        <div>
          <h2>Weights & Mark Scheme (Admin-only)</h2>
          <div class="sub">Weights must sum to exactly 1.00 (strict). Presets available.</div>
        </div>
        <div class="row noPrint">
          <span class="pill" id="lockPill"><span class="dot" id="lockDot"></span><span id="lockText">Locked</span></span>
        </div>
      </header>

      <div class="content">
        <div class="row noPrint" style="align-items:flex-end;">
          <div style="min-width:260px;flex:1;">
            <label>Rubric Preset (admin)</label>
            <select id="preset">
              <option value="custom">Custom</option>
              <option value="lecturer">Lecturer</option>
              <option value="senior">Senior Lecturer</option>
              <option value="assoc">Associate Professor</option>
              <option value="prof">Professor</option>
            </select>
          </div>

          <div style="min-width:260px;flex:1;">
            <label>Admin Password (to unlock settings)</label>
            <input id="adminPw" type="password" placeholder="Ask admin for password" />
          </div>

          <div class="row right" style="flex:1;">
            <button class="btn ghost" id="btnLoadLocal">Load saved</button>
            <button class="btn secondary" id="btnSaveLocal">Save locally</button>
            <button class="btn danger" id="btnResetAll">Reset all</button>
          </div>
        </div>

        <div class="notice warn" id="weightWarn" style="display:none;"></div>

        <div class="hr"></div>

        <div class="grid">
          <div><label class="requiredMark">Weight: Teaching (T)</label><input id="wT" type="number" step="0.01" min="0" value="0.40" /></div>
          <div><label class="requiredMark">Weight: Research (R)</label><input id="wR" type="number" step="0.01" min="0" value="0.30" /></div>
          <div><label class="requiredMark">Weight: Administration (A)</label><input id="wA" type="number" step="0.01" min="0" value="0.20" /></div>
          <div><label class="requiredMark">Weight: Service (S)</label><input id="wS" type="number" step="0.01" min="0" value="0.10" /></div>
        </div>

        <div class="hr"></div>

        <div class="grid">
          <div><label>Teaching: points per credit</label><input id="tCreditW" type="number" step="0.1" min="0" value="5" /></div>
          <div><label>Teaching: points per student</label><input id="tStudentW" type="number" step="0.01" min="0" value="0.10" /></div>
          <div><label>Teaching: points per contact hour</label><input id="tHourW" type="number" step="0.1" min="0" value="1.0" /></div>
          <div><label>Multiplier for PG course</label><input id="tPgMult" type="number" step="0.05" min="0" value="1.20" /></div>
        </div>

        <div class="hr"></div>

        <div class="grid">
          <div><label>Research: PI base</label><input id="rPI" type="number" step="1" min="0" value="25" /></div>
          <div><label>Research: Co-I base</label><input id="rCo" type="number" step="1" min="0" value="12" /></div>
          <div><label>Research: Member base</label><input id="rMem" type="number" step="1" min="0" value="6" /></div>
          <div><label>Research Effort: points per supervision/review hour</label><input id="rEffortW" type="number" step="0.1" min="0" value="1.0" /></div>
        </div>

        <div class="hr"></div>

        <div class="grid">
          <div><label>Admin: points per level (Programme)</label><input id="aProg" type="number" step="0.5" min="0" value="3" /></div>
          <div><label>Admin: points per level (Faculty)</label><input id="aFac" type="number" step="0.5" min="0" value="5" /></div>
          <div><label>Admin: points per level (University)</label><input id="aUni" type="number" step="0.5" min="0" value="7" /></div>
          <div><label>Admin: points per level (State)</label><input id="aState" type="number" step="0.5" min="0" value="8" /></div>

          <div><label>Admin: points per level (National)</label><input id="aNat" type="number" step="0.5" min="0" value="10" /></div>
          <div><label>Admin: points per level (International)</label><input id="aInt" type="number" step="0.5" min="0" value="12" /></div>
          <div><label>Admin: points per level (Industry)</label><input id="aInd" type="number" step="0.5" min="0" value="9" /></div>
          <div><label>Admin: points per meeting</label><input id="aMeetW" type="number" step="0.1" min="0" value="1.5" /></div>

          <div><label>Admin: points per preparation hour</label><input id="aPrepW" type="number" step="0.1" min="0" value="1.0" /></div>
          <div><label>Admin: points per month (duration)</label><input id="aMonthW" type="number" step="0.1" min="0" value="0.3" /></div>
          <div><label>Admin: appointment type bonus (Official)</label><input id="aOfficialB" type="number" step="0.5" min="0" value="3" /></div>
          <div><label>Admin: appointment type bonus (Conference Committee)</label><input id="aConfB" type="number" step="0.5" min="0" value="4" /></div>
        </div>

        <div class="hr"></div>

        <div class="grid">
          <div><label>Service: points per hour</label><input id="sHourW" type="number" step="0.1" min="0" value="1.0" /></div>
          <div><label>Service: points per 10 participants</label><input id="sPaxW" type="number" step="0.1" min="0" value="0.8" /></div>
          <div><label>Service: Lead bonus</label><input id="sLead" type="number" step="0.5" min="0" value="4" /></div>
          <div><label>Service: Member bonus</label><input id="sMember" type="number" step="0.5" min="0" value="1.5" /></div>
        </div>

        <div class="notice">
          <b>Security note:</b> This is a static GitHub Pages site. Admin lock here is a practical UI lock, not a secure authentication system.
        </div>
      </div>
    </section>

    <!-- TEACHING -->
    <section class="section teaching" id="secTeaching">
      <div class="accent"></div>
      <header>
        <div>
          <h2>Teaching – Courses</h2>
          <div class="sub">Credit auto from last digit of course code (e.g., SJ24102 → 2). Credit is read-only.</div>
        </div>
        <div class="row noPrint">
          <button class="btn secondary" id="addCourse">+ Add course</button>
          <button class="btn ghost" id="clearCourse">Clear</button>
        </div>
      </header>
      <div class="content">
        <table id="tblCourse">
          <thead>
            <tr>
              <th style="width:10%">Level</th>
              <th style="width:14%">Course Code *</th>
              <th>Course Name *</th>
              <th style="width:8%">Credit</th>
              <th style="width:10%">Students *</th>
              <th style="width:8%">LEC *</th>
              <th style="width:8%">TUT *</th>
              <th style="width:8%">LAB *</th>
              <th style="width:9%">FIELD *</th>
              <th style="width:12%">Contact Hours</th>
              <th style="width:8%">Del</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- RESEARCH -->
    <section class="section research" id="secResearch">
      <div class="accent"></div>
      <header>
        <div>
          <h2>Research – Grants + Effort (Top-down busyness)</h2>
          <div class="sub">Grants are top-down. Research Effort captures supervision/reviewing time (optional, but recommended).</div>
        </div>
        <div class="row noPrint">
          <button class="btn secondary" id="addGrant">+ Add grant</button>
          <button class="btn ghost" id="clearGrant">Clear</button>
        </div>
      </header>
      <div class="content">
        <table id="tblGrant">
          <thead>
            <tr>
              <th style="width:14%">Grant Code *</th>
              <th>Title *</th>
              <th style="width:12%">Level *</th>
              <th style="width:12%">Role *</th>
              <th style="width:12%">Status *</th>
              <th style="width:12%">Amount (RM)</th>
              <th style="width:12%">Duration (months) *</th>
              <th style="width:8%">Del</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>

        <div class="hr"></div>

        <div class="row noPrint" style="justify-content:space-between;gap:12px;">
          <div>
            <h3 style="margin:0;font-size:1rem;font-weight:1000;">Research Effort (Supervision / Reviewing / Editorial / Consultancy)</h3>
            <div class="sub">Use hours to represent effort (more defensible than “publication output”).</div>
          </div>
          <div class="row">
            <button class="btn secondary" id="addEffort">+ Add effort</button>
            <button class="btn ghost" id="clearEffort">Clear</button>
          </div>
        </div>

        <table id="tblEffort">
          <thead>
            <tr>
              <th>Activity Type *</th>
              <th>Description *</th>
              <th style="width:16%">Hours *</th>
              <th style="width:10%">Del</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>

        <div class="hr"></div>

        <div class="row noPrint" style="justify-content:space-between;gap:12px;">
          <div>
            <h3 style="margin:0;font-size:1rem;font-weight:1000;">Publications (Optional)</h3>
            <div class="sub">Default OFF to avoid “self-create busy”. You may enable if management agrees.</div>
          </div>
          <div class="row">
            <label style="margin:0;color:var(--muted);font-size:.86rem;display:flex;gap:8px;align-items:center;">
              <input id="pubToggle" type="checkbox" style="width:auto;transform:scale(1.05)" />
              Include publications in scoring
            </label>
          </div>
        </div>

        <div id="pubWrap" style="display:none;">
          <div class="row noPrint" style="justify-content:flex-end;">
            <button class="btn secondary" id="addPub">+ Add publication</button>
            <button class="btn ghost" id="clearPub">Clear</button>
          </div>

          <table id="tblPub">
            <thead>
              <tr>
                <th style="width:14%">Year *</th>
                <th>Title *</th>
                <th style="width:14%">Index *</th>
                <th style="width:12%">Quartile</th>
                <th style="width:16%">Authorship *</th>
                <th style="width:12%">Status *</th>
                <th style="width:8%">Del</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- ADMINISTRATION -->
    <section class="section admin" id="secAdmin">
      <div class="accent"></div>
      <header>
        <div>
          <h2>Administration – Appointments & Committees</h2>
          <div class="sub">Level + meetings + preparation hours + duration. Suitable for conference committees (AJK + pre-event work).</div>
        </div>
        <div class="row noPrint">
          <button class="btn secondary" id="addAdmin">+ Add appointment</button>
          <button class="btn ghost" id="clearAdmin">Clear</button>
        </div>
      </header>
      <div class="content">
        <table id="tblAdmin">
          <thead>
            <tr>
              <th>Appointment / Role *</th>
              <th style="width:16%">Type *</th>
              <th style="width:16%">Level *</th>
              <th style="width:12%">Meetings *</th>
              <th style="width:14%">Prep Hours *</th>
              <th style="width:14%">Duration (months) *</th>
              <th style="width:8%">Del</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- SERVICE -->
    <section class="section service" id="secService">
      <div class="accent"></div>
      <header>
        <div>
          <h2>Service / Community / Others</h2>
          <div class="sub">Hours + participants + role.</div>
        </div>
        <div class="row noPrint">
          <button class="btn secondary" id="addService">+ Add activity</button>
          <button class="btn ghost" id="clearService">Clear</button>
        </div>
      </header>
      <div class="content">
        <table id="tblService">
          <thead>
            <tr>
              <th>Activity *</th>
              <th style="width:14%">Role *</th>
              <th style="width:12%">Hours *</th>
              <th style="width:14%">Participants *</th>
              <th style="width:8%">Del</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- RESULTS -->
    <section class="section results" id="secResults">
      <div class="accent"></div>
      <header>
        <div>
          <h2>Results & Export</h2>
          <div class="sub">Calculate at bottom • Print PDF includes signatures • Export for dashboard</div>
        </div>
        <span class="pill" id="auditPill"><span class="dot" style="background:var(--info)"></span><span id="auditStamp">Not calculated yet</span></span>
      </header>

      <div class="content">
        <div class="kpi">
          <div class="box"><div class="k">Teaching (T)</div><div class="v" id="outT">0.0</div><div class="s">Courses + contact hours</div></div>
          <div class="box"><div class="k">Research (R)</div><div class="v" id="outR">0.0</div><div class="s">Grants + effort (+ optional pubs)</div></div>
          <div class="box"><div class="k">Administration (A)</div><div class="v" id="outA">0.0</div><div class="s">Level + meetings + prep + duration</div></div>
          <div class="box"><div class="k">Service (S)</div><div class="v" id="outS">0.0</div><div class="s">Hours + participants</div></div>
          <div class="box"><div class="k">Overall Index</div><div class="v" id="outIndex">0.0</div><div class="s">Scale 0–100</div></div>
        </div>

        <div class="zone">
          <div>
            <div class="k" style="color:var(--muted);font-size:.86rem">Busyness Index</div>
            <div class="big"><span id="bigIndex">0.0</span> <span style="font-size:.92rem;color:rgba(236,242,255,.75)">/100</span></div>
          </div>
          <div class="tag normal" id="zoneTag"><span class="dot"></span><span id="zoneText">Normal</span></div>
        </div>
        <p id="zoneDesc" style="color:var(--muted);margin:10px 0 0;line-height:1.45"></p>

        <div class="hr"></div>

        <div class="notice" id="chartNote">
          Chart uses section colours. If not visible, CDN may be blocked; scores/exports still work.
        </div>
        <canvas id="chart" height="140"></canvas>

        <div class="hr"></div>

        <!-- Management View import -->
        <div class="row noPrint" style="justify-content:space-between;gap:12px;">
          <div style="min-width:260px;flex:1">
            <label>Management View – Import staff JSON (read-only)</label>
            <input type="file" id="jsonImport" accept=".json" />
          </div>
          <div class="row right" style="flex:1">
            <button class="btn secondary" id="btnExportSummaryCSV">Export Summary CSV</button>
            <button class="btn secondary" id="btnExportDetailedCSV">Export Detailed CSV</button>
            <button class="btn" id="btnExportJSON">Export Full JSON</button>
          </div>
        </div>

        <div class="hr"></div>

        <!-- Calculate & Print at bottom -->
        <div class="row noPrint" style="justify-content:flex-end;">
          <button class="btn secondary" id="btnCalculate">Calculate</button>
          <button class="btn" id="btnPrint">Print PDF</button>
        </div>

        <!-- Signature block (print) -->
        <div class="hr"></div>
        <div class="section" style="box-shadow:none;border:1px dashed rgba(255,255,255,.18);background:rgba(255,255,255,.03);">
          <header style="border-bottom:none">
            <div>
              <h2 style="font-size:1rem;margin:0">Signatures (for PDF)</h2>
              <div class="sub">Printed output includes staff & dean signature lines and dates.</div>
            </div>
          </header>
          <div class="content">
            <div class="grid">
              <div>
                <label>Printed Date</label>
                <input id="printDate" readonly />
              </div>
              <div>
                <label>Staff Name</label>
                <input id="sigStaffName" readonly />
              </div>
              <div>
                <label>Staff ID</label>
                <input id="sigStaffId" readonly />
              </div>
              <div>
                <label>Faculty</label>
                <input id="sigFaculty" readonly />
              </div>
            </div>

            <div class="hr"></div>

            <div class="grid">
              <div style="grid-column: span 2;">
                <label>Staff Signature</label>
                <input placeholder="Signature (manual/digital)" />
              </div>
              <div>
                <label>Staff Signature Date</label>
                <input placeholder="DD/MM/YYYY" />
              </div>
              <div style="grid-column: span 1;">
                <label>Dean Name</label>
                <input id="sigDean" readonly />
              </div>

              <div style="grid-column: span 2;">
                <label>Dean Signature</label>
                <input placeholder="Signature (manual/digital)" />
              </div>
              <div>
                <label>Dean Signature Date</label>
                <input placeholder="DD/MM/YYYY" />
              </div>
              <div>
                <label>Dean Office / Faculty</label>
                <input id="sigDeanOffice" readonly />
              </div>
            </div>

          </div>
        </div>

      </div>
    </section>

    <div class="footer">© <span id="yearNow"></span> FST UMS</div>
  </div>

<script>
/* ======================
   CONFIG
====================== */
const LS_KEY = "fst_ums_busyness_v3";
const ADMIN_PASSWORD = "FST-ADMIN"; // CHANGE THIS (Dato' boleh tukar)
const STAFF_ID_REGEX = /^\d{6}-\d{5}$/;

/* ======================
   STATE
====================== */
let isAdminUnlocked = false;
let isManagementView = false;
let lastCalculatedISO = "";

const state = {
  profile: {
    name:"", staffId:"", dept:"", grade:"", gradeOther:"",
    status:"", statusOther:"",
    period:"", faculty:"Faculty of Science and Technology (FST), UMS",
    dean:""
  },
  settings: {
    weights: { T:0.40, R:0.30, A:0.20, S:0.10 },
    teaching: { creditW:5, studentW:0.10, hourW:1.0, pgMult:1.20 },
    research: { PI:25, CO:12, MEM:6, effortW:1.0, pubW:4 }, // pubW used only when toggle ON
    admin: {
      levelW: { Programme:3, Faculty:5, University:7, State:8, National:10, International:12, Industry:9 },
      perMeeting:1.5, perPrepHour:1.0, perMonth:0.3,
      bonus: { Official:3, "Conference Committee":4, "Ad-hoc":1.5 }
    },
    service: { hourW:1.0, paxW:0.8, lead:4, member:1.5 }
  },
  toggles: { includePubs:false },
  data: { courses:[], grants:[], effort:[], pubs:[], adminRoles:[], service:[] }
};

function n(v){ const x = parseFloat(v); return Number.isFinite(x) ? x : 0; }
function clamp(x, lo, hi){ return Math.max(lo, Math.min(hi, x)); }
function uid(){ return Math.random().toString(16).slice(2) + Date.now().toString(16); }
function $(id){ return document.getElementById(id); }

/* ======================
   UI helpers: Other fields
====================== */
function bindOther(selectId, wrapId, inputId){
  const sel = $(selectId), wrap = $(wrapId), inp = $(inputId);
  const update = ()=>{
    const isOther = sel.value === "Other";
    wrap.style.display = isOther ? "block" : "none";
    if(!isOther) inp.value = "";
    autosave();
  };
  sel.addEventListener("change", update);
  inp.addEventListener("input", ()=>autosave());
  update();
}

/* ======================
   CREDIT parsing (SJ24102 -> 2)
====================== */
function inferCredit(code){
  if(!code) return 0;
  const s = String(code).trim();
  const mLastDigit = s.match(/(\d)(?!.*\d)/);
  return mLastDigit ? n(mLastDigit[1]) : 0;
}
function contactHours(c){ return n(c.lec)+n(c.tut)+n(c.lab)+n(c.field); }

/* ======================
   Seed rows (one each)
====================== */
function ensureSeed(){
  if(state.data.courses.length===0) state.data.courses.push({ id:uid(), level:"UG", code:"", name:"", credit:0, students:0, lec:0, tut:0, lab:0, field:0 });
  if(state.data.grants.length===0) state.data.grants.push({ id:uid(), code:"", title:"", level:"University", role:"PI", status:"Active", amount:0, months:0 });
  if(state.data.effort.length===0) state.data.effort.push({ id:uid(), type:"Supervision", desc:"", hours:0 });
  if(state.data.adminRoles.length===0) state.data.adminRoles.push({ id:uid(), role:"", type:"Official", level:"Programme", meetings:0, prep:0, months:0 });
  if(state.data.service.length===0) state.data.service.push({ id:uid(), activity:"", role:"Lead", hours:0, pax:0 });
}

/* ======================
   Render tables
====================== */
function renderCourses(){
  const tb = $("tblCourse").querySelector("tbody");
  tb.innerHTML = "";
  state.data.courses.forEach(r=>{
    const tr = document.createElement("tr");
    tr.dataset.id = r.id;
    tr.innerHTML = `
      <td><select class="miniinput" data-k="level"><option>UG</option><option>PG</option></select></td>
      <td><input class="miniinput" data-k="code" placeholder="e.g., SJ24102" /></td>
      <td><input class="miniinput" data-k="name" placeholder="Course name" /></td>
      <td><input class="miniinput" data-k="credit" type="number" readonly /></td>
      <td><input class="miniinput" data-k="students" type="number" min="0" step="1" /></td>
      <td><input class="miniinput" data-k="lec" type="number" min="0" step="1" /></td>
      <td><input class="miniinput" data-k="tut" type="number" min="0" step="1" /></td>
      <td><input class="miniinput" data-k="lab" type="number" min="0" step="1" /></td>
      <td><input class="miniinput" data-k="field" type="number" min="0" step="1" /></td>
      <td><input class="miniinput" data-k="ch" type="number" readonly /></td>
      <td><button class="btn danger" data-act="del" style="padding:6px 10px;font-size:.8rem">✖</button></td>
    `;
    tb.appendChild(tr);

    tr.querySelector('[data-k="level"]').value = r.level;
    tr.querySelector('[data-k="code"]').value = r.code;
    tr.querySelector('[data-k="name"]').value = r.name;
    tr.querySelector('[data-k="credit"]').value = r.credit;
    tr.querySelector('[data-k="students"]').value = r.students;
    tr.querySelector('[data-k="lec"]').value = r.lec;
    tr.querySelector('[data-k="tut"]').value = r.tut;
    tr.querySelector('[data-k="lab"]').value = r.lab;
    tr.querySelector('[data-k="field"]').value = r.field;
    tr.querySelector('[data-k="ch"]').value = contactHours(r);

    tr.addEventListener("input",(e)=>{
      const k = e.target.getAttribute("data-k");
      if(!k) return;
      const obj = state.data.courses.find(x=>x.id===tr.dataset.id);
      if(!obj) return;

      if(k==="code"){
        obj.code = e.target.value.trim();
        obj.credit = inferCredit(obj.code);
        tr.querySelector('[data-k="credit"]').value = obj.credit;
      } else if(k==="level" || k==="name"){
        obj[k] = e.target.value;
      } else if(["students","lec","tut","lab","field"].includes(k)){
        obj[k] = Math.max(0, n(e.target.value));
        e.target.value = obj[k];
      }

      tr.querySelector('[data-k="ch"]').value = contactHours(obj);
      autosave();
    });

    tr.addEventListener("click",(e)=>{
      if(e.target?.getAttribute("data-act")==="del"){
        state.data.courses = state.data.courses.filter(x=>x.id!==tr.dataset.id);
        ensureSeed(); renderCourses(); autosave();
      }
    });
  });
}

function renderGrants(){
  const tb = $("tblGrant").querySelector("tbody");
  tb.innerHTML = "";
  state.data.grants.forEach(r=>{
    const tr = document.createElement("tr");
    tr.dataset.id = r.id;
    tr.innerHTML = `
      <td><input class="miniinput" data-k="code" placeholder="e.g., FRGS/..." /></td>
      <td><input class="miniinput" data-k="title" placeholder="Grant title" /></td>
      <td><select class="miniinput" data-k="level"><option>University</option><option>National</option><option>International</option></select></td>
      <td><select class="miniinput" data-k="role"><option>PI</option><option>Co-I</option><option>Member</option></select></td>
      <td><select class="miniinput" data-k="status"><option>Active</option><option>Applied</option><option>Ended</option></select></td>
      <td><input class="miniinput" data-k="amount" type="number" min="0" step="1000" /></td>
      <td><input class="miniinput" data-k="months" type="number" min="0" step="1" /></td>
      <td><button class="btn danger" data-act="del" style="padding:6px 10px;font-size:.8rem">✖</button></td>
    `;
    tb.appendChild(tr);

    tr.querySelector('[data-k="code"]').value = r.code;
    tr.querySelector('[data-k="title"]').value = r.title;
    tr.querySelector('[data-k="level"]').value = r.level;
    tr.querySelector('[data-k="role"]').value = r.role;
    tr.querySelector('[data-k="status"]').value = r.status;
    tr.querySelector('[data-k="amount"]').value = r.amount;
    tr.querySelector('[data-k="months"]').value = r.months;

    tr.addEventListener("input",(e)=>{
      const k = e.target.getAttribute("data-k");
      if(!k) return;
      const obj = state.data.grants.find(x=>x.id===tr.dataset.id);
      if(!obj) return;

      if(k==="amount" || k==="months"){
        obj[k] = Math.max(0, n(e.target.value));
        e.target.value = obj[k];
      } else {
        obj[k] = e.target.value;
      }
      autosave();
    });

    tr.addEventListener("click",(e)=>{
      if(e.target?.getAttribute("data-act")==="del"){
        state.data.grants = state.data.grants.filter(x=>x.id!==tr.dataset.id);
        ensureSeed(); renderGrants(); autosave();
      }
    });
  });
}

function renderEffort(){
  const tb = $("tblEffort").querySelector("tbody");
  tb.innerHTML = "";
  state.data.effort.forEach(r=>{
    const tr = document.createElement("tr");
    tr.dataset.id = r.id;
    tr.innerHTML = `
      <td>
        <select class="miniinput" data-k="type">
          <option>Supervision</option>
          <option>Peer Review</option>
          <option>Editorial</option>
          <option>Consultancy</option>
          <option>Other</option>
        </select>
      </td>
      <td><input class="miniinput" data-k="desc" placeholder="Describe briefly" /></td>
      <td><input class="miniinput" data-k="hours" type="number" min="0" step="0.5" /></td>
      <td><button class="btn danger" data-act="del" style="padding:6px 10px;font-size:.8rem">✖</button></td>
    `;
    tb.appendChild(tr);

    tr.querySelector('[data-k="type"]').value = r.type;
    tr.querySelector('[data-k="desc"]').value = r.desc;
    tr.querySelector('[data-k="hours"]').value = r.hours;

    tr.addEventListener("input",(e)=>{
      const k = e.target.getAttribute("data-k");
      if(!k) return;
      const obj = state.data.effort.find(x=>x.id===tr.dataset.id);
      if(!obj) return;

      if(k==="hours"){
        obj.hours = Math.max(0, n(e.target.value));
        e.target.value = obj.hours;
      } else {
        obj[k] = e.target.value;
      }
      autosave();
    });

    tr.addEventListener("click",(e)=>{
      if(e.target?.getAttribute("data-act")==="del"){
        state.data.effort = state.data.effort.filter(x=>x.id!==tr.dataset.id);
        ensureSeed(); renderEffort(); autosave();
      }
    });
  });
}

function renderPubs(){
  const tb = $("tblPub").querySelector("tbody");
  tb.innerHTML = "";
  state.data.pubs.forEach(r=>{
    const tr = document.createElement("tr");
    tr.dataset.id = r.id;
    tr.innerHTML = `
      <td><input class="miniinput" data-k="year" placeholder="e.g., 2025" /></td>
      <td><input class="miniinput" data-k="title" placeholder="Publication title" /></td>
      <td>
        <select class="miniinput" data-k="index">
          <option>Scopus</option><option>WoS</option><option>MyCite</option><option>Non-indexed</option>
        </select>
      </td>
      <td>
        <select class="miniinput" data-k="quartile">
          <option>Q1</option><option>Q2</option><option>Q3</option><option>Q4</option><option>N/A</option>
        </select>
      </td>
      <td>
        <select class="miniinput" data-k="authorship">
          <option>First/Corresponding</option><option>Co-author</option><option>Single author</option>
        </select>
      </td>
      <td>
        <select class="miniinput" data-k="status">
          <option>Published</option><option>Accepted</option><option>Submitted</option><option>In preparation</option>
        </select>
      </td>
      <td><button class="btn danger" data-act="del" style="padding:6px 10px;font-size:.8rem">✖</button></td>
    `;
    tb.appendChild(tr);

    tr.querySelector('[data-k="year"]').value = r.year;
    tr.querySelector('[data-k="title"]').value = r.title;
    tr.querySelector('[data-k="index"]').value = r.index;
    tr.querySelector('[data-k="quartile"]').value = r.quartile;
    tr.querySelector('[data-k="authorship"]').value = r.authorship;
    tr.querySelector('[data-k="status"]').value = r.status;

    tr.addEventListener("input",(e)=>{
      const k = e.target.getAttribute("data-k");
      if(!k) return;
      const obj = state.data.pubs.find(x=>x.id===tr.dataset.id);
      if(!obj) return;
      obj[k] = e.target.value;
      autosave();
    });

    tr.addEventListener("click",(e)=>{
      if(e.target?.getAttribute("data-act")==="del"){
        state.data.pubs = state.data.pubs.filter(x=>x.id!==tr.dataset.id);
        renderPubs(); autosave();
      }
    });
  });
}

function renderAdmin(){
  const tb = $("tblAdmin").querySelector("tbody");
  tb.innerHTML = "";
  state.data.adminRoles.forEach(r=>{
    const tr = document.createElement("tr");
    tr.dataset.id = r.id;
    tr.innerHTML = `
      <td><input class="miniinput" data-k="role" placeholder="e.g., AJK Conference / Programme Head" /></td>
      <td>
        <select class="miniinput" data-k="type">
          <option>Official</option><option>Ad-hoc</option><option>Conference Committee</option>
        </select>
      </td>
      <td>
        <select class="miniinput" data-k="level">
          <option>Programme</option><option>Faculty</option><option>University</option>
          <option>State</option><option>National</option><option>International</option><option>Industry</option>
        </select>
      </td>
      <td><input class="miniinput" data-k="meetings" type="number" min="0" step="1" /></td>
      <td><input class="miniinput" data-k="prep" type="number" min="0" step="0.5" /></td>
      <td><input class="miniinput" data-k="months" type="number" min="0" step="1" /></td>
      <td><button class="btn danger" data-act="del" style="padding:6px 10px;font-size:.8rem">✖</button></td>
    `;
    tb.appendChild(tr);

    tr.querySelector('[data-k="role"]').value = r.role;
    tr.querySelector('[data-k="type"]').value = r.type;
    tr.querySelector('[data-k="level"]').value = r.level;
    tr.querySelector('[data-k="meetings"]').value = r.meetings;
    tr.querySelector('[data-k="prep"]').value = r.prep;
    tr.querySelector('[data-k="months"]').value = r.months;

    tr.addEventListener("input",(e)=>{
      const k = e.target.getAttribute("data-k");
      if(!k) return;
      const obj = state.data.adminRoles.find(x=>x.id===tr.dataset.id);
      if(!obj) return;

      if(["meetings","prep","months"].includes(k)){
        obj[k] = Math.max(0, n(e.target.value));
        e.target.value = obj[k];
      } else {
        obj[k] = e.target.value;
      }
      autosave();
    });

    tr.addEventListener("click",(e)=>{
      if(e.target?.getAttribute("data-act")==="del"){
        state.data.adminRoles = state.data.adminRoles.filter(x=>x.id!==tr.dataset.id);
        ensureSeed(); renderAdmin(); autosave();
      }
    });
  });
}

function renderService(){
  const tb = $("tblService").querySelector("tbody");
  tb.innerHTML = "";
  state.data.service.forEach(r=>{
    const tr = document.createElement("tr");
    tr.dataset.id = r.id;
    tr.innerHTML = `
      <td><input class="miniinput" data-k="activity" placeholder="e.g., Community workshop" /></td>
      <td><select class="miniinput" data-k="role"><option>Lead</option><option>Member</option></select></td>
      <td><input class="miniinput" data-k="hours" type="number" min="0" step="0.5" /></td>
      <td><input class="miniinput" data-k="pax" type="number" min="0" step="1" /></td>
      <td><button class="btn danger" data-act="del" style="padding:6px 10px;font-size:.8rem">✖</button></td>
    `;
    tb.appendChild(tr);

    tr.querySelector('[data-k="activity"]').value = r.activity;
    tr.querySelector('[data-k="role"]').value = r.role;
    tr.querySelector('[data-k="hours"]').value = r.hours;
    tr.querySelector('[data-k="pax"]').value = r.pax;

    tr.addEventListener("input",(e)=>{
      const k = e.target.getAttribute("data-k");
      if(!k) return;
      const obj = state.data.service.find(x=>x.id===tr.dataset.id);
      if(!obj) return;

      if(k==="hours" || k==="pax"){
        obj[k] = Math.max(0, n(e.target.value));
        e.target.value = obj[k];
      } else {
        obj[k] = e.target.value;
      }
      autosave();
    });

    tr.addEventListener("click",(e)=>{
      if(e.target?.getAttribute("data-act")==="del"){
        state.data.service = state.data.service.filter(x=>x.id!==tr.dataset.id);
        ensureSeed(); renderService(); autosave();
      }
    });
  });
}

function renderAll(){
  renderCourses();
  renderGrants();
  renderEffort();
  if(state.toggles.includePubs) renderPubs();
  renderAdmin();
  renderService();
}

/* ======================
   Settings sync
====================== */
function syncSettingsFromUI(){
  state.settings.weights.T = n($("wT").value);
  state.settings.weights.R = n($("wR").value);
  state.settings.weights.A = n($("wA").value);
  state.settings.weights.S = n($("wS").value);

  state.settings.teaching.creditW = n($("tCreditW").value);
  state.settings.teaching.studentW = n($("tStudentW").value);
  state.settings.teaching.hourW = n($("tHourW").value);
  state.settings.teaching.pgMult = n($("tPgMult").value);

  state.settings.research.PI = n($("rPI").value);
  state.settings.research.CO = n($("rCo").value);
  state.settings.research.MEM = n($("rMem").value);
  state.settings.research.effortW = n($("rEffortW").value);

  state.settings.admin.levelW.Programme = n($("aProg").value);
  state.settings.admin.levelW.Faculty = n($("aFac").value);
  state.settings.admin.levelW.University = n($("aUni").value);
  state.settings.admin.levelW.State = n($("aState").value);
  state.settings.admin.levelW.National = n($("aNat").value);
  state.settings.admin.levelW.International = n($("aInt").value);
  state.settings.admin.levelW.Industry = n($("aInd").value);
  state.settings.admin.perMeeting = n($("aMeetW").value);
  state.settings.admin.perPrepHour = n($("aPrepW").value);
  state.settings.admin.perMonth = n($("aMonthW").value);
  state.settings.admin.bonus.Official = n($("aOfficialB").value);
  state.settings.admin.bonus["Conference Committee"] = n($("aConfB").value);

  state.settings.service.hourW = n($("sHourW").value);
  state.settings.service.paxW = n($("sPaxW").value);
  state.settings.service.lead = n($("sLead").value);
  state.settings.service.member = n($("sMember").value);
}

function syncUIFromSettings(){
  $("wT").value = state.settings.weights.T;
  $("wR").value = state.settings.weights.R;
  $("wA").value = state.settings.weights.A;
  $("wS").value = state.settings.weights.S;

  $("tCreditW").value = state.settings.teaching.creditW;
  $("tStudentW").value = state.settings.teaching.studentW;
  $("tHourW").value = state.settings.teaching.hourW;
  $("tPgMult").value = state.settings.teaching.pgMult;

  $("rPI").value = state.settings.research.PI;
  $("rCo").value = state.settings.research.CO;
  $("rMem").value = state.settings.research.MEM;
  $("rEffortW").value = state.settings.research.effortW;

  $("aProg").value = state.settings.admin.levelW.Programme;
  $("aFac").value = state.settings.admin.levelW.Faculty;
  $("aUni").value = state.settings.admin.levelW.University;
  $("aState").value = state.settings.admin.levelW.State;
  $("aNat").value = state.settings.admin.levelW.National;
  $("aInt").value = state.settings.admin.levelW.International;
  $("aInd").value = state.settings.admin.levelW.Industry;
  $("aMeetW").value = state.settings.admin.perMeeting;
  $("aPrepW").value = state.settings.admin.perPrepHour;
  $("aMonthW").value = state.settings.admin.perMonth;
  $("aOfficialB").value = state.settings.admin.bonus.Official;
  $("aConfB").value = state.settings.admin.bonus["Conference Committee"];

  $("sHourW").value = state.settings.service.hourW;
  $("sPaxW").value = state.settings.service.paxW;
  $("sLead").value = state.settings.service.lead;
  $("sMember").value = state.settings.service.member;
}

/* ======================
   Profile sync (including Other)
====================== */
function syncProfileFromUI(){
  state.profile.name = $("pName").value.trim();
  state.profile.staffId = $("pStaffId").value.trim();
  state.profile.dept = $("pDept").value.trim();
  state.profile.grade = $("pGrade").value;
  state.profile.gradeOther = $("pGradeOther").value.trim();
  state.profile.status = $("pStatus").value;
  state.profile.statusOther = $("pStatusOther").value.trim();
  state.profile.period = $("pPeriod").value.trim();
  state.profile.faculty = $("pFaculty").value.trim();
  state.profile.dean = $("pDean").value.trim();
}
function syncUIFromProfile(){
  $("pName").value = state.profile.name;
  $("pStaffId").value = state.profile.staffId;
  $("pDept").value = state.profile.dept;
  $("pGrade").value = state.profile.grade;
  $("pGradeOther").value = state.profile.gradeOther;
  $("pStatus").value = state.profile.status;
  $("pStatusOther").value = state.profile.statusOther;
  $("pPeriod").value = state.profile.period;
  $("pFaculty").value = state.profile.faculty;
  $("pDean").value = state.profile.dean;
}

/* ======================
   Strict validation (required fields)
====================== */
function clearErrors(){
  document.querySelectorAll(".err").forEach(e=>e.classList.remove("err"));
}

function markErr(elId){
  const e = $(elId);
  if(e) e.classList.add("err");
}

function showMsg(type, html){
  const box = $("msgBox");
  box.className = "notice " + (type || "");
  box.innerHTML = html;
}

function validateWeightsStrict(){
  syncSettingsFromUI();
  const w = state.settings.weights;
  const sum = w.T + w.R + w.A + w.S;

  if(Object.values(w).some(v=>v<0)){
    $("weightWarn").style.display="block";
    $("weightWarn").textContent="Weights cannot be negative.";
    return false;
  }
  if(Math.abs(sum - 1.0) > 0.001){
    $("weightWarn").style.display="block";
    $("weightWarn").textContent=`Weight sum must be exactly 1.00. Current sum = ${sum.toFixed(3)}.`;
    return false;
  }
  $("weightWarn").style.display="none";
  $("weightWarn").textContent="";
  return true;
}

function validateProfileRequired(){
  syncProfileFromUI();

  let ok = true;

  if(!state.profile.name){ markErr("pName"); ok=false; }
  if(!state.profile.staffId || !STAFF_ID_REGEX.test(state.profile.staffId)){ markErr("pStaffId"); ok=false; }

  if(!state.profile.dept){ markErr("pDept"); ok=false; }

  if(!state.profile.grade){ markErr("pGrade"); ok=false; }
  if(state.profile.grade==="Other" && !state.profile.gradeOther){ markErr("pGradeOther"); ok=false; }

  if(!state.profile.status){ markErr("pStatus"); ok=false; }
  if(state.profile.status==="Other" && !state.profile.statusOther){ markErr("pStatusOther"); ok=false; }

  if(!state.profile.period){ markErr("pPeriod"); ok=false; }
  if(!state.profile.faculty){ markErr("pFaculty"); ok=false; }
  if(!state.profile.dean){ markErr("pDean"); ok=false; }

  return ok;
}

function validateTableRows(){
  // if a row exists, require its mandatory fields
  let ok = true;

  // Courses
  state.data.courses.forEach((c, i)=>{
    const tr = $("tblCourse").querySelectorAll("tbody tr")[i];
    if(!tr) return;

    const code = (c.code||"").trim();
    const name = (c.name||"").trim();

    // require all fields in existing row
    if(!code){ tr.querySelector('[data-k="code"]').classList.add("err"); ok=false; }
    if(!name){ tr.querySelector('[data-k="name"]').classList.add("err"); ok=false; }
    if(n(c.students) <= 0){ tr.querySelector('[data-k="students"]').classList.add("err"); ok=false; }
    if(n(c.lec) < 0 || n(c.tut) < 0 || n(c.lab) < 0 || n(c.field) < 0){ ok=false; }
    // require at least 1 contact hour
    if(contactHours(c) <= 0){
      tr.querySelector('[data-k="lec"]').classList.add("err");
      tr.querySelector('[data-k="tut"]').classList.add("err");
      tr.querySelector('[data-k="lab"]').classList.add("err");
      tr.querySelector('[data-k="field"]').classList.add("err");
      ok=false;
    }
    // auto-credit must be >0
    if(n(c.credit) <= 0){ tr.querySelector('[data-k="code"]').classList.add("err"); ok=false; }
  });

  // Grants
  state.data.grants.forEach((g, i)=>{
    const tr = $("tblGrant").querySelectorAll("tbody tr")[i];
    if(!tr) return;
    if(!(g.code||"").trim()){ tr.querySelector('[data-k="code"]').classList.add("err"); ok=false; }
    if(!(g.title||"").trim()){ tr.querySelector('[data-k="title"]').classList.add("err"); ok=false; }
    if(!(g.level||"").trim()){ tr.querySelector('[data-k="level"]').classList.add("err"); ok=false; }
    if(!(g.role||"").trim()){ tr.querySelector('[data-k="role"]').classList.add("err"); ok=false; }
    if(!(g.status||"").trim()){ tr.querySelector('[data-k="status"]').classList.add("err"); ok=false; }
    if(n(g.months) <= 0){ tr.querySelector('[data-k="months"]').classList.add("err"); ok=false; }
  });

  // Effort
  state.data.effort.forEach((e, i)=>{
    const tr = $("tblEffort").querySelectorAll("tbody tr")[i];
    if(!tr) return;
    if(!(e.type||"").trim()){ tr.querySelector('[data-k="type"]').classList.add("err"); ok=false; }
    if(!(e.desc||"").trim()){ tr.querySelector('[data-k="desc"]').classList.add("err"); ok=false; }
    if(n(e.hours) <= 0){ tr.querySelector('[data-k="hours"]').classList.add("err"); ok=false; }
  });

  // Publications (only if enabled)
  if(state.toggles.includePubs){
    state.data.pubs.forEach((p, i)=>{
      const tr = $("tblPub").querySelectorAll("tbody tr")[i];
      if(!tr) return;
      if(!(p.year||"").trim()){ tr.querySelector('[data-k="year"]').classList.add("err"); ok=false; }
      if(!(p.title||"").trim()){ tr.querySelector('[data-k="title"]').classList.add("err"); ok=false; }
      if(!(p.index||"").trim()){ tr.querySelector('[data-k="index"]').classList.add("err"); ok=false; }
      if(!(p.authorship||"").trim()){ tr.querySelector('[data-k="authorship"]').classList.add("err"); ok=false; }
      if(!(p.status||"").trim()){ tr.querySelector('[data-k="status"]').classList.add("err"); ok=false; }
    });
  }

  // Admin
  state.data.adminRoles.forEach((a, i)=>{
    const tr = $("tblAdmin").querySelectorAll("tbody tr")[i];
    if(!tr) return;
    if(!(a.role||"").trim()){ tr.querySelector('[data-k="role"]').classList.add("err"); ok=false; }
    if(!(a.type||"").trim()){ tr.querySelector('[data-k="type"]').classList.add("err"); ok=false; }
    if(!(a.level||"").trim()){ tr.querySelector('[data-k="level"]').classList.add("err"); ok=false; }
    if(n(a.meetings) < 0){ tr.querySelector('[data-k="meetings"]').classList.add("err"); ok=false; }
    if(n(a.prep) < 0){ tr.querySelector('[data-k="prep"]').classList.add("err"); ok=false; }
    if(n(a.months) <= 0){ tr.querySelector('[data-k="months"]').classList.add("err"); ok=false; }
  });

  // Service
  state.data.service.forEach((s, i)=>{
    const tr = $("tblService").querySelectorAll("tbody tr")[i];
    if(!tr) return;
    if(!(s.activity||"").trim()){ tr.querySelector('[data-k="activity"]').classList.add("err"); ok=false; }
    if(!(s.role||"").trim()){ tr.querySelector('[data-k="role"]').classList.add("err"); ok=false; }
    if(n(s.hours) <= 0){ tr.querySelector('[data-k="hours"]').classList.add("err"); ok=false; }
    if(n(s.pax) < 0){ tr.querySelector('[data-k="pax"]').classList.add("err"); ok=false; }
  });

  return ok;
}

/* ======================
   Scoring
====================== */
function scoreTeaching(){
  const s = state.settings.teaching;
  let total = 0;
  state.data.courses.forEach(c=>{
    const credit = n(c.credit);
    const students = n(c.students);
    const ch = contactHours(c);

    let base = (credit * s.creditW) + (students * s.studentW) + (ch * s.hourW);
    if((c.level||"UG")==="PG") base *= (s.pgMult || 1);
    total += base;
  });
  return total;
}

function scoreResearch(){
  const r = state.settings.research;
  let total = 0;

  // Grants
  state.data.grants.forEach(g=>{
    let base = 0;
    const role = (g.role||"").toUpperCase();
    if(role==="PI") base += r.PI;
    else if(role==="CO-I") base += r.CO;
    else base += r.MEM;

    const lvl = (g.level||"").toLowerCase();
    if(lvl==="national") base += 3;
    if(lvl==="international") base += 6;

    const st = (g.status||"").toLowerCase();
    if(st==="active") base += 5;
    if(st==="applied") base += 2;

    base += n(g.months) * 0.15;
    base += (n(g.amount)/100000) * 2; // RM100k -> +2
    total += base;
  });

  // Effort (top-down busyness)
  state.data.effort.forEach(e=>{
    total += Math.max(0, n(e.hours)) * (r.effortW || 1);
  });

  // Publications (optional)
  if(state.toggles.includePubs){
    state.data.pubs.forEach(p=>{
      let base = r.pubW || 0;

      const idx = (p.index||"").toLowerCase();
      if(idx==="wos") base += 2;
      if(idx==="scopus") base += 1;
      if(idx==="mycite") base += 0.5;

      const q = (p.quartile||"").toUpperCase();
      if(q==="Q1") base += 3;
      else if(q==="Q2") base += 2;
      else if(q==="Q3") base += 1;
      else if(q==="Q4") base += 0.5;

      const auth = (p.authorship||"").toLowerCase();
      if(auth.includes("first") || auth.includes("single")) base += 2;

      const st = (p.status||"").toLowerCase();
      if(st==="published") base += 2;
      else if(st==="accepted") base += 1;
      else if(st==="submitted") base += 0.5;

      total += base;
    });
  }

  return total;
}

function scoreAdmin(){
  const a = state.settings.admin;
  let total = 0;

  state.data.adminRoles.forEach(x=>{
    const level = x.level || "Programme";
    const lvlScore = n(a.levelW[level] ?? 0);

    const perMeeting = n(a.perMeeting);
    const perPrep = n(a.perPrepHour);
    const perMonth = n(a.perMonth);

    const meetings = Math.max(0, n(x.meetings));
    const prep = Math.max(0, n(x.prep));
    const months = Math.max(0, n(x.months));

    const bonus = n(a.bonus[x.type] ?? 0);

    total += lvlScore + (meetings*perMeeting) + (prep*perPrep) + (months*perMonth) + bonus;
  });

  return total;
}

function scoreService(){
  const s = state.settings.service;
  let total = 0;
  state.data.service.forEach(x=>{
    const hours = Math.max(0, n(x.hours));
    const pax = Math.max(0, n(x.pax));
    let base = (hours*s.hourW) + ((pax/10)*s.paxW);
    base += (String(x.role).toLowerCase()==="lead") ? s.lead : s.member;
    total += base;
  });
  return total;
}

function classify(index){
  if(index < 40) return { key:"low", label:"Low", desc:"Lower workload range." };
  if(index < 70) return { key:"normal", label:"Normal", desc:"Balanced workload range." };
  if(index < 90) return { key:"high", label:"High", desc:"High busyness. Be cautious with new assignments." };
  return { key:"over", label:"Overload", desc:"Very high. Consider workload redistribution/support." };
}

/* ======================
   Chart
====================== */
let chartObj = null;
function drawChart(T,R,A,S,index){
  const ctx = $("chart").getContext("2d");
  if(chartObj) chartObj.destroy();

  const css = getComputedStyle(document.documentElement);
  const colors = [
    css.getPropertyValue("--a-teaching").trim(),
    css.getPropertyValue("--a-research").trim(),
    css.getPropertyValue("--a-admin").trim(),
    css.getPropertyValue("--a-service").trim(),
    css.getPropertyValue("--a-results").trim()
  ];

  chartObj = new Chart(ctx, {
    type:"bar",
    data:{
      labels:["Teaching (T)","Research (R)","Administration (A)","Service (S)","Overall"],
      datasets:[{ data:[T,R,A,S,index], backgroundColor: colors }]
    },
    options:{
      responsive:true,
      plugins:{ legend:{ display:false } },
      scales:{ y:{ beginAtZero:true } }
    }
  });
}

/* ======================
   Calculate & outputs
====================== */
function calculate(){
  clearErrors();
  syncProfileFromUI();

  if(!validateWeightsStrict()){
    showMsg("warn", "<b>Action required:</b> Fix weights (sum must be exactly 1.00) before calculation.");
    return;
  }
  if(!validateProfileRequired()){
    showMsg("bad", "<b>Missing required profile fields.</b> Please complete all compulsory fields (including valid Staff ID format).");
    return;
  }
  if(!validateTableRows()){
    showMsg("bad", "<b>Missing required activity fields.</b> Please complete all compulsory cells highlighted in red.");
    return;
  }

  const T = scoreTeaching();
  const R = scoreResearch();
  const A = scoreAdmin();
  const S = scoreService();

  const w = state.settings.weights;
  const index = clamp((T*w.T) + (R*w.R) + (A*w.A) + (S*w.S), 0, 100);

  lastCalculatedISO = new Date().toISOString();
  $("auditStamp").textContent = "Calculated: " + lastCalculatedISO;

  $("outT").textContent = T.toFixed(1);
  $("outR").textContent = R.toFixed(1);
  $("outA").textContent = A.toFixed(1);
  $("outS").textContent = S.toFixed(1);
  $("outIndex").textContent = index.toFixed(1);
  $("bigIndex").textContent = index.toFixed(1);

  const cls = classify(index);
  $("zoneTag").className = "tag " + cls.key;
  $("zoneText").textContent = cls.label;
  $("zoneDesc").textContent = cls.desc;

  try{ drawChart(T,R,A,S,index); }catch(e){ console.warn(e); }

  // signature block auto-fill
  const d = new Date();
  $("printDate").value = d.toLocaleDateString("en-GB");
  $("sigStaffName").value = state.profile.name;
  $("sigStaffId").value = state.profile.staffId;
  $("sigFaculty").value = state.profile.faculty;
  $("sigDean").value = state.profile.dean;
  $("sigDeanOffice").value = state.profile.faculty;

  showMsg("ok", "<b>OK:</b> Index updated. You may Export or Print PDF.");
  autosave();
}

/* ======================
   Exports
====================== */
function downloadText(filename, text, mime="text/plain;charset=utf-8"){
  const blob = new Blob([text], {type:mime});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = filename;
  document.body.appendChild(a); a.click(); a.remove();
  setTimeout(()=>URL.revokeObjectURL(url), 500);
}
function quote(x){
  const s = String(x ?? "");
  if(s.includes(",") || s.includes('"') || s.includes("\n")){
    return '"' + s.replaceAll('"','""') + '"';
  }
  return s;
}
function exportSummaryCSV(){
  calculate();
  const T = n($("outT").textContent), R = n($("outR").textContent), A = n($("outA").textContent), S = n($("outS").textContent);
  const index = n($("outIndex").textContent);
  const zone = $("zoneText").textContent;

  const gradeFinal = (state.profile.grade==="Other") ? state.profile.gradeOther : state.profile.grade;
  const statusFinal = (state.profile.status==="Other") ? state.profile.statusOther : state.profile.status;

  const header = [
    "timestamp","period","name","staff_id","programme_dept","grade","appointment_status","faculty","dean",
    "score_T","score_R","score_A","score_S","index_total","zone",
    "count_courses","count_grants","count_effort","count_pubs_included","count_admin","count_service"
  ].join(",");

  const row = [
    lastCalculatedISO || new Date().toISOString(),
    quote(state.profile.period),
    quote(state.profile.name),
    quote(state.profile.staffId),
    quote(state.profile.dept),
    quote(gradeFinal),
    quote(statusFinal),
    quote(state.profile.faculty),
    quote(state.profile.dean),
    T.toFixed(1), R.toFixed(1), A.toFixed(1), S.toFixed(1), index.toFixed(1), quote(zone),
    state.data.courses.length,
    state.data.grants.length,
    state.data.effort.length,
    state.toggles.includePubs ? state.data.pubs.length : 0,
    state.data.adminRoles.length,
    state.data.service.length
  ].join(",");

  downloadText("fst_ums_busyness_summary.csv", header + "\n" + row, "text/csv;charset=utf-8");
}

function exportDetailedCSV(){
  calculate();
  const blocks = [];

  const gradeFinal = (state.profile.grade==="Other") ? state.profile.gradeOther : state.profile.grade;
  const statusFinal = (state.profile.status==="Other") ? state.profile.statusOther : state.profile.status;

  blocks.push("==PROFILE==");
  blocks.push(["timestamp","period","name","staff_id","programme_dept","grade","appointment_status","faculty","dean"].join(","));
  blocks.push([
    lastCalculatedISO || new Date().toISOString(),
    quote(state.profile.period), quote(state.profile.name), quote(state.profile.staffId), quote(state.profile.dept),
    quote(gradeFinal), quote(statusFinal), quote(state.profile.faculty), quote(state.profile.dean)
  ].join(","));

  blocks.push("\n==COURSES==");
  blocks.push(["level","code","name","credit","students","lec","tut","lab","field","contact_hours"].join(","));
  state.data.courses.forEach(c=>{
    blocks.push([
      quote(c.level), quote(c.code), quote(c.name), n(c.credit), n(c.students), n(c.lec), n(c.tut), n(c.lab), n(c.field), contactHours(c)
    ].join(","));
  });

  blocks.push("\n==GRANTS==");
  blocks.push(["code","title","level","role","status","amount_rm","duration_months"].join(","));
  state.data.grants.forEach(g=>{
    blocks.push([quote(g.code),quote(g.title),quote(g.level),quote(g.role),quote(g.status),n(g.amount),n(g.months)].join(","));
  });

  blocks.push("\n==RESEARCH_EFFORT==");
  blocks.push(["type","description","hours"].join(","));
  state.data.effort.forEach(e=>{
    blocks.push([quote(e.type),quote(e.desc),n(e.hours)].join(","));
  });

  if(state.toggles.includePubs){
    blocks.push("\n==PUBLICATIONS==");
    blocks.push(["year","title","index","quartile","authorship","status"].join(","));
    state.data.pubs.forEach(p=>{
      blocks.push([quote(p.year),quote(p.title),quote(p.index),quote(p.quartile),quote(p.authorship),quote(p.status)].join(","));
    });
  }

  blocks.push("\n==ADMIN_APPOINTMENTS==");
  blocks.push(["role","type","level","meetings","prep_hours","duration_months"].join(","));
  state.data.adminRoles.forEach(a=>{
    blocks.push([quote(a.role),quote(a.type),quote(a.level),n(a.meetings),n(a.prep),n(a.months)].join(","));
  });

  blocks.push("\n==SERVICE==");
  blocks.push(["activity","role","hours","participants"].join(","));
  state.data.service.forEach(s=>{
    blocks.push([quote(s.activity),quote(s.role),n(s.hours),n(s.pax)].join(","));
  });

  downloadText("fst_ums_busyness_detailed.csv", blocks.join("\n"), "text/csv;charset=utf-8");
}

function exportJSON(){
  calculate();
  const gradeFinal = (state.profile.grade==="Other") ? state.profile.gradeOther : state.profile.grade;
  const statusFinal = (state.profile.status==="Other") ? state.profile.statusOther : state.profile.status;

  const payload = {
    metadata: { exported_at: new Date().toISOString(), calculated_at: lastCalculatedISO || null, version:"v3", system:"FST UMS Staff Busyness Index" },
    profile: { ...state.profile, grade_final: gradeFinal, status_final: statusFinal },
    toggles: state.toggles,
    settings: state.settings,
    data: state.data,
    results: {
      T: n($("outT").textContent),
      R: n($("outR").textContent),
      A: n($("outA").textContent),
      S: n($("outS").textContent),
      index: n($("outIndex").textContent),
      zone: $("zoneText").textContent
    }
  };
  downloadText("fst_ums_busyness_full.json", JSON.stringify(payload, null, 2), "application/json;charset=utf-8");
}

/* ======================
   Admin lock + mode
====================== */
function setSettingsLocked(locked){
  const ids = [
    "preset","wT","wR","wA","wS","tCreditW","tStudentW","tHourW","tPgMult",
    "rPI","rCo","rMem","rEffortW",
    "aProg","aFac","aUni","aState","aNat","aInt","aInd","aMeetW","aPrepW","aMonthW","aOfficialB","aConfB",
    "sHourW","sPaxW","sLead","sMember"
  ];
  ids.forEach(id=>{
    const e = $(id);
    if(!e) return;
    if(id==="preset") e.disabled = locked;
    else e.readOnly = locked;
    if(e.tagName==="SELECT") e.disabled = locked;
  });

  $("lockText").textContent = locked ? "Locked" : "Unlocked (Admin)";
  $("lockDot").style.background = locked ? "var(--warn)" : "var(--ok)";
}

function adminUnlock(){
  const pw = $("adminPw").value || "";
  if(pw === ADMIN_PASSWORD){
    isAdminUnlocked = true;
    setSettingsLocked(false);
    showMsg("ok", "<b>Admin unlocked:</b> Settings can now be edited on this browser.");
    autosave();
  } else {
    showMsg("bad", "<b>Admin unlock failed:</b> Incorrect password.");
  }
}

function toggleMode(){
  isManagementView = !isManagementView;
  $("roleText").textContent = isManagementView ? "Management View" : "Staff Mode";
  $("roleDot").style.background = isManagementView ? "var(--warn)" : "var(--ok)";
  $("btnToggleMode").textContent = isManagementView ? "Switch to Staff Mode" : "Switch to Management View";

  // hide settings for management
  $("secSettings").style.display = isManagementView ? "none" : "block";

  // read-only for management view (profile + activities)
  const ro = isManagementView;
  ["pName","pStaffId","pDept","pGrade","pStatus","pPeriod","pFaculty","pDean","pGradeOther","pStatusOther"].forEach(id=>{
    const e = $(id); if(!e) return;
    if(e.tagName==="SELECT") e.disabled = ro;
    else e.readOnly = ro;
  });
  document.querySelectorAll("#secTeaching input, #secTeaching select, #secResearch input, #secResearch select, #secAdmin input, #secAdmin select, #secService input, #secService select")
    .forEach(e=>{ if(e.tagName==="SELECT") e.disabled = ro; else e.readOnly = ro; });

  // hide add/clear buttons in management view
  ["addCourse","clearCourse","addGrant","clearGrant","addEffort","clearEffort","addAdmin","clearAdmin","addService","clearService","addPub","clearPub"].forEach(id=>{
    const b=$(id); if(b) b.style.display = ro ? "none" : "inline-flex";
  });

  $("btnAdminUnlock").style.display = ro ? "none" : "inline-flex";
  showMsg("ok", ro
    ? "<b>Management View:</b> Settings hidden. Import JSON to review staff record (read-only)."
    : "<b>Staff Mode:</b> Fill activities, then Calculate at the bottom."
  );
}

/* ======================
   Save/Load/Import
====================== */
function autosave(){
  syncProfileFromUI();
  if(isAdminUnlocked) syncSettingsFromUI();
  localStorage.setItem(LS_KEY, JSON.stringify({ state, lastCalculatedISO, isAdminUnlocked }));
}
function loadLocal(){
  const raw = localStorage.getItem(LS_KEY);
  if(!raw) return false;
  try{
    const obj = JSON.parse(raw);
    if(obj?.state){
      Object.assign(state.profile, obj.state.profile || {});
      Object.assign(state.settings, obj.state.settings || {});
      Object.assign(state.toggles, obj.state.toggles || {});
      Object.assign(state.data, obj.state.data || {});
      lastCalculatedISO = obj.lastCalculatedISO || "";
      isAdminUnlocked = !!obj.isAdminUnlocked;
      syncUIFromProfile();
      syncUIFromSettings();
      $("pubToggle").checked = !!state.toggles.includePubs;
      updatePubToggleUI();
      renderAll();
      setSettingsLocked(!isAdminUnlocked);
      return true;
    }
  }catch{}
  return false;
}
function resetAll(){
  if(!confirm("Reset all data and settings?")) return;
  localStorage.removeItem(LS_KEY);
  location.reload();
}
function importJSONFile(file){
  const reader = new FileReader();
  reader.onload = ()=>{
    try{
      const obj = JSON.parse(reader.result);
      if(obj?.profile && obj?.settings && obj?.data){
        Object.assign(state.profile, obj.profile || {});
        Object.assign(state.settings, obj.settings || {});
        Object.assign(state.toggles, obj.toggles || {});
        Object.assign(state.data, obj.data || {});
        lastCalculatedISO = obj.metadata?.calculated_at || "";
      } else {
        throw new Error("Invalid format");
      }

      syncUIFromProfile();
      syncUIFromSettings();
      $("pubToggle").checked = !!state.toggles.includePubs;
      updatePubToggleUI();
      renderAll();

      if(!isManagementView) toggleMode();
      calculate();
      showMsg("ok", "<b>Imported:</b> Staff JSON loaded (Management View).");
    } catch(e){
      console.error(e);
      showMsg("bad", "<b>Error:</b> Unable to import JSON. Please import JSON exported from this system.");
    }
  };
  reader.readAsText(file);
}

/* ======================
   Pub toggle
====================== */
function updatePubToggleUI(){
  state.toggles.includePubs = $("pubToggle").checked;
  $("pubWrap").style.display = state.toggles.includePubs ? "block" : "none";
  if(state.toggles.includePubs && state.data.pubs.length===0){
    state.data.pubs.push({ id:uid(), year:"", title:"", index:"Scopus", quartile:"Q1", authorship:"First/Corresponding", status:"Published" });
  }
  renderAll();
  autosave();
}

/* ======================
   Presets (Admin only)
====================== */
function applyPreset(p){
  if(!isAdminUnlocked) return;

  if(p==="lecturer"){
    state.settings.weights = { T:0.55, R:0.20, A:0.15, S:0.10 };
  } else if(p==="senior"){
    state.settings.weights = { T:0.45, R:0.30, A:0.15, S:0.10 };
  } else if(p==="assoc"){
    state.settings.weights = { T:0.35, R:0.40, A:0.15, S:0.10 };
  } else if(p==="prof"){
    state.settings.weights = { T:0.25, R:0.50, A:0.15, S:0.10 };
  }
  syncUIFromSettings();
  autosave();
  showMsg("ok", `<b>Preset applied:</b> ${p}.`);
}

/* ======================
   Buttons
====================== */
function addRow(kind){
  if(kind==="course") state.data.courses.push({ id:uid(), level:"UG", code:"", name:"", credit:0, students:0, lec:0, tut:0, lab:0, field:0 });
  if(kind==="grant") state.data.grants.push({ id:uid(), code:"", title:"", level:"University", role:"PI", status:"Active", amount:0, months:0 });
  if(kind==="effort") state.data.effort.push({ id:uid(), type:"Supervision", desc:"", hours:0 });
  if(kind==="pub") state.data.pubs.push({ id:uid(), year:"", title:"", index:"Scopus", quartile:"Q1", authorship:"First/Corresponding", status:"Published" });
  if(kind==="admin") state.data.adminRoles.push({ id:uid(), role:"", type:"Official", level:"Programme", meetings:0, prep:0, months:0 });
  if(kind==="service") state.data.service.push({ id:uid(), activity:"", role:"Lead", hours:0, pax:0 });
  renderAll(); autosave();
}
function clearKind(kind){
  if(!confirm("Clear this section?")) return;
  if(kind==="course") state.data.courses = [];
  if(kind==="grant") state.data.grants = [];
  if(kind==="effort") state.data.effort = [];
  if(kind==="pub") state.data.pubs = [];
  if(kind==="admin") state.data.adminRoles = [];
  if(kind==="service") state.data.service = [];
  ensureSeed();
  renderAll(); autosave();
}

/* ======================
   Scaffolding / init
====================== */
function init(){
  $("yearNow").textContent = String(new Date().getFullYear());

  ensureSeed();
  renderAll();

  // other fields
  bindOther("pGrade","pGradeOtherWrap","pGradeOther");
  bindOther("pStatus","pStatusOtherWrap","pStatusOther");

  // pub toggle
  $("pubToggle").addEventListener("change", updatePubToggleUI);
  updatePubToggleUI();

  // load local
  loadLocal();

  // lock settings by default
  setSettingsLocked(!isAdminUnlocked);
  $("lockDot").style.background = !isAdminUnlocked ? "var(--warn)" : "var(--ok)";
  $("lockText").textContent = !isAdminUnlocked ? "Locked" : "Unlocked (Admin)";

  // settings change (admin only)
  document.querySelectorAll("#secSettings input, #secSettings select").forEach(e=>{
    e.addEventListener("input", ()=>{
      if(!isAdminUnlocked) return;
      if(e.id==="preset") applyPreset(e.value);
      else autosave();
    });
  });

  // profile autosave
  ["pName","pStaffId","pDept","pPeriod","pFaculty","pDean","pGrade","pStatus","pGradeOther","pStatusOther"].forEach(id=>{
    $(id).addEventListener("input", ()=>autosave());
  });

  // buttons
  $("btnAdminUnlock").addEventListener("click",(e)=>{ e.preventDefault(); adminUnlock(); });
  $("btnToggleMode").addEventListener("click",(e)=>{ e.preventDefault(); toggleMode(); });

  $("btnSaveLocal").addEventListener("click",(e)=>{ e.preventDefault(); autosave(); showMsg("ok","<b>Saved:</b> Stored locally in this browser."); });
  $("btnLoadLocal").addEventListener("click",(e)=>{ e.preventDefault(); if(loadLocal()) showMsg("ok","<b>Loaded:</b> Local saved data loaded."); else showMsg("warn","<b>No saved data</b> found."); });
  $("btnResetAll").addEventListener("click",(e)=>{ e.preventDefault(); resetAll(); });

  $("addCourse").addEventListener("click",(e)=>{ e.preventDefault(); addRow("course"); });
  $("clearCourse").addEventListener("click",(e)=>{ e.preventDefault(); clearKind("course"); });

  $("addGrant").addEventListener("click",(e)=>{ e.preventDefault(); addRow("grant"); });
  $("clearGrant").addEventListener("click",(e)=>{ e.preventDefault(); clearKind("grant"); });

  $("addEffort").addEventListener("click",(e)=>{ e.preventDefault(); addRow("effort"); });
  $("clearEffort").addEventListener("click",(e)=>{ e.preventDefault(); clearKind("effort"); });

  const addPubBtn = $("addPub"); const clearPubBtn = $("clearPub");
  if(addPubBtn) addPubBtn.addEventListener("click",(e)=>{ e.preventDefault(); addRow("pub"); });
  if(clearPubBtn) clearPubBtn.addEventListener("click",(e)=>{ e.preventDefault(); clearKind("pub"); });

  $("addAdmin").addEventListener("click",(e)=>{ e.preventDefault(); addRow("admin"); });
  $("clearAdmin").addEventListener("click",(e)=>{ e.preventDefault(); clearKind("admin"); });

  $("addService").addEventListener("click",(e)=>{ e.preventDefault(); addRow("service"); });
  $("clearService").addEventListener("click",(e)=>{ e.preventDefault(); clearKind("service"); });

  $("btnCalculate").addEventListener("click",(e)=>{ e.preventDefault(); calculate(); });
  $("btnPrint").addEventListener("click",(e)=>{ e.preventDefault(); calculate(); window.print(); });

  $("btnExportSummaryCSV").addEventListener("click",(e)=>{ e.preventDefault(); exportSummaryCSV(); });
  $("btnExportDetailedCSV").addEventListener("click",(e)=>{ e.preventDefault(); exportDetailedCSV(); });
  $("btnExportJSON").addEventListener("click",(e)=>{ e.preventDefault(); exportJSON(); });

  $("jsonImport").addEventListener("change",(e)=>{
    const f = e.target.files?.[0];
    if(f) importJSONFile(f);
    e.target.value = "";
  });

  // initial signature fields
  $("printDate").value = new Date().toLocaleDateString("en-GB");
}
init();
</script>
</body>
</html>
