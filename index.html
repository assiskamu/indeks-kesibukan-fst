<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>FST UMS – Staff Busyness Index (Calculator)</title>

  <!-- =========================================================
       ADVANCED SETTINGS PASSPHRASE (EDIT HERE)
       Change this anytime to update local settings access.
       NOTE: This is front-end only (GitHub Pages static).
       ========================================================= -->
  <script>
    const ADMIN_PASSWORD = "FST-ADMIN-2025";  // <-- EDIT PASSWORD HERE
  </script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- jsPDF for manual PDF -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    :root{
      /* Web theme (professional dark). Print will override to B/W + gray. */
      --bg:#0b1220;
      --surface:#101a2d;
      --surface-2:#141f36;
      --border:rgba(255,255,255,.12);
      --shadow: 0 18px 60px rgba(0,0,0,.45);
      --radius: 18px;

      --text:#eaf0ff;
      --muted:#b8c3e6;

      --primary:#4cc7ff;
      --accent:#2bd4bf;
      --danger:#ff5b6e;
      --warn:#ffb020;

      --t:#7c9dff;
      --sv:#3cc9ff;
      --r:#32d29c;
      --p:#f094c4;
      --a:#f2b44a;
      --s:#fb8898;
      --l:#43d389;
      --set:#60a5fa;

      /* ONE font family everywhere (web + print + manual). */
      --font: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial, "Noto Sans", "Liberation Sans", sans-serif;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: var(--font);
      background:
        radial-gradient(1200px 700px at 20% 5%, rgba(96,165,250,.18), transparent 55%),
        radial-gradient(1000px 650px at 80% 10%, rgba(244,114,182,.14), transparent 60%),
        radial-gradient(900px 650px at 70% 80%, rgba(45,212,191,.12), transparent 55%),
        linear-gradient(180deg, #070b15, #0b1220 45%, #070b15);
      color:var(--text);
      -webkit-text-size-adjust: 100%;
      text-rendering: optimizeLegibility;
    }

    .wrap{max-width:1180px;margin:0 auto;padding:22px 18px 80px}

    /* =========================
       Top bar (mobile-friendly)
    ========================= */
    .topbar{
      display:flex;align-items:center;justify-content:space-between;gap:14px;
      padding:14px 16px;border:1px solid var(--border);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      position:sticky;top:10px;z-index:20;
      backdrop-filter: blur(10px);
    }
    .brand{display:flex;align-items:center;gap:14px;min-width:0}
    .logoBox{
      width:120px;height:72px;
      border-radius:14px;
      background:#ffffff;
      overflow:hidden;
      display:flex;align-items:center;justify-content:center;
      border:none;
      box-shadow:none;
      padding:8px;
      flex: 0 0 auto;
    }
    .logoBox img{width:100%;height:100%;object-fit:contain}

    .title{display:flex;flex-direction:column;gap:2px;min-width:0}
    .title h1{
      font-size:16px;margin:0;letter-spacing:.2px;
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
      max-width: 520px;
    }
    .title .sub{
      font-size:12px;color:var(--muted);
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
      max-width: 520px;
    }
    .title-actions{display:flex;align-items:center;gap:8px;flex-wrap:wrap}

    .top-actions{display:flex;flex-wrap:wrap;gap:8px;align-items:center;justify-content:flex-end}

    .btn{
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      color:var(--text);
      padding:10px 14px;border-radius:12px;
      cursor:pointer; font-weight:650;
      transition: transform .08s ease, background .2s ease, border .2s ease;
      user-select:none;
      font-family: var(--font);
      display:inline-flex;align-items:center;gap:8px;
    }
    .btn:hover{background:rgba(255,255,255,.10)}
    .btn:active{transform: translateY(1px)}
    .btn-primary{
      background:linear-gradient(180deg, rgba(76,199,255,.45), rgba(76,199,255,.18));
      border-color: rgba(76,199,255,.65);
      color:#041521;
    }
    .btn-secondary{background:rgba(255,255,255,.08)}
    .btn-ghost{background:transparent}
    .btn-danger{
      background:linear-gradient(180deg, rgba(255,91,110,.35), rgba(255,91,110,.14));
      border-color: rgba(255,91,110,.55);
    }
    .btn-warn{
      background:linear-gradient(180deg, rgba(255,176,32,.38), rgba(255,176,32,.16));
      border-color: rgba(255,176,32,.55);
    }
    .btn-sm{padding:6px 10px;border-radius:10px;font-size:.82rem}
    .btn-md{padding:12px 18px;border-radius:14px;font-size:.95rem}
    .btn-icon{padding:6px 8px;min-width:36px;justify-content:center}
    .btn-icon svg{width:16px;height:16px;fill:currentColor}

    .pill{
      padding:8px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.05);
      color:var(--muted);
      font-size:12px;
      font-family: var(--font);
    }
    .pill strong{color:var(--text)}

    .badge{
      display:inline-flex;align-items:center;gap:8px;
      padding:6px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      font-size:12px;color:var(--muted);
      font-family: var(--font);
    }
    .dot{width:9px;height:9px;border-radius:99px;background:var(--accent);box-shadow:0 0 0 4px rgba(45,212,191,.15)}
    .dot.lock{background:var(--warn);box-shadow:0 0 0 4px rgba(255,176,32,.15)}

    /* =========================
       Sections
    ========================= */
    .section{
      margin-top:16px;
      border:1px solid rgba(255,255,255,.10);
      border-radius: var(--radius);
      overflow:hidden;
      box-shadow: var(--shadow);
    }
    .section header{
      display:flex;gap:10px;align-items:flex-start;justify-content:space-between;
      padding:16px 18px;
      border-bottom:1px solid rgba(255,255,255,.10);
    }
    .section h2{margin:0;font-size:15px;letter-spacing:.2px;font-family:var(--font)}
    .section .sub{margin-top:4px;color:var(--muted);font-size:12px;max-width:920px;font-family:var(--font)}
    .content{padding:16px 18px}

    /* Strong section backgrounds (web only) */
    .profile{
      background:
        radial-gradient(900px 520px at 18% 10%, rgba(96,165,250,.46) 0%, rgba(96,165,250,0) 58%),
        linear-gradient(180deg, rgba(96,165,250,.22), rgba(255,255,255,.03));
    }
    .toggles{
      background:
        radial-gradient(900px 520px at 18% 10%, rgba(167,139,250,.46) 0%, rgba(167,139,250,0) 58%),
        linear-gradient(180deg, rgba(167,139,250,.22), rgba(255,255,255,.03));
    }
    .settings{
      background:
        radial-gradient(900px 520px at 18% 10%, rgba(96,165,250,.44) 0%, rgba(96,165,250,0) 58%),
        linear-gradient(180deg, rgba(96,165,250,.20), rgba(255,255,255,.03));
    }
    .teaching{
      background:
        radial-gradient(900px 520px at 18% 10%, rgba(167,139,250,.48) 0%, rgba(167,139,250,0) 60%),
        linear-gradient(180deg, rgba(167,139,250,.22), rgba(255,255,255,.03));
    }
    .supervision{
      background:
        radial-gradient(900px 520px at 18% 10%, rgba(56,189,248,.48) 0%, rgba(56,189,248,0) 60%),
        linear-gradient(180deg, rgba(56,189,248,.22), rgba(255,255,255,.03));
    }
    .research{
      background:
        radial-gradient(900px 520px at 18% 10%, rgba(52,211,153,.46) 0%, rgba(52,211,153,0) 60%),
        linear-gradient(180deg, rgba(52,211,153,.20), rgba(255,255,255,.03));
    }
    .publication{
      background:
        radial-gradient(900px 520px at 18% 10%, rgba(244,114,182,.46) 0%, rgba(244,114,182,0) 60%),
        linear-gradient(180deg, rgba(244,114,182,.20), rgba(255,255,255,.03));
    }
    .admin{
      background:
        radial-gradient(900px 520px at 18% 10%, rgba(251,191,36,.48) 0%, rgba(251,191,36,0) 60%),
        linear-gradient(180deg, rgba(251,191,36,.18), rgba(255,255,255,.03));
    }
    .service{
      background:
        radial-gradient(900px 520px at 18% 10%, rgba(251,113,133,.48) 0%, rgba(251,113,133,0) 60%),
        linear-gradient(180deg, rgba(251,113,133,.18), rgba(255,255,255,.03));
    }
    .labops{
      background:
        radial-gradient(900px 520px at 18% 10%, rgba(34,197,94,.48) 0%, rgba(34,197,94,0) 60%),
        linear-gradient(180deg, rgba(34,197,94,.18), rgba(255,255,255,.03));
    }
    .results{
      background:
        radial-gradient(900px 520px at 18% 10%, rgba(45,212,191,.48) 0%, rgba(45,212,191,0) 60%),
        linear-gradient(180deg, rgba(45,212,191,.18), rgba(255,255,255,.03));
    }
    .prosch{
      background:
        radial-gradient(900px 520px at 18% 10%, rgba(160,160,160,.34) 0%, rgba(160,160,160,0) 60%),
        linear-gradient(180deg, rgba(180,180,180,.12), rgba(255,255,255,.03));
    }

    /* =========================
       Layout grids
    ========================= */
    .grid{display:grid;gap:12px}
    .grid.two{grid-template-columns:repeat(2, minmax(0,1fr))}
    .grid.three{grid-template-columns:repeat(3, minmax(0,1fr))}

    /* =========================
       Form controls
    ========================= */
    label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px;font-family:var(--font)}
    input,select,textarea{
      width:100%;
      background:rgba(7,11,21,.55);
      border:1px solid rgba(255,255,255,.14);
      color:var(--text);
      border-radius:12px;
      padding:10px 10px;
      outline:none;
      font-family: var(--font);
      font-size: 14px;
      line-height: 1.25;
    }
    input:focus,select:focus,textarea:focus{border-color:rgba(76,199,255,.8);box-shadow:0 0 0 3px rgba(76,199,255,.2)}
    input:focus-visible,select:focus-visible,textarea:focus-visible,button:focus-visible{
      outline:3px solid rgba(76,199,255,.85);
      outline-offset:2px;
    }
    textarea{
      min-height:70px;
      resize:vertical;
      overflow:hidden; /* enables auto-grow without scrollbars */
    }
    input.err, select.err, textarea.err{border-color: rgba(255,91,110,.85) !important; box-shadow: 0 0 0 3px rgba(255,91,110,.18)}
    .hint{font-size:12px;color:var(--muted);margin-top:6px;font-family:var(--font)}
    .requiredMark::after{content:" *"; color: var(--warn); font-weight:800}

    /* =========================
       Tables: responsive
    ========================= */
    .tableWrap{
      width:100%;
      overflow-x:auto;
      -webkit-overflow-scrolling: touch;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.1);
      background:rgba(8,14,28,.35);
    }
    table{width:100%;border-collapse:collapse;min-width:0}
    th,td{
      border-bottom:1px solid rgba(255,255,255,.10);
      padding:10px 8px;
      vertical-align:top;
      font-family:var(--font);
      min-width:0;
    }
    th{font-size:12px;color:var(--muted);text-align:left}
    td input, td select, td textarea{
      padding:8px 8px;
      border-radius:10px;
      width:100%;
      max-width:100%;
    }

    /* allow long text inside table cells */
    td .cellText{
      white-space:pre-wrap;
      word-break:break-word;
      overflow-wrap:anywhere;
    }

    @media (max-width:980px){
      .tableWrap{overflow:visible}
      table thead{display:none}
      table tbody tr{
        display:block;
        margin:12px;
        border:1px solid rgba(255,255,255,.12);
        border-radius:14px;
        padding:8px 12px;
        background:rgba(12,18,35,.8);
      }
      table tbody tr td{
        display:flex;
        align-items:center;
        justify-content:space-between;
        gap:12px;
        border:none;
        padding:6px 0;
      }
      table tbody tr td::before{
        content:attr(data-label);
        color:var(--muted);
        font-weight:600;
        width:42%;
      }
      table tbody tr td input,
      table tbody tr td select,
      table tbody tr td textarea{
        width:58%;
      }
      table tbody tr td.cell-actions::before{display:none}
    }

    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .row.right{justify-content:flex-end}

    .notice{
      padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);color:var(--muted);font-size:12px;
      font-family:var(--font);
      white-space: normal;
      overflow-wrap:anywhere;
      word-break:break-word;
    }
    .notice.bad{border-color: rgba(255,91,110,.55); background: rgba(255,91,110,.10); color:#ffd9de}
    .notice.warn{border-color: rgba(255,176,32,.55); background: rgba(255,176,32,.10); color:#ffe9c2}
    .notice.ok{border-color: rgba(45,212,191,.55); background: rgba(45,212,191,.10); color:#d9fffb}

    .kpi{
      display:grid;gap:10px;
      grid-template-columns:repeat(4, minmax(0,1fr));
    }
    .box{
      border:1px solid rgba(255,255,255,.12);
      background:rgba(7,11,21,.40);
      border-radius:14px;
      padding:12px;
      font-family:var(--font);
      min-width: 0;
    }
    .box .k{font-size:12px;color:var(--muted)}
    .box .v{font-size:20px;font-weight:900;margin-top:4px}
    .box .s{font-size:12px;color:var(--muted);margin-top:4px}

    /* Narrative / summary boxes: ensure wrap (web + print) */
    .wrapText{
      white-space: pre-wrap;
      overflow-wrap:anywhere;
      word-break:break-word;
    }

    .footer{
      margin-top:18px;
      color:rgba(255,255,255,.55);
      font-size:12px;text-align:center;
      font-family:var(--font)
    }
    .spacer{height:10px}

    .icon-btn{
      border:1px solid rgba(255,255,255,.2);
      background:rgba(255,255,255,.08);
      color:var(--text);
      width:34px;height:34px;border-radius:10px;
      display:inline-flex;align-items:center;justify-content:center;
      cursor:pointer;
    }
    .icon-btn svg{width:16px;height:16px;fill:currentColor}

    .dropdown{position:relative;display:inline-flex}
    .dropdown-menu{
      position:absolute;right:0;top:calc(100% + 8px);
      background:var(--surface-2);
      border:1px solid rgba(255,255,255,.14);
      border-radius:12px;
      padding:8px;
      min-width:220px;
      box-shadow:var(--shadow);
      display:none;
      z-index:30;
    }
    .dropdown-menu.open{display:block}
    .dropdown-menu button{
      width:100%;justify-content:flex-start;border-radius:10px;
    }

    /* Admin panel */
    .adminPanel{
      display:flex;gap:8px;align-items:center;flex-wrap:wrap;
    }
    .adminPanel input{
      width:220px;
      background:rgba(7,11,21,.65);
    }
    .adminPanel .small{flex-basis:100%}
    .small{font-size:12px;color:var(--muted);font-family:var(--font)}

    /* =========================
       RESPONSIVE (Phone/Tablet)
    ========================= */
    @media(max-width:980px){
      .wrap{padding:14px 12px 70px}
      .topbar{position:relative;top:auto;flex-direction:column;align-items:stretch;gap:12px}
      .brand{width:100%}
      .logoBox{width:110px;height:66px}
      .title h1,.title .sub{max-width: 100%}
      .top-actions{justify-content:flex-start}
      .grid.two,.grid.three{grid-template-columns:1fr}
      .kpi{grid-template-columns:repeat(2, minmax(0,1fr))}
      .btn{padding:12px 12px}
    }
    @media(max-width:520px){
      .kpi{grid-template-columns:1fr}
      .logoBox{width:104px;height:62px}
      .btn{width:100%}
      .adminPanel{width:100%}
      .adminPanel input{width:100%}
      .pill,.badge{width:100%;justify-content:center}
    }

    /* =========================
       PRINT (Professional B/W + Gray)
    ========================= */
    .printOnly{display:none}
    @media print{
      @page { margin: 14mm; }

      body{
        background:#fff !important;
        color:#000 !important;
        font-family: var(--font) !important;
      }

      /* Force all text to print in black for readability */
      *, *::before, *::after{
        color:#000 !important;
        text-shadow:none !important;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
      }
      input::placeholder, textarea::placeholder{
        color:#000 !important;
      }

      /* Hide web controls */
      .topbar,.noPrint,#secSettings,#secToggles{display:none !important}

      .wrap{max-width: 100% !important; padding:0 !important}

      /* Sections look like official forms */
      .section{
        box-shadow:none !important;
        border:1px solid #444 !important;
        border-radius: 8px !important;
        margin-top: 10px !important;
        background:#fff !important;
      }
      .section header{
        background:#e9e9e9 !important;
        color:#000 !important;
        border-bottom:1px solid #444 !important;
        padding:10px 12px !important;
      }
      .section h2{font-size: 12pt !important}
      .section .sub{color:#111 !important; font-size: 10pt !important}

      .content{padding:10px 12px !important}

      /* Inputs appear like form fields */
      input,select,textarea{
        color:#000 !important;
        background:#fff !important;
        border:1px solid #000 !important;
        border-radius: 6px !important;
      }

      /* KPI boxes */
      .box{
        border:1px solid #000 !important;
        background:#fff !important;
        border-radius: 8px !important;
      }
      .box .k,.box .s{color:#111 !important}
      .box .v{color:#000 !important}

      /* Tables: B/W */
      .tableWrap{overflow:visible !important}
      table{min-width: 0 !important; width:100% !important}
      th,td{
        border-bottom:1px solid #000 !important;
        color:#000 !important;
      }
      th{
        background:#efefef !important;
        border-top:1px solid #000 !important;
      }

      /* Force wrapping everywhere important */
      .wrapText, .notice, .hint, .sub, td, th, div, span{
        white-space: normal !important;
        overflow-wrap:anywhere !important;
        word-break:break-word !important;
      }

      .printOnly{display:block !important}
      canvas{max-width:100% !important; height:auto !important}
    }
  </style>
</head>

<body>
<div class="wrap">

  <div class="topbar">
    <div class="brand">
      <div class="logoBox" title="Place 'UMS logo.png' in the same folder as index.html">
        <img id="umsLogo" src="UMS logo.png" alt="UMS logo"
             onerror="this.style.display='none'; this.parentElement.innerHTML='<div style=&quot;color:#111;font-weight:800;font-size:12px;text-align:center;line-height:1.1&quot;>UMS<br>LOGO</div>';">
      </div>
      <div class="title">
        <h1>FST UMS – Staff Busyness Index Calculator</h1>
        <div class="sub">Single-file, local-only tool for workload recording and reporting. Advanced settings are for local configuration only (no security control).</div>
        <div class="title-actions noPrint">
          <span class="small">Need help?</span>
          <button class="icon-btn" id="btnManual" aria-label="Download user guide (PDF)" title="Download user guide (PDF)">
            <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 2a10 10 0 1 0 10 10A10.01 10.01 0 0 0 12 2Zm.02 17a1.25 1.25 0 1 1 1.23-1.25A1.24 1.24 0 0 1 12.02 19Zm2.2-7.43-.86.88a2.33 2.33 0 0 0-.74 1.76v.29h-1.5v-.41a3.4 3.4 0 0 1 .93-2.36l1.07-1.09a1.48 1.48 0 0 0-.25-2.4 1.67 1.67 0 0 0-2.2.49 1.93 1.93 0 0 0-.32.86H8.85a3.17 3.17 0 0 1 .57-1.69A3.15 3.15 0 0 1 13.7 6.8a3.03 3.03 0 0 1 .46 4.77Z"/></svg>
          </button>
        </div>
      </div>
    </div>

    <div class="top-actions noPrint">
      <span class="pill">Mode: <strong id="modeText">Staff</strong></span>
      <span class="badge"><span id="lockDot" class="dot lock"></span><span id="lockText">Settings locked</span></span>

      <div class="adminPanel">
        <input type="password" id="adminPass" placeholder="Advanced Settings (Local) passphrase">
        <button class="btn btn-warn btn-sm" id="btnAdminUnlock"><span class="btn-label">Enable Settings</span></button>
        <button class="btn btn-ghost btn-sm" id="btnAdminLock" style="display:none;"><span class="btn-label">Disable</span></button>
        <div class="small">Local configuration only — not a security control.</div>
      </div>

      <button class="btn btn-secondary" id="btnSaveLocal"><span class="btn-label">Save</span></button>
      <button class="btn btn-danger" id="btnReset"><span class="btn-label">Reset</span></button>
    </div>
  </div>

  <!-- PROFILE -->
  <section class="section profile" id="secProfile">
    <header>
      <div>
        <h2>Staff Profile</h2>
        <div class="sub">All fields are required. Example Staff ID: <b>250505-02025</b>.</div>
      </div>
    </header>
    <div class="content">
      <div class="grid three">
        <div>
          <label class="requiredMark">Full Name</label>
          <input id="pName" placeholder="e.g., Dr. Amina Yusuf"/>
        </div>
        <div>
          <label class="requiredMark">Staff ID</label>
          <input id="pStaffId" placeholder="e.g., 250505-02025"/>
        </div>
        <div>
          <label class="requiredMark">Staff Category</label>
          <select id="pCategory">
            <option value="">Select</option>
            <option value="Academic">Academic</option>
            <option value="Administrative">Administrative</option>
            <option value="Laboratory">Laboratory</option>
          </select>
          <div class="hint">Selecting a category auto-applies section ON/OFF states and default weights.</div>
        </div>

        <div>
          <label class="requiredMark">School/Unit</label>
          <input id="pUnit" placeholder="e.g., Mathematics with Economics / Finance Unit / Chemistry Lab"/>
        </div>

        <div>
          <label class="requiredMark">Grade</label>
          <select id="pGrade">
            <option value="">Select</option>
            <option>Lecturer</option>
            <option>Senior Lecturer</option>
            <option>Associate Professor</option>
            <option>Professor</option>
            <option>Lab Officer</option>
            <option>Assistant Science Officer</option>
            <option>Administrative Officer</option>
            <option>Others</option>
          </select>
        </div>
        <div id="pGradeOtherWrap" style="display:none;">
          <label class="requiredMark">Other grade (specify)</label>
          <input id="pGradeOther" placeholder="Type the grade"/>
        </div>

        <div>
          <label class="requiredMark">Employment Status</label>
          <select id="pStatus">
            <option value="">Select</option>
            <option>Permanent</option>
            <option>Contract</option>
            <option>Part-time</option>
            <option>Others</option>
          </select>
        </div>
        <div id="pStatusOtherWrap" style="display:none;">
          <label class="requiredMark">Other status (specify)</label>
          <input id="pStatusOther" placeholder="Type the status"/>
        </div>

        <div>
          <label class="requiredMark">Reporting Period</label>
          <select id="pPeriod">
            <option value="">Select</option>
            <option value="Monthly">Monthly</option>
            <option value="Quarterly">Quarterly</option>
            <option value="Semester">Semester</option>
            <option value="Annual">Annual</option>
          </select>
      <div class="hint">All scores are normalized to <b>points per month</b> for fair comparisons.</div>
        </div>
      </div>

      <div class="spacer"></div>
      <div id="msgProfile" class="notice warn" style="display:none;"></div>
    </div>
  </section>

  <!-- TOGGLES -->
  <section class="section toggles" id="secToggles">
    <header>
      <div>
        <h2>Section Applicability (On/Off)</h2>
        <div class="sub">
          Turn on only relevant sections. The calculator will <b>re-normalize weights</b> using active sections only.
          This supports Academic, Administrative, and Laboratory roles fairly.
        </div>
      </div>
      <div class="row right noPrint">
        <span class="pill">Auto from Category</span>
      </div>
    </header>
    <div class="content">
      <div class="grid three">
        <div><label><input type="checkbox" id="enTeaching" checked> Teaching</label></div>
        <div><label><input type="checkbox" id="enSupervision" checked> Student Supervision</label></div>
        <div><label><input type="checkbox" id="enResearch" checked> Research (Grants/Projects)</label></div>
        <div><label><input type="checkbox" id="enPublication" checked> Publication</label></div>
        <div><label><input type="checkbox" id="enAdministration" checked> Administration</label></div>
        <div><label><input type="checkbox" id="enServices" checked> Service & Engagement</label></div>
        <div><label><input type="checkbox" id="enLabOps"> Laboratory Operations</label></div>
        <div><label><input type="checkbox" id="enProSch" checked> Professional & Scholarly Service (Reviewer/Editor/Examiner/Committee)</label></div>
      </div>
      <div class="spacer"></div>
      <div id="toggleWarn" class="notice warn" style="display:none;"></div>
    </div>
  </section>

  <!-- SETTINGS (ADMIN ONLY) -->
  <section class="section settings" id="secSettings">
    <header>
      <div>
        <h2>Advanced Settings (Local Configuration)</h2>
        <div class="sub">
          Locked by default. Unlock locally to edit weights, scoring scheme, and benchmarks.
          <span class="small">This is for local configuration only; it does not provide security. Baseline weights must sum to 1.00.</span>
        </div>
      </div>
    </header>
    <div class="content">
      <div id="msgSettings" class="notice warn" style="display:none;"></div>

      <div class="notice">
        <b>Important:</b> This tool measures <b>busyness (workload)</b>, not performance.
        Scoring emphasizes workload indicators (time, volume, meetings, duration, responsibility) and excludes quality/outcome metrics (e.g., journal quartiles, impact factors).
      </div>

      <div class="spacer"></div>

      <div class="grid three">
        <div><label class="requiredMark">Weight: Teaching</label><input class="adminOnly" id="wTeaching" type="number" step="0.01" min="0" value="0.30"/></div>
        <div><label class="requiredMark">Weight: Student Supervision</label><input class="adminOnly" id="wSupervision" type="number" step="0.01" min="0" value="0.15"/></div>
        <div><label class="requiredMark">Weight: Research</label><input class="adminOnly" id="wResearch" type="number" step="0.01" min="0" value="0.20"/></div>
        <div><label class="requiredMark">Weight: Publication</label><input class="adminOnly" id="wPublication" type="number" step="0.01" min="0" value="0.10"/></div>
        <div><label class="requiredMark">Weight: Administration</label><input class="adminOnly" id="wAdministration" type="number" step="0.01" min="0" value="0.15"/></div>
        <div><label class="requiredMark">Weight: Service & Engagement</label><input class="adminOnly" id="wServices" type="number" step="0.01" min="0" value="0.10"/></div>
        <div><label class="requiredMark">Weight: Laboratory Operations</label><input class="adminOnly" id="wLabOps" type="number" step="0.01" min="0" value="0.00"/></div>
        <div><label class="requiredMark">Weight: Professional & Scholarly Service</label><input class="adminOnly" id="wProSch" type="number" step="0.01" min="0" value="0.00"/></div>
      </div>

      <div class="spacer"></div>
      <div class="row noPrint">
        <button class="btn adminOnly" id="btnPresetAcademic"><span class="btn-label">Preset: Academic</span></button>
        <button class="btn adminOnly" id="btnPresetAdmin"><span class="btn-label">Preset: Administrative</span></button>
        <button class="btn adminOnly" id="btnPresetLab"><span class="btn-label">Preset: Laboratory</span></button>
      </div>

      <div class="spacer"></div>
      <div class="notice">
        <b>Weight logic:</b> Baseline weights must sum to <b>1.00</b>.
        During calculation, the tool uses only ON sections and re-normalizes weights automatically.
      </div>

      <div class="spacer"></div>
      <hr style="border:0;border-top:1px solid rgba(255,255,255,.10);margin:16px 0">

      <!-- Benchmarks (Admin input: A) -->
      <div class="notice">
        <b>Institutional Benchmarks (advanced settings input):</b>
        These values are used for interpretation only (e.g., below/around/above faculty average; percentile band).
        They do not change the score calculation.
      </div>

      <div class="spacer"></div>
      <div class="grid three">
        <div><label>Faculty average index (points per month)</label><input class="adminOnly" id="bmAvg" type="number" step="0.1" min="0" value="45.0"/></div>
        <div><label>Percentile cut-off: 25th percentile (P25)</label><input class="adminOnly" id="bmP25" type="number" step="0.1" min="0" value="30.0"/></div>
        <div><label>Percentile cut-off: 50th percentile (P50 / median)</label><input class="adminOnly" id="bmP50" type="number" step="0.1" min="0" value="45.0"/></div>
        <div><label>Percentile cut-off: 75th percentile (P75)</label><input class="adminOnly" id="bmP75" type="number" step="0.1" min="0" value="60.0"/></div>
      </div>

      <div class="spacer"></div>
      <hr style="border:0;border-top:1px solid rgba(255,255,255,.10);margin:16px 0">

      <!-- Scoring parameters -->
      <div class="grid three">
        <div><label>Teaching – points per contact hour</label><input class="adminOnly" id="tHourW" type="number" step="0.1" min="0" value="1.0"/></div>
        <div><label>Teaching – points per student (scaled /100)</label><input class="adminOnly" id="tStudW" type="number" step="0.1" min="0" value="0.6"/></div>
        <div><label>Teaching – multiplier per credit</label><input class="adminOnly" id="tCreditW" type="number" step="0.1" min="0" value="0.4"/></div>

        <div><label>Student Supervision – Undergraduate (per student)</label><input class="adminOnly" id="svUG" type="number" step="0.1" min="0" value="1.5"/></div>
        <div><label>Student Supervision – Master (per student)</label><input class="adminOnly" id="svM" type="number" step="0.1" min="0" value="3.0"/></div>
        <div><label>Student Supervision – PhD (per student)</label><input class="adminOnly" id="svPHD" type="number" step="0.1" min="0" value="4.5"/></div>

        <div><label>Research – base points per grant</label><input class="adminOnly" id="rBase" type="number" step="0.1" min="0" value="6"/></div>
        <div><label>Research – level multipliers (University,National,International)</label><input class="adminOnly" id="rUniNatIntl" type="text" value="1.0,1.4,1.8"/></div>
        <div><label>Research – role multipliers (PI,Co-I,Member)</label><input class="adminOnly" id="rRole" type="text" value="1.6,1.2,1.0"/></div>

        <div><label>Publication – base points per item</label><input class="adminOnly" id="pBase" type="number" step="0.1" min="0" value="4"/></div>
        <div><label>Publication – type multipliers (Journal,Book/Chapter,Proceeding,Other)</label><input class="adminOnly" id="pType" type="text" value="1.5,1.8,1.0,0.8"/></div>
        <div><label>Publication – indexed multipliers (Yes,No)</label><input class="adminOnly" id="pIdx" type="text" value="1.4,1.0"/></div>

        <div><label>Administration – base points by level (Programme,Faculty,University,State,National,International,Industry)</label><input class="adminOnly" id="aLevel" type="text" value="3,5,7,8,10,12,9"/></div>
        <div><label>Administration – points per meeting</label><input class="adminOnly" id="aMeetW" type="number" step="0.1" min="0" value="1.5"/></div>
        <div><label>Administration – points per month in role</label><input class="adminOnly" id="aMonthW" type="number" step="0.1" min="0" value="0.3"/></div>

        <div><label>Service & Engagement – points per hour</label><input class="adminOnly" id="sHourW" type="number" step="0.1" min="0" value="1.0"/></div>
        <div><label>Service & Engagement – points per participants (scaled /10)</label><input class="adminOnly" id="sPaxW" type="number" step="0.1" min="0" value="0.8"/></div>
        <div><label>Service & Engagement – role bonus (Lead,Member)</label><input class="adminOnly" id="sRoleBonus" type="text" value="4,1.5"/></div>

        <div><label>Laboratory Operations – points per volume</label><input class="adminOnly" id="lVolW" type="number" step="0.1" min="0" value="1.0"/></div>
        <div><label>Laboratory Operations – points per hour</label><input class="adminOnly" id="lHourW" type="number" step="0.1" min="0" value="1.0"/></div>
        <div><label>Laboratory Operations – multipliers (Complexity Low,Medium,High)</label><input class="adminOnly" id="lCx" type="text" value="1.0,1.3,1.6"/></div>
        <div><label>Laboratory Operations – multipliers (Urgency Normal,Tight,Critical)</label><input class="adminOnly" id="lUr" type="text" value="1.0,1.25,1.5"/></div>

        <!-- Professional & Scholarly Service parameters (busyness-based) -->
        <div><label>Professional & Scholarly Service – base points per item</label><input class="adminOnly" id="psBase" type="number" step="0.1" min="0" value="3.0"/></div>
        <div><label>Professional & Scholarly Service – role multipliers (Lead,Member)</label><input class="adminOnly" id="psRole" type="text" value="1.3,1.0"/></div>
        <div><label>Professional & Scholarly Service – multipliers (Complexity Low,Medium,High)</label><input class="adminOnly" id="psCx" type="text" value="1.0,1.3,1.6"/></div>
        <div><label>Professional & Scholarly Service – multipliers (Urgency Normal,Tight,Critical)</label><input class="adminOnly" id="psUr" type="text" value="1.0,1.25,1.5"/></div>
      </div>

      <div class="spacer"></div>
      <div class="notice">
        <b>Passphrase location:</b> At the very top of this <code>index.html</code>, search for <code>ADMIN_PASSWORD</code>.
      </div>
    </div>
  </section>

  <!-- TEACHING -->
  <section class="section teaching" id="secTeaching">
    <header>
      <div>
        <h2>Teaching</h2>
        <div class="sub">Credit is auto-extracted from the <b>last digit</b> of course code (e.g., SJ24102 → credit=2). Contact hours are auto-computed.</div>
      </div>
      <div class="row right noPrint">
        <button class="btn" id="addTeach"><span class="btn-label">Add course</span></button>
        <button class="btn btn-ghost" id="clearTeach"><span class="btn-label">Clear</span></button>
      </div>
    </header>
    <div class="content">
      <div class="tableWrap">
        <table id="tblTeach">
          <thead>
            <tr>
              <th style="width:14%">Course Code *</th>
              <th>Course Title *</th>
              <th style="width:8%">Credit</th>
              <th style="width:10%">Students *</th>
              <th style="width:10%">Lecture *</th>
              <th style="width:10%">Tutorial *</th>
              <th style="width:10%">Lab *</th>
              <th style="width:10%">Field *</th>
              <th style="width:10%">Contact Hours</th>
              <th style="width:6%">Action</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- SUPERVISION -->
  <section class="section supervision" id="secSupervision">
    <header>
      <div>
        <h2>Student Supervision</h2>
        <div class="sub">Include active supervision load for the reporting period (Undergraduate, Master, PhD).</div>
      </div>
      <div class="row right noPrint">
        <button class="btn" id="addSv"><span class="btn-label">Add supervision</span></button>
        <button class="btn btn-ghost" id="clearSv"><span class="btn-label">Clear</span></button>
      </div>
    </header>
    <div class="content">
      <div class="tableWrap">
        <table id="tblSv">
          <thead>
            <tr>
              <th style="width:18%">Level *</th>
              <th>Student / Project *</th>
              <th style="width:14%">Role *</th>
              <th style="width:12%">Status *</th>
              <th style="width:12%">Start *</th>
              <th style="width:12%">End *</th>
              <th style="width:8%">Action</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- RESEARCH -->
  <section class="section research" id="secResearch">
    <header>
      <div>
        <h2>Research (Grants / Projects)</h2>
        <div class="sub">Specify grant level, status, role, amount and duration.</div>
      </div>
      <div class="row right noPrint">
        <button class="btn" id="addRes"><span class="btn-label">Add grant</span></button>
        <button class="btn btn-ghost" id="clearRes"><span class="btn-label">Clear</span></button>
      </div>
    </header>
    <div class="content">
      <div class="tableWrap">
        <table id="tblRes">
          <thead>
            <tr>
              <th style="width:14%">Grant Code *</th>
              <th>Title *</th>
              <th style="width:14%">Level *</th>
              <th style="width:12%">Status *</th>
              <th style="width:12%">Role *</th>
              <th style="width:12%">Amount (RM) *</th>
              <th style="width:10%">Start *</th>
              <th style="width:10%">End *</th>
              <th style="width:6%">Action</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- PUBLICATION -->
  <section class="section publication" id="secPublication">
    <header>
      <div>
        <h2>Publication</h2>
        <div class="sub">If ON, record publication output for the reporting period. This captures workload (count/handling), not quality metrics.</div>
      </div>
      <div class="row right noPrint">
        <button class="btn" id="addPub"><span class="btn-label">Add publication</span></button>
        <button class="btn btn-ghost" id="clearPub"><span class="btn-label">Clear</span></button>
      </div>
    </header>
    <div class="content">
      <div class="tableWrap">
        <table id="tblPub">
          <thead>
            <tr>
              <th style="width:10%">Year *</th>
              <th>Title *</th>
              <th style="width:16%">Type *</th>
              <th style="width:14%">Indexed? *</th>
              <th style="width:14%">Role *</th>
              <th style="width:12%">Start *</th>
              <th style="width:12%">End *</th>
              <th style="width:6%">Action</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- ADMINISTRATION -->
  <section class="section admin" id="secAdmin">
    <header>
      <div>
        <h2>Administration</h2>
        <div class="sub">Include appointments, level, duration (months) and meeting workload. Notes should describe workload clearly.</div>
      </div>
      <div class="row right noPrint">
        <button class="btn" id="addAdmin"><span class="btn-label">Add admin role</span></button>
        <button class="btn btn-ghost" id="clearAdmin"><span class="btn-label">Clear</span></button>
      </div>
    </header>
    <div class="content">
      <div class="tableWrap">
        <table id="tblAdmin">
          <thead>
            <tr>
              <th style="width:18%">Position *</th>
              <th style="width:14%">Type *</th>
              <th style="width:18%">Level *</th>
              <th style="width:10%">Months *</th>
              <th style="width:10%">Meetings *</th>
              <th>Workload Notes *</th>
              <th style="width:10%">Start *</th>
              <th style="width:10%">End *</th>
              <th style="width:6%">Action</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="spacer"></div>
      <div class="notice">Tip: Record conference committee work under <b>Professional & Scholarly Service</b> (recommended) or Administration if it is an official appointment. Describe workload clearly in Notes.</div>
    </div>
  </section>

  <!-- SERVICES -->
  <section class="section service" id="secService">
    <header>
      <div>
        <h2>Service & Engagement</h2>
        <div class="sub">Service to university, industry, or community. Include start and end dates.</div>
      </div>
      <div class="row right noPrint">
        <button class="btn" id="addSvc"><span class="btn-label">Add service</span></button>
        <button class="btn btn-ghost" id="clearSvc"><span class="btn-label">Clear</span></button>
      </div>
    </header>
    <div class="content">
      <div class="tableWrap">
        <table id="tblSvc">
          <thead>
            <tr>
              <th style="width:18%">Service Type *</th>
              <th>Activity *</th>
              <th style="width:12%">Role *</th>
              <th style="width:10%">Hours (optional)</th>
              <th style="width:10%">Participants *</th>
              <th style="width:12%">Start *</th>
              <th style="width:12%">End *</th>
              <th style="width:6%">Action</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- LAB OPERATIONS -->
  <section class="section labops" id="secLabOps" style="display:none;">
    <header>
      <div>
        <h2>Laboratory Operations</h2>
        <div class="sub">For lab staff or lab-support work. Scored using (volume + hours) × complexity × urgency.</div>
      </div>
      <div class="row right noPrint">
        <button class="btn" id="addLab"><span class="btn-label">Add lab activity</span></button>
        <button class="btn btn-ghost" id="clearLab"><span class="btn-label">Clear</span></button>
      </div>
    </header>
    <div class="content">
      <div class="tableWrap">
        <table id="tblLab">
          <thead>
            <tr>
              <th style="width:18%">Type *</th>
              <th>Description *</th>
              <th style="width:10%">Volume *</th>
              <th style="width:12%">Complexity *</th>
              <th style="width:12%">Urgency *</th>
              <th style="width:10%">Hours *</th>
              <th style="width:12%">Start *</th>
              <th style="width:12%">End *</th>
              <th style="width:6%">Action</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- PROFESSIONAL & SCHOLARLY SERVICE -->
  <section class="section prosch" id="secProSch">
    <header>
      <div>
        <h2>Professional & Scholarly Service</h2>
        <div class="sub">
          This section captures <b>workload</b> such as journal reviewing, editorial handling, external examining, and conference committee work.
          It does not capture quality metrics (e.g., journal ranking). Use volume, rounds, complexity, urgency and time indicators.
        </div>
      </div>
      <div class="row right noPrint">
        <button class="btn" id="addProSch"><span class="btn-label">Add item</span></button>
        <button class="btn btn-ghost" id="clearProSch"><span class="btn-label">Clear</span></button>
      </div>
    </header>
    <div class="content">
      <div class="tableWrap">
        <table id="tblProSch">
          <thead>
            <tr>
              <th style="width:18%">Activity Type *</th>
              <th>Description *</th>
              <th style="width:12%">Role *</th>
              <th style="width:10%">Quantity *</th>
              <th style="width:10%">Rounds *</th>
              <th style="width:12%">Complexity *</th>
              <th style="width:12%">Urgency *</th>
              <th style="width:10%">Hours *</th>
              <th style="width:10%">Start *</th>
              <th style="width:10%">End *</th>
              <th style="width:6%">Action</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="spacer"></div>
      <div class="notice">
        Example: Reviewer (Quantity=3 manuscripts, Rounds=2, Complexity=High, Urgency=Tight, Hours=10).
        Conference committee can be recorded as “Conference Committee / Secretariat / Chair”.
      </div>
    </div>
  </section>

  <!-- RESULTS -->
  <section class="section results" id="secResults">
    <header>
      <div>
        <h2>Results</h2>
        <div class="sub">
          Calculate a monthly-normalized busyness index, review contributions, export data, and print a professional black-and-white form (settings hidden in print).
        </div>
      </div>
    </header>
    <div class="content">
      <div id="msgGlobal" class="notice warn" style="display:none;"></div>

      <!-- KPIs -->
      <div class="kpi">
        <div class="box"><div class="k">Teaching</div><div class="v" id="outTeaching">0.0</div><div class="s">Monthly-normalized workload points</div></div>
        <div class="box"><div class="k">Student Supervision</div><div class="v" id="outSupervision">0.0</div><div class="s">Monthly-normalized workload points</div></div>
        <div class="box"><div class="k">Research (Grants / Projects)</div><div class="v" id="outResearch">0.0</div><div class="s">Monthly-normalized workload points</div></div>
        <div class="box"><div class="k">Publication</div><div class="v" id="outPublication">0.0</div><div class="s">Monthly-normalized workload points</div></div>

        <div class="box"><div class="k">Administration</div><div class="v" id="outAdministration">0.0</div><div class="s">Monthly-normalized workload points</div></div>
        <div class="box"><div class="k">Service & Engagement</div><div class="v" id="outServices">0.0</div><div class="s">Monthly-normalized workload points</div></div>
        <div class="box"><div class="k">Laboratory Operations</div><div class="v" id="outLabOps">0.0</div><div class="s">Monthly-normalized workload points</div></div>
        <div class="box"><div class="k">Professional & Scholarly Service</div><div class="v" id="outProSch">0.0</div><div class="s">Monthly-normalized workload points</div></div>

        <div class="box">
          <div class="k">Overall Busyness Index (Points per month)</div>
          <div class="v" id="outIndex">0.0</div>
          <div class="s" id="outBand">—</div>
        </div>

        <div class="box">
          <div class="k">Benchmark Interpretation (Advanced Settings)</div>
          <div class="s wrapText" id="outBenchmark">—</div>
        </div>
      </div>

      <div class="spacer"></div>

      <div class="grid two">
        <div class="box">
          <div class="k">Dean View Summary (read-only)</div>
          <div class="hint wrapText" id="outDean">—</div>
        </div>
        <div class="box">
          <div class="k">Narrative Summary (workload drivers)</div>
          <div class="hint wrapText" id="outNarr">—</div>
        </div>
      </div>

      <div class="spacer"></div>

      <div class="box">
        <div class="k">Top 3 contributors</div>
        <ol class="hint wrapText" id="outTop3">
          <li>—</li>
        </ol>
      </div>

      <div class="spacer"></div>

      <div class="row noPrint" style="justify-content:flex-end">
        <button class="btn btn-primary btn-md" id="btnCalc"><span class="btn-label">Calculate</span></button>
        <button class="btn btn-secondary" id="btnPrint"><span class="btn-label">Print PDF</span></button>
        <div class="dropdown">
          <button class="btn btn-secondary" id="btnExportToggle" aria-haspopup="true" aria-expanded="false" aria-controls="exportMenu">
            <span class="btn-label">Export</span>
            <svg viewBox="0 0 20 20" aria-hidden="true"><path d="M5 7l5 6 5-6H5z"/></svg>
          </button>
          <div class="dropdown-menu" id="exportMenu" role="menu">
            <button class="btn btn-ghost" id="btnExportSummaryCSV" role="menuitem">Summary CSV</button>
            <button class="btn btn-ghost" id="btnExportDetailedCSV" role="menuitem">Detailed CSV</button>
            <button class="btn btn-ghost" id="btnExportJSON" role="menuitem">Full JSON</button>
          </div>
        </div>
      </div>

      <!-- PRINT-ONLY SIGNATURES -->
      <div class="printOnly" style="margin-top:16px">
        <hr style="border:0;border-top:1px solid #000;margin:12px 0">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px">
          <div>
            <div style="font-weight:800;margin-bottom:8px">Staff Declaration</div>
            <div>Full name: <span id="printName"></span></div>
            <div>Staff ID: <span id="printId"></span></div>
            <div>Date printed: <span id="printDate"></span></div>
            <div style="height:110px;border:1px solid #000;margin-top:10px;padding:10px">Staff Signature:</div>
          </div>
          <div>
            <div style="font-weight:800;margin-bottom:8px">Dean Approval</div>
            <div>Faculty: Faculty of Science and Technology</div>
            <div>Dean: Prof. P.Geol. Ts. Dr. Rodeano Roslee</div>
            <div>Date: _______________________</div>
            <div style="height:110px;border:1px solid #000;margin-top:10px;padding:10px">Dean Signature:</div>
          </div>
        </div>
        <div style="margin-top:12px;font-size:11px;color:#000">
          <div><strong>Note:</strong> This busyness index reflects workload intensity only and is not a performance evaluation.</div>
          <div>Use alongside qualitative review and departmental context.</div>
          <div style="margin-top:6px">Printed on: <span id="printFooterDate"></span></div>
        </div>
        <div style="margin-top:10px;font-size:11px;color:#000">© FST UMS</div>
      </div>

      <div class="spacer"></div>

      <div class="box">
        <canvas id="chart" height="120"></canvas>
      </div>

    </div>
  </section>

  <div class="footer">© FST UMS</div>
</div>

<script>
/* =========================================================
   Helpers
========================================================= */
const $ = (id)=>document.getElementById(id);
const clamp = (x,a,b)=>Math.max(a,Math.min(b,x));
const n = (v)=>{ const x=parseFloat(v); return isNaN(x)?0:x; };
const uid = ()=>Math.random().toString(16).slice(2)+Date.now().toString(16);

function showMsg(kind, html){
  const el = $("msgGlobal");
  el.className = "notice " + (kind==="bad"?"bad":kind==="ok"?"ok":"warn");
  el.innerHTML = html;
  el.style.display = "block";
}
function hideMsg(){ $("msgGlobal").style.display="none"; }
function confirmDelete(message="Delete this record? This action cannot be undone."){
  return window.confirm(message);
}

/* =========================================================
   Period normalization (points per month)
========================================================= */
function periodMonths(period){
  if(period==="Monthly") return 1;
  if(period==="Quarterly") return 3;
  if(period==="Semester") return 6;
  if(period==="Annual") return 12;
  return 1;
}

/* =========================================================
   Soft caps / diminishing returns
========================================================= */
function applySoftCap(score, cap, marginalRateAfterCap){
  const c = Math.max(0, n(cap));
  const r = clamp(n(marginalRateAfterCap), 0, 1);
  const s = Math.max(0, n(score));
  if(c<=0) return s;
  if(s<=c) return s;
  return c + (s-c)*r;
}

/* =========================================================
   State
========================================================= */
let isAdmin = false;

const state = {
  profile:{
    name:"", staffId:"", category:"", unit:"",
    grade:"", gradeOther:"",
    status:"", statusOther:"",
    period:""
  },

  enabled:{
    Teaching:true,
    Supervision:true,
    Research:true,
    Publication:true,
    Administration:true,
    Services:true,
    LabOps:false,
    ProSch:true
  },

  // Baseline weights must sum to 1.00
  weights:{
    Teaching:0.30,
    Supervision:0.15,
    Research:0.20,
    Publication:0.10,
    Administration:0.15,
    Services:0.10,
    LabOps:0.00,
    ProSch:0.00
  },

  // Admin scoring scheme + caps (defaults are sensible placeholders)
  scheme:{
    teaching:{ hourW:1.0, studW:0.6, creditW:0.4 },
    supervision:{ ug:1.5, m:3.0, phd:4.5 },
    research:{ base:6, lvl:[1.0,1.4,1.8], role:[1.6,1.2,1.0] },
    publication:{ base:4, type:[1.5,1.8,1.0,0.8], idx:[1.4,1.0] },
    admin:{ lvl:[3,5,7,8,10,12,9], meetW:1.5, monthW:0.3 },
    service:{ hourW:1.0, paxW:0.8, bonus:[4,1.5] },
    lab:{ volW:1.0, hourW:1.0, cx:[1.0,1.3,1.6], ur:[1.0,1.25,1.5] },
    prosch:{ base:3.0, role:[1.3,1.0], cx:[1.0,1.3,1.6], ur:[1.0,1.25,1.5] },

    // Soft caps (applied AFTER period-normalization)
    caps:{
      Teaching:{ cap:35, rate:0.40 },
      Supervision:{ cap:25, rate:0.45 },
      Research:{ cap:30, rate:0.45 },
      Publication:{ cap:20, rate:0.50 },
      Administration:{ cap:35, rate:0.45 },
      Services:{ cap:25, rate:0.50 },
      LabOps:{ cap:35, rate:0.45 },
      ProSch:{ cap:25, rate:0.50 }
    }
  },

  // Benchmarks (interpretation only)
  benchmarks:{ avg:45.0, p25:30.0, p50:45.0, p75:60.0 },

  data:{
    teaching:[],
    supervision:[],
    research:[],
    publication:[],
    admin:[],
    service:[],
    lab:[],
    prosch:[]
  },

  audit:{ last_saved_at:null, last_calc_at:null }
};

/* =========================================================
   Admin lock
========================================================= */
function setAdminUI(){
  $("modeText").textContent = isAdmin ? "Advanced Settings" : "Staff";
  $("btnAdminLock").style.display = isAdmin ? "inline-block" : "none";
  $("lockDot").className = "dot " + (isAdmin ? "" : "lock");
  $("lockText").textContent = isAdmin ? "Settings unlocked (local)" : "Settings locked";

  document.querySelectorAll(".adminOnly").forEach(el=>{
    el.disabled = !isAdmin;
  });
}

function unlockAdmin(){
  const pw = $("adminPass").value;
  if(pw === ADMIN_PASSWORD){
    isAdmin = true;
    setAdminUI();
    showMsg("ok","<b>Settings unlocked:</b> You can now edit weights, scoring scheme, and benchmarks (local only).");
  }else{
    isAdmin = false;
    setAdminUI();
    showMsg("bad","<b>Passphrase mismatch:</b> Unable to unlock advanced settings.");
  }
}
function lockAdmin(){
  isAdmin = false;
  $("adminPass").value = "";
  setAdminUI();
  showMsg("warn","<b>Locked:</b> Settings are now read-only.");
}

/* =========================================================
   Parsing helper
========================================================= */
function parseCSVNums(str, expected){
  const arr = (str||"").split(",").map(s=>n(s.trim()));
  if(arr.length!==expected) return null;
  return arr;
}

/* =========================================================
   Category templates (weights + section ON/OFF)
========================================================= */
function applyTemplateByCategory(cat){
  if(cat==="Academic"){
    state.enabled = {
      Teaching:true, Supervision:true, Research:true, Publication:true,
      Administration:true, Services:true, LabOps:false, ProSch:true
    };
    state.weights = {
      Teaching:0.28, Supervision:0.14, Research:0.20, Publication:0.10,
      Administration:0.12, Services:0.08, LabOps:0.00, ProSch:0.08
    };
  } else if(cat==="Administrative"){
    state.enabled = {
      Teaching:false, Supervision:false, Research:false, Publication:false,
      Administration:true, Services:true, LabOps:false, ProSch:true
    };
    state.weights = {
      Teaching:0.00, Supervision:0.00, Research:0.00, Publication:0.00,
      Administration:0.55, Services:0.30, LabOps:0.00, ProSch:0.15
    };
  } else if(cat==="Laboratory"){
    state.enabled = {
      Teaching:false, Supervision:false, Research:false, Publication:false,
      Administration:true, Services:true, LabOps:true, ProSch:true
    };
    state.weights = {
      Teaching:0.00, Supervision:0.00, Research:0.00, Publication:0.00,
      Administration:0.40, Services:0.20, LabOps:0.30, ProSch:0.10
    };
  }
  syncUIFromState();
  applySectionVisibility();
  autosave();
}

/* =========================================================
   Sync UI <-> State
========================================================= */
function syncProfileFromUI(){
  state.profile.name = $("pName").value.trim();
  state.profile.staffId = $("pStaffId").value.trim();
  state.profile.category = $("pCategory").value;
  state.profile.unit = $("pUnit").value.trim();
  state.profile.grade = $("pGrade").value;
  state.profile.gradeOther = $("pGradeOther").value.trim();
  state.profile.status = $("pStatus").value;
  state.profile.statusOther = $("pStatusOther").value.trim();
  state.profile.period = $("pPeriod").value;
}

function syncEnabledFromUI(){
  state.enabled.Teaching = $("enTeaching").checked;
  state.enabled.Supervision = $("enSupervision").checked;
  state.enabled.Research = $("enResearch").checked;
  state.enabled.Publication = $("enPublication").checked;
  state.enabled.Administration = $("enAdministration").checked;
  state.enabled.Services = $("enServices").checked;
  state.enabled.LabOps = $("enLabOps").checked;
  state.enabled.ProSch = $("enProSch").checked;
}

function syncSettingsFromUI_ifAdmin(){
  if(!isAdmin) return;

  // weights
  state.weights.Teaching = n($("wTeaching").value);
  state.weights.Supervision = n($("wSupervision").value);
  state.weights.Research = n($("wResearch").value);
  state.weights.Publication = n($("wPublication").value);
  state.weights.Administration = n($("wAdministration").value);
  state.weights.Services = n($("wServices").value);
  state.weights.LabOps = n($("wLabOps").value);
  state.weights.ProSch = n($("wProSch").value);

  // benchmarks
  state.benchmarks.avg = n($("bmAvg").value);
  state.benchmarks.p25 = n($("bmP25").value);
  state.benchmarks.p50 = n($("bmP50").value);
  state.benchmarks.p75 = n($("bmP75").value);

  // scheme
  state.scheme.teaching.hourW = n($("tHourW").value);
  state.scheme.teaching.studW = n($("tStudW").value);
  state.scheme.teaching.creditW = n($("tCreditW").value);

  state.scheme.supervision.ug = n($("svUG").value);
  state.scheme.supervision.m = n($("svM").value);
  state.scheme.supervision.phd = n($("svPHD").value);

  state.scheme.research.base = n($("rBase").value);
  const rLvl = parseCSVNums($("rUniNatIntl").value, 3); if(rLvl) state.scheme.research.lvl = rLvl;
  const rRole = parseCSVNums($("rRole").value, 3); if(rRole) state.scheme.research.role = rRole;

  state.scheme.publication.base = n($("pBase").value);
  const pType = parseCSVNums($("pType").value, 4); if(pType) state.scheme.publication.type = pType;
  const pIdx = parseCSVNums($("pIdx").value, 2); if(pIdx) state.scheme.publication.idx = pIdx;

  const aLvl = parseCSVNums($("aLevel").value, 7); if(aLvl) state.scheme.admin.lvl = aLvl;
  state.scheme.admin.meetW = n($("aMeetW").value);
  state.scheme.admin.monthW = n($("aMonthW").value);

  state.scheme.service.hourW = n($("sHourW").value);
  state.scheme.service.paxW = n($("sPaxW").value);
  const sBonus = parseCSVNums($("sRoleBonus").value, 2); if(sBonus) state.scheme.service.bonus = sBonus;

  state.scheme.lab.volW = n($("lVolW").value);
  state.scheme.lab.hourW = n($("lHourW").value);
  const lCx = parseCSVNums($("lCx").value, 3); if(lCx) state.scheme.lab.cx = lCx;
  const lUr = parseCSVNums($("lUr").value, 3); if(lUr) state.scheme.lab.ur = lUr;

  // prosch
  state.scheme.prosch.base = n($("psBase").value);
  const psRole = parseCSVNums($("psRole").value, 2); if(psRole) state.scheme.prosch.role = psRole;
  const psCx = parseCSVNums($("psCx").value, 3); if(psCx) state.scheme.prosch.cx = psCx;
  const psUr = parseCSVNums($("psUr").value, 3); if(psUr) state.scheme.prosch.ur = psUr;
}

function syncUIFromState(){
  // profile
  $("pName").value = state.profile.name || "";
  $("pStaffId").value = state.profile.staffId || "";
  $("pCategory").value = state.profile.category || "";
  $("pUnit").value = state.profile.unit || "";
  $("pGrade").value = state.profile.grade || "";
  $("pGradeOther").value = state.profile.gradeOther || "";
  $("pStatus").value = state.profile.status || "";
  $("pStatusOther").value = state.profile.statusOther || "";
  $("pPeriod").value = state.profile.period || "";

  $("pGradeOtherWrap").style.display = (state.profile.grade==="Others") ? "block" : "none";
  $("pStatusOtherWrap").style.display = (state.profile.status==="Others") ? "block" : "none";

  // enabled
  $("enTeaching").checked = !!state.enabled.Teaching;
  $("enSupervision").checked = !!state.enabled.Supervision;
  $("enResearch").checked = !!state.enabled.Research;
  $("enPublication").checked = !!state.enabled.Publication;
  $("enAdministration").checked = !!state.enabled.Administration;
  $("enServices").checked = !!state.enabled.Services;
  $("enLabOps").checked = !!state.enabled.LabOps;
  $("enProSch").checked = !!state.enabled.ProSch;

  // weights
  $("wTeaching").value = state.weights.Teaching.toFixed(2);
  $("wSupervision").value = state.weights.Supervision.toFixed(2);
  $("wResearch").value = state.weights.Research.toFixed(2);
  $("wPublication").value = state.weights.Publication.toFixed(2);
  $("wAdministration").value = state.weights.Administration.toFixed(2);
  $("wServices").value = state.weights.Services.toFixed(2);
  $("wLabOps").value = state.weights.LabOps.toFixed(2);
  $("wProSch").value = state.weights.ProSch.toFixed(2);

  // benchmarks
  $("bmAvg").value = state.benchmarks.avg;
  $("bmP25").value = state.benchmarks.p25;
  $("bmP50").value = state.benchmarks.p50;
  $("bmP75").value = state.benchmarks.p75;

  // scheme
  $("tHourW").value = state.scheme.teaching.hourW;
  $("tStudW").value = state.scheme.teaching.studW;
  $("tCreditW").value = state.scheme.teaching.creditW;

  $("svUG").value = state.scheme.supervision.ug;
  $("svM").value = state.scheme.supervision.m;
  $("svPHD").value = state.scheme.supervision.phd;

  $("rBase").value = state.scheme.research.base;
  $("rUniNatIntl").value = state.scheme.research.lvl.join(",");
  $("rRole").value = state.scheme.research.role.join(",");

  $("pBase").value = state.scheme.publication.base;
  $("pType").value = state.scheme.publication.type.join(",");
  $("pIdx").value = state.scheme.publication.idx.join(",");

  $("aLevel").value = state.scheme.admin.lvl.join(",");
  $("aMeetW").value = state.scheme.admin.meetW;
  $("aMonthW").value = state.scheme.admin.monthW;

  $("sHourW").value = state.scheme.service.hourW;
  $("sPaxW").value = state.scheme.service.paxW;
  $("sRoleBonus").value = state.scheme.service.bonus.join(",");

  $("lVolW").value = state.scheme.lab.volW;
  $("lHourW").value = state.scheme.lab.hourW;
  $("lCx").value = state.scheme.lab.cx.join(",");
  $("lUr").value = state.scheme.lab.ur.join(",");

  $("psBase").value = state.scheme.prosch.base;
  $("psRole").value = state.scheme.prosch.role.join(",");
  $("psCx").value = state.scheme.prosch.cx.join(",");
  $("psUr").value = state.scheme.prosch.ur.join(",");
}

function applySectionVisibility(){
  $("secTeaching").style.display = state.enabled.Teaching ? "block" : "none";
  $("secSupervision").style.display = state.enabled.Supervision ? "block" : "none";
  $("secResearch").style.display = state.enabled.Research ? "block" : "none";
  $("secPublication").style.display = state.enabled.Publication ? "block" : "none";
  $("secAdmin").style.display = state.enabled.Administration ? "block" : "none";
  $("secService").style.display = state.enabled.Services ? "block" : "none";
  $("secLabOps").style.display = state.enabled.LabOps ? "block" : "none";
  $("secProSch").style.display = state.enabled.ProSch ? "block" : "none";
}

/* =========================================================
   Benchmark UI
========================================================= */
function updateBenchmarkUI(indexValue=null){
  if(indexValue===null){
    $("outBenchmark").textContent = "—";
  }else{
    $("outBenchmark").textContent = benchmarkText(indexValue);
  }
}

/* =========================================================
   Validation helpers
========================================================= */
function validateProfile(){
  const ids = ["pName","pStaffId","pCategory","pUnit","pGrade","pStatus","pPeriod","pGradeOther","pStatusOther"];
  ids.forEach(id=>$(id).classList.remove("err"));
  let ok=true;

  if(!$("pName").value.trim()) ok=false, $("pName").classList.add("err");
  if(!$("pStaffId").value.trim()) ok=false, $("pStaffId").classList.add("err");
  if(!$("pCategory").value) ok=false, $("pCategory").classList.add("err");
  if(!$("pUnit").value.trim()) ok=false, $("pUnit").classList.add("err");
  if(!$("pGrade").value) ok=false, $("pGrade").classList.add("err");
  if(!$("pStatus").value) ok=false, $("pStatus").classList.add("err");
  if(!$("pPeriod").value) ok=false, $("pPeriod").classList.add("err");

  if($("pGrade").value==="Others" && !$("pGradeOther").value.trim()) ok=false, $("pGradeOther").classList.add("err");
  if($("pStatus").value==="Others" && !$("pStatusOther").value.trim()) ok=false, $("pStatusOther").classList.add("err");

  $("msgProfile").style.display = ok ? "none" : "block";
  if(!ok) $("msgProfile").innerHTML = "<b>Action required:</b> Please complete all required profile fields.";
  return ok;
}

function validateToggles(){
  syncEnabledFromUI();
  const anyOn = Object.values(state.enabled).some(Boolean);
  $("toggleWarn").style.display = anyOn ? "none" : "block";
  if(!anyOn) $("toggleWarn").textContent = "At least one section must be ON.";
  return anyOn;
}

function validateWeightsBaseline_ifAdmin(){
  if(!isAdmin) return true;
  const sum =
    state.weights.Teaching +
    state.weights.Supervision +
    state.weights.Research +
    state.weights.Publication +
    state.weights.Administration +
    state.weights.Services +
    state.weights.LabOps +
    state.weights.ProSch;

  const ok = Math.abs(sum-1.00) <= 0.005;
  $("msgSettings").style.display = ok ? "none" : "block";
  if(!ok) $("msgSettings").innerHTML = `<b>Settings validation:</b> Baseline weights must sum to 1.00. Current sum = <b>${sum.toFixed(2)}</b>.`;
  return ok;
}

function getActiveWeights(){
  const aw = {
    Teaching: state.enabled.Teaching ? state.weights.Teaching : 0,
    Supervision: state.enabled.Supervision ? state.weights.Supervision : 0,
    Research: state.enabled.Research ? state.weights.Research : 0,
    Publication: state.enabled.Publication ? state.weights.Publication : 0,
    Administration: state.enabled.Administration ? state.weights.Administration : 0,
    Services: state.enabled.Services ? state.weights.Services : 0,
    LabOps: state.enabled.LabOps ? state.weights.LabOps : 0,
    ProSch: state.enabled.ProSch ? state.weights.ProSch : 0
  };
  const sum = Object.values(aw).reduce((a,b)=>a+b,0);
  if(sum<=0) return null;
  Object.keys(aw).forEach(k=>aw[k]=aw[k]/sum);
  return aw;
}

/* =========================================================
   Activity data seeding
========================================================= */
function ensureSeed(){
  if(state.data.teaching.length===0)
    state.data.teaching.push({id:uid(), code:"", name:"", credit:0, students:0, lecture:0, tutorial:0, laboratory:0, field:0});
  if(state.data.supervision.length===0)
    state.data.supervision.push({id:uid(), level:"Undergraduate", title:"", role:"Main", status:"Active", start:"", end:""});
  if(state.data.research.length===0)
    state.data.research.push({id:uid(), code:"", title:"", level:"University", status:"Active", role:"PI", amount:0, start:"", end:""});
  if(state.data.publication.length===0)
    state.data.publication.push({id:uid(), year:(new Date()).getFullYear(), title:"", type:"Journal", indexed:"Yes", role:"First/Corresponding", start:"", end:""});
  if(state.data.admin.length===0)
    state.data.admin.push({id:uid(), position:"", type:"Official", level:"Faculty", months:0, meetings:0, notes:"", start:"", end:""});
  if(state.data.service.length===0)
    state.data.service.push({id:uid(), type:"Service to University", activity:"", role:"Lead", hours:0, participants:0, start:"", end:""});
  if(state.data.lab.length===0)
    state.data.lab.push({id:uid(), type:"Equipment/Maintenance", desc:"", volume:0, complexity:"Medium", urgency:"Normal", hours:0, start:"", end:""});
  if(state.data.prosch.length===0)
    state.data.prosch.push({id:uid(), activityType:"Reviewer", desc:"", role:"Member", quantity:1, rounds:1, complexity:"Medium", urgency:"Normal", hours:0, start:"", end:""});
}

/* =========================================================
   Teaching helpers
========================================================= */
function creditFromCode(code){
  const s = (code||"").trim();
  const m = s.match(/(\d)\s*$/);
  return m ? parseInt(m[1],10) : 0;
}
function contactHoursRow(r){
  return Math.max(0,n(r.lecture)) + Math.max(0,n(r.tutorial)) + Math.max(0,n(r.laboratory)) + Math.max(0,n(r.field));
}

/* =========================================================
   Scoring (raw -> monthly -> soft caps)
========================================================= */
function scoreTeaching_raw(){
  const sc=state.scheme.teaching;
  let total=0;
  state.data.teaching.forEach(x=>{
    const credit = creditFromCode(x.code);
    x.credit = credit;
    const contact = contactHoursRow(x);
    const students = Math.max(0,n(x.students));
    total += (contact*sc.hourW) + ((students/100)*sc.studW) + (credit*sc.creditW);
  });
  return total;
}

function scoreSupervision_raw(){
  const sc=state.scheme.supervision;
  let total=0;
  state.data.supervision.forEach(x=>{
    const roleMultiplier = (x.role==="Main") ? 1.0 : 0.6;
    const statusMultiplier = (x.status==="Active") ? 1.0 : 0.5;
    let base = 0;
    if(x.level==="Undergraduate") base=sc.ug;
    if(x.level==="Master") base=sc.m;
    if(x.level==="PhD") base=sc.phd;
    total += base * roleMultiplier * statusMultiplier;
  });
  return total;
}

function scoreResearch_raw(){
  const sc=state.scheme.research;
  const lvlMap={University:0, National:1, International:2};
  const roleMap={PI:0, "Co-I":1, Member:2};
  let total=0;
  state.data.research.forEach(x=>{
    const statusMultiplier = (x.status==="Active") ? 1.0 : (x.status==="Applied") ? 0.6 : 0.3;
    const li = lvlMap[x.level] ?? 0;
    const ri = roleMap[x.role] ?? 2;
    total += sc.base * sc.lvl[li] * sc.role[ri] * statusMultiplier;
  });
  return total;
}

function scorePublication_raw(){
  const sc=state.scheme.publication;
  const typeMap={"Journal":0,"Book/Chapter":1,"Proceeding":2,"Other":3};
  const idxMap={"Yes":0,"No":1};
  let total=0;
  state.data.publication.forEach(x=>{
    const ti = typeMap[x.type] ?? 3;
    const ii = idxMap[x.indexed] ?? 1;
    const roleMultiplier = (x.role==="First/Corresponding") ? 1.2 : 1.0;
    total += sc.base * sc.type[ti] * sc.idx[ii] * roleMultiplier;
  });
  return total;
}

function scoreAdministration_raw(){
  const sc=state.scheme.admin;
  const lvlMap={"Programme":0,"Faculty":1,"University":2,"State":3,"National":4,"International":5,"Industry":6};
  let total=0;
  state.data.admin.forEach(x=>{
    const li = lvlMap[x.level] ?? 1;
    const base = sc.lvl[li];
    const meetings = Math.max(0,n(x.meetings));
    const months = Math.max(0,n(x.months));
    const typeMultiplier = (x.type==="Official") ? 1.0 : 0.7;
    total += (base + meetings*sc.meetW + months*sc.monthW) * typeMultiplier;
  });
  return total;
}

function scoreServices_raw(){
  const sc=state.scheme.service;
  const roleMap={Lead:0, Member:1};
  let total=0;
  state.data.service.forEach(x=>{
    const hrs = Math.max(0,n(x.hours));
    const pax = Math.max(0,n(x.participants));
    const ri = roleMap[x.role] ?? 1;
    total += (hrs*sc.hourW) + ((pax/10)*sc.paxW) + sc.bonus[ri];
  });
  return total;
}

function scoreLabOps_raw(){
  const sc=state.scheme.lab;
  const cxMap={Low:0, Medium:1, High:2};
  const urMap={Normal:0, Tight:1, Critical:2};
  let total=0;
  state.data.lab.forEach(x=>{
    const vol = Math.max(0,n(x.volume));
    const hrs = Math.max(0,n(x.hours));
    const ci = cxMap[x.complexity] ?? 1;
    const ui = urMap[x.urgency] ?? 0;
    const base = (vol*sc.volW) + (hrs*sc.hourW);
    total += base * sc.cx[ci] * sc.ur[ui];
  });
  return total;
}

function scoreProSch_raw(){
  const sc=state.scheme.prosch;
  const roleMap={Lead:0, Member:1};
  const cxMap={Low:0, Medium:1, High:2};
  const urMap={Normal:0, Tight:1, Critical:2};

  let total=0;
  state.data.prosch.forEach(x=>{
    const qty = Math.max(0, Math.floor(n(x.quantity)));
    const rnd = Math.max(1, Math.floor(n(x.rounds) || 1));
    const hrs = Math.max(0, n(x.hours));
    const ri = roleMap[x.role] ?? 1;
    const ci = cxMap[x.complexity] ?? 1;
    const ui = urMap[x.urgency] ?? 0;

    const baseEffort = (sc.base * qty * rnd) + hrs;
    total += baseEffort * sc.role[ri] * sc.cx[ci] * sc.ur[ui];
  });
  return total;
}

function normalizeAndCap(sectionName, rawScore){
  const months = periodMonths(state.profile.period);
  const perMonth = (months>0) ? (Math.max(0,n(rawScore)) / months) : Math.max(0,n(rawScore));
  const capCfg = state.scheme.caps[sectionName] || {cap:0, rate:1};
  return applySoftCap(perMonth, capCfg.cap, capCfg.rate);
}

/* =========================================================
   Benchmarks interpretation text
========================================================= */
function benchmarkText(index){
  const b = state.benchmarks;
  const parts = [];

  if(n(b.avg)>0){
    if(index < b.avg - 5) parts.push(`Below faculty average (${b.avg.toFixed(1)}).`);
    else if(index > b.avg + 5) parts.push(`Above faculty average (${b.avg.toFixed(1)}).`);
    else parts.push(`Around faculty average (${b.avg.toFixed(1)}).`);
  }

  const p25=n(b.p25), p50=n(b.p50), p75=n(b.p75);
  if(p75>0 && p50>0 && p25>0){
    let band = "";
    if(index < p25) band = "Below 25th percentile (lighter workload relative to peers).";
    else if(index < p50) band = "Between 25th–50th percentile.";
    else if(index < p75) band = "Between 50th–75th percentile.";
    else band = "Above 75th percentile (heavier workload relative to peers).";
    parts.push(band);
  }

  if(parts.length===0) return "No benchmarks set in advanced settings.";
  return parts.join(" ");
}
</script>

<script>
/* =========================================================
   Tables: renderAll()
========================================================= */
let chart=null;

const deleteButtonHTML = (label="Delete record") => `
  <button class="btn btn-danger btn-sm btn-icon" data-act="del" aria-label="${label}">
    <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M9 3h6l1 2h5v2H3V5h5l1-2Zm1 6h2v9h-2V9Zm4 0h2v9h-2V9ZM6 9h2v9H6V9Zm1 12h10a2 2 0 0 0 2-2V9H5v10a2 2 0 0 0 2 2Z"/></svg>
  </button>`;

function renderAll(){
  renderTeaching();
  renderSupervision();
  renderResearch();
  renderPublication();
  renderAdministration();
  renderServices();
  renderLabOps();
  renderProSch();
}

/* =========================================================
   Teaching table
========================================================= */
function renderTeaching(){
  const tb = $("tblTeach").querySelector("tbody");
  tb.innerHTML="";
  state.data.teaching.forEach(r=>{
    const tr=document.createElement("tr"); tr.dataset.id=r.id;
    tr.innerHTML=`
      <td data-label="Course Code *"><input data-k="code" placeholder="e.g., SJ24102"/></td>
      <td data-label="Course Title *"><input data-k="name" placeholder="Course title"/></td>
      <td data-label="Credit"><input data-k="credit" disabled/></td>
      <td data-label="Students *"><input data-k="students" type="number" min="0" step="1"/></td>
      <td data-label="Lecture *"><input data-k="lecture" type="number" min="0" step="0.5"/></td>
      <td data-label="Tutorial *"><input data-k="tutorial" type="number" min="0" step="0.5"/></td>
      <td data-label="Lab *"><input data-k="laboratory" type="number" min="0" step="0.5"/></td>
      <td data-label="Field *"><input data-k="field" type="number" min="0" step="0.5"/></td>
      <td data-label="Contact Hours"><input data-k="contact" disabled/></td>
      <td class="cell-actions" data-label="Action">${deleteButtonHTML("Delete course")}</td>
    `;
    tb.appendChild(tr);

    tr.querySelector('[data-k="code"]').value=r.code || "";
    tr.querySelector('[data-k="name"]').value=r.name || "";
    tr.querySelector('[data-k="credit"]').value=r.credit || 0;
    tr.querySelector('[data-k="students"]').value=n(r.students)||0;
    tr.querySelector('[data-k="lecture"]').value=n(r.lecture)||0;
    tr.querySelector('[data-k="tutorial"]').value=n(r.tutorial)||0;
    tr.querySelector('[data-k="laboratory"]').value=n(r.laboratory)||0;
    tr.querySelector('[data-k="field"]').value=n(r.field)||0;
    tr.querySelector('[data-k="contact"]').value=contactHoursRow(r).toFixed(1);

    tr.addEventListener("input",(e)=>{
      const k=e.target.getAttribute("data-k"); if(!k) return;
      const obj=state.data.teaching.find(x=>x.id===tr.dataset.id); if(!obj) return;

      if(k==="code"){
        obj.code = (e.target.value||"").toUpperCase();
        obj.credit = creditFromCode(obj.code);
        tr.querySelector('[data-k="credit"]').value=obj.credit;
      } else if(k==="name"){
        obj.name = e.target.value || "";
      } else if(["students","lecture","tutorial","laboratory","field"].includes(k)){
        obj[k] = Math.max(0, n(e.target.value));
        e.target.value = obj[k];
        tr.querySelector('[data-k="contact"]').value = contactHoursRow(obj).toFixed(1);
      }
      autosave();
    });

    tr.addEventListener("click",(e)=>{
      if(e.target?.getAttribute("data-act")==="del"){
        if(!confirmDelete("Delete this course record?")) return;
        state.data.teaching = state.data.teaching.filter(x=>x.id!==tr.dataset.id);
        ensureSeed(); renderAll(); autosave();
      }
    });
  });
}

/* =========================================================
   Supervision table
========================================================= */
function renderSupervision(){
  const tb=$("tblSv").querySelector("tbody");
  tb.innerHTML="";
  state.data.supervision.forEach(r=>{
    const tr=document.createElement("tr"); tr.dataset.id=r.id;
    tr.innerHTML=`
      <td data-label="Level *">
        <select data-k="level">
          <option>Undergraduate</option>
          <option>Master</option>
          <option>PhD</option>
        </select>
      </td>
      <td data-label="Student / Project *"><input data-k="title" placeholder="Student name or project"/></td>
      <td data-label="Role *">
        <select data-k="role">
          <option>Main</option>
          <option>Co-supervisor</option>
        </select>
      </td>
      <td data-label="Status *">
        <select data-k="status">
          <option>Active</option>
          <option>Completed</option>
        </select>
      </td>
      <td data-label="Start Date *"><input data-k="start" type="date"/></td>
      <td data-label="End Date *"><input data-k="end" type="date"/></td>
      <td class="cell-actions" data-label="Action">${deleteButtonHTML("Delete supervision record")}</td>
    `;
    tb.appendChild(tr);

    tr.querySelector('[data-k="level"]').value=r.level || "Undergraduate";
    tr.querySelector('[data-k="title"]').value=r.title || "";
    tr.querySelector('[data-k="role"]').value=r.role || "Main";
    tr.querySelector('[data-k="status"]').value=r.status || "Active";
    tr.querySelector('[data-k="start"]').value=r.start || "";
    tr.querySelector('[data-k="end"]').value=r.end || "";

    tr.addEventListener("input",(e)=>{
      const k=e.target.getAttribute("data-k"); if(!k) return;
      const obj=state.data.supervision.find(x=>x.id===tr.dataset.id); if(!obj) return;
      obj[k]=e.target.value;
      autosave();
    });

    tr.addEventListener("click",(e)=>{
      if(e.target?.getAttribute("data-act")==="del"){
        if(!confirmDelete("Delete this supervision record?")) return;
        state.data.supervision = state.data.supervision.filter(x=>x.id!==tr.dataset.id);
        ensureSeed(); renderAll(); autosave();
      }
    });
  });
}

/* =========================================================
   Research table
========================================================= */
function renderResearch(){
  const tb=$("tblRes").querySelector("tbody");
  tb.innerHTML="";
  state.data.research.forEach(r=>{
    const tr=document.createElement("tr"); tr.dataset.id=r.id;
    tr.innerHTML=`
      <td data-label="Grant Code *"><input data-k="code" placeholder="Grant code"/></td>
      <td data-label="Title *"><input data-k="title" placeholder="Grant title"/></td>
      <td data-label="Level *">
        <select data-k="level">
          <option>University</option>
          <option>National</option>
          <option>International</option>
        </select>
      </td>
      <td data-label="Status *">
        <select data-k="status">
          <option>Active</option>
          <option>Applied</option>
          <option>Ended</option>
        </select>
      </td>
      <td data-label="Role *">
        <select data-k="role">
          <option>PI</option>
          <option>Co-I</option>
          <option>Member</option>
        </select>
      </td>
      <td data-label="Amount (RM) *"><input data-k="amount" type="number" min="0" step="1" placeholder="RM"/></td>
      <td data-label="Start Date *"><input data-k="start" type="date"/></td>
      <td data-label="End Date *"><input data-k="end" type="date"/></td>
      <td class="cell-actions" data-label="Action">${deleteButtonHTML("Delete research record")}</td>
    `;
    tb.appendChild(tr);

    tr.querySelector('[data-k="code"]').value=r.code || "";
    tr.querySelector('[data-k="title"]').value=r.title || "";
    tr.querySelector('[data-k="level"]').value=r.level || "University";
    tr.querySelector('[data-k="status"]').value=r.status || "Active";
    tr.querySelector('[data-k="role"]').value=r.role || "PI";
    tr.querySelector('[data-k="amount"]').value=n(r.amount)||0;
    tr.querySelector('[data-k="start"]').value=r.start || "";
    tr.querySelector('[data-k="end"]').value=r.end || "";

    tr.addEventListener("input",(e)=>{
      const k=e.target.getAttribute("data-k"); if(!k) return;
      const obj=state.data.research.find(x=>x.id===tr.dataset.id); if(!obj) return;
      if(k==="amount"){
        obj.amount = Math.max(0, n(e.target.value));
        e.target.value = obj.amount;
      }else{
        obj[k] = e.target.value;
      }
      autosave();
    });

    tr.addEventListener("click",(e)=>{
      if(e.target?.getAttribute("data-act")==="del"){
        if(!confirmDelete("Delete this research record?")) return;
        state.data.research = state.data.research.filter(x=>x.id!==tr.dataset.id);
        ensureSeed(); renderAll(); autosave();
      }
    });
  });
}

/* =========================================================
   Publication table
========================================================= */
function renderPublication(){
  const tb=$("tblPub").querySelector("tbody");
  tb.innerHTML="";
  state.data.publication.forEach(r=>{
    const tr=document.createElement("tr"); tr.dataset.id=r.id;
    tr.innerHTML=`
      <td data-label="Year *"><input data-k="year" type="number" min="1990" step="1"/></td>
      <td data-label="Title *"><input data-k="title" placeholder="Publication title"/></td>
      <td data-label="Type *">
        <select data-k="type">
          <option>Journal</option>
          <option>Book/Chapter</option>
          <option>Proceeding</option>
          <option>Other</option>
        </select>
      </td>
      <td data-label="Indexed? *">
        <select data-k="indexed">
          <option>Yes</option>
          <option>No</option>
        </select>
      </td>
      <td data-label="Role *">
        <select data-k="role">
          <option>First/Corresponding</option>
          <option>Co-author</option>
        </select>
      </td>
      <td data-label="Start Date *"><input data-k="start" type="date"/></td>
      <td data-label="End Date *"><input data-k="end" type="date"/></td>
      <td class="cell-actions" data-label="Action">${deleteButtonHTML("Delete publication record")}</td>
    `;
    tb.appendChild(tr);

    tr.querySelector('[data-k="year"]').value = r.year || (new Date()).getFullYear();
    tr.querySelector('[data-k="title"]').value = r.title || "";
    tr.querySelector('[data-k="type"]').value = r.type || "Journal";
    tr.querySelector('[data-k="indexed"]').value = r.indexed || "Yes";
    tr.querySelector('[data-k="role"]').value = r.role || "First/Corresponding";
    tr.querySelector('[data-k="start"]').value = r.start || "";
    tr.querySelector('[data-k="end"]').value = r.end || "";

    tr.addEventListener("input",(e)=>{
      const k=e.target.getAttribute("data-k"); if(!k) return;
      const obj=state.data.publication.find(x=>x.id===tr.dataset.id); if(!obj) return;

      if(k==="year"){
        obj.year = Math.max(1990, Math.floor(n(e.target.value) || (new Date()).getFullYear()));
        e.target.value = obj.year;
      }else{
        obj[k] = e.target.value;
      }
      autosave();
    });

    tr.addEventListener("click",(e)=>{
      if(e.target?.getAttribute("data-act")==="del"){
        if(!confirmDelete("Delete this publication record?")) return;
        state.data.publication = state.data.publication.filter(x=>x.id!==tr.dataset.id);
        ensureSeed(); renderAll(); autosave();
      }
    });
  });
}

/* =========================================================
   Administration table
========================================================= */
function renderAdministration(){
  const tb=$("tblAdmin").querySelector("tbody");
  tb.innerHTML="";
  state.data.admin.forEach(r=>{
    const tr=document.createElement("tr"); tr.dataset.id=r.id;
    tr.innerHTML=`
      <td data-label="Position *"><input data-k="position" placeholder="Position or appointment"/></td>
      <td data-label="Type *">
        <select data-k="type">
          <option>Official</option>
          <option>Ad-hoc</option>
        </select>
      </td>
      <td data-label="Level *">
        <select data-k="level">
          <option>Programme</option>
          <option>Faculty</option>
          <option>University</option>
          <option>State</option>
          <option>National</option>
          <option>International</option>
          <option>Industry</option>
        </select>
      </td>
      <td data-label="Months *"><input data-k="months" type="number" min="0" step="1"/></td>
      <td data-label="Meetings *"><input data-k="meetings" type="number" min="0" step="1"/></td>
      <td data-label="Workload Notes *"><textarea data-k="notes" rows="2" placeholder="Key workload notes"></textarea></td>
      <td data-label="Start Date *"><input data-k="start" type="date"/></td>
      <td data-label="End Date *"><input data-k="end" type="date"/></td>
      <td class="cell-actions" data-label="Action">${deleteButtonHTML("Delete administration record")}</td>
    `;
    tb.appendChild(tr);

    tr.querySelector('[data-k="position"]').value = r.position || "";
    tr.querySelector('[data-k="type"]').value = r.type || "Official";
    tr.querySelector('[data-k="level"]').value = r.level || "Faculty";
    tr.querySelector('[data-k="months"]').value = Math.max(0, Math.floor(n(r.months)));
    tr.querySelector('[data-k="meetings"]').value = Math.max(0, Math.floor(n(r.meetings)));
    tr.querySelector('[data-k="notes"]').value = r.notes || "";
    tr.querySelector('[data-k="start"]').value = r.start || "";
    tr.querySelector('[data-k="end"]').value = r.end || "";

    tr.addEventListener("input",(e)=>{
      const k=e.target.getAttribute("data-k"); if(!k) return;
      const obj=state.data.admin.find(x=>x.id===tr.dataset.id); if(!obj) return;

      if(k==="months" || k==="meetings"){
        obj[k] = Math.max(0, Math.floor(n(e.target.value)));
        e.target.value = obj[k];
      }else{
        obj[k] = e.target.value;
      }
      autosave();
    });

    tr.addEventListener("click",(e)=>{
      if(e.target?.getAttribute("data-act")==="del"){
        if(!confirmDelete("Delete this administration record?")) return;
        state.data.admin = state.data.admin.filter(x=>x.id!==tr.dataset.id);
        ensureSeed(); renderAll(); autosave();
      }
    });
  });
}

/* =========================================================
   Services table
========================================================= */
function renderServices(){
  const tb=$("tblSvc").querySelector("tbody");
  tb.innerHTML="";
  state.data.service.forEach(r=>{
    const tr=document.createElement("tr"); tr.dataset.id=r.id;
    tr.innerHTML=`
      <td data-label="Service Type *">
        <select data-k="type">
          <option>Service to University</option>
          <option>Service to Industry</option>
          <option>Service to Community</option>
          <option>Other</option>
        </select>
      </td>
      <td data-label="Activity *"><textarea data-k="activity" rows="2" placeholder="Describe the activity"></textarea></td>
      <td data-label="Role *">
        <select data-k="role">
          <option>Lead</option>
          <option>Member</option>
        </select>
      </td>
      <td data-label="Hours *"><input data-k="hours" type="number" min="0" step="0.5"/></td>
      <td data-label="Participants *"><input data-k="participants" type="number" min="0" step="1"/></td>
      <td data-label="Start Date *"><input data-k="start" type="date"/></td>
      <td data-label="End Date *"><input data-k="end" type="date"/></td>
      <td class="cell-actions" data-label="Action">${deleteButtonHTML("Delete service record")}</td>
    `;
    tb.appendChild(tr);

    tr.querySelector('[data-k="type"]').value = r.type || "Service to University";
    tr.querySelector('[data-k="activity"]').value = r.activity || "";
    tr.querySelector('[data-k="role"]').value = r.role || "Lead";
    tr.querySelector('[data-k="hours"]').value = Math.max(0, n(r.hours));
    tr.querySelector('[data-k="participants"]').value = Math.max(0, Math.floor(n(r.participants)));
    tr.querySelector('[data-k="start"]').value = r.start || "";
    tr.querySelector('[data-k="end"]').value = r.end || "";

    tr.addEventListener("input",(e)=>{
      const k=e.target.getAttribute("data-k"); if(!k) return;
      const obj=state.data.service.find(x=>x.id===tr.dataset.id); if(!obj) return;

      if(k==="hours"){
        obj.hours = Math.max(0, n(e.target.value));
        e.target.value = obj.hours;
      } else if(k==="participants"){
        obj.participants = Math.max(0, Math.floor(n(e.target.value)));
        e.target.value = obj.participants;
      } else {
        obj[k] = e.target.value;
      }
      autosave();
    });

    tr.addEventListener("click",(e)=>{
      if(e.target?.getAttribute("data-act")==="del"){
        if(!confirmDelete("Delete this service record?")) return;
        state.data.service = state.data.service.filter(x=>x.id!==tr.dataset.id);
        ensureSeed(); renderAll(); autosave();
      }
    });
  });
}

/* =========================================================
   Lab Operations table
========================================================= */
function renderLabOps(){
  const tb=$("tblLab").querySelector("tbody");
  tb.innerHTML="";
  state.data.lab.forEach(r=>{
    const tr=document.createElement("tr"); tr.dataset.id=r.id;
    tr.innerHTML=`
      <td data-label="Activity Type *">
        <select data-k="type">
          <option>Lab Sessions Support</option>
          <option>Equipment/Maintenance</option>
          <option>Safety/Compliance</option>
          <option>Consumables/Procurement</option>
          <option>Field/Site Work</option>
          <option>Other</option>
        </select>
      </td>
      <td data-label="Description *"><textarea data-k="desc" rows="2" placeholder="Describe briefly"></textarea></td>
      <td data-label="Volume *"><input data-k="volume" type="number" min="0" step="1"/></td>
      <td data-label="Complexity *">
        <select data-k="complexity">
          <option>Low</option><option>Medium</option><option>High</option>
        </select>
      </td>
      <td data-label="Urgency *">
        <select data-k="urgency">
          <option>Normal</option><option>Tight</option><option>Critical</option>
        </select>
      </td>
      <td data-label="Hours *"><input data-k="hours" type="number" min="0" step="0.5"/></td>
      <td data-label="Start Date *"><input data-k="start" type="date"/></td>
      <td data-label="End Date *"><input data-k="end" type="date"/></td>
      <td class="cell-actions" data-label="Action">${deleteButtonHTML("Delete lab operations record")}</td>
    `;
    tb.appendChild(tr);

    tr.querySelector('[data-k="type"]').value = r.type || "Equipment/Maintenance";
    tr.querySelector('[data-k="desc"]').value = r.desc || "";
    tr.querySelector('[data-k="volume"]').value = Math.max(0, Math.floor(n(r.volume)));
    tr.querySelector('[data-k="complexity"]').value = r.complexity || "Medium";
    tr.querySelector('[data-k="urgency"]').value = r.urgency || "Normal";
    tr.querySelector('[data-k="hours"]').value = Math.max(0, n(r.hours));
    tr.querySelector('[data-k="start"]').value = r.start || "";
    tr.querySelector('[data-k="end"]').value = r.end || "";

    tr.addEventListener("input",(e)=>{
      const k=e.target.getAttribute("data-k"); if(!k) return;
      const obj=state.data.lab.find(x=>x.id===tr.dataset.id); if(!obj) return;

      if(k==="volume"){
        obj.volume = Math.max(0, Math.floor(n(e.target.value)));
        e.target.value = obj.volume;
      } else if(k==="hours"){
        obj.hours = Math.max(0, n(e.target.value));
        e.target.value = obj.hours;
      } else {
        obj[k] = e.target.value;
      }
      autosave();
    });

    tr.addEventListener("click",(e)=>{
      if(e.target?.getAttribute("data-act")==="del"){
        if(!confirmDelete("Delete this lab operations record?")) return;
        state.data.lab = state.data.lab.filter(x=>x.id!==tr.dataset.id);
        ensureSeed(); renderAll(); autosave();
      }
    });
  });
}

/* =========================================================
   Professional & Scholarly Service table
========================================================= */
function renderProSch(){
  const tb=$("tblProSch").querySelector("tbody");
  tb.innerHTML="";
  state.data.prosch.forEach(r=>{
    const tr=document.createElement("tr"); tr.dataset.id=r.id;
    tr.innerHTML=`
      <td data-label="Activity Type *">
        <select data-k="activityType">
          <option>Reviewer</option>
          <option>Editor</option>
          <option>External Examiner</option>
          <option>Internal Examiner</option>
          <option>Conference Committee</option>
          <option>Journal Editorial Board</option>
          <option>Grant Panel / Assessor</option>
          <option>Other</option>
        </select>
      </td>
      <td data-label="Description *"><textarea data-k="desc" rows="2" placeholder="Describe task (journal/conference/thesis scope, key notes)"></textarea></td>
      <td data-label="Role *">
        <select data-k="role">
          <option>Lead</option>
          <option>Member</option>
        </select>
      </td>
      <td data-label="Quantity *"><input data-k="quantity" type="number" min="0" step="1" placeholder="e.g., 3"/></td>
      <td data-label="Rounds *"><input data-k="rounds" type="number" min="1" step="1" placeholder="e.g., 2"/></td>
      <td data-label="Complexity *">
        <select data-k="complexity">
          <option>Low</option><option>Medium</option><option>High</option>
        </select>
      </td>
      <td data-label="Urgency *">
        <select data-k="urgency">
          <option>Normal</option><option>Tight</option><option>Critical</option>
        </select>
      </td>
      <td data-label="Hours (optional)"><input data-k="hours" type="number" min="0" step="0.5" placeholder="optional"/></td>
      <td data-label="Start Date *"><input data-k="start" type="date"/></td>
      <td data-label="End Date *"><input data-k="end" type="date"/></td>
      <td class="cell-actions" data-label="Action">${deleteButtonHTML("Delete professional service record")}</td>
    `;
    tb.appendChild(tr);

    tr.querySelector('[data-k="activityType"]').value = r.activityType || "Reviewer";
    tr.querySelector('[data-k="desc"]').value = r.desc || "";
    tr.querySelector('[data-k="role"]').value = r.role || "Member";
    tr.querySelector('[data-k="quantity"]').value = Math.max(0, Math.floor(n(r.quantity) || 0));
    tr.querySelector('[data-k="rounds"]').value = Math.max(1, Math.floor(n(r.rounds) || 1));
    tr.querySelector('[data-k="complexity"]').value = r.complexity || "Medium";
    tr.querySelector('[data-k="urgency"]').value = r.urgency || "Normal";
    tr.querySelector('[data-k="hours"]').value = Math.max(0, n(r.hours) || 0);
    tr.querySelector('[data-k="start"]').value = r.start || "";
    tr.querySelector('[data-k="end"]').value = r.end || "";

    tr.addEventListener("input",(e)=>{
      const k=e.target.getAttribute("data-k"); if(!k) return;
      const obj=state.data.prosch.find(x=>x.id===tr.dataset.id); if(!obj) return;

      if(k==="quantity"){
        obj.quantity = Math.max(0, Math.floor(n(e.target.value)));
        e.target.value = obj.quantity;
      } else if(k==="rounds"){
        obj.rounds = Math.max(1, Math.floor(n(e.target.value) || 1));
        e.target.value = obj.rounds;
      } else if(k==="hours"){
        obj.hours = Math.max(0, n(e.target.value));
        e.target.value = obj.hours;
      } else {
        obj[k] = e.target.value;
      }
      autosave();
    });

    tr.addEventListener("click",(e)=>{
      if(e.target?.getAttribute("data-act")==="del"){
        if(!confirmDelete("Delete this professional service record?")) return;
        state.data.prosch = state.data.prosch.filter(x=>x.id!==tr.dataset.id);
        ensureSeed(); renderAll(); autosave();
      }
    });
  });
}

/* =========================================================
   Add / Clear actions
========================================================= */
function addRow(kind){
  if(kind==="teach") state.data.teaching.push({id:uid(), code:"", name:"", credit:0, students:0, lecture:0, tutorial:0, laboratory:0, field:0});
  if(kind==="sv") state.data.supervision.push({id:uid(), level:"Undergraduate", title:"", role:"Main", status:"Active", start:"", end:""});

  if(kind==="res") state.data.research.push({
    id:uid(),
    code:"",
    title:"",
    level:"University",
    status:"Active",
    role:"PI",
    amount:0,
    start:"",
    end:""
  });

  if(kind==="pub") state.data.publication.push({
    id:uid(),
    year:(new Date()).getFullYear(),
    title:"",
    type:"Journal",
    indexed:"Yes",
    role:"First/Corresponding",
    start:"",
    end:""
  });

  if(kind==="admin") state.data.admin.push({id:uid(), position:"", type:"Official", level:"Faculty", months:0, meetings:0, notes:"", start:"", end:""});
  if(kind==="svc") state.data.service.push({id:uid(), type:"Service to University", activity:"", role:"Lead", hours:0, participants:0, start:"", end:""});
  if(kind==="lab") state.data.lab.push({id:uid(), type:"Equipment/Maintenance", desc:"", volume:0, complexity:"Medium", urgency:"Normal", hours:0, start:"", end:""});
  if(kind==="ps") state.data.prosch.push({id:uid(), activityType:"Reviewer", desc:"", role:"Member", quantity:1, rounds:1, complexity:"Medium", urgency:"Normal", hours:0, start:"", end:""});
  renderAll(); autosave();
}

function clearKind(kind){
  if(kind==="teach") state.data.teaching=[];
  if(kind==="sv") state.data.supervision=[];
  if(kind==="res") state.data.research=[];
  if(kind==="pub") state.data.publication=[];
  if(kind==="admin") state.data.admin=[];
  if(kind==="svc") state.data.service=[];
  if(kind==="lab") state.data.lab=[];
  if(kind==="ps") state.data.prosch=[];
  ensureSeed(); renderAll(); autosave();
}

/* =========================================================
   Validation (activity tables)
========================================================= */
function validateActivityTables(){
  document.querySelectorAll("input.err,select.err,textarea.err").forEach(el=>el.classList.remove("err"));
  let ok=true;

  const requireText = (el)=>{ if(!el || !String(el.value||"").trim()){ el?.classList.add("err"); ok=false; } };
  const requireNonNeg = (el, strictPositive=false)=>{
    const v=n(el?.value);
    if(v<0 || (strictPositive && v<=0)){ el?.classList.add("err"); ok=false; }
  };
  const requireDate = (el)=>{ if(!el || !el.value){ el?.classList.add("err"); ok=false; } };

  if(state.enabled.Teaching){
    $("tblTeach").querySelectorAll("tbody tr").forEach(tr=>{
      requireText(tr.querySelector('[data-k="code"]'));
      requireText(tr.querySelector('[data-k="name"]'));
      requireNonNeg(tr.querySelector('[data-k="students"]'), true);
      ["lecture","tutorial","laboratory","field"].forEach(k=>requireNonNeg(tr.querySelector(`[data-k="${k}"]`), false));
    });
  }

  if(state.enabled.Supervision){
    $("tblSv").querySelectorAll("tbody tr").forEach(tr=>{
      requireText(tr.querySelector('[data-k="title"]'));
      requireDate(tr.querySelector('[data-k="start"]'));
      requireDate(tr.querySelector('[data-k="end"]'));
    });
  }

  if(state.enabled.Research){
    $("tblRes").querySelectorAll("tbody tr").forEach(tr=>{
      requireText(tr.querySelector('[data-k="code"]'));
      requireText(tr.querySelector('[data-k="title"]'));
      requireNonNeg(tr.querySelector('[data-k="amount"]'), true);
      requireDate(tr.querySelector('[data-k="start"]'));
      requireDate(tr.querySelector('[data-k="end"]'));
    });
  }

  if(state.enabled.Publication){
    $("tblPub").querySelectorAll("tbody tr").forEach(tr=>{
      requireNonNeg(tr.querySelector('[data-k="year"]'), true);
      requireText(tr.querySelector('[data-k="title"]'));
      requireDate(tr.querySelector('[data-k="start"]'));
      requireDate(tr.querySelector('[data-k="end"]'));
    });
  }

  if(state.enabled.Administration){
    $("tblAdmin").querySelectorAll("tbody tr").forEach(tr=>{
      requireText(tr.querySelector('[data-k="position"]'));
      requireNonNeg(tr.querySelector('[data-k="months"]'), true);
      requireNonNeg(tr.querySelector('[data-k="meetings"]'), false);
      requireText(tr.querySelector('[data-k="notes"]'));
      requireDate(tr.querySelector('[data-k="start"]'));
      requireDate(tr.querySelector('[data-k="end"]'));
    });
  }

  if(state.enabled.Services){
    $("tblSvc").querySelectorAll("tbody tr").forEach(tr=>{
      requireText(tr.querySelector('[data-k="activity"]'));
      requireNonNeg(tr.querySelector('[data-k="hours"]'), true);
      requireNonNeg(tr.querySelector('[data-k="participants"]'), true);
      requireDate(tr.querySelector('[data-k="start"]'));
      requireDate(tr.querySelector('[data-k="end"]'));
    });
  }

  if(state.enabled.LabOps){
    $("tblLab").querySelectorAll("tbody tr").forEach(tr=>{
      requireText(tr.querySelector('[data-k="desc"]'));
      requireNonNeg(tr.querySelector('[data-k="volume"]'), true);
      requireNonNeg(tr.querySelector('[data-k="hours"]'), true);
      requireDate(tr.querySelector('[data-k="start"]'));
      requireDate(tr.querySelector('[data-k="end"]'));
    });
  }

  if(state.enabled.ProSch){
    $("tblProSch").querySelectorAll("tbody tr").forEach(tr=>{
      requireText(tr.querySelector('[data-k="desc"]'));
      requireNonNeg(tr.querySelector('[data-k="quantity"]'), true);
      requireNonNeg(tr.querySelector('[data-k="rounds"]'), true);
      requireDate(tr.querySelector('[data-k="start"]'));
      requireDate(tr.querySelector('[data-k="end"]'));
    });
  }

  if(!ok){
    showMsg("warn","<b>Validation:</b> Please fill all required fields (no empty/negative values). Highlighted boxes require attention.");
  }
  return ok;
}

/* =========================================================
   Banding (interpretation)
========================================================= */
function bandFromIndex(x){
  if(x<20) return {label:"Low workload (per month)", cls:"ok"};
  if(x<45) return {label:"Normal workload (per month)", cls:"ok"};
  if(x<70) return {label:"High workload (per month)", cls:"warn"};
  return {label:"Overload risk (per month)", cls:"bad"};
}

/* =========================================================
   Narrative
========================================================= */
function narrative(scores, aw){
  const items = [
    ["Teaching", scores.Teaching, aw.Teaching, state.enabled.Teaching],
    ["Student Supervision", scores.Supervision, aw.Supervision, state.enabled.Supervision],
    ["Research", scores.Research, aw.Research, state.enabled.Research],
    ["Publication", scores.Publication, aw.Publication, state.enabled.Publication],
    ["Administration", scores.Administration, aw.Administration, state.enabled.Administration],
    ["Service & Engagement", scores.Services, aw.Services, state.enabled.Services],
    ["Laboratory Operations", scores.LabOps, aw.LabOps, state.enabled.LabOps],
    ["Professional & Scholarly Service", scores.ProSch, aw.ProSch, state.enabled.ProSch]
  ].filter(x=>x[3]);

  items.sort((a,b)=> (b[1]*b[2]) - (a[1]*a[2]));
  const top = items[0];
  const second = items[1] || null;
  const last = items[items.length-1];

  const topText = top ? `${top[0]} (weighted contribution ${(top[1]*top[2]).toFixed(1)})` : "—";
  const secondText = second ? `${second[0]} (${(second[1]*second[2]).toFixed(1)})` : "";
  const lowText = last ? `${last[0]} (weighted contribution ${(last[1]*last[2]).toFixed(1)})` : "—";

  return `Most of the workload is driven by ${topText}${secondText ? `, followed by ${secondText}` : ""}. The lowest contribution is from ${lowText}. This index measures workload intensity (busyness), not performance or quality.`;
}

function renderTopContributors(scores, aw){
  const items = [
    {label:"Teaching", value:scores.Teaching*aw.Teaching, enabled:state.enabled.Teaching},
    {label:"Student Supervision", value:scores.Supervision*aw.Supervision, enabled:state.enabled.Supervision},
    {label:"Research", value:scores.Research*aw.Research, enabled:state.enabled.Research},
    {label:"Publication", value:scores.Publication*aw.Publication, enabled:state.enabled.Publication},
    {label:"Administration", value:scores.Administration*aw.Administration, enabled:state.enabled.Administration},
    {label:"Service & Engagement", value:scores.Services*aw.Services, enabled:state.enabled.Services},
    {label:"Laboratory Operations", value:scores.LabOps*aw.LabOps, enabled:state.enabled.LabOps},
    {label:"Professional & Scholarly Service", value:scores.ProSch*aw.ProSch, enabled:state.enabled.ProSch}
  ].filter(x=>x.enabled);

  items.sort((a,b)=>b.value-a.value);
  const top = items.slice(0,3);
  const list = $("outTop3");
  list.innerHTML = "";
  if(top.length===0){
    const li = document.createElement("li");
    li.textContent = "—";
    list.appendChild(li);
    return;
  }
  top.forEach(item=>{
    const li = document.createElement("li");
    li.innerHTML = `<strong>${item.label}</strong> — ${item.value.toFixed(1)} weighted points`;
    list.appendChild(li);
  });
}

function deanViewSummary(index, band, aw){
  const labelMap = {
    Supervision:"Student Supervision",
    Services:"Service & Engagement",
    LabOps:"Laboratory Operations",
    ProSch:"Professional & Scholarly Service"
  };
  const on = Object.entries(state.enabled)
    .filter(([k,v])=>v)
    .map(([k])=>labelMap[k] || k)
    .join(", ");
  const w = Object.entries(aw)
    .filter(([k,v])=>v>0)
    .map(([k,v])=>`${labelMap[k] || k}:${v.toFixed(2)}`)
    .join(" | ");
  const bm = benchmarkText(index);

  return `Name: ${state.profile.name} | Staff ID: ${state.profile.staffId} | Category: ${state.profile.category} | Reporting Period: ${state.profile.period} | Sections ON: ${on} | Normalized weights: ${w} | Busyness Index (points per month): ${index.toFixed(1)} (${band.label}) | Benchmark: ${bm}`;
}

/* =========================================================
   Chart
========================================================= */
function drawChart(scores, aw){
  const labels=[], vals=[], colors=[];
  const palette = {
    Teaching: "rgba(124,157,255,0.82)",
    Supervision: "rgba(60,201,255,0.82)",
    Research: "rgba(50,210,156,0.82)",
    Publication: "rgba(240,148,196,0.82)",
    Administration: "rgba(242,180,74,0.82)",
    Services: "rgba(251,136,152,0.82)",
    LabOps: "rgba(67,211,137,0.82)",
    ProSch: "rgba(160,170,190,0.82)"
  };
  const pushIf=(on,label,raw,w,color)=>{
    if(!on) return;
    labels.push(label);
    vals.push(raw*w);
    colors.push(color);
  };

  pushIf(state.enabled.Teaching, "Teaching", scores.Teaching, aw.Teaching, palette.Teaching);
  pushIf(state.enabled.Supervision, "Student Supervision", scores.Supervision, aw.Supervision, palette.Supervision);
  pushIf(state.enabled.Research, "Research", scores.Research, aw.Research, palette.Research);
  pushIf(state.enabled.Publication, "Publication", scores.Publication, aw.Publication, palette.Publication);
  pushIf(state.enabled.Administration, "Administration", scores.Administration, aw.Administration, palette.Administration);
  pushIf(state.enabled.Services, "Service & Engagement", scores.Services, aw.Services, palette.Services);
  pushIf(state.enabled.LabOps, "Laboratory Operations", scores.LabOps, aw.LabOps, palette.LabOps);
  pushIf(state.enabled.ProSch, "Professional & Scholarly Service", scores.ProSch, aw.ProSch, palette.ProSch);

  const ctx=$("chart").getContext("2d");
  if(chart) chart.destroy();
  chart=new Chart(ctx,{
    type:"bar",
    data:{ labels, datasets:[{ label:"Weighted contribution (section points per month × normalized weight)", data:vals, backgroundColor:colors, borderColor:colors, borderWidth:1 }] },
    options:{
      responsive:true,
      plugins:{ legend:{ labels:{ color:"#eaf0ff"} } },
      scales:{
        x:{ ticks:{ color:"#eaf0ff"} , grid:{ color:"rgba(255,255,255,.08)" } },
        y:{ ticks:{ color:"#eaf0ff"} , grid:{ color:"rgba(255,255,255,.08)" } }
      }
    }
  });
}

/* =========================================================
   Calculate
========================================================= */
function calculate(){
  hideMsg();
  syncProfileFromUI();
  syncEnabledFromUI();
  syncSettingsFromUI_ifAdmin();

  if(!validateProfile()) return;
  if(!validateToggles()) return;
  applySectionVisibility();
  ensureSeed();
  renderAll();

  if(!validateWeightsBaseline_ifAdmin()){
    showMsg("warn","<b>Settings validation:</b> Fix weights so baseline sum is 1.00.");
    return;
  }
  if(!validateActivityTables()) return;

  const aw = getActiveWeights();
  if(!aw){
    showMsg("bad","<b>Error:</b> Active weights are zero. Turn ON sections and ensure weights are not all zero.");
    return;
  }

  const raw = {
    Teaching: state.enabled.Teaching ? scoreTeaching_raw() : 0,
    Supervision: state.enabled.Supervision ? scoreSupervision_raw() : 0,
    Research: state.enabled.Research ? scoreResearch_raw() : 0,
    Publication: state.enabled.Publication ? scorePublication_raw() : 0,
    Administration: state.enabled.Administration ? scoreAdministration_raw() : 0,
    Services: state.enabled.Services ? scoreServices_raw() : 0,
    LabOps: state.enabled.LabOps ? scoreLabOps_raw() : 0,
    ProSch: state.enabled.ProSch ? scoreProSch_raw() : 0
  };

  const scores = {
    Teaching: state.enabled.Teaching ? normalizeAndCap("Teaching", raw.Teaching) : 0,
    Supervision: state.enabled.Supervision ? normalizeAndCap("Supervision", raw.Supervision) : 0,
    Research: state.enabled.Research ? normalizeAndCap("Research", raw.Research) : 0,
    Publication: state.enabled.Publication ? normalizeAndCap("Publication", raw.Publication) : 0,
    Administration: state.enabled.Administration ? normalizeAndCap("Administration", raw.Administration) : 0,
    Services: state.enabled.Services ? normalizeAndCap("Services", raw.Services) : 0,
    LabOps: state.enabled.LabOps ? normalizeAndCap("LabOps", raw.LabOps) : 0,
    ProSch: state.enabled.ProSch ? normalizeAndCap("ProSch", raw.ProSch) : 0
  };

  $("outTeaching").textContent = scores.Teaching.toFixed(1);
  $("outSupervision").textContent = scores.Supervision.toFixed(1);
  $("outResearch").textContent = scores.Research.toFixed(1);
  $("outPublication").textContent = scores.Publication.toFixed(1);
  $("outAdministration").textContent = scores.Administration.toFixed(1);
  $("outServices").textContent = scores.Services.toFixed(1);
  $("outLabOps").textContent = scores.LabOps.toFixed(1);
  $("outProSch").textContent = scores.ProSch.toFixed(1);

  const rawIndex =
    (scores.Teaching*aw.Teaching) +
    (scores.Supervision*aw.Supervision) +
    (scores.Research*aw.Research) +
    (scores.Publication*aw.Publication) +
    (scores.Administration*aw.Administration) +
    (scores.Services*aw.Services) +
    (scores.LabOps*aw.LabOps) +
    (scores.ProSch*aw.ProSch);

  const index = clamp(rawIndex, 0, 100);

  $("outIndex").textContent = index.toFixed(1);
  const b = bandFromIndex(index);
  $("outBand").textContent = b.label;

  $("outNarr").textContent = narrative(scores, aw);
  $("outDean").textContent = deanViewSummary(index, b, aw);
  renderTopContributors(scores, aw);

  updateBenchmarkUI(index);
  drawChart(scores, aw);

  state.audit.last_calc_at = new Date().toISOString();
  autosave();

  showMsg("ok", `<b>Calculated:</b> Busyness Index = <b>${index.toFixed(1)}</b> (${b.label}). Scores are normalized to points per month and apply diminishing returns (soft caps).`);
}

/* =========================================================
   Print helpers
========================================================= */
function syncPrintFields(){
  const name = (state.profile.name||"").trim();
  const id = (state.profile.staffId||"").trim();
  $("printName").textContent = name;
  $("printId").textContent = id;
  $("printDate").textContent = new Date().toLocaleString();
  $("printFooterDate").textContent = new Date().toLocaleDateString();
}
</script>

<script>
/* =========================================================
   EXPORT
========================================================= */
function download(filename, content, mime="text/plain"){
  const blob = new Blob([content], {type:mime});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href=url; a.download=filename; a.click();
  setTimeout(()=>URL.revokeObjectURL(url), 1500);
}

function exportSummaryCSV(){
  const aw = getActiveWeights() || {};
  const rows = [
    ["timestamp", new Date().toISOString()],
    ["name", state.profile.name],
    ["staff_id", state.profile.staffId],
    ["category", state.profile.category],
    ["unit", state.profile.unit],
    ["grade", (state.profile.grade==="Others")?state.profile.gradeOther:state.profile.grade],
    ["status", (state.profile.status==="Others")?state.profile.statusOther:state.profile.status],
    ["reporting_period", state.profile.period],
    ["months_in_period", periodMonths(state.profile.period)],
    ["enabled_sections", JSON.stringify(state.enabled)],
    ["baseline_weights", JSON.stringify(state.weights)],
    ["active_weights_normalized", JSON.stringify(aw)],
    ["Teaching_points_per_month", $("outTeaching").textContent],
    ["Supervision_points_per_month", $("outSupervision").textContent],
    ["Research_points_per_month", $("outResearch").textContent],
    ["Publication_points_per_month", $("outPublication").textContent],
    ["Administration_points_per_month", $("outAdministration").textContent],
    ["Services_points_per_month", $("outServices").textContent],
    ["Lab_Operations_points_per_month", $("outLabOps").textContent],
    ["Professional_and_Scholarly_Service_points_per_month", $("outProSch").textContent],
    ["busyness_index_points_per_month", $("outIndex").textContent],
    ["band", $("outBand").textContent],
    ["benchmark_avg", String(state.benchmarks?.avg ?? "")],
    ["benchmark_p25", String(state.benchmarks?.p25 ?? "")],
    ["benchmark_p50", String(state.benchmarks?.p50 ?? "")],
    ["benchmark_p75", String(state.benchmarks?.p75 ?? "")]
  ];
  const csv = rows.map(r=>r.map(x=>`"${String(x).replaceAll('"','""')}"`).join(",")).join("\n");
  download("FST_UMS_Busyness_Summary.csv", csv, "text/csv");
}

function exportDetailedCSV(){
  const lines = [];
  const pushSection = (name, arr)=>{
    lines.push(`SECTION,${name}`);
    if(!arr || arr.length===0){ lines.push("EMPTY"); lines.push(""); return; }
    const keys = Object.keys(arr[0]);
    lines.push(keys.join(","));
    arr.forEach(o=>{
      lines.push(keys.map(k=>`"${String(o[k]??"").replaceAll('"','""')}"`).join(","));
    });
    lines.push("");
  };

  pushSection("Teaching", state.data.teaching);
  pushSection("Supervision", state.data.supervision);
  pushSection("Research", state.data.research);
  pushSection("Publication", state.data.publication);
  pushSection("Administration", state.data.admin);
  pushSection("Services", state.data.service);
  pushSection("Lab Operations", state.data.lab);
  pushSection("Professional & Scholarly Service", state.data.prosch);

  download("FST_UMS_Busyness_Detailed.csv", lines.join("\n"), "text/csv");
}

function exportJSON(){
  const payload = {
    meta:{ generated_at:new Date().toISOString(), app:"FST UMS Staff Busyness Index", version:"2.0" },
    profile: state.profile,
    enabled_sections: state.enabled,
    baseline_weights: state.weights,
    active_weights_normalized: getActiveWeights(),
    scheme: state.scheme,
    benchmarks: state.benchmarks,
    period_months: periodMonths(state.profile.period),
    data: state.data,
    results:{
      Teaching_points_per_month: $("outTeaching").textContent,
      Supervision_points_per_month: $("outSupervision").textContent,
      Research_points_per_month: $("outResearch").textContent,
      Publication_points_per_month: $("outPublication").textContent,
      Administration_points_per_month: $("outAdministration").textContent,
      Services_points_per_month: $("outServices").textContent,
      Lab_Operations_points_per_month: $("outLabOps").textContent,
      Professional_and_Scholarly_Service_points_per_month: $("outProSch").textContent,
      busyness_index_points_per_month: $("outIndex").textContent,
      band: $("outBand").textContent,
      benchmark_text: $("outBenchmark").textContent,
      dean_summary: $("outDean").textContent,
      narrative: $("outNarr").textContent
    },
    audit: state.audit
  };
  download("FST_UMS_Busyness_Full.json", JSON.stringify(payload,null,2), "application/json");
}

/* =========================================================
   MANUAL PDF (Professional)
========================================================= */
function manualPDF(){
  const jsPDFLib = (window.jspdf && window.jspdf.jsPDF) || window.jsPDF;
  if(!jsPDFLib){
    showMsg("bad", "PDF generator not loaded. Please check your connection and try again.");
    return;
  }

  const doc = new jsPDFLib({unit:"pt", format:"a4"});
  const W = doc.internal.pageSize.getWidth();
  const H = doc.internal.pageSize.getHeight();
  const m = 44;
  let y = 48;

  const setBody = ()=>{ doc.setFont("helvetica","normal"); doc.setFontSize(11); doc.setTextColor(0,0,0); };
  const setSmall = ()=>{ doc.setFont("helvetica","normal"); doc.setFontSize(9); doc.setTextColor(60,60,60); };
  const setSubhead = ()=>{ doc.setFont("helvetica","bold"); doc.setFontSize(11); doc.setTextColor(0,0,0); };

  const newPageIfNeeded = (hNeed=0)=>{
    if(y + hNeed > H - m){
      doc.addPage();
      y = m;
    }
  };

  const hr = ()=>{
    newPageIfNeeded(12);
    doc.setDrawColor(180,180,180);
    doc.setLineWidth(0.8);
    doc.line(m, y, W-m, y);
    y += 12;
  };

  const headerBox = (title)=>{
    newPageIfNeeded(44);
    doc.setFillColor(235,235,235);
    doc.setDrawColor(160,160,160);
    doc.setLineWidth(0.8);
    doc.rect(m, y, W-m*2, 26, "FD");
    doc.setFont("helvetica","bold");
    doc.setFontSize(12);
    doc.setTextColor(0,0,0);
    doc.text(title, m+10, y+17);
    y += 36;
  };

  const paragraph = (text, fontSize=11)=>{
    setBody();
    doc.setFontSize(fontSize);
    const lines = doc.splitTextToSize(text, W - m*2);
    lines.forEach(line=>{
      newPageIfNeeded(fontSize+8);
      doc.text(line, m, y);
      y += fontSize + 6;
    });
  };

  const formula = (text)=>{
    newPageIfNeeded(18);
    doc.setFont("courier","normal");
    doc.setFontSize(10);
    doc.setTextColor(0,0,0);
    const lines = doc.splitTextToSize(text, W - m*2);
    lines.forEach(line=>{
      newPageIfNeeded(16);
      doc.text(line, m, y);
      y += 14;
    });
    setBody();
  };

  const bullet = (items)=>{
    items.forEach(it=>{
      const lines = doc.splitTextToSize(it, W - m*2 - 18);
      lines.forEach((ln,idx)=>{
        newPageIfNeeded(16);
        doc.setFont("helvetica","normal"); doc.setFontSize(11);
        doc.text(idx===0 ? "•" : " ", m, y);
        doc.text(ln, m+14, y);
        y += 14;
      });
    });
  };

  const subhead = (text)=>{
    newPageIfNeeded(18);
    setSubhead();
    doc.text(text, m, y);
    y += 16;
    setBody();
  };

  doc.setFont("helvetica","bold"); doc.setFontSize(16); doc.setTextColor(0,0,0);
  doc.text("FST UMS Staff Busyness Index", m, y); y+=18;
  doc.setFont("helvetica","normal"); doc.setFontSize(11);
  doc.text("Calculation Manual (Points per Month, with Soft Caps)", m, y); y+=14;
  setSmall();
  doc.text("This tool measures busyness (workload intensity) based on activities and time/effort proxies. It does not measure performance or quality.", m, y); y+=18;
  hr();

  headerBox("1. Purpose & How to Use");
  paragraph("This manual explains required fields, scoring logic, soft caps and worked examples for Academic, Administrative and Laboratory staff categories. The index captures workload intensity only.");
  bullet([
    "Choose reporting period (Monthly, Quarterly, Semester, Annual). All section scores are normalized to points per month.",
    "Select Category preset to auto-set ON/OFF sections and baseline weights. You may still toggle sections if needed.",
    "Fill required fields (marked *) in each section, then click Calculate. Use Print for a B/W summary or Export for CSV/JSON.",
    "Advanced settings can be unlocked locally to adjust baseline weights, caps and scoring parameters."
  ]);
  hr();

  headerBox("2. Required Fields & Data Entry");
  paragraph("Complete these inputs before calculating. Required fields are marked * inside the calculator.");
  bullet([
    "Profile: Name, Staff ID, Category (Academic / Administrative / Laboratory), Unit/School/Department, Grade (or Other + text), Status (or Other + text), Reporting Period.",
    "Section toggles: Turn ON only relevant sections. Category presets update ON/OFF and baseline weights automatically.",
    "Teaching: Course code and name, enrolled students, lecture/tutorial/lab/field contact hours, start/end. Credit is auto-read from the last digit of the course code; contact hours auto-sum.",
    "Student Supervision: Level (Undergraduate, Master, PhD), student/project title, role (Main/Co), status (Active/Completed/Applied), start/end.",
    "Research (Grants/Projects): Grant code, title, level (University/National/International), status, role (PI/Co-I/Member), amount (RM), start/end.",
    "Publication: Year, title, type (Journal/Book-Chapter/Proceeding/Other), indexed? (Yes/No), role (First/Corresponding/Co-Author), start/end.",
    "Administration: Position, type (Official/Other), level (Programme to Industry), months in role, meetings, workload notes, start/end.",
    "Service & Engagement: Service type, activity, role (Lead/Member), hours, participants, start/end.",
    "Laboratory Operations: Type, description, volume, complexity, urgency, hours, start/end. Turn ON for Laboratory staff or roles with lab duties.",
    "Professional & Scholarly Service: Activity type (Reviewer/Editor/Examiner/Committee), description, role, quantity, rounds, complexity, urgency, hours, start/end."
  ]);
  hr();

  headerBox("3. Calculation Pipeline");
  bullet([
    "A) Raw section score: computed per section using workload proxies (hours, students, rounds, meetings, etc.).",
    "B) Period normalization: raw section score / months_in_period (points per month).",
    "C) Soft caps (diminishing returns): prevent inflation when a section is extremely large.",
    "D) Weighting: normalized weights use only ON sections. Sum of normalized weights = 1.",
    "E) Clamp: final index is clamped between 0 and 100 points per month (for display consistency)."
  ]);
  formula(`months_in_period = { Monthly:1, Quarterly:3, Semester:6, Annual:12 }
section_points_per_month = section_points_total / months_in_period
soft_cap(x, cap, tail) = (x <= cap) ? x : cap + (x - cap) * tail    (0 < tail < 1)
normalized_weight_i = baseline_weight_i / sum(baseline weights for ON sections)
index = sum(adjusted_section_points_per_month_i * normalized_weight_i)
final_index = clamp(index, 0, 100)`);
  hr();

  headerBox("4. Section Formulas (Busyness-based)");
  formula(
`Teaching = sum[(contact_hours * hourW) + ((students/100) * studW) + (credit * creditW)]
Student Supervision = sum[base(level) * role_multiplier * status_multiplier]
Research = sum[base * level_multiplier * role_multiplier * status_multiplier]
Publication = sum[base * type_multiplier * indexed_multiplier * role_multiplier]
Administration = sum[(base(level) + meetings * meetW + months * monthW) * type_multiplier]
Service & Engagement = sum[(hours * hourW) + ((participants/10) * paxW) + role_bonus]
Lab Operations = sum[(volume * volW + hours * hourW) * complexity_multiplier * urgency_multiplier]
Professional & Scholarly Service = sum[((base * quantity * rounds) + hours) * role_multiplier * complexity_multiplier * urgency_multiplier]`);
  hr();

  headerBox("5. Soft Caps (after monthly normalization)");
  paragraph("Caps are applied per section with tail rates (diminishing returns beyond the cap).");
  formula(
`Teaching cap=35, tail=0.40
Student Supervision cap=25, tail=0.45
Research cap=30, tail=0.45
Publication cap=20, tail=0.50
Administration cap=35, tail=0.45
Service & Engagement cap=25, tail=0.50
Laboratory Operations cap=35, tail=0.45
Professional & Scholarly Service cap=25, tail=0.50`);
  hr();

  headerBox("6. Worked Examples by Staff Category (using default presets)");
  paragraph("Examples use current default scoring parameters (version 2.0). Points shown are already normalized to the selected reporting period.");

  subhead("Academic (period: Monthly; sections ON: Teaching, Student Supervision, Research, Publication, Administration, Service & Engagement, ProSch)");
  paragraph("Baseline weights: Teaching 0.28, Student Supervision 0.14, Research 0.20, Publication 0.10, Administration 0.12, Service & Engagement 0.08, Professional & Scholarly Service 0.08.");
  formula(
`Data entered:
- Teaching: 2 courses -> 10.12 pts (contact hours + students + credits)
- Student Supervision: 2 Master (Main, Active) + 1 PhD (Main, Active) -> 10.50 pts
- Research: 1 National grant (PI, Active) -> 13.44 pts
- Publication: 2 indexed journal papers (First/Corresponding) -> 20.16 raw -> 20.08 after cap (cap 20, tail 0.50)
- Administration: Faculty appointment (12 months, 4 meetings) -> 14.60 pts
- Service & Engagement: Lead outreach (10 hours, 60 pax) -> 18.80 pts
- Professional & Scholarly Service: Reviewer (3 manuscripts, 2 rounds, High complexity, Tight urgency, +5 hours) -> 46.00 raw -> 35.50 after cap (cap 25, tail 0.50)
 Index = (10.12*0.28)+(10.50*0.14)+(13.44*0.20)+(20.08*0.10)+(14.60*0.12)+(18.80*0.08)+(35.50*0.08)
 Index ≈ 15.10 points per month`);

  subhead("Administrative (period: Quarterly = 3 months; sections ON: Administration, Service & Engagement, ProSch)");
  paragraph("Baseline weights: Administration 0.55, Service & Engagement 0.30, Professional & Scholarly Service 0.15.");
  formula(
`Data entered:
- Administration: 2 roles (Faculty level: 3 months, 8 meetings; University level: 3 months, 4 meetings) -> 31.80 raw -> 10.60 per month
- Service & Engagement: Lead outreach (15 hours, 120 pax) + Member support (6 hours, 40 pax) -> 39.30 raw -> 13.10 per month
- Professional & Scholarly Service: External examiner (2 rounds, High complexity, Normal urgency, +6 hours, Lead) -> 24.96 raw -> 8.32 per month
 Index = (10.60*0.55) + (13.10*0.30) + (8.32*0.15)
 Index ≈ 11.00 points per month`);

  subhead("Laboratory (period: Monthly; sections ON: Administration, Service & Engagement, Laboratory Operations, ProSch)");
  paragraph("Baseline weights: Administration 0.40, Service & Engagement 0.20, Laboratory Operations 0.30, Professional & Scholarly Service 0.10.");
  formula(
`Data entered:
- Laboratory Operations: Equipment maintenance (vol=25, hrs=14, Medium, Tight) + Sample processing (vol=40, hrs=20, High, Critical) -> 207.38 raw -> 112.57 after cap (cap 35, tail 0.45)
- Administration: Lab safety officer (12 months, 4 meetings, Faculty level) -> 14.60 pts
- Service & Engagement: Training session (Lead, 8 hours, 30 participants) -> 14.40 pts
- Professional & Scholarly Service: 2 reviews (1 round, Medium complexity, Normal urgency, +4 hours) -> 13.00 pts
 Index = (112.57*0.30) + (14.60*0.40) + (14.40*0.20) + (13.00*0.10)
 Index ≈ 43.79 points per month`);

  subhead("Exports & Evidence");
  bullet([
    "Use Print for a clean black-and-white PDF (hides settings).",
    "Export Summary CSV for monthly-normalized section totals; Detailed CSV for row-level data; Full JSON for all inputs, weights and outputs.",
    "For auditability, keep start/end dates and workload notes clear and specific."
  ]);

  setSmall();
  paragraph("© Faculty of Science and Technology (FST), Universiti Malaysia Sabah (UMS).", 9);

  doc.save("FST_UMS_Busyness_Index_Manual.pdf");
}
/* =========================================================
   STORAGE
========================================================= */
function autosave(){
  state.audit.last_saved_at = new Date().toISOString();
  localStorage.setItem("fst_busyness_v2", JSON.stringify(state));
}
function saveNow(){
  syncProfileFromUI();
  syncEnabledFromUI();
  syncSettingsFromUI_ifAdmin();
  autosave();
  showMsg("ok","<b>Saved locally:</b> Data stored in your browser (localStorage).");
}
function loadLocal(){
  const raw = localStorage.getItem("fst_busyness_v2");
  if(!raw) return;
  try{
    const obj = JSON.parse(raw);

    // Merge safely to keep new defaults if missing
    if(obj.profile) state.profile = {...state.profile, ...obj.profile};
    if(obj.enabled) state.enabled = {...state.enabled, ...obj.enabled};
    if(obj.weights) state.weights = {...state.weights, ...obj.weights};
    if(obj.scheme) state.scheme = {...state.scheme, ...obj.scheme};
    if(obj.benchmarks) state.benchmarks = {...state.benchmarks, ...obj.benchmarks};
    if(obj.data) state.data = {...state.data, ...obj.data};
    if(obj.audit) state.audit = {...state.audit, ...obj.audit};
  }catch(e){}
}

/* =========================================================
   RESET
========================================================= */
function resetAll(){
  if(!confirm("Reset all data? This will clear local saved data for this tool on this browser.")) return;
  localStorage.removeItem("fst_busyness_v2");
  location.reload();
}

/* =========================================================
   INIT
========================================================= */
function init(){
  loadLocal();
  ensureSeed();
  syncUIFromState();
  applySectionVisibility();
  renderAll();
  setAdminUI();
  updateBenchmarkUI(null);

  $("pGrade").addEventListener("change", ()=>{
    $("pGradeOtherWrap").style.display = ($("pGrade").value==="Others") ? "block" : "none";
    autosave();
  });
  $("pStatus").addEventListener("change", ()=>{
    $("pStatusOtherWrap").style.display = ($("pStatus").value==="Others") ? "block" : "none";
    autosave();
  });

  // Category template
  $("pCategory").addEventListener("change", ()=>{
    syncProfileFromUI();
    if(state.profile.category) applyTemplateByCategory(state.profile.category);
  });

  // Toggles
  ["enTeaching","enSupervision","enResearch","enPublication","enAdministration","enServices","enLabOps","enProSch"].forEach(id=>{
    $(id).addEventListener("change", ()=>{
      syncEnabledFromUI();
      applySectionVisibility();
      autosave();
    });
  });

  // Advanced settings
  $("btnAdminUnlock").addEventListener("click",(e)=>{ e.preventDefault(); unlockAdmin(); });
  $("btnAdminLock").addEventListener("click",(e)=>{ e.preventDefault(); lockAdmin(); });

  // Add/Clear
  $("addTeach").onclick=(e)=>{e.preventDefault(); addRow("teach");};
  $("clearTeach").onclick=(e)=>{e.preventDefault(); clearKind("teach");};

  $("addSv").onclick=(e)=>{e.preventDefault(); addRow("sv");};
  $("clearSv").onclick=(e)=>{e.preventDefault(); clearKind("sv");};

  $("addRes").onclick=(e)=>{e.preventDefault(); syncProfileFromUI(); addRow("res");};
  $("clearRes").onclick=(e)=>{e.preventDefault(); clearKind("res");};

  $("addPub").onclick=(e)=>{e.preventDefault(); syncProfileFromUI(); addRow("pub");};
  $("clearPub").onclick=(e)=>{e.preventDefault(); clearKind("pub");};

  $("addAdmin").onclick=(e)=>{e.preventDefault(); addRow("admin");};
  $("clearAdmin").onclick=(e)=>{e.preventDefault(); clearKind("admin");};

  $("addSvc").onclick=(e)=>{e.preventDefault(); addRow("svc");};
  $("clearSvc").onclick=(e)=>{e.preventDefault(); clearKind("svc");};

  $("addLab").onclick=(e)=>{e.preventDefault(); addRow("lab");};
  $("clearLab").onclick=(e)=>{e.preventDefault(); clearKind("lab");};

  $("addProSch").onclick=(e)=>{e.preventDefault(); addRow("ps");};
  $("clearProSch").onclick=(e)=>{e.preventDefault(); clearKind("ps");};

  // Calculate / Print / Manual / Export
  $("btnCalc").onclick=(e)=>{e.preventDefault(); calculate();};

  $("btnPrint").onclick=(e)=>{
    e.preventDefault();
    syncProfileFromUI();
    syncPrintFields();
    window.print();
  };

  $("btnManual").onclick=(e)=>{e.preventDefault(); manualPDF();};

  const exportToggle = $("btnExportToggle");
  const exportMenu = $("exportMenu");
  const closeExportMenu = ()=>{
    exportMenu.classList.remove("open");
    exportToggle.setAttribute("aria-expanded","false");
  };
  exportToggle.onclick=(e)=>{
    e.preventDefault();
    const isOpen = exportMenu.classList.toggle("open");
    exportToggle.setAttribute("aria-expanded", String(isOpen));
  };
  document.addEventListener("click",(e)=>{
    if(!exportMenu.contains(e.target) && !exportToggle.contains(e.target)){
      closeExportMenu();
    }
  });
  document.addEventListener("keydown",(e)=>{
    if(e.key==="Escape") closeExportMenu();
  });

  $("btnExportSummaryCSV").onclick=(e)=>{e.preventDefault(); exportSummaryCSV(); closeExportMenu();};
  $("btnExportDetailedCSV").onclick=(e)=>{e.preventDefault(); exportDetailedCSV(); closeExportMenu();};
  $("btnExportJSON").onclick=(e)=>{e.preventDefault(); exportJSON(); closeExportMenu();};

  // Save / Reset
  $("btnSaveLocal").onclick=(e)=>{e.preventDefault(); saveNow();};
  $("btnReset").onclick=(e)=>{e.preventDefault(); resetAll();};

  // Presets (admin only)
  $("btnPresetAcademic").onclick=(e)=>{e.preventDefault(); if(!isAdmin) return; applyTemplateByCategory("Academic");};
  $("btnPresetAdmin").onclick=(e)=>{e.preventDefault(); if(!isAdmin) return; applyTemplateByCategory("Administrative");};
  $("btnPresetLab").onclick=(e)=>{e.preventDefault(); if(!isAdmin) return; applyTemplateByCategory("Laboratory");};

  hideMsg();
}
document.addEventListener("DOMContentLoaded", init);
</script>

</body>
</html>
